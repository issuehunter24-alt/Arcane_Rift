const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/browserAll-C4gCvB1g.js","assets/webworkerAll-DVt7NNgS.js","assets/colorToUniform-DGpQ3aG5.js","assets/WebGPURenderer-DtnNeq-x.js","assets/SharedSystems-CJO59ONV.js","assets/WebGLRenderer-CehUSIvP.js"])))=>i.map(i=>d[i]);
function Qp(r,e){for(var t=0;t<e.length;t++){const s=e[t];if(typeof s!="string"&&!Array.isArray(s)){for(const n in s)if(n!=="default"&&!(n in r)){const a=Object.getOwnPropertyDescriptor(s,n);a&&Object.defineProperty(r,n,a.get?a:{enumerable:!0,get:()=>s[n]})}}}return Object.freeze(Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}))}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=t(n);fetch(n.href,a)}})();const Zp="modulepreload",em=function(r){return"/"+r},Sl={},fi=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),o=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));n=Promise.allSettled(t.map(c=>{if(c=em(c),c in Sl)return;Sl[c]=!0;const l=c.endsWith(".css"),h=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${h}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":Zp,l||(d.as="script"),d.crossOrigin="",d.href=c,o&&d.setAttribute("nonce",o),document.head.appendChild(d),l)return new Promise((u,f)=>{d.addEventListener("load",u),d.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${c}`)))})}))}function a(i){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=i,window.dispatchEvent(o),!o.defaultPrevented)throw i}return n.then(i=>{for(const o of i||[])o.status==="rejected"&&a(o.reason);return e().catch(a)})};var J=(r=>(r.Application="application",r.WebGLPipes="webgl-pipes",r.WebGLPipesAdaptor="webgl-pipes-adaptor",r.WebGLSystem="webgl-system",r.WebGPUPipes="webgpu-pipes",r.WebGPUPipesAdaptor="webgpu-pipes-adaptor",r.WebGPUSystem="webgpu-system",r.CanvasSystem="canvas-system",r.CanvasPipesAdaptor="canvas-pipes-adaptor",r.CanvasPipes="canvas-pipes",r.Asset="asset",r.LoadParser="load-parser",r.ResolveParser="resolve-parser",r.CacheParser="cache-parser",r.DetectionParser="detection-parser",r.MaskEffect="mask-effect",r.BlendMode="blend-mode",r.TextureSource="texture-source",r.Environment="environment",r.ShapeBuilder="shape-builder",r.Batcher="batcher",r))(J||{});const Go=r=>{if(typeof r=="function"||typeof r=="object"&&r.extension){if(!r.extension)throw new Error("Extension class must have an extension object");r={...typeof r.extension!="object"?{type:r.extension}:r.extension,ref:r}}if(typeof r=="object")r={...r};else throw new Error("Invalid extension type");return typeof r.type=="string"&&(r.type=[r.type]),r},ya=(r,e)=>Go(r).priority??e,at={_addHandlers:{},_removeHandlers:{},_queue:{},remove(...r){return r.map(Go).forEach(e=>{e.type.forEach(t=>{var s,n;return(n=(s=this._removeHandlers)[t])==null?void 0:n.call(s,e)})}),this},add(...r){return r.map(Go).forEach(e=>{e.type.forEach(t=>{var a,i;const s=this._addHandlers,n=this._queue;s[t]?(i=s[t])==null||i.call(s,e):(n[t]=n[t]||[],(a=n[t])==null||a.push(e))})}),this},handle(r,e,t){var i;const s=this._addHandlers,n=this._removeHandlers;if(s[r]||n[r])throw new Error(`Extension type ${r} already has a handler`);s[r]=e,n[r]=t;const a=this._queue;return a[r]&&((i=a[r])==null||i.forEach(o=>e(o)),delete a[r]),this},handleByMap(r,e){return this.handle(r,t=>{t.name&&(e[t.name]=t.ref)},t=>{t.name&&delete e[t.name]})},handleByNamedList(r,e,t=-1){return this.handle(r,s=>{e.findIndex(a=>a.name===s.name)>=0||(e.push({name:s.name,value:s.ref}),e.sort((a,i)=>ya(i.value,t)-ya(a.value,t)))},s=>{const n=e.findIndex(a=>a.name===s.name);n!==-1&&e.splice(n,1)})},handleByList(r,e,t=-1){return this.handle(r,s=>{e.includes(s.ref)||(e.push(s.ref),e.sort((n,a)=>ya(a,t)-ya(n,t)))},s=>{const n=e.indexOf(s.ref);n!==-1&&e.splice(n,1)})},mixin(r,...e){for(const t of e)Object.defineProperties(r.prototype,Object.getOwnPropertyDescriptors(t))}},tm={extension:{type:J.Environment,name:"browser",priority:-1},test:()=>!0,load:async()=>{await fi(()=>import("./browserAll-C4gCvB1g.js"),__vite__mapDeps([0,1,2]))}},rm={extension:{type:J.Environment,name:"webworker",priority:0},test:()=>typeof self<"u"&&self.WorkerGlobalScope!==void 0,load:async()=>{await fi(()=>import("./webworkerAll-DVt7NNgS.js"),__vite__mapDeps([1,2]))}};class nt{constructor(e,t,s){this._x=t||0,this._y=s||0,this._observer=e}clone(e){return new nt(e??this._observer,this._x,this._y)}set(e=0,t=e){return(this._x!==e||this._y!==t)&&(this._x=e,this._y=t,this._observer._onUpdate(this)),this}copyFrom(e){return(this._x!==e.x||this._y!==e.y)&&(this._x=e.x,this._y=e.y,this._observer._onUpdate(this)),this}copyTo(e){return e.set(this._x,this._y),e}equals(e){return e.x===this._x&&e.y===this._y}toString(){return`[pixi.js/math:ObservablePoint x=${this._x} y=${this._y} scope=${this._observer}]`}get x(){return this._x}set x(e){this._x!==e&&(this._x=e,this._observer._onUpdate(this))}get y(){return this._y}set y(e){this._y!==e&&(this._y=e,this._observer._onUpdate(this))}}function Ei(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function sm(r){if(r.__esModule)return r;var e=r.default;if(typeof e=="function"){var t=function s(){return this instanceof s?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(s){var n=Object.getOwnPropertyDescriptor(r,s);Object.defineProperty(t,s,n.get?n:{enumerable:!0,get:function(){return r[s]}})}),t}var Md={exports:{}};(function(r){var e=Object.prototype.hasOwnProperty,t="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(t=!1));function n(c,l,h){this.fn=c,this.context=l,this.once=h||!1}function a(c,l,h,d,u){if(typeof h!="function")throw new TypeError("The listener must be a function");var f=new n(h,d||c,u),p=t?t+l:l;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],f]:c._events[p].push(f):(c._events[p]=f,c._eventsCount++),c}function i(c,l){--c._eventsCount===0?c._events=new s:delete c._events[l]}function o(){this._events=new s,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],h,d;if(this._eventsCount===0)return l;for(d in h=this._events)e.call(h,d)&&l.push(t?d.slice(1):d);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(h)):l},o.prototype.listeners=function(l){var h=t?t+l:l,d=this._events[h];if(!d)return[];if(d.fn)return[d.fn];for(var u=0,f=d.length,p=new Array(f);u<f;u++)p[u]=d[u].fn;return p},o.prototype.listenerCount=function(l){var h=t?t+l:l,d=this._events[h];return d?d.fn?1:d.length:0},o.prototype.emit=function(l,h,d,u,f,p){var g=t?t+l:l;if(!this._events[g])return!1;var m=this._events[g],_=arguments.length,b,x;if(m.fn){switch(m.once&&this.removeListener(l,m.fn,void 0,!0),_){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,h),!0;case 3:return m.fn.call(m.context,h,d),!0;case 4:return m.fn.call(m.context,h,d,u),!0;case 5:return m.fn.call(m.context,h,d,u,f),!0;case 6:return m.fn.call(m.context,h,d,u,f,p),!0}for(x=1,b=new Array(_-1);x<_;x++)b[x-1]=arguments[x];m.fn.apply(m.context,b)}else{var S=m.length,T;for(x=0;x<S;x++)switch(m[x].once&&this.removeListener(l,m[x].fn,void 0,!0),_){case 1:m[x].fn.call(m[x].context);break;case 2:m[x].fn.call(m[x].context,h);break;case 3:m[x].fn.call(m[x].context,h,d);break;case 4:m[x].fn.call(m[x].context,h,d,u);break;default:if(!b)for(T=1,b=new Array(_-1);T<_;T++)b[T-1]=arguments[T];m[x].fn.apply(m[x].context,b)}}return!0},o.prototype.on=function(l,h,d){return a(this,l,h,d,!1)},o.prototype.once=function(l,h,d){return a(this,l,h,d,!0)},o.prototype.removeListener=function(l,h,d,u){var f=t?t+l:l;if(!this._events[f])return this;if(!h)return i(this,f),this;var p=this._events[f];if(p.fn)p.fn===h&&(!u||p.once)&&(!d||p.context===d)&&i(this,f);else{for(var g=0,m=[],_=p.length;g<_;g++)(p[g].fn!==h||u&&!p[g].once||d&&p[g].context!==d)&&m.push(p[g]);m.length?this._events[f]=m.length===1?m[0]:m:i(this,f)}return this},o.prototype.removeAllListeners=function(l){var h;return l?(h=t?t+l:l,this._events[h]&&i(this,h)):(this._events=new s,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,r.exports=o})(Md);var nm=Md.exports;const qt=Ei(nm),am=Math.PI*2,im=180/Math.PI,om=Math.PI/180;class ft{constructor(e=0,t=0){this.x=0,this.y=0,this.x=e,this.y=t}clone(){return new ft(this.x,this.y)}copyFrom(e){return this.set(e.x,e.y),this}copyTo(e){return e.set(this.x,this.y),e}equals(e){return e.x===this.x&&e.y===this.y}set(e=0,t=e){return this.x=e,this.y=t,this}toString(){return`[pixi.js/math:Point x=${this.x} y=${this.y}]`}static get shared(){return Qi.x=0,Qi.y=0,Qi}}const Qi=new ft;class pe{constructor(e=1,t=0,s=0,n=1,a=0,i=0){this.array=null,this.a=e,this.b=t,this.c=s,this.d=n,this.tx=a,this.ty=i}fromArray(e){this.a=e[0],this.b=e[1],this.c=e[3],this.d=e[4],this.tx=e[2],this.ty=e[5]}set(e,t,s,n,a,i){return this.a=e,this.b=t,this.c=s,this.d=n,this.tx=a,this.ty=i,this}toArray(e,t){this.array||(this.array=new Float32Array(9));const s=t||this.array;return e?(s[0]=this.a,s[1]=this.b,s[2]=0,s[3]=this.c,s[4]=this.d,s[5]=0,s[6]=this.tx,s[7]=this.ty,s[8]=1):(s[0]=this.a,s[1]=this.c,s[2]=this.tx,s[3]=this.b,s[4]=this.d,s[5]=this.ty,s[6]=0,s[7]=0,s[8]=1),s}apply(e,t){t=t||new ft;const s=e.x,n=e.y;return t.x=this.a*s+this.c*n+this.tx,t.y=this.b*s+this.d*n+this.ty,t}applyInverse(e,t){t=t||new ft;const s=this.a,n=this.b,a=this.c,i=this.d,o=this.tx,c=this.ty,l=1/(s*i+a*-n),h=e.x,d=e.y;return t.x=i*l*h+-a*l*d+(c*a-o*i)*l,t.y=s*l*d+-n*l*h+(-c*s+o*n)*l,t}translate(e,t){return this.tx+=e,this.ty+=t,this}scale(e,t){return this.a*=e,this.d*=t,this.c*=e,this.b*=t,this.tx*=e,this.ty*=t,this}rotate(e){const t=Math.cos(e),s=Math.sin(e),n=this.a,a=this.c,i=this.tx;return this.a=n*t-this.b*s,this.b=n*s+this.b*t,this.c=a*t-this.d*s,this.d=a*s+this.d*t,this.tx=i*t-this.ty*s,this.ty=i*s+this.ty*t,this}append(e){const t=this.a,s=this.b,n=this.c,a=this.d;return this.a=e.a*t+e.b*n,this.b=e.a*s+e.b*a,this.c=e.c*t+e.d*n,this.d=e.c*s+e.d*a,this.tx=e.tx*t+e.ty*n+this.tx,this.ty=e.tx*s+e.ty*a+this.ty,this}appendFrom(e,t){const s=e.a,n=e.b,a=e.c,i=e.d,o=e.tx,c=e.ty,l=t.a,h=t.b,d=t.c,u=t.d;return this.a=s*l+n*d,this.b=s*h+n*u,this.c=a*l+i*d,this.d=a*h+i*u,this.tx=o*l+c*d+t.tx,this.ty=o*h+c*u+t.ty,this}setTransform(e,t,s,n,a,i,o,c,l){return this.a=Math.cos(o+l)*a,this.b=Math.sin(o+l)*a,this.c=-Math.sin(o-c)*i,this.d=Math.cos(o-c)*i,this.tx=e-(s*this.a+n*this.c),this.ty=t-(s*this.b+n*this.d),this}prepend(e){const t=this.tx;if(e.a!==1||e.b!==0||e.c!==0||e.d!==1){const s=this.a,n=this.c;this.a=s*e.a+this.b*e.c,this.b=s*e.b+this.b*e.d,this.c=n*e.a+this.d*e.c,this.d=n*e.b+this.d*e.d}return this.tx=t*e.a+this.ty*e.c+e.tx,this.ty=t*e.b+this.ty*e.d+e.ty,this}decompose(e){const t=this.a,s=this.b,n=this.c,a=this.d,i=e.pivot,o=-Math.atan2(-n,a),c=Math.atan2(s,t),l=Math.abs(o+c);return l<1e-5||Math.abs(am-l)<1e-5?(e.rotation=c,e.skew.x=e.skew.y=0):(e.rotation=0,e.skew.x=o,e.skew.y=c),e.scale.x=Math.sqrt(t*t+s*s),e.scale.y=Math.sqrt(n*n+a*a),e.position.x=this.tx+(i.x*t+i.y*n),e.position.y=this.ty+(i.x*s+i.y*a),e}invert(){const e=this.a,t=this.b,s=this.c,n=this.d,a=this.tx,i=e*n-t*s;return this.a=n/i,this.b=-t/i,this.c=-s/i,this.d=e/i,this.tx=(s*this.ty-n*a)/i,this.ty=-(e*this.ty-t*a)/i,this}isIdentity(){return this.a===1&&this.b===0&&this.c===0&&this.d===1&&this.tx===0&&this.ty===0}identity(){return this.a=1,this.b=0,this.c=0,this.d=1,this.tx=0,this.ty=0,this}clone(){const e=new pe;return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e}copyTo(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e}copyFrom(e){return this.a=e.a,this.b=e.b,this.c=e.c,this.d=e.d,this.tx=e.tx,this.ty=e.ty,this}equals(e){return e.a===this.a&&e.b===this.b&&e.c===this.c&&e.d===this.d&&e.tx===this.tx&&e.ty===this.ty}toString(){return`[pixi.js:Matrix a=${this.a} b=${this.b} c=${this.c} d=${this.d} tx=${this.tx} ty=${this.ty}]`}static get IDENTITY(){return lm.identity()}static get shared(){return cm.identity()}}const cm=new pe,lm=new pe,Kr=[1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1,0,1],Jr=[0,1,1,1,0,-1,-1,-1,0,1,1,1,0,-1,-1,-1],Qr=[0,-1,-1,-1,0,1,1,1,0,1,1,1,0,-1,-1,-1],Zr=[1,1,0,-1,-1,-1,0,1,-1,-1,0,1,1,1,0,-1],zo=[],$d=[],_a=Math.sign;function hm(){for(let r=0;r<16;r++){const e=[];zo.push(e);for(let t=0;t<16;t++){const s=_a(Kr[r]*Kr[t]+Qr[r]*Jr[t]),n=_a(Jr[r]*Kr[t]+Zr[r]*Jr[t]),a=_a(Kr[r]*Qr[t]+Qr[r]*Zr[t]),i=_a(Jr[r]*Qr[t]+Zr[r]*Zr[t]);for(let o=0;o<16;o++)if(Kr[o]===s&&Jr[o]===n&&Qr[o]===a&&Zr[o]===i){e.push(o);break}}}for(let r=0;r<16;r++){const e=new pe;e.set(Kr[r],Jr[r],Qr[r],Zr[r],0,0),$d.push(e)}}hm();const xe={E:0,SE:1,S:2,SW:3,W:4,NW:5,N:6,NE:7,MIRROR_VERTICAL:8,MAIN_DIAGONAL:10,MIRROR_HORIZONTAL:12,REVERSE_DIAGONAL:14,uX:r=>Kr[r],uY:r=>Jr[r],vX:r=>Qr[r],vY:r=>Zr[r],inv:r=>r&8?r&15:-r&7,add:(r,e)=>zo[r][e],sub:(r,e)=>zo[r][xe.inv(e)],rotate180:r=>r^4,isVertical:r=>(r&3)===2,byDirection:(r,e)=>Math.abs(r)*2<=Math.abs(e)?e>=0?xe.S:xe.N:Math.abs(e)*2<=Math.abs(r)?r>0?xe.E:xe.W:e>0?r>0?xe.SE:xe.SW:r>0?xe.NE:xe.NW,matrixAppendRotationInv:(r,e,t=0,s=0)=>{const n=$d[xe.inv(e)];n.tx=t,n.ty=s,r.append(n)},transformRectCoords:(r,e,t,s)=>{const{x:n,y:a,width:i,height:o}=r,{x:c,y:l,width:h,height:d}=e;return t===xe.E?(s.set(n+c,a+l,i,o),s):t===xe.S?s.set(h-a-o+c,n+l,o,i):t===xe.W?s.set(h-n-i+c,d-a-o+l,i,o):t===xe.N?s.set(a+c,d-n-i+l,o,i):s.set(n+c,a+l,i,o)}},ba=[new ft,new ft,new ft,new ft];class Re{constructor(e=0,t=0,s=0,n=0){this.type="rectangle",this.x=Number(e),this.y=Number(t),this.width=Number(s),this.height=Number(n)}get left(){return this.x}get right(){return this.x+this.width}get top(){return this.y}get bottom(){return this.y+this.height}isEmpty(){return this.left===this.right||this.top===this.bottom}static get EMPTY(){return new Re(0,0,0,0)}clone(){return new Re(this.x,this.y,this.width,this.height)}copyFromBounds(e){return this.x=e.minX,this.y=e.minY,this.width=e.maxX-e.minX,this.height=e.maxY-e.minY,this}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}copyTo(e){return e.copyFrom(this),e}contains(e,t){return this.width<=0||this.height<=0?!1:e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height}strokeContains(e,t,s,n=.5){const{width:a,height:i}=this;if(a<=0||i<=0)return!1;const o=this.x,c=this.y,l=s*(1-n),h=s-l,d=o-l,u=o+a+l,f=c-l,p=c+i+l,g=o+h,m=o+a-h,_=c+h,b=c+i-h;return e>=d&&e<=u&&t>=f&&t<=p&&!(e>g&&e<m&&t>_&&t<b)}intersects(e,t){if(!t){const R=this.x<e.x?e.x:this.x;if((this.right>e.right?e.right:this.right)<=R)return!1;const B=this.y<e.y?e.y:this.y;return(this.bottom>e.bottom?e.bottom:this.bottom)>B}const s=this.left,n=this.right,a=this.top,i=this.bottom;if(n<=s||i<=a)return!1;const o=ba[0].set(e.left,e.top),c=ba[1].set(e.left,e.bottom),l=ba[2].set(e.right,e.top),h=ba[3].set(e.right,e.bottom);if(l.x<=o.x||c.y<=o.y)return!1;const d=Math.sign(t.a*t.d-t.b*t.c);if(d===0||(t.apply(o,o),t.apply(c,c),t.apply(l,l),t.apply(h,h),Math.max(o.x,c.x,l.x,h.x)<=s||Math.min(o.x,c.x,l.x,h.x)>=n||Math.max(o.y,c.y,l.y,h.y)<=a||Math.min(o.y,c.y,l.y,h.y)>=i))return!1;const u=d*(c.y-o.y),f=d*(o.x-c.x),p=u*s+f*a,g=u*n+f*a,m=u*s+f*i,_=u*n+f*i;if(Math.max(p,g,m,_)<=u*o.x+f*o.y||Math.min(p,g,m,_)>=u*h.x+f*h.y)return!1;const b=d*(o.y-l.y),x=d*(l.x-o.x),S=b*s+x*a,T=b*n+x*a,A=b*s+x*i,C=b*n+x*i;return!(Math.max(S,T,A,C)<=b*o.x+x*o.y||Math.min(S,T,A,C)>=b*h.x+x*h.y)}pad(e=0,t=e){return this.x-=e,this.y-=t,this.width+=e*2,this.height+=t*2,this}fit(e){const t=Math.max(this.x,e.x),s=Math.min(this.x+this.width,e.x+e.width),n=Math.max(this.y,e.y),a=Math.min(this.y+this.height,e.y+e.height);return this.x=t,this.width=Math.max(s-t,0),this.y=n,this.height=Math.max(a-n,0),this}ceil(e=1,t=.001){const s=Math.ceil((this.x+this.width-t)*e)/e,n=Math.ceil((this.y+this.height-t)*e)/e;return this.x=Math.floor((this.x+t)*e)/e,this.y=Math.floor((this.y+t)*e)/e,this.width=s-this.x,this.height=n-this.y,this}scale(e,t=e){return this.x*=e,this.y*=t,this.width*=e,this.height*=t,this}enlarge(e){const t=Math.min(this.x,e.x),s=Math.max(this.x+this.width,e.x+e.width),n=Math.min(this.y,e.y),a=Math.max(this.y+this.height,e.y+e.height);return this.x=t,this.width=s-t,this.y=n,this.height=a-n,this}getBounds(e){return e||(e=new Re),e.copyFrom(this),e}containsRect(e){if(this.width<=0||this.height<=0)return!1;const t=e.x,s=e.y,n=e.x+e.width,a=e.y+e.height;return t>=this.x&&t<this.x+this.width&&s>=this.y&&s<this.y+this.height&&n>=this.x&&n<this.x+this.width&&a>=this.y&&a<this.y+this.height}set(e,t,s,n){return this.x=e,this.y=t,this.width=s,this.height=n,this}toString(){return`[pixi.js/math:Rectangle x=${this.x} y=${this.y} width=${this.width} height=${this.height}]`}}const Zi={default:-1};function je(r="default"){return Zi[r]===void 0&&(Zi[r]=-1),++Zi[r]}const kl=new Set,_e="8.0.0",dm="8.3.4",Os={quiet:!1,noColor:!1},he=(r,e,t=3)=>{if(Os.quiet||kl.has(e))return;let s=new Error().stack;const n=`${e}
Deprecated since v${r}`,a=typeof console.groupCollapsed=="function"&&!Os.noColor;typeof s>"u"?console.warn("PixiJS Deprecation Warning: ",n):(s=s.split(`
`).splice(t).join(`
`),a?(console.groupCollapsed("%cPixiJS Deprecation Warning: %c%s","color:#614108;background:#fffbe6","font-weight:normal;color:#614108;background:#fffbe6",n),console.warn(s),console.groupEnd()):(console.warn("PixiJS Deprecation Warning: ",n),console.warn(s))),kl.add(e)};Object.defineProperties(he,{quiet:{get:()=>Os.quiet,set:r=>{Os.quiet=r},enumerable:!0,configurable:!1},noColor:{get:()=>Os.noColor,set:r=>{Os.noColor=r},enumerable:!0,configurable:!1}});const Od=()=>{};function Ns(r){return r+=r===0?1:0,--r,r|=r>>>1,r|=r>>>2,r|=r>>>4,r|=r>>>8,r|=r>>>16,r+1}function Il(r){return!(r&r-1)&&!!r}function Bd(r){const e={};for(const t in r)r[t]!==void 0&&(e[t]=r[t]);return e}const Al=Object.create(null);function um(r){const e=Al[r];return e===void 0&&(Al[r]=je("resource")),e}const Dd=class Ld extends qt{constructor(e={}){super(),this._resourceType="textureSampler",this._touched=0,this._maxAnisotropy=1,this.destroyed=!1,e={...Ld.defaultOptions,...e},this.addressMode=e.addressMode,this.addressModeU=e.addressModeU??this.addressModeU,this.addressModeV=e.addressModeV??this.addressModeV,this.addressModeW=e.addressModeW??this.addressModeW,this.scaleMode=e.scaleMode,this.magFilter=e.magFilter??this.magFilter,this.minFilter=e.minFilter??this.minFilter,this.mipmapFilter=e.mipmapFilter??this.mipmapFilter,this.lodMinClamp=e.lodMinClamp,this.lodMaxClamp=e.lodMaxClamp,this.compare=e.compare,this.maxAnisotropy=e.maxAnisotropy??1}set addressMode(e){this.addressModeU=e,this.addressModeV=e,this.addressModeW=e}get addressMode(){return this.addressModeU}set wrapMode(e){he(_e,"TextureStyle.wrapMode is now TextureStyle.addressMode"),this.addressMode=e}get wrapMode(){return this.addressMode}set scaleMode(e){this.magFilter=e,this.minFilter=e,this.mipmapFilter=e}get scaleMode(){return this.magFilter}set maxAnisotropy(e){this._maxAnisotropy=Math.min(e,16),this._maxAnisotropy>1&&(this.scaleMode="linear")}get maxAnisotropy(){return this._maxAnisotropy}get _resourceId(){return this._sharedResourceId||this._generateResourceId()}update(){this.emit("change",this),this._sharedResourceId=null}_generateResourceId(){const e=`${this.addressModeU}-${this.addressModeV}-${this.addressModeW}-${this.magFilter}-${this.minFilter}-${this.mipmapFilter}-${this.lodMinClamp}-${this.lodMaxClamp}-${this.compare}-${this._maxAnisotropy}`;return this._sharedResourceId=um(e),this._resourceId}destroy(){this.destroyed=!0,this.emit("destroy",this),this.emit("change",this),this.removeAllListeners()}};Dd.defaultOptions={addressMode:"clamp-to-edge",scaleMode:"linear"};let Hs=Dd;const Fd=class jd extends qt{constructor(e={}){super(),this.options=e,this.uid=je("textureSource"),this._resourceType="textureSource",this._resourceId=je("resource"),this.uploadMethodId="unknown",this._resolution=1,this.pixelWidth=1,this.pixelHeight=1,this.width=1,this.height=1,this.sampleCount=1,this.mipLevelCount=1,this.autoGenerateMipmaps=!1,this.format="rgba8unorm",this.dimension="2d",this.antialias=!1,this._touched=0,this._batchTick=-1,this._textureBindLocation=-1,e={...jd.defaultOptions,...e},this.label=e.label??"",this.resource=e.resource,this.autoGarbageCollect=e.autoGarbageCollect,this._resolution=e.resolution,e.width?this.pixelWidth=e.width*this._resolution:this.pixelWidth=this.resource?this.resourceWidth??1:1,e.height?this.pixelHeight=e.height*this._resolution:this.pixelHeight=this.resource?this.resourceHeight??1:1,this.width=this.pixelWidth/this._resolution,this.height=this.pixelHeight/this._resolution,this.format=e.format,this.dimension=e.dimensions,this.mipLevelCount=e.mipLevelCount,this.autoGenerateMipmaps=e.autoGenerateMipmaps,this.sampleCount=e.sampleCount,this.antialias=e.antialias,this.alphaMode=e.alphaMode,this.style=new Hs(Bd(e)),this.destroyed=!1,this._refreshPOT()}get source(){return this}get style(){return this._style}set style(e){var t,s;this.style!==e&&((t=this._style)==null||t.off("change",this._onStyleChange,this),this._style=e,(s=this._style)==null||s.on("change",this._onStyleChange,this),this._onStyleChange())}set maxAnisotropy(e){this._style.maxAnisotropy=e}get maxAnisotropy(){return this._style.maxAnisotropy}get addressMode(){return this._style.addressMode}set addressMode(e){this._style.addressMode=e}get repeatMode(){return this._style.addressMode}set repeatMode(e){this._style.addressMode=e}get magFilter(){return this._style.magFilter}set magFilter(e){this._style.magFilter=e}get minFilter(){return this._style.minFilter}set minFilter(e){this._style.minFilter=e}get mipmapFilter(){return this._style.mipmapFilter}set mipmapFilter(e){this._style.mipmapFilter=e}get lodMinClamp(){return this._style.lodMinClamp}set lodMinClamp(e){this._style.lodMinClamp=e}get lodMaxClamp(){return this._style.lodMaxClamp}set lodMaxClamp(e){this._style.lodMaxClamp=e}_onStyleChange(){this.emit("styleChange",this)}update(){if(this.resource){const e=this._resolution;if(this.resize(this.resourceWidth/e,this.resourceHeight/e))return}this.emit("update",this)}destroy(){this.destroyed=!0,this.emit("destroy",this),this.emit("change",this),this._style&&(this._style.destroy(),this._style=null),this.uploadMethodId=null,this.resource=null,this.removeAllListeners()}unload(){this._resourceId=je("resource"),this.emit("change",this),this.emit("unload",this)}get resourceWidth(){const{resource:e}=this;return e.naturalWidth||e.videoWidth||e.displayWidth||e.width}get resourceHeight(){const{resource:e}=this;return e.naturalHeight||e.videoHeight||e.displayHeight||e.height}get resolution(){return this._resolution}set resolution(e){this._resolution!==e&&(this._resolution=e,this.width=this.pixelWidth/e,this.height=this.pixelHeight/e)}resize(e,t,s){s||(s=this._resolution),e||(e=this.width),t||(t=this.height);const n=Math.round(e*s),a=Math.round(t*s);return this.width=n/s,this.height=a/s,this._resolution=s,this.pixelWidth===n&&this.pixelHeight===a?!1:(this._refreshPOT(),this.pixelWidth=n,this.pixelHeight=a,this.emit("resize",this),this._resourceId=je("resource"),this.emit("change",this),!0)}updateMipmaps(){this.autoGenerateMipmaps&&this.mipLevelCount>1&&this.emit("updateMipmaps",this)}set wrapMode(e){this._style.wrapMode=e}get wrapMode(){return this._style.wrapMode}set scaleMode(e){this._style.scaleMode=e}get scaleMode(){return this._style.scaleMode}_refreshPOT(){this.isPowerOfTwo=Il(this.pixelWidth)&&Il(this.pixelHeight)}static test(e){throw new Error("Unimplemented")}};Fd.defaultOptions={resolution:1,format:"bgra8unorm",alphaMode:"premultiply-alpha-on-upload",dimensions:"2d",mipLevelCount:1,autoGenerateMipmaps:!1,sampleCount:1,antialias:!1,autoGarbageCollect:!1};let Xt=Fd;class Mc extends Xt{constructor(e){const t=e.resource||new Float32Array(e.width*e.height*4);let s=e.format;s||(t instanceof Float32Array?s="rgba32float":t instanceof Int32Array||t instanceof Uint32Array?s="rgba32uint":t instanceof Int16Array||t instanceof Uint16Array?s="rgba16uint":(t instanceof Int8Array,s="bgra8unorm")),super({...e,resource:t,format:s}),this.uploadMethodId="buffer"}static test(e){return e instanceof Int8Array||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array}}Mc.extension=J.TextureSource;const Cl=new pe;class fm{constructor(e,t){this.mapCoord=new pe,this.uClampFrame=new Float32Array(4),this.uClampOffset=new Float32Array(2),this._textureID=-1,this._updateID=0,this.clampOffset=0,typeof t>"u"?this.clampMargin=e.width<10?0:.5:this.clampMargin=t,this.isSimple=!1,this.texture=e}get texture(){return this._texture}set texture(e){var t;this.texture!==e&&((t=this._texture)==null||t.removeListener("update",this.update,this),this._texture=e,this._texture.addListener("update",this.update,this),this.update())}multiplyUvs(e,t){t===void 0&&(t=e);const s=this.mapCoord;for(let n=0;n<e.length;n+=2){const a=e[n],i=e[n+1];t[n]=a*s.a+i*s.c+s.tx,t[n+1]=a*s.b+i*s.d+s.ty}return t}update(){const e=this._texture;this._updateID++;const t=e.uvs;this.mapCoord.set(t.x1-t.x0,t.y1-t.y0,t.x3-t.x0,t.y3-t.y0,t.x0,t.y0);const s=e.orig,n=e.trim;n&&(Cl.set(s.width/n.width,0,0,s.height/n.height,-n.x/n.width,-n.y/n.height),this.mapCoord.append(Cl));const a=e.source,i=this.uClampFrame,o=this.clampMargin/a._resolution,c=this.clampOffset/a._resolution;return i[0]=(e.frame.x+o+c)/a.width,i[1]=(e.frame.y+o+c)/a.height,i[2]=(e.frame.x+e.frame.width-o+c)/a.width,i[3]=(e.frame.y+e.frame.height-o+c)/a.height,this.uClampOffset[0]=this.clampOffset/a.pixelWidth,this.uClampOffset[1]=this.clampOffset/a.pixelHeight,this.isSimple=e.frame.width===a.width&&e.frame.height===a.height&&e.rotate===0,!0}}class me extends qt{constructor({source:e,label:t,frame:s,orig:n,trim:a,defaultAnchor:i,defaultBorders:o,rotate:c,dynamic:l}={}){if(super(),this.uid=je("texture"),this.uvs={x0:0,y0:0,x1:0,y1:0,x2:0,y2:0,x3:0,y3:0},this.frame=new Re,this.noFrame=!1,this.dynamic=!1,this.isTexture=!0,this.label=t,this.source=(e==null?void 0:e.source)??new Xt,this.noFrame=!s,s)this.frame.copyFrom(s);else{const{width:h,height:d}=this._source;this.frame.width=h,this.frame.height=d}this.orig=n||this.frame,this.trim=a,this.rotate=c??0,this.defaultAnchor=i,this.defaultBorders=o,this.destroyed=!1,this.dynamic=l||!1,this.updateUvs()}set source(e){this._source&&this._source.off("resize",this.update,this),this._source=e,e.on("resize",this.update,this),this.emit("update",this)}get source(){return this._source}get textureMatrix(){return this._textureMatrix||(this._textureMatrix=new fm(this)),this._textureMatrix}get width(){return this.orig.width}get height(){return this.orig.height}updateUvs(){const{uvs:e,frame:t}=this,{width:s,height:n}=this._source,a=t.x/s,i=t.y/n,o=t.width/s,c=t.height/n;let l=this.rotate;if(l){const h=o/2,d=c/2,u=a+h,f=i+d;l=xe.add(l,xe.NW),e.x0=u+h*xe.uX(l),e.y0=f+d*xe.uY(l),l=xe.add(l,2),e.x1=u+h*xe.uX(l),e.y1=f+d*xe.uY(l),l=xe.add(l,2),e.x2=u+h*xe.uX(l),e.y2=f+d*xe.uY(l),l=xe.add(l,2),e.x3=u+h*xe.uX(l),e.y3=f+d*xe.uY(l)}else e.x0=a,e.y0=i,e.x1=a+o,e.y1=i,e.x2=a+o,e.y2=i+c,e.x3=a,e.y3=i+c}destroy(e=!1){this._source&&e&&(this._source.destroy(),this._source=null),this._textureMatrix=null,this.destroyed=!0,this.emit("destroy",this),this.removeAllListeners()}update(){this.noFrame&&(this.frame.width=this._source.width,this.frame.height=this._source.height),this.updateUvs(),this.emit("update",this)}get baseTexture(){return he(_e,"Texture.baseTexture is now Texture.source"),this._source}}me.EMPTY=new me({label:"EMPTY",source:new Xt({label:"EMPTY"})});me.EMPTY.destroy=Od;me.WHITE=new me({source:new Mc({resource:new Uint8Array([255,255,255,255]),width:1,height:1,alphaMode:"premultiply-alpha-on-upload",label:"WHITE"}),label:"WHITE"});me.WHITE.destroy=Od;function pm(r,e,t){const{width:s,height:n}=t.orig,a=t.trim;if(a){const i=a.width,o=a.height;r.minX=a.x-e._x*s,r.maxX=r.minX+i,r.minY=a.y-e._y*n,r.maxY=r.minY+o}else r.minX=-e._x*s,r.maxX=r.minX+s,r.minY=-e._y*n,r.maxY=r.minY+n}const El=new pe;class Wt{constructor(e=1/0,t=1/0,s=-1/0,n=-1/0){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,this.matrix=El,this.minX=e,this.minY=t,this.maxX=s,this.maxY=n}isEmpty(){return this.minX>this.maxX||this.minY>this.maxY}get rectangle(){this._rectangle||(this._rectangle=new Re);const e=this._rectangle;return this.minX>this.maxX||this.minY>this.maxY?(e.x=0,e.y=0,e.width=0,e.height=0):e.copyFromBounds(this),e}clear(){return this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0,this.matrix=El,this}set(e,t,s,n){this.minX=e,this.minY=t,this.maxX=s,this.maxY=n}addFrame(e,t,s,n,a){a||(a=this.matrix);const i=a.a,o=a.b,c=a.c,l=a.d,h=a.tx,d=a.ty;let u=this.minX,f=this.minY,p=this.maxX,g=this.maxY,m=i*e+c*t+h,_=o*e+l*t+d;m<u&&(u=m),_<f&&(f=_),m>p&&(p=m),_>g&&(g=_),m=i*s+c*t+h,_=o*s+l*t+d,m<u&&(u=m),_<f&&(f=_),m>p&&(p=m),_>g&&(g=_),m=i*e+c*n+h,_=o*e+l*n+d,m<u&&(u=m),_<f&&(f=_),m>p&&(p=m),_>g&&(g=_),m=i*s+c*n+h,_=o*s+l*n+d,m<u&&(u=m),_<f&&(f=_),m>p&&(p=m),_>g&&(g=_),this.minX=u,this.minY=f,this.maxX=p,this.maxY=g}addRect(e,t){this.addFrame(e.x,e.y,e.x+e.width,e.y+e.height,t)}addBounds(e,t){this.addFrame(e.minX,e.minY,e.maxX,e.maxY,t)}addBoundsMask(e){this.minX=this.minX>e.minX?this.minX:e.minX,this.minY=this.minY>e.minY?this.minY:e.minY,this.maxX=this.maxX<e.maxX?this.maxX:e.maxX,this.maxY=this.maxY<e.maxY?this.maxY:e.maxY}applyMatrix(e){const t=this.minX,s=this.minY,n=this.maxX,a=this.maxY,{a:i,b:o,c,d:l,tx:h,ty:d}=e;let u=i*t+c*s+h,f=o*t+l*s+d;this.minX=u,this.minY=f,this.maxX=u,this.maxY=f,u=i*n+c*s+h,f=o*n+l*s+d,this.minX=u<this.minX?u:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=u>this.maxX?u:this.maxX,this.maxY=f>this.maxY?f:this.maxY,u=i*t+c*a+h,f=o*t+l*a+d,this.minX=u<this.minX?u:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=u>this.maxX?u:this.maxX,this.maxY=f>this.maxY?f:this.maxY,u=i*n+c*a+h,f=o*n+l*a+d,this.minX=u<this.minX?u:this.minX,this.minY=f<this.minY?f:this.minY,this.maxX=u>this.maxX?u:this.maxX,this.maxY=f>this.maxY?f:this.maxY}fit(e){return this.minX<e.left&&(this.minX=e.left),this.maxX>e.right&&(this.maxX=e.right),this.minY<e.top&&(this.minY=e.top),this.maxY>e.bottom&&(this.maxY=e.bottom),this}fitBounds(e,t,s,n){return this.minX<e&&(this.minX=e),this.maxX>t&&(this.maxX=t),this.minY<s&&(this.minY=s),this.maxY>n&&(this.maxY=n),this}pad(e,t=e){return this.minX-=e,this.maxX+=e,this.minY-=t,this.maxY+=t,this}ceil(){return this.minX=Math.floor(this.minX),this.minY=Math.floor(this.minY),this.maxX=Math.ceil(this.maxX),this.maxY=Math.ceil(this.maxY),this}clone(){return new Wt(this.minX,this.minY,this.maxX,this.maxY)}scale(e,t=e){return this.minX*=e,this.minY*=t,this.maxX*=e,this.maxY*=t,this}get x(){return this.minX}set x(e){const t=this.maxX-this.minX;this.minX=e,this.maxX=e+t}get y(){return this.minY}set y(e){const t=this.maxY-this.minY;this.minY=e,this.maxY=e+t}get width(){return this.maxX-this.minX}set width(e){this.maxX=this.minX+e}get height(){return this.maxY-this.minY}set height(e){this.maxY=this.minY+e}get left(){return this.minX}get right(){return this.maxX}get top(){return this.minY}get bottom(){return this.maxY}get isPositive(){return this.maxX-this.minX>0&&this.maxY-this.minY>0}get isValid(){return this.minX+this.minY!==1/0}addVertexData(e,t,s,n){let a=this.minX,i=this.minY,o=this.maxX,c=this.maxY;n||(n=this.matrix);const l=n.a,h=n.b,d=n.c,u=n.d,f=n.tx,p=n.ty;for(let g=t;g<s;g+=2){const m=e[g],_=e[g+1],b=l*m+d*_+f,x=h*m+u*_+p;a=b<a?b:a,i=x<i?x:i,o=b>o?b:o,c=x>c?x:c}this.minX=a,this.minY=i,this.maxX=o,this.maxY=c}containsPoint(e,t){return this.minX<=e&&this.minY<=t&&this.maxX>=e&&this.maxY>=t}toString(){return`[pixi.js:Bounds minX=${this.minX} minY=${this.minY} maxX=${this.maxX} maxY=${this.maxY} width=${this.width} height=${this.height}]`}copyFrom(e){return this.minX=e.minX,this.minY=e.minY,this.maxX=e.maxX,this.maxY=e.maxY,this}}var mm={grad:.9,turn:360,rad:360/(2*Math.PI)},ur=function(r){return typeof r=="string"?r.length>0:typeof r=="number"},Je=function(r,e,t){return e===void 0&&(e=0),t===void 0&&(t=Math.pow(10,e)),Math.round(t*r)/t+0},$t=function(r,e,t){return e===void 0&&(e=0),t===void 0&&(t=1),r>t?t:r>e?r:e},Nd=function(r){return(r=isFinite(r)?r%360:0)>0?r:r+360},Tl=function(r){return{r:$t(r.r,0,255),g:$t(r.g,0,255),b:$t(r.b,0,255),a:$t(r.a)}},eo=function(r){return{r:Je(r.r),g:Je(r.g),b:Je(r.b),a:Je(r.a,3)}},gm=/^#([0-9a-f]{3,8})$/i,xa=function(r){var e=r.toString(16);return e.length<2?"0"+e:e},Hd=function(r){var e=r.r,t=r.g,s=r.b,n=r.a,a=Math.max(e,t,s),i=a-Math.min(e,t,s),o=i?a===e?(t-s)/i:a===t?2+(s-e)/i:4+(e-t)/i:0;return{h:60*(o<0?o+6:o),s:a?i/a*100:0,v:a/255*100,a:n}},Ud=function(r){var e=r.h,t=r.s,s=r.v,n=r.a;e=e/360*6,t/=100,s/=100;var a=Math.floor(e),i=s*(1-t),o=s*(1-(e-a)*t),c=s*(1-(1-e+a)*t),l=a%6;return{r:255*[s,o,i,i,c,s][l],g:255*[c,s,s,o,i,i][l],b:255*[i,i,c,s,s,o][l],a:n}},Pl=function(r){return{h:Nd(r.h),s:$t(r.s,0,100),l:$t(r.l,0,100),a:$t(r.a)}},Rl=function(r){return{h:Je(r.h),s:Je(r.s),l:Je(r.l),a:Je(r.a,3)}},Ml=function(r){return Ud((t=(e=r).s,{h:e.h,s:(t*=((s=e.l)<50?s:100-s)/100)>0?2*t/(s+t)*100:0,v:s+t,a:e.a}));var e,t,s},Pn=function(r){return{h:(e=Hd(r)).h,s:(n=(200-(t=e.s))*(s=e.v)/100)>0&&n<200?t*s/100/(n<=100?n:200-n)*100:0,l:n/2,a:e.a};var e,t,s,n},ym=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,_m=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,bm=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,xm=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Vo={string:[[function(r){var e=gm.exec(r);return e?(r=e[1]).length<=4?{r:parseInt(r[0]+r[0],16),g:parseInt(r[1]+r[1],16),b:parseInt(r[2]+r[2],16),a:r.length===4?Je(parseInt(r[3]+r[3],16)/255,2):1}:r.length===6||r.length===8?{r:parseInt(r.substr(0,2),16),g:parseInt(r.substr(2,2),16),b:parseInt(r.substr(4,2),16),a:r.length===8?Je(parseInt(r.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(r){var e=bm.exec(r)||xm.exec(r);return e?e[2]!==e[4]||e[4]!==e[6]?null:Tl({r:Number(e[1])/(e[2]?100/255:1),g:Number(e[3])/(e[4]?100/255:1),b:Number(e[5])/(e[6]?100/255:1),a:e[7]===void 0?1:Number(e[7])/(e[8]?100:1)}):null},"rgb"],[function(r){var e=ym.exec(r)||_m.exec(r);if(!e)return null;var t,s,n=Pl({h:(t=e[1],s=e[2],s===void 0&&(s="deg"),Number(t)*(mm[s]||1)),s:Number(e[3]),l:Number(e[4]),a:e[5]===void 0?1:Number(e[5])/(e[6]?100:1)});return Ml(n)},"hsl"]],object:[[function(r){var e=r.r,t=r.g,s=r.b,n=r.a,a=n===void 0?1:n;return ur(e)&&ur(t)&&ur(s)?Tl({r:Number(e),g:Number(t),b:Number(s),a:Number(a)}):null},"rgb"],[function(r){var e=r.h,t=r.s,s=r.l,n=r.a,a=n===void 0?1:n;if(!ur(e)||!ur(t)||!ur(s))return null;var i=Pl({h:Number(e),s:Number(t),l:Number(s),a:Number(a)});return Ml(i)},"hsl"],[function(r){var e=r.h,t=r.s,s=r.v,n=r.a,a=n===void 0?1:n;if(!ur(e)||!ur(t)||!ur(s))return null;var i=function(o){return{h:Nd(o.h),s:$t(o.s,0,100),v:$t(o.v,0,100),a:$t(o.a)}}({h:Number(e),s:Number(t),v:Number(s),a:Number(a)});return Ud(i)},"hsv"]]},$l=function(r,e){for(var t=0;t<e.length;t++){var s=e[t][0](r);if(s)return[s,e[t][1]]}return[null,void 0]},wm=function(r){return typeof r=="string"?$l(r.trim(),Vo.string):typeof r=="object"&&r!==null?$l(r,Vo.object):[null,void 0]},to=function(r,e){var t=Pn(r);return{h:t.h,s:$t(t.s+100*e,0,100),l:t.l,a:t.a}},ro=function(r){return(299*r.r+587*r.g+114*r.b)/1e3/255},Ol=function(r,e){var t=Pn(r);return{h:t.h,s:t.s,l:$t(t.l+100*e,0,100),a:t.a}},Wo=function(){function r(e){this.parsed=wm(e)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return r.prototype.isValid=function(){return this.parsed!==null},r.prototype.brightness=function(){return Je(ro(this.rgba),2)},r.prototype.isDark=function(){return ro(this.rgba)<.5},r.prototype.isLight=function(){return ro(this.rgba)>=.5},r.prototype.toHex=function(){return e=eo(this.rgba),t=e.r,s=e.g,n=e.b,i=(a=e.a)<1?xa(Je(255*a)):"","#"+xa(t)+xa(s)+xa(n)+i;var e,t,s,n,a,i},r.prototype.toRgb=function(){return eo(this.rgba)},r.prototype.toRgbString=function(){return e=eo(this.rgba),t=e.r,s=e.g,n=e.b,(a=e.a)<1?"rgba("+t+", "+s+", "+n+", "+a+")":"rgb("+t+", "+s+", "+n+")";var e,t,s,n,a},r.prototype.toHsl=function(){return Rl(Pn(this.rgba))},r.prototype.toHslString=function(){return e=Rl(Pn(this.rgba)),t=e.h,s=e.s,n=e.l,(a=e.a)<1?"hsla("+t+", "+s+"%, "+n+"%, "+a+")":"hsl("+t+", "+s+"%, "+n+"%)";var e,t,s,n,a},r.prototype.toHsv=function(){return e=Hd(this.rgba),{h:Je(e.h),s:Je(e.s),v:Je(e.v),a:Je(e.a,3)};var e},r.prototype.invert=function(){return tr({r:255-(e=this.rgba).r,g:255-e.g,b:255-e.b,a:e.a});var e},r.prototype.saturate=function(e){return e===void 0&&(e=.1),tr(to(this.rgba,e))},r.prototype.desaturate=function(e){return e===void 0&&(e=.1),tr(to(this.rgba,-e))},r.prototype.grayscale=function(){return tr(to(this.rgba,-1))},r.prototype.lighten=function(e){return e===void 0&&(e=.1),tr(Ol(this.rgba,e))},r.prototype.darken=function(e){return e===void 0&&(e=.1),tr(Ol(this.rgba,-e))},r.prototype.rotate=function(e){return e===void 0&&(e=15),this.hue(this.hue()+e)},r.prototype.alpha=function(e){return typeof e=="number"?tr({r:(t=this.rgba).r,g:t.g,b:t.b,a:e}):Je(this.rgba.a,3);var t},r.prototype.hue=function(e){var t=Pn(this.rgba);return typeof e=="number"?tr({h:e,s:t.s,l:t.l,a:t.a}):Je(t.h)},r.prototype.isEqual=function(e){return this.toHex()===tr(e).toHex()},r}(),tr=function(r){return r instanceof Wo?r:new Wo(r)},Bl=[],vm=function(r){r.forEach(function(e){Bl.indexOf(e)<0&&(e(Wo,Vo),Bl.push(e))})};function Sm(r,e){var t={white:"#ffffff",bisque:"#ffe4c4",blue:"#0000ff",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",antiquewhite:"#faebd7",aqua:"#00ffff",azure:"#f0ffff",whitesmoke:"#f5f5f5",papayawhip:"#ffefd5",plum:"#dda0dd",blanchedalmond:"#ffebcd",black:"#000000",gold:"#ffd700",goldenrod:"#daa520",gainsboro:"#dcdcdc",cornsilk:"#fff8dc",cornflowerblue:"#6495ed",burlywood:"#deb887",aquamarine:"#7fffd4",beige:"#f5f5dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkkhaki:"#bdb76b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",peachpuff:"#ffdab9",darkmagenta:"#8b008b",darkred:"#8b0000",darkorchid:"#9932cc",darkorange:"#ff8c00",darkslateblue:"#483d8b",gray:"#808080",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",deeppink:"#ff1493",deepskyblue:"#00bfff",wheat:"#f5deb3",firebrick:"#b22222",floralwhite:"#fffaf0",ghostwhite:"#f8f8ff",darkviolet:"#9400d3",magenta:"#ff00ff",green:"#008000",dodgerblue:"#1e90ff",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",blueviolet:"#8a2be2",forestgreen:"#228b22",lawngreen:"#7cfc00",indianred:"#cd5c5c",indigo:"#4b0082",fuchsia:"#ff00ff",brown:"#a52a2a",maroon:"#800000",mediumblue:"#0000cd",lightcoral:"#f08080",darkturquoise:"#00ced1",lightcyan:"#e0ffff",ivory:"#fffff0",lightyellow:"#ffffe0",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",linen:"#faf0e6",mediumaquamarine:"#66cdaa",lemonchiffon:"#fffacd",lime:"#00ff00",khaki:"#f0e68c",mediumseagreen:"#3cb371",limegreen:"#32cd32",mediumspringgreen:"#00fa9a",lightskyblue:"#87cefa",lightblue:"#add8e6",midnightblue:"#191970",lightpink:"#ffb6c1",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",mintcream:"#f5fffa",lightslategray:"#778899",lightslategrey:"#778899",navajowhite:"#ffdead",navy:"#000080",mediumvioletred:"#c71585",powderblue:"#b0e0e6",palegoldenrod:"#eee8aa",oldlace:"#fdf5e6",paleturquoise:"#afeeee",mediumturquoise:"#48d1cc",mediumorchid:"#ba55d3",rebeccapurple:"#663399",lightsteelblue:"#b0c4de",mediumslateblue:"#7b68ee",thistle:"#d8bfd8",tan:"#d2b48c",orchid:"#da70d6",mediumpurple:"#9370db",purple:"#800080",pink:"#ffc0cb",skyblue:"#87ceeb",springgreen:"#00ff7f",palegreen:"#98fb98",red:"#ff0000",yellow:"#ffff00",slateblue:"#6a5acd",lavenderblush:"#fff0f5",peru:"#cd853f",palevioletred:"#db7093",violet:"#ee82ee",teal:"#008080",slategray:"#708090",slategrey:"#708090",aliceblue:"#f0f8ff",darkseagreen:"#8fbc8f",darkolivegreen:"#556b2f",greenyellow:"#adff2f",seagreen:"#2e8b57",seashell:"#fff5ee",tomato:"#ff6347",silver:"#c0c0c0",sienna:"#a0522d",lavender:"#e6e6fa",lightgreen:"#90ee90",orange:"#ffa500",orangered:"#ff4500",steelblue:"#4682b4",royalblue:"#4169e1",turquoise:"#40e0d0",yellowgreen:"#9acd32",salmon:"#fa8072",saddlebrown:"#8b4513",sandybrown:"#f4a460",rosybrown:"#bc8f8f",darksalmon:"#e9967a",lightgoldenrodyellow:"#fafad2",snow:"#fffafa",lightgrey:"#d3d3d3",lightgray:"#d3d3d3",dimgray:"#696969",dimgrey:"#696969",olivedrab:"#6b8e23",olive:"#808000"},s={};for(var n in t)s[t[n]]=n;var a={};r.prototype.toName=function(i){if(!(this.rgba.a||this.rgba.r||this.rgba.g||this.rgba.b))return"transparent";var o,c,l=s[this.toHex()];if(l)return l;if(i!=null&&i.closest){var h=this.toRgb(),d=1/0,u="black";if(!a.length)for(var f in t)a[f]=new r(t[f]).toRgb();for(var p in t){var g=(o=h,c=a[p],Math.pow(o.r-c.r,2)+Math.pow(o.g-c.g,2)+Math.pow(o.b-c.b,2));g<d&&(d=g,u=p)}return u}},e.string.push([function(i){var o=i.toLowerCase(),c=o==="transparent"?"#0000":t[o];return c?new r(c).toRgb():null},"name"])}vm([Sm]);const Us=class kn{constructor(e=16777215){this._value=null,this._components=new Float32Array(4),this._components.fill(1),this._int=16777215,this.value=e}get red(){return this._components[0]}get green(){return this._components[1]}get blue(){return this._components[2]}get alpha(){return this._components[3]}setValue(e){return this.value=e,this}set value(e){if(e instanceof kn)this._value=this._cloneSource(e._value),this._int=e._int,this._components.set(e._components);else{if(e===null)throw new Error("Cannot set Color#value to null");(this._value===null||!this._isSourceEqual(this._value,e))&&(this._value=this._cloneSource(e),this._normalize(this._value))}}get value(){return this._value}_cloneSource(e){return typeof e=="string"||typeof e=="number"||e instanceof Number||e===null?e:Array.isArray(e)||ArrayBuffer.isView(e)?e.slice(0):typeof e=="object"&&e!==null?{...e}:e}_isSourceEqual(e,t){const s=typeof e;if(s!==typeof t)return!1;if(s==="number"||s==="string"||e instanceof Number)return e===t;if(Array.isArray(e)&&Array.isArray(t)||ArrayBuffer.isView(e)&&ArrayBuffer.isView(t))return e.length!==t.length?!1:e.every((a,i)=>a===t[i]);if(e!==null&&t!==null){const a=Object.keys(e),i=Object.keys(t);return a.length!==i.length?!1:a.every(o=>e[o]===t[o])}return e===t}toRgba(){const[e,t,s,n]=this._components;return{r:e,g:t,b:s,a:n}}toRgb(){const[e,t,s]=this._components;return{r:e,g:t,b:s}}toRgbaString(){const[e,t,s]=this.toUint8RgbArray();return`rgba(${e},${t},${s},${this.alpha})`}toUint8RgbArray(e){const[t,s,n]=this._components;return this._arrayRgb||(this._arrayRgb=[]),e||(e=this._arrayRgb),e[0]=Math.round(t*255),e[1]=Math.round(s*255),e[2]=Math.round(n*255),e}toArray(e){this._arrayRgba||(this._arrayRgba=[]),e||(e=this._arrayRgba);const[t,s,n,a]=this._components;return e[0]=t,e[1]=s,e[2]=n,e[3]=a,e}toRgbArray(e){this._arrayRgb||(this._arrayRgb=[]),e||(e=this._arrayRgb);const[t,s,n]=this._components;return e[0]=t,e[1]=s,e[2]=n,e}toNumber(){return this._int}toBgrNumber(){const[e,t,s]=this.toUint8RgbArray();return(s<<16)+(t<<8)+e}toLittleEndianNumber(){const e=this._int;return(e>>16)+(e&65280)+((e&255)<<16)}multiply(e){const[t,s,n,a]=kn._temp.setValue(e)._components;return this._components[0]*=t,this._components[1]*=s,this._components[2]*=n,this._components[3]*=a,this._refreshInt(),this._value=null,this}premultiply(e,t=!0){return t&&(this._components[0]*=e,this._components[1]*=e,this._components[2]*=e),this._components[3]=e,this._refreshInt(),this._value=null,this}toPremultiplied(e,t=!0){if(e===1)return(255<<24)+this._int;if(e===0)return t?0:this._int;let s=this._int>>16&255,n=this._int>>8&255,a=this._int&255;return t&&(s=s*e+.5|0,n=n*e+.5|0,a=a*e+.5|0),(e*255<<24)+(s<<16)+(n<<8)+a}toHex(){const e=this._int.toString(16);return`#${"000000".substring(0,6-e.length)+e}`}toHexa(){const t=Math.round(this._components[3]*255).toString(16);return this.toHex()+"00".substring(0,2-t.length)+t}setAlpha(e){return this._components[3]=this._clamp(e),this}_normalize(e){let t,s,n,a;if((typeof e=="number"||e instanceof Number)&&e>=0&&e<=16777215){const i=e;t=(i>>16&255)/255,s=(i>>8&255)/255,n=(i&255)/255,a=1}else if((Array.isArray(e)||e instanceof Float32Array)&&e.length>=3&&e.length<=4)e=this._clamp(e),[t,s,n,a=1]=e;else if((e instanceof Uint8Array||e instanceof Uint8ClampedArray)&&e.length>=3&&e.length<=4)e=this._clamp(e,0,255),[t,s,n,a=255]=e,t/=255,s/=255,n/=255,a/=255;else if(typeof e=="string"||typeof e=="object"){if(typeof e=="string"){const o=kn.HEX_PATTERN.exec(e);o&&(e=`#${o[2]}`)}const i=tr(e);i.isValid()&&({r:t,g:s,b:n,a}=i.rgba,t/=255,s/=255,n/=255)}if(t!==void 0)this._components[0]=t,this._components[1]=s,this._components[2]=n,this._components[3]=a,this._refreshInt();else throw new Error(`Unable to convert color ${e}`)}_refreshInt(){this._clamp(this._components);const[e,t,s]=this._components;this._int=(e*255<<16)+(t*255<<8)+(s*255|0)}_clamp(e,t=0,s=1){return typeof e=="number"?Math.min(Math.max(e,t),s):(e.forEach((n,a)=>{e[a]=Math.min(Math.max(n,t),s)}),e)}static isColorLike(e){return typeof e=="number"||typeof e=="string"||e instanceof Number||e instanceof kn||Array.isArray(e)||e instanceof Uint8Array||e instanceof Uint8ClampedArray||e instanceof Float32Array||e.r!==void 0&&e.g!==void 0&&e.b!==void 0||e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0||e.h!==void 0&&e.s!==void 0&&e.l!==void 0||e.h!==void 0&&e.s!==void 0&&e.l!==void 0&&e.a!==void 0||e.h!==void 0&&e.s!==void 0&&e.v!==void 0||e.h!==void 0&&e.s!==void 0&&e.v!==void 0&&e.a!==void 0}};Us.shared=new Us;Us._temp=new Us;Us.HEX_PATTERN=/^(#|0x)?(([a-f0-9]{3}){1,2}([a-f0-9]{2})?)$/i;let qe=Us;const km={cullArea:null,cullable:!1,cullableChildren:!0};let so=0;const Dl=500;function Ae(...r){so!==Dl&&(so++,so===Dl?console.warn("PixiJS Warning: too many warnings, no more warnings will be reported to the console by PixiJS."):console.warn("PixiJS Warning: ",...r))}const Kn={_registeredResources:new Set,register(r){this._registeredResources.add(r)},unregister(r){this._registeredResources.delete(r)},release(){this._registeredResources.forEach(r=>r.clear())},get registeredCount(){return this._registeredResources.size},isRegistered(r){return this._registeredResources.has(r)},reset(){this._registeredResources.clear()}};class Im{constructor(e,t){this._pool=[],this._count=0,this._index=0,this._classType=e,t&&this.prepopulate(t)}prepopulate(e){for(let t=0;t<e;t++)this._pool[this._index++]=new this._classType;this._count+=e}get(e){var s;let t;return this._index>0?t=this._pool[--this._index]:t=new this._classType,(s=t.init)==null||s.call(t,e),t}return(e){var t;(t=e.reset)==null||t.call(e),this._pool[this._index++]=e}get totalSize(){return this._count}get totalFree(){return this._index}get totalUsed(){return this._count-this._index}clear(){if(this._pool.length>0&&this._pool[0].destroy)for(let e=0;e<this._index;e++)this._pool[e].destroy();this._pool.length=0,this._count=0,this._index=0}}class Am{constructor(){this._poolsByClass=new Map}prepopulate(e,t){this.getPool(e).prepopulate(t)}get(e,t){return this.getPool(e).get(t)}return(e){this.getPool(e.constructor).return(e)}getPool(e){return this._poolsByClass.has(e)||this._poolsByClass.set(e,new Im(e)),this._poolsByClass.get(e)}stats(){const e={};return this._poolsByClass.forEach(t=>{const s=e[t._classType.name]?t._classType.name+t._classType.ID:t._classType.name;e[s]={free:t.totalFree,used:t.totalUsed,size:t.totalSize}}),e}clear(){this._poolsByClass.forEach(e=>e.clear()),this._poolsByClass.clear()}}const Ot=new Am;Kn.register(Ot);const Cm={get isCachedAsTexture(){var r;return!!((r=this.renderGroup)!=null&&r.isCachedAsTexture)},cacheAsTexture(r){typeof r=="boolean"&&r===!1?this.disableRenderGroup():(this.enableRenderGroup(),this.renderGroup.enableCacheAsTexture(r===!0?{}:r))},updateCacheTexture(){var r;(r=this.renderGroup)==null||r.updateCacheTexture()},get cacheAsBitmap(){return this.isCachedAsTexture},set cacheAsBitmap(r){he("v8.6.0","cacheAsBitmap is deprecated, use cacheAsTexture instead."),this.cacheAsTexture(r)}};function Em(r,e,t){const s=r.length;let n;if(e>=s||t===0)return;t=e+t>s?s-e:t;const a=s-t;for(n=e;n<a;++n)r[n]=r[n+t];r.length=a}const Tm={allowChildren:!0,removeChildren(r=0,e){var a;const t=e??this.children.length,s=t-r,n=[];if(s>0&&s<=t){for(let o=t-1;o>=r;o--){const c=this.children[o];c&&(n.push(c),c.parent=null)}Em(this.children,r,t);const i=this.renderGroup||this.parentRenderGroup;i&&i.removeChildren(n);for(let o=0;o<n.length;++o){const c=n[o];(a=c.parentRenderLayer)==null||a.detach(c),this.emit("childRemoved",c,this,o),n[o].emit("removed",this)}return n.length>0&&this._didViewChangeTick++,n}else if(s===0&&this.children.length===0)return n;throw new RangeError("removeChildren: numeric values are outside the acceptable range.")},removeChildAt(r){const e=this.getChildAt(r);return this.removeChild(e)},getChildAt(r){if(r<0||r>=this.children.length)throw new Error(`getChildAt: Index (${r}) does not exist.`);return this.children[r]},setChildIndex(r,e){if(e<0||e>=this.children.length)throw new Error(`The index ${e} supplied is out of bounds ${this.children.length}`);this.getChildIndex(r),this.addChildAt(r,e)},getChildIndex(r){const e=this.children.indexOf(r);if(e===-1)throw new Error("The supplied Container must be a child of the caller");return e},addChildAt(r,e){this.allowChildren||he(_e,"addChildAt: Only Containers will be allowed to add children in v8.0.0");const{children:t}=this;if(e<0||e>t.length)throw new Error(`${r}addChildAt: The index ${e} supplied is out of bounds ${t.length}`);if(r.parent){const n=r.parent.children.indexOf(r);if(r.parent===this&&n===e)return r;n!==-1&&r.parent.children.splice(n,1)}e===t.length?t.push(r):t.splice(e,0,r),r.parent=this,r.didChange=!0,r._updateFlags=15;const s=this.renderGroup||this.parentRenderGroup;return s&&s.addChild(r),this.sortableChildren&&(this.sortDirty=!0),this.emit("childAdded",r,this,e),r.emit("added",this),r},swapChildren(r,e){if(r===e)return;const t=this.getChildIndex(r),s=this.getChildIndex(e);this.children[t]=e,this.children[s]=r;const n=this.renderGroup||this.parentRenderGroup;n&&(n.structureDidChange=!0),this._didContainerChangeTick++},removeFromParent(){var r;(r=this.parent)==null||r.removeChild(this)},reparentChild(...r){return r.length===1?this.reparentChildAt(r[0],this.children.length):(r.forEach(e=>this.reparentChildAt(e,this.children.length)),r[0])},reparentChildAt(r,e){if(r.parent===this)return this.setChildIndex(r,e),r;const t=r.worldTransform.clone();r.removeFromParent(),this.addChildAt(r,e);const s=this.worldTransform.clone();return s.invert(),t.prepend(s),r.setFromMatrix(t),r},replaceChild(r,e){r.updateLocalTransform(),this.addChildAt(e,this.getChildIndex(r)),e.setFromMatrix(r.localTransform),e.updateLocalTransform(),this.removeChild(r)}},Pm={collectRenderables(r,e,t){this.parentRenderLayer&&this.parentRenderLayer!==t||this.globalDisplayStatus<7||!this.includeInBuild||(this.sortableChildren&&this.sortChildren(),this.isSimple?this.collectRenderablesSimple(r,e,t):this.renderGroup?e.renderPipes.renderGroup.addRenderGroup(this.renderGroup,r):this.collectRenderablesWithEffects(r,e,t))},collectRenderablesSimple(r,e,t){const s=this.children,n=s.length;for(let a=0;a<n;a++)s[a].collectRenderables(r,e,t)},collectRenderablesWithEffects(r,e,t){const{renderPipes:s}=e;for(let n=0;n<this.effects.length;n++){const a=this.effects[n];s[a.pipe].push(a,this,r)}this.collectRenderablesSimple(r,e,t);for(let n=this.effects.length-1;n>=0;n--){const a=this.effects[n];s[a.pipe].pop(a,this,r)}}};class Ll{constructor(){this.pipe="filter",this.priority=1}destroy(){for(let e=0;e<this.filters.length;e++)this.filters[e].destroy();this.filters=null,this.filterArea=null}}class Rm{constructor(){this._effectClasses=[],this._tests=[],this._initialized=!1}init(){this._initialized||(this._initialized=!0,this._effectClasses.forEach(e=>{this.add({test:e.test,maskClass:e})}))}add(e){this._tests.push(e)}getMaskEffect(e){this._initialized||this.init();for(let t=0;t<this._tests.length;t++){const s=this._tests[t];if(s.test(e))return Ot.get(s.maskClass,e)}return e}returnMaskEffect(e){Ot.return(e)}}const qo=new Rm;at.handleByList(J.MaskEffect,qo._effectClasses);const Mm={_maskEffect:null,_maskOptions:{inverse:!1},_filterEffect:null,effects:[],_markStructureAsChanged(){const r=this.renderGroup||this.parentRenderGroup;r&&(r.structureDidChange=!0)},addEffect(r){this.effects.indexOf(r)===-1&&(this.effects.push(r),this.effects.sort((t,s)=>t.priority-s.priority),this._markStructureAsChanged(),this._updateIsSimple())},removeEffect(r){const e=this.effects.indexOf(r);e!==-1&&(this.effects.splice(e,1),this._markStructureAsChanged(),this._updateIsSimple())},set mask(r){const e=this._maskEffect;(e==null?void 0:e.mask)!==r&&(e&&(this.removeEffect(e),qo.returnMaskEffect(e),this._maskEffect=null),r!=null&&(this._maskEffect=qo.getMaskEffect(r),this.addEffect(this._maskEffect)))},get mask(){var r;return(r=this._maskEffect)==null?void 0:r.mask},setMask(r){this._maskOptions={...this._maskOptions,...r},r.mask&&(this.mask=r.mask),this._markStructureAsChanged()},set filters(r){var a;!Array.isArray(r)&&r&&(r=[r]);const e=this._filterEffect||(this._filterEffect=new Ll);r=r;const t=(r==null?void 0:r.length)>0,s=((a=e.filters)==null?void 0:a.length)>0,n=t!==s;r=Array.isArray(r)?r.slice(0):r,e.filters=Object.freeze(r),n&&(t?this.addEffect(e):(this.removeEffect(e),e.filters=r??null))},get filters(){var r;return(r=this._filterEffect)==null?void 0:r.filters},set filterArea(r){this._filterEffect||(this._filterEffect=new Ll),this._filterEffect.filterArea=r},get filterArea(){var r;return(r=this._filterEffect)==null?void 0:r.filterArea}},$m={label:null,get name(){return he(_e,"Container.name property has been removed, use Container.label instead"),this.label},set name(r){he(_e,"Container.name property has been removed, use Container.label instead"),this.label=r},getChildByName(r,e=!1){return this.getChildByLabel(r,e)},getChildByLabel(r,e=!1){const t=this.children;for(let s=0;s<t.length;s++){const n=t[s];if(n.label===r||r instanceof RegExp&&r.test(n.label))return n}if(e)for(let s=0;s<t.length;s++){const a=t[s].getChildByLabel(r,!0);if(a)return a}return null},getChildrenByLabel(r,e=!1,t=[]){const s=this.children;for(let n=0;n<s.length;n++){const a=s[n];(a.label===r||r instanceof RegExp&&r.test(a.label))&&t.push(a)}if(e)for(let n=0;n<s.length;n++)s[n].getChildrenByLabel(r,!0,t);return t}},yt=Ot.getPool(pe),yr=Ot.getPool(Wt),Om=new pe,Bm={getFastGlobalBounds(r,e){e||(e=new Wt),e.clear(),this._getGlobalBoundsRecursive(!!r,e,this.parentRenderLayer),e.isValid||e.set(0,0,0,0);const t=this.renderGroup||this.parentRenderGroup;return e.applyMatrix(t.worldTransform),e},_getGlobalBoundsRecursive(r,e,t){let s=e;if(r&&this.parentRenderLayer&&this.parentRenderLayer!==t||this.localDisplayStatus!==7||!this.measurable)return;const n=!!this.effects.length;if((this.renderGroup||n)&&(s=yr.get().clear()),this.boundsArea)e.addRect(this.boundsArea,this.worldTransform);else{if(this.renderPipeId){const i=this.bounds;s.addFrame(i.minX,i.minY,i.maxX,i.maxY,this.groupTransform)}const a=this.children;for(let i=0;i<a.length;i++)a[i]._getGlobalBoundsRecursive(r,s,t)}if(n){let a=!1;const i=this.renderGroup||this.parentRenderGroup;for(let o=0;o<this.effects.length;o++)this.effects[o].addBounds&&(a||(a=!0,s.applyMatrix(i.worldTransform)),this.effects[o].addBounds(s,!0));a&&s.applyMatrix(i.worldTransform.copyTo(Om).invert()),e.addBounds(s),yr.return(s)}else this.renderGroup&&(e.addBounds(s,this.relativeGroupTransform),yr.return(s))}};function Gd(r,e,t){t.clear();let s,n;return r.parent?e?s=r.parent.worldTransform:(n=yt.get().identity(),s=$c(r,n)):s=pe.IDENTITY,zd(r,t,s,e),n&&yt.return(n),t.isValid||t.set(0,0,0,0),t}function zd(r,e,t,s){var o,c;if(!r.visible||!r.measurable)return;let n;s?n=r.worldTransform:(r.updateLocalTransform(),n=yt.get(),n.appendFrom(r.localTransform,t));const a=e,i=!!r.effects.length;if(i&&(e=yr.get().clear()),r.boundsArea)e.addRect(r.boundsArea,n);else{const l=r.bounds;l&&!l.isEmpty()&&(e.matrix=n,e.addBounds(l));for(let h=0;h<r.children.length;h++)zd(r.children[h],e,n,s)}if(i){for(let l=0;l<r.effects.length;l++)(c=(o=r.effects[l]).addBounds)==null||c.call(o,e);a.addBounds(e,pe.IDENTITY),yr.return(e)}s||yt.return(n)}function $c(r,e){const t=r.parent;return t&&($c(t,e),t.updateLocalTransform(),e.append(t.localTransform)),e}function Vd(r,e){if(r===16777215||!e)return e;if(e===16777215||!r)return r;const t=r>>16&255,s=r>>8&255,n=r&255,a=e>>16&255,i=e>>8&255,o=e&255,c=t*a/255|0,l=s*i/255|0,h=n*o/255|0;return(c<<16)+(l<<8)+h}const Fl=16777215;function jl(r,e){return r===Fl?e:e===Fl?r:Vd(r,e)}function ni(r){return((r&255)<<16)+(r&65280)+(r>>16&255)}const Dm={getGlobalAlpha(r){if(r)return this.renderGroup?this.renderGroup.worldAlpha:this.parentRenderGroup?this.parentRenderGroup.worldAlpha*this.alpha:this.alpha;let e=this.alpha,t=this.parent;for(;t;)e*=t.alpha,t=t.parent;return e},getGlobalTransform(r=new pe,e){if(e)return r.copyFrom(this.worldTransform);this.updateLocalTransform();const t=$c(this,yt.get().identity());return r.appendFrom(this.localTransform,t),yt.return(t),r},getGlobalTint(r){if(r)return this.renderGroup?ni(this.renderGroup.worldColor):this.parentRenderGroup?ni(jl(this.localColor,this.parentRenderGroup.worldColor)):this.tint;let e=this.localColor,t=this.parent;for(;t;)e=jl(e,t.localColor),t=t.parent;return ni(e)}};function Wd(r,e,t){return e.clear(),t||(t=pe.IDENTITY),qd(r,e,t,r,!0),e.isValid||e.set(0,0,0,0),e}function qd(r,e,t,s,n){var c,l;let a;if(n)a=yt.get(),a=t.copyTo(a);else{if(!r.visible||!r.measurable)return;r.updateLocalTransform();const h=r.localTransform;a=yt.get(),a.appendFrom(h,t)}const i=e,o=!!r.effects.length;if(o&&(e=yr.get().clear()),r.boundsArea)e.addRect(r.boundsArea,a);else{r.renderPipeId&&(e.matrix=a,e.addBounds(r.bounds));const h=r.children;for(let d=0;d<h.length;d++)qd(h[d],e,a,s,!1)}if(o){for(let h=0;h<r.effects.length;h++)(l=(c=r.effects[h]).addLocalBounds)==null||l.call(c,e,s);i.addBounds(e,pe.IDENTITY),yr.return(e)}yt.return(a)}function Xd(r,e){const t=r.children;for(let s=0;s<t.length;s++){const n=t[s],a=n.uid,i=(n._didViewChangeTick&65535)<<16|n._didContainerChangeTick&65535,o=e.index;(e.data[o]!==a||e.data[o+1]!==i)&&(e.data[e.index]=a,e.data[e.index+1]=i,e.didChange=!0),e.index=o+2,n.children.length&&Xd(n,e)}return e.didChange}const Lm=new pe,Fm={_localBoundsCacheId:-1,_localBoundsCacheData:null,_setWidth(r,e){const t=Math.sign(this.scale.x)||1;e!==0?this.scale.x=r/e*t:this.scale.x=t},_setHeight(r,e){const t=Math.sign(this.scale.y)||1;e!==0?this.scale.y=r/e*t:this.scale.y=t},getLocalBounds(){this._localBoundsCacheData||(this._localBoundsCacheData={data:[],index:1,didChange:!1,localBounds:new Wt});const r=this._localBoundsCacheData;return r.index=1,r.didChange=!1,r.data[0]!==this._didViewChangeTick&&(r.didChange=!0,r.data[0]=this._didViewChangeTick),Xd(this,r),r.didChange&&Wd(this,r.localBounds,Lm),r.localBounds},getBounds(r,e){return Gd(this,r,e||new Wt)}},jm={_onRender:null,set onRender(r){const e=this.renderGroup||this.parentRenderGroup;if(!r){this._onRender&&(e==null||e.removeOnRender(this)),this._onRender=null;return}this._onRender||e==null||e.addOnRender(this),this._onRender=r},get onRender(){return this._onRender}},Nm={_zIndex:0,sortDirty:!1,sortableChildren:!1,get zIndex(){return this._zIndex},set zIndex(r){this._zIndex!==r&&(this._zIndex=r,this.depthOfChildModified())},depthOfChildModified(){this.parent&&(this.parent.sortableChildren=!0,this.parent.sortDirty=!0),this.parentRenderGroup&&(this.parentRenderGroup.structureDidChange=!0)},sortChildren(){this.sortDirty&&(this.sortDirty=!1,this.children.sort(Hm))}};function Hm(r,e){return r._zIndex-e._zIndex}const Um={getGlobalPosition(r=new ft,e=!1){return this.parent?this.parent.toGlobal(this._position,r,e):(r.x=this._position.x,r.y=this._position.y),r},toGlobal(r,e,t=!1){const s=this.getGlobalTransform(yt.get(),t);return e=s.apply(r,e),yt.return(s),e},toLocal(r,e,t,s){e&&(r=e.toGlobal(r,t,s));const n=this.getGlobalTransform(yt.get(),s);return t=n.applyInverse(r,t),yt.return(n),t}};class Yd{constructor(){this.uid=je("instructionSet"),this.instructions=[],this.instructionSize=0,this.renderables=[],this.gcTick=0}reset(){this.instructionSize=0}destroy(){this.instructions.length=0,this.renderables.length=0,this.renderPipes=null,this.gcTick=0}add(e){this.instructions[this.instructionSize++]=e}log(){this.instructions.length=this.instructionSize,console.table(this.instructions,["type","action"])}}let Gm=0;class zm{constructor(e){this._poolKeyHash=Object.create(null),this._texturePool={},this.textureOptions=e||{},this.enableFullScreen=!1,this.textureStyle=new Hs(this.textureOptions)}createTexture(e,t,s){const n=new Xt({...this.textureOptions,width:e,height:t,resolution:1,antialias:s,autoGarbageCollect:!1});return new me({source:n,label:`texturePool_${Gm++}`})}getOptimalTexture(e,t,s=1,n){let a=Math.ceil(e*s-1e-6),i=Math.ceil(t*s-1e-6);a=Ns(a),i=Ns(i);const o=(a<<17)+(i<<1)+(n?1:0);this._texturePool[o]||(this._texturePool[o]=[]);let c=this._texturePool[o].pop();return c||(c=this.createTexture(a,i,n)),c.source._resolution=s,c.source.width=a/s,c.source.height=i/s,c.source.pixelWidth=a,c.source.pixelHeight=i,c.frame.x=0,c.frame.y=0,c.frame.width=e,c.frame.height=t,c.updateUvs(),this._poolKeyHash[c.uid]=o,c}getSameSizeTexture(e,t=!1){const s=e.source;return this.getOptimalTexture(e.width,e.height,s._resolution,t)}returnTexture(e,t=!1){const s=this._poolKeyHash[e.uid];t&&(e.source.style=this.textureStyle),this._texturePool[s].push(e)}clear(e){if(e=e!==!1,e)for(const t in this._texturePool){const s=this._texturePool[t];if(s)for(let n=0;n<s.length;n++)s[n].destroy(!0)}this._texturePool={}}}const Kd=new zm;Kn.register(Kd);class Vm{constructor(){this.renderPipeId="renderGroup",this.root=null,this.canBundle=!1,this.renderGroupParent=null,this.renderGroupChildren=[],this.worldTransform=new pe,this.worldColorAlpha=4294967295,this.worldColor=16777215,this.worldAlpha=1,this.childrenToUpdate=Object.create(null),this.updateTick=0,this.gcTick=0,this.childrenRenderablesToUpdate={list:[],index:0},this.structureDidChange=!0,this.instructionSet=new Yd,this._onRenderContainers=[],this.textureNeedsUpdate=!0,this.isCachedAsTexture=!1,this._matrixDirty=7}init(e){this.root=e,e._onRender&&this.addOnRender(e),e.didChange=!0;const t=e.children;for(let s=0;s<t.length;s++){const n=t[s];n._updateFlags=15,this.addChild(n)}}enableCacheAsTexture(e={}){this.textureOptions=e,this.isCachedAsTexture=!0,this.textureNeedsUpdate=!0}disableCacheAsTexture(){this.isCachedAsTexture=!1,this.texture&&(Kd.returnTexture(this.texture,!0),this.texture=null)}updateCacheTexture(){this.textureNeedsUpdate=!0;const e=this._parentCacheAsTextureRenderGroup;e&&!e.textureNeedsUpdate&&e.updateCacheTexture()}reset(){this.renderGroupChildren.length=0;for(const e in this.childrenToUpdate){const t=this.childrenToUpdate[e];t.list.fill(null),t.index=0}this.childrenRenderablesToUpdate.index=0,this.childrenRenderablesToUpdate.list.fill(null),this.root=null,this.updateTick=0,this.structureDidChange=!0,this._onRenderContainers.length=0,this.renderGroupParent=null,this.disableCacheAsTexture()}get localTransform(){return this.root.localTransform}addRenderGroupChild(e){e.renderGroupParent&&e.renderGroupParent._removeRenderGroupChild(e),e.renderGroupParent=this,this.renderGroupChildren.push(e)}_removeRenderGroupChild(e){const t=this.renderGroupChildren.indexOf(e);t>-1&&this.renderGroupChildren.splice(t,1),e.renderGroupParent=null}addChild(e){if(this.structureDidChange=!0,e.parentRenderGroup=this,e.updateTick=-1,e.parent===this.root?e.relativeRenderGroupDepth=1:e.relativeRenderGroupDepth=e.parent.relativeRenderGroupDepth+1,e.didChange=!0,this.onChildUpdate(e),e.renderGroup){this.addRenderGroupChild(e.renderGroup);return}e._onRender&&this.addOnRender(e);const t=e.children;for(let s=0;s<t.length;s++)this.addChild(t[s])}removeChild(e){if(this.structureDidChange=!0,e._onRender&&(e.renderGroup||this.removeOnRender(e)),e.parentRenderGroup=null,e.renderGroup){this._removeRenderGroupChild(e.renderGroup);return}const t=e.children;for(let s=0;s<t.length;s++)this.removeChild(t[s])}removeChildren(e){for(let t=0;t<e.length;t++)this.removeChild(e[t])}onChildUpdate(e){let t=this.childrenToUpdate[e.relativeRenderGroupDepth];t||(t=this.childrenToUpdate[e.relativeRenderGroupDepth]={index:0,list:[]}),t.list[t.index++]=e}updateRenderable(e){e.globalDisplayStatus<7||(this.instructionSet.renderPipes[e.renderPipeId].updateRenderable(e),e.didViewUpdate=!1)}onChildViewUpdate(e){this.childrenRenderablesToUpdate.list[this.childrenRenderablesToUpdate.index++]=e}get isRenderable(){return this.root.localDisplayStatus===7&&this.worldAlpha>0}addOnRender(e){this._onRenderContainers.push(e)}removeOnRender(e){this._onRenderContainers.splice(this._onRenderContainers.indexOf(e),1)}runOnRender(e){for(let t=0;t<this._onRenderContainers.length;t++)this._onRenderContainers[t]._onRender(e)}destroy(){this.disableCacheAsTexture(),this.renderGroupParent=null,this.root=null,this.childrenRenderablesToUpdate=null,this.childrenToUpdate=null,this.renderGroupChildren=null,this._onRenderContainers=null,this.instructionSet=null}getChildren(e=[]){const t=this.root.children;for(let s=0;s<t.length;s++)this._getChildren(t[s],e);return e}_getChildren(e,t=[]){if(t.push(e),e.renderGroup)return t;const s=e.children;for(let n=0;n<s.length;n++)this._getChildren(s[n],t);return t}invalidateMatrices(){this._matrixDirty=7}get inverseWorldTransform(){return this._matrixDirty&1?(this._matrixDirty&=-2,this._inverseWorldTransform||(this._inverseWorldTransform=new pe),this._inverseWorldTransform.copyFrom(this.worldTransform).invert()):this._inverseWorldTransform}get textureOffsetInverseTransform(){return this._matrixDirty&2?(this._matrixDirty&=-3,this._textureOffsetInverseTransform||(this._textureOffsetInverseTransform=new pe),this._textureOffsetInverseTransform.copyFrom(this.inverseWorldTransform).translate(-this._textureBounds.x,-this._textureBounds.y)):this._textureOffsetInverseTransform}get inverseParentTextureTransform(){if(!(this._matrixDirty&4))return this._inverseParentTextureTransform;this._matrixDirty&=-5;const e=this._parentCacheAsTextureRenderGroup;return e?(this._inverseParentTextureTransform||(this._inverseParentTextureTransform=new pe),this._inverseParentTextureTransform.copyFrom(this.worldTransform).prepend(e.inverseWorldTransform).translate(-e._textureBounds.x,-e._textureBounds.y)):this.worldTransform}get cacheToLocalTransform(){return this.isCachedAsTexture?this.textureOffsetInverseTransform:this._parentCacheAsTextureRenderGroup?this._parentCacheAsTextureRenderGroup.textureOffsetInverseTransform:null}}function Wm(r,e,t={}){for(const s in e)!t[s]&&e[s]!==void 0&&(r[s]=e[s])}const no=new nt(null),wa=new nt(null),ao=new nt(null,1,1),va=new nt(null),Nl=1,qm=2,io=4;class ve extends qt{constructor(e={}){var t,s;super(),this.uid=je("renderable"),this._updateFlags=15,this.renderGroup=null,this.parentRenderGroup=null,this.parentRenderGroupIndex=0,this.didChange=!1,this.didViewUpdate=!1,this.relativeRenderGroupDepth=0,this.children=[],this.parent=null,this.includeInBuild=!0,this.measurable=!0,this.isSimple=!0,this.parentRenderLayer=null,this.updateTick=-1,this.localTransform=new pe,this.relativeGroupTransform=new pe,this.groupTransform=this.relativeGroupTransform,this.destroyed=!1,this._position=new nt(this,0,0),this._scale=ao,this._pivot=wa,this._origin=va,this._skew=no,this._cx=1,this._sx=0,this._cy=0,this._sy=1,this._rotation=0,this.localColor=16777215,this.localAlpha=1,this.groupAlpha=1,this.groupColor=16777215,this.groupColorAlpha=4294967295,this.localBlendMode="inherit",this.groupBlendMode="normal",this.localDisplayStatus=7,this.globalDisplayStatus=7,this._didContainerChangeTick=0,this._didViewChangeTick=0,this._didLocalTransformChangeId=-1,this.effects=[],Wm(this,e,{children:!0,parent:!0,effects:!0}),(t=e.children)==null||t.forEach(n=>this.addChild(n)),(s=e.parent)==null||s.addChild(this)}static mixin(e){he("8.8.0","Container.mixin is deprecated, please use extensions.mixin instead."),at.mixin(ve,e)}set _didChangeId(e){this._didViewChangeTick=e>>12&4095,this._didContainerChangeTick=e&4095}get _didChangeId(){return this._didContainerChangeTick&4095|(this._didViewChangeTick&4095)<<12}addChild(...e){if(this.allowChildren||he(_e,"addChild: Only Containers will be allowed to add children in v8.0.0"),e.length>1){for(let n=0;n<e.length;n++)this.addChild(e[n]);return e[0]}const t=e[0],s=this.renderGroup||this.parentRenderGroup;return t.parent===this?(this.children.splice(this.children.indexOf(t),1),this.children.push(t),s&&(s.structureDidChange=!0),t):(t.parent&&t.parent.removeChild(t),this.children.push(t),this.sortableChildren&&(this.sortDirty=!0),t.parent=this,t.didChange=!0,t._updateFlags=15,s&&s.addChild(t),this.emit("childAdded",t,this,this.children.length-1),t.emit("added",this),this._didViewChangeTick++,t._zIndex!==0&&t.depthOfChildModified(),t)}removeChild(...e){if(e.length>1){for(let n=0;n<e.length;n++)this.removeChild(e[n]);return e[0]}const t=e[0],s=this.children.indexOf(t);return s>-1&&(this._didViewChangeTick++,this.children.splice(s,1),this.renderGroup?this.renderGroup.removeChild(t):this.parentRenderGroup&&this.parentRenderGroup.removeChild(t),t.parentRenderLayer&&t.parentRenderLayer.detach(t),t.parent=null,this.emit("childRemoved",t,this,s),t.emit("removed",this)),t}_onUpdate(e){e&&e===this._skew&&this._updateSkew(),this._didContainerChangeTick++,!this.didChange&&(this.didChange=!0,this.parentRenderGroup&&this.parentRenderGroup.onChildUpdate(this))}set isRenderGroup(e){!!this.renderGroup!==e&&(e?this.enableRenderGroup():this.disableRenderGroup())}get isRenderGroup(){return!!this.renderGroup}enableRenderGroup(){if(this.renderGroup)return;const e=this.parentRenderGroup;e==null||e.removeChild(this),this.renderGroup=Ot.get(Vm,this),this.groupTransform=pe.IDENTITY,e==null||e.addChild(this),this._updateIsSimple()}disableRenderGroup(){if(!this.renderGroup)return;const e=this.parentRenderGroup;e==null||e.removeChild(this),Ot.return(this.renderGroup),this.renderGroup=null,this.groupTransform=this.relativeGroupTransform,e==null||e.addChild(this),this._updateIsSimple()}_updateIsSimple(){this.isSimple=!this.renderGroup&&this.effects.length===0}get worldTransform(){return this._worldTransform||(this._worldTransform=new pe),this.renderGroup?this._worldTransform.copyFrom(this.renderGroup.worldTransform):this.parentRenderGroup&&this._worldTransform.appendFrom(this.relativeGroupTransform,this.parentRenderGroup.worldTransform),this._worldTransform}get x(){return this._position.x}set x(e){this._position.x=e}get y(){return this._position.y}set y(e){this._position.y=e}get position(){return this._position}set position(e){this._position.copyFrom(e)}get rotation(){return this._rotation}set rotation(e){this._rotation!==e&&(this._rotation=e,this._onUpdate(this._skew))}get angle(){return this.rotation*im}set angle(e){this.rotation=e*om}get pivot(){return this._pivot===wa&&(this._pivot=new nt(this,0,0)),this._pivot}set pivot(e){this._pivot===wa&&(this._pivot=new nt(this,0,0),this._origin!==va&&Ae("Setting both a pivot and origin on a Container is not recommended. This can lead to unexpected behavior if not handled carefully.")),typeof e=="number"?this._pivot.set(e):this._pivot.copyFrom(e)}get skew(){return this._skew===no&&(this._skew=new nt(this,0,0)),this._skew}set skew(e){this._skew===no&&(this._skew=new nt(this,0,0)),this._skew.copyFrom(e)}get scale(){return this._scale===ao&&(this._scale=new nt(this,1,1)),this._scale}set scale(e){this._scale===ao&&(this._scale=new nt(this,0,0)),typeof e=="string"&&(e=parseFloat(e)),typeof e=="number"?this._scale.set(e):this._scale.copyFrom(e)}get origin(){return this._origin===va&&(this._origin=new nt(this,0,0)),this._origin}set origin(e){this._origin===va&&(this._origin=new nt(this,0,0),this._pivot!==wa&&Ae("Setting both a pivot and origin on a Container is not recommended. This can lead to unexpected behavior if not handled carefully.")),typeof e=="number"?this._origin.set(e):this._origin.copyFrom(e)}get width(){return Math.abs(this.scale.x*this.getLocalBounds().width)}set width(e){const t=this.getLocalBounds().width;this._setWidth(e,t)}get height(){return Math.abs(this.scale.y*this.getLocalBounds().height)}set height(e){const t=this.getLocalBounds().height;this._setHeight(e,t)}getSize(e){e||(e={});const t=this.getLocalBounds();return e.width=Math.abs(this.scale.x*t.width),e.height=Math.abs(this.scale.y*t.height),e}setSize(e,t){const s=this.getLocalBounds();typeof e=="object"?(t=e.height??e.width,e=e.width):t??(t=e),e!==void 0&&this._setWidth(e,s.width),t!==void 0&&this._setHeight(t,s.height)}_updateSkew(){const e=this._rotation,t=this._skew;this._cx=Math.cos(e+t._y),this._sx=Math.sin(e+t._y),this._cy=-Math.sin(e-t._x),this._sy=Math.cos(e-t._x)}updateTransform(e){return this.position.set(typeof e.x=="number"?e.x:this.position.x,typeof e.y=="number"?e.y:this.position.y),this.scale.set(typeof e.scaleX=="number"?e.scaleX||1:this.scale.x,typeof e.scaleY=="number"?e.scaleY||1:this.scale.y),this.rotation=typeof e.rotation=="number"?e.rotation:this.rotation,this.skew.set(typeof e.skewX=="number"?e.skewX:this.skew.x,typeof e.skewY=="number"?e.skewY:this.skew.y),this.pivot.set(typeof e.pivotX=="number"?e.pivotX:this.pivot.x,typeof e.pivotY=="number"?e.pivotY:this.pivot.y),this.origin.set(typeof e.originX=="number"?e.originX:this.origin.x,typeof e.originY=="number"?e.originY:this.origin.y),this}setFromMatrix(e){e.decompose(this)}updateLocalTransform(){const e=this._didContainerChangeTick;if(this._didLocalTransformChangeId===e)return;this._didLocalTransformChangeId=e;const t=this.localTransform,s=this._scale,n=this._pivot,a=this._origin,i=this._position,o=s._x,c=s._y,l=n._x,h=n._y,d=-a._x,u=-a._y;t.a=this._cx*o,t.b=this._sx*o,t.c=this._cy*c,t.d=this._sy*c,t.tx=i._x-(l*t.a+h*t.c)+(d*t.a+u*t.c)-d,t.ty=i._y-(l*t.b+h*t.d)+(d*t.b+u*t.d)-u}set alpha(e){e!==this.localAlpha&&(this.localAlpha=e,this._updateFlags|=Nl,this._onUpdate())}get alpha(){return this.localAlpha}set tint(e){const s=qe.shared.setValue(e??16777215).toBgrNumber();s!==this.localColor&&(this.localColor=s,this._updateFlags|=Nl,this._onUpdate())}get tint(){return ni(this.localColor)}set blendMode(e){this.localBlendMode!==e&&(this.parentRenderGroup&&(this.parentRenderGroup.structureDidChange=!0),this._updateFlags|=qm,this.localBlendMode=e,this._onUpdate())}get blendMode(){return this.localBlendMode}get visible(){return!!(this.localDisplayStatus&2)}set visible(e){const t=e?2:0;(this.localDisplayStatus&2)!==t&&(this.parentRenderGroup&&(this.parentRenderGroup.structureDidChange=!0),this._updateFlags|=io,this.localDisplayStatus^=2,this._onUpdate())}get culled(){return!(this.localDisplayStatus&4)}set culled(e){const t=e?0:4;(this.localDisplayStatus&4)!==t&&(this.parentRenderGroup&&(this.parentRenderGroup.structureDidChange=!0),this._updateFlags|=io,this.localDisplayStatus^=4,this._onUpdate())}get renderable(){return!!(this.localDisplayStatus&1)}set renderable(e){const t=e?1:0;(this.localDisplayStatus&1)!==t&&(this._updateFlags|=io,this.localDisplayStatus^=1,this.parentRenderGroup&&(this.parentRenderGroup.structureDidChange=!0),this._onUpdate())}get isRenderable(){return this.localDisplayStatus===7&&this.groupAlpha>0}destroy(e=!1){var n;if(this.destroyed)return;this.destroyed=!0;let t;if(this.children.length&&(t=this.removeChildren(0,this.children.length)),this.removeFromParent(),this.parent=null,this._maskEffect=null,this._filterEffect=null,this.effects=null,this._position=null,this._scale=null,this._pivot=null,this._origin=null,this._skew=null,this.emit("destroyed",this),this.removeAllListeners(),(typeof e=="boolean"?e:e==null?void 0:e.children)&&t)for(let a=0;a<t.length;++a)t[a].destroy(e);(n=this.renderGroup)==null||n.destroy(),this.renderGroup=null}}at.mixin(ve,Tm,Bm,Um,jm,Fm,Mm,$m,Nm,km,Cm,Dm,Pm);class Oc extends ve{constructor(e){super(e),this.canBundle=!0,this.allowChildren=!1,this._roundPixels=0,this._lastUsed=-1,this._gpuData=Object.create(null),this._bounds=new Wt(0,1,0,0),this._boundsDirty=!0}get bounds(){return this._boundsDirty?(this.updateBounds(),this._boundsDirty=!1,this._bounds):this._bounds}get roundPixels(){return!!this._roundPixels}set roundPixels(e){this._roundPixels=e?1:0}containsPoint(e){const t=this.bounds,{x:s,y:n}=e;return s>=t.minX&&s<=t.maxX&&n>=t.minY&&n<=t.maxY}onViewUpdate(){if(this._didViewChangeTick++,this._boundsDirty=!0,this.didViewUpdate)return;this.didViewUpdate=!0;const e=this.renderGroup||this.parentRenderGroup;e&&e.onChildViewUpdate(this)}destroy(e){var t,s;super.destroy(e),this._bounds=null;for(const n in this._gpuData)(s=(t=this._gpuData[n]).destroy)==null||s.call(t);this._gpuData=null}collectRenderablesSimple(e,t,s){const{renderPipes:n}=t;n.blendMode.pushBlendMode(this,this.groupBlendMode,e),n[this.renderPipeId].addRenderable(this,e),this.didViewUpdate=!1;const i=this.children,o=i.length;for(let c=0;c<o;c++)i[c].collectRenderables(e,t,s);n.blendMode.popBlendMode(e)}}class mt extends Oc{constructor(e=me.EMPTY){e instanceof me&&(e={texture:e});const{texture:t=me.EMPTY,anchor:s,roundPixels:n,width:a,height:i,...o}=e;super({label:"Sprite",...o}),this.renderPipeId="sprite",this.batched=!0,this._visualBounds={minX:0,maxX:1,minY:0,maxY:0},this._anchor=new nt({_onUpdate:()=>{this.onViewUpdate()}}),s?this.anchor=s:t.defaultAnchor&&(this.anchor=t.defaultAnchor),this.texture=t,this.allowChildren=!1,this.roundPixels=n??!1,a!==void 0&&(this.width=a),i!==void 0&&(this.height=i)}static from(e,t=!1){return e instanceof me?new mt(e):new mt(me.from(e,t))}set texture(e){e||(e=me.EMPTY);const t=this._texture;t!==e&&(t&&t.dynamic&&t.off("update",this.onViewUpdate,this),e.dynamic&&e.on("update",this.onViewUpdate,this),this._texture=e,this._width&&this._setWidth(this._width,this._texture.orig.width),this._height&&this._setHeight(this._height,this._texture.orig.height),this.onViewUpdate())}get texture(){return this._texture}get visualBounds(){return pm(this._visualBounds,this._anchor,this._texture),this._visualBounds}get sourceBounds(){return he("8.6.1","Sprite.sourceBounds is deprecated, use visualBounds instead."),this.visualBounds}updateBounds(){const e=this._anchor,t=this._texture,s=this._bounds,{width:n,height:a}=t.orig;s.minX=-e._x*n,s.maxX=s.minX+n,s.minY=-e._y*a,s.maxY=s.minY+a}destroy(e=!1){if(super.destroy(e),typeof e=="boolean"?e:e==null?void 0:e.texture){const s=typeof e=="boolean"?e:e==null?void 0:e.textureSource;this._texture.destroy(s)}this._texture=null,this._visualBounds=null,this._bounds=null,this._anchor=null,this._gpuData=null}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}get width(){return Math.abs(this.scale.x)*this._texture.orig.width}set width(e){this._setWidth(e,this._texture.orig.width),this._width=e}get height(){return Math.abs(this.scale.y)*this._texture.orig.height}set height(e){this._setHeight(e,this._texture.orig.height),this._height=e}getSize(e){return e||(e={}),e.width=Math.abs(this.scale.x)*this._texture.orig.width,e.height=Math.abs(this.scale.y)*this._texture.orig.height,e}setSize(e,t){typeof e=="object"?(t=e.height??e.width,e=e.width):t??(t=e),e!==void 0&&this._setWidth(e,this._texture.orig.width),t!==void 0&&this._setHeight(t,this._texture.orig.height)}}const Xm=new Wt;function Jd(r,e,t){const s=Xm;r.measurable=!0,Gd(r,t,s),e.addBoundsMask(s),r.measurable=!1}function Qd(r,e,t){const s=yr.get();r.measurable=!0;const n=yt.get().identity(),a=Zd(r,t,n);Wd(r,s,a),r.measurable=!1,e.addBoundsMask(s),yt.return(n),yr.return(s)}function Zd(r,e,t){return r?(r!==e&&(Zd(r.parent,e,t),r.updateLocalTransform(),t.append(r.localTransform)),t):(Ae("Mask bounds, renderable is not inside the root container"),t)}class eu{constructor(e){this.priority=0,this.inverse=!1,this.pipe="alphaMask",e!=null&&e.mask&&this.init(e.mask)}init(e){this.mask=e,this.renderMaskToTexture=!(e instanceof mt),this.mask.renderable=this.renderMaskToTexture,this.mask.includeInBuild=!this.renderMaskToTexture,this.mask.measurable=!1}reset(){this.mask.measurable=!0,this.mask=null}addBounds(e,t){this.inverse||Jd(this.mask,e,t)}addLocalBounds(e,t){Qd(this.mask,e,t)}containsPoint(e,t){const s=this.mask;return t(s,e)}destroy(){this.reset()}static test(e){return e instanceof mt}}eu.extension=J.MaskEffect;class tu{constructor(e){this.priority=0,this.pipe="colorMask",e!=null&&e.mask&&this.init(e.mask)}init(e){this.mask=e}destroy(){}static test(e){return typeof e=="number"}}tu.extension=J.MaskEffect;class ru{constructor(e){this.priority=0,this.pipe="stencilMask",e!=null&&e.mask&&this.init(e.mask)}init(e){this.mask=e,this.mask.includeInBuild=!1,this.mask.measurable=!1}reset(){this.mask.measurable=!0,this.mask.includeInBuild=!0,this.mask=null}addBounds(e,t){Jd(this.mask,e,t)}addLocalBounds(e,t){Qd(this.mask,e,t)}containsPoint(e,t){const s=this.mask;return t(s,e)}destroy(){this.reset()}static test(e){return e instanceof ve}}ru.extension=J.MaskEffect;const Ym={createCanvas:(r,e)=>{const t=document.createElement("canvas");return t.width=r,t.height=e,t},createImage:()=>new Image,getCanvasRenderingContext2D:()=>CanvasRenderingContext2D,getWebGLRenderingContext:()=>WebGLRenderingContext,getNavigator:()=>navigator,getBaseUrl:()=>document.baseURI??window.location.href,getFontFaceSet:()=>document.fonts,fetch:(r,e)=>fetch(r,e),parseXML:r=>new DOMParser().parseFromString(r,"text/xml")};let Hl=Ym;const ke={get(){return Hl},set(r){Hl=r}};class su extends Xt{constructor(e){e.resource||(e.resource=ke.get().createCanvas()),e.width||(e.width=e.resource.width,e.autoDensity||(e.width/=e.resolution)),e.height||(e.height=e.resource.height,e.autoDensity||(e.height/=e.resolution)),super(e),this.uploadMethodId="image",this.autoDensity=e.autoDensity,this.resizeCanvas(),this.transparent=!!e.transparent}resizeCanvas(){this.autoDensity&&"style"in this.resource&&(this.resource.style.width=`${this.width}px`,this.resource.style.height=`${this.height}px`),(this.resource.width!==this.pixelWidth||this.resource.height!==this.pixelHeight)&&(this.resource.width=this.pixelWidth,this.resource.height=this.pixelHeight)}resize(e=this.width,t=this.height,s=this._resolution){const n=super.resize(e,t,s);return n&&this.resizeCanvas(),n}static test(e){return globalThis.HTMLCanvasElement&&e instanceof HTMLCanvasElement||globalThis.OffscreenCanvas&&e instanceof OffscreenCanvas}get context2D(){return this._context2D||(this._context2D=this.resource.getContext("2d"))}}su.extension=J.TextureSource;class hs extends Xt{constructor(e){super(e),this.uploadMethodId="image",this.autoGarbageCollect=!0}static test(e){return globalThis.HTMLImageElement&&e instanceof HTMLImageElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||globalThis.VideoFrame&&e instanceof VideoFrame}}hs.extension=J.TextureSource;var Xo=(r=>(r[r.INTERACTION=50]="INTERACTION",r[r.HIGH=25]="HIGH",r[r.NORMAL=0]="NORMAL",r[r.LOW=-25]="LOW",r[r.UTILITY=-50]="UTILITY",r))(Xo||{});class oo{constructor(e,t=null,s=0,n=!1){this.next=null,this.previous=null,this._destroyed=!1,this._fn=e,this._context=t,this.priority=s,this._once=n}match(e,t=null){return this._fn===e&&this._context===t}emit(e){this._fn&&(this._context?this._fn.call(this._context,e):this._fn(e));const t=this.next;return this._once&&this.destroy(!0),this._destroyed&&(this.next=null),t}connect(e){this.previous=e,e.next&&(e.next.previous=this),this.next=e.next,e.next=this}destroy(e=!1){this._destroyed=!0,this._fn=null,this._context=null,this.previous&&(this.previous.next=this.next),this.next&&(this.next.previous=this.previous);const t=this.next;return this.next=e?null:t,this.previous=null,t}}const nu=class It{constructor(){this.autoStart=!1,this.deltaTime=1,this.lastTime=-1,this.speed=1,this.started=!1,this._requestId=null,this._maxElapsedMS=100,this._minElapsedMS=0,this._protected=!1,this._lastFrame=-1,this._head=new oo(null,null,1/0),this.deltaMS=1/It.targetFPMS,this.elapsedMS=1/It.targetFPMS,this._tick=e=>{this._requestId=null,this.started&&(this.update(e),this.started&&this._requestId===null&&this._head.next&&(this._requestId=requestAnimationFrame(this._tick)))}}_requestIfNeeded(){this._requestId===null&&this._head.next&&(this.lastTime=performance.now(),this._lastFrame=this.lastTime,this._requestId=requestAnimationFrame(this._tick))}_cancelIfNeeded(){this._requestId!==null&&(cancelAnimationFrame(this._requestId),this._requestId=null)}_startIfPossible(){this.started?this._requestIfNeeded():this.autoStart&&this.start()}add(e,t,s=Xo.NORMAL){return this._addListener(new oo(e,t,s))}addOnce(e,t,s=Xo.NORMAL){return this._addListener(new oo(e,t,s,!0))}_addListener(e){let t=this._head.next,s=this._head;if(!t)e.connect(s);else{for(;t;){if(e.priority>t.priority){e.connect(s);break}s=t,t=t.next}e.previous||e.connect(s)}return this._startIfPossible(),this}remove(e,t){let s=this._head.next;for(;s;)s.match(e,t)?s=s.destroy():s=s.next;return this._head.next||this._cancelIfNeeded(),this}get count(){if(!this._head)return 0;let e=0,t=this._head;for(;t=t.next;)e++;return e}start(){this.started||(this.started=!0,this._requestIfNeeded())}stop(){this.started&&(this.started=!1,this._cancelIfNeeded())}destroy(){if(!this._protected){this.stop();let e=this._head.next;for(;e;)e=e.destroy(!0);this._head.destroy(),this._head=null}}update(e=performance.now()){let t;if(e>this.lastTime){if(t=this.elapsedMS=e-this.lastTime,t>this._maxElapsedMS&&(t=this._maxElapsedMS),t*=this.speed,this._minElapsedMS){const a=e-this._lastFrame|0;if(a<this._minElapsedMS)return;this._lastFrame=e-a%this._minElapsedMS}this.deltaMS=t,this.deltaTime=this.deltaMS*It.targetFPMS;const s=this._head;let n=s.next;for(;n;)n=n.emit(this);s.next||this._cancelIfNeeded()}else this.deltaTime=this.deltaMS=this.elapsedMS=0;this.lastTime=e}get FPS(){return 1e3/this.elapsedMS}get minFPS(){return 1e3/this._maxElapsedMS}set minFPS(e){const t=Math.min(this.maxFPS,e),s=Math.min(Math.max(0,t)/1e3,It.targetFPMS);this._maxElapsedMS=1/s}get maxFPS(){return this._minElapsedMS?Math.round(1e3/this._minElapsedMS):0}set maxFPS(e){if(e===0)this._minElapsedMS=0;else{const t=Math.max(this.minFPS,e);this._minElapsedMS=1/(t/1e3)}}static get shared(){if(!It._shared){const e=It._shared=new It;e.autoStart=!0,e._protected=!0}return It._shared}static get system(){if(!It._system){const e=It._system=new It;e.autoStart=!0,e._protected=!0}return It._system}};nu.targetFPMS=.06;let Sa=nu,co;async function au(){return co??(co=(async()=>{var i;const e=ke.get().createCanvas(1,1).getContext("webgl");if(!e)return"premultiply-alpha-on-upload";const t=await new Promise(o=>{const c=document.createElement("video");c.onloadeddata=()=>o(c),c.onerror=()=>o(null),c.autoplay=!1,c.crossOrigin="anonymous",c.preload="auto",c.src="data:video/webm;base64,GkXfo59ChoEBQveBAULygQRC84EIQoKEd2VibUKHgQJChYECGFOAZwEAAAAAAAHTEU2bdLpNu4tTq4QVSalmU6yBoU27i1OrhBZUrmtTrIHGTbuMU6uEElTDZ1OsggEXTbuMU6uEHFO7a1OsggG97AEAAAAAAABZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVSalmoCrXsYMPQkBNgIRMYXZmV0GETGF2ZkSJiEBEAAAAAAAAFlSua8yuAQAAAAAAAEPXgQFzxYgAAAAAAAAAAZyBACK1nIN1bmSIgQCGhVZfVlA5g4EBI+ODhAJiWgDglLCBArqBApqBAlPAgQFVsIRVuYEBElTDZ9Vzc9JjwItjxYgAAAAAAAAAAWfInEWjh0VOQ09ERVJEh49MYXZjIGxpYnZweC12cDlnyKJFo4hEVVJBVElPTkSHlDAwOjAwOjAwLjA0MDAwMDAwMAAAH0O2dcfngQCgwqGggQAAAIJJg0IAABAAFgA4JBwYSgAAICAAEb///4r+AAB1oZ2mm+6BAaWWgkmDQgAAEAAWADgkHBhKAAAgIABIQBxTu2uRu4+zgQC3iveBAfGCAXHwgQM=",c.load()});if(!t)return"premultiply-alpha-on-upload";const s=e.createTexture();e.bindTexture(e.TEXTURE_2D,s);const n=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,n),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,s,0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,e.NONE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t);const a=new Uint8Array(4);return e.readPixels(0,0,1,1,e.RGBA,e.UNSIGNED_BYTE,a),e.deleteFramebuffer(n),e.deleteTexture(s),(i=e.getExtension("WEBGL_lose_context"))==null||i.loseContext(),a[0]<=a[3]?"premultiplied-alpha":"premultiply-alpha-on-upload"})()),co}const Ti=class iu extends Xt{constructor(e){super(e),this.isReady=!1,this.uploadMethodId="video",e={...iu.defaultOptions,...e},this._autoUpdate=!0,this._isConnectedToTicker=!1,this._updateFPS=e.updateFPS||0,this._msToNextUpdate=0,this.autoPlay=e.autoPlay!==!1,this.alphaMode=e.alphaMode??"premultiply-alpha-on-upload",this._videoFrameRequestCallback=this._videoFrameRequestCallback.bind(this),this._videoFrameRequestCallbackHandle=null,this._load=null,this._resolve=null,this._reject=null,this._onCanPlay=this._onCanPlay.bind(this),this._onCanPlayThrough=this._onCanPlayThrough.bind(this),this._onError=this._onError.bind(this),this._onPlayStart=this._onPlayStart.bind(this),this._onPlayStop=this._onPlayStop.bind(this),this._onSeeked=this._onSeeked.bind(this),e.autoLoad!==!1&&this.load()}updateFrame(){if(!this.destroyed){if(this._updateFPS){const e=Sa.shared.elapsedMS*this.resource.playbackRate;this._msToNextUpdate=Math.floor(this._msToNextUpdate-e)}(!this._updateFPS||this._msToNextUpdate<=0)&&(this._msToNextUpdate=this._updateFPS?Math.floor(1e3/this._updateFPS):0),this.isValid&&this.update()}}_videoFrameRequestCallback(){this.updateFrame(),this.destroyed?this._videoFrameRequestCallbackHandle=null:this._videoFrameRequestCallbackHandle=this.resource.requestVideoFrameCallback(this._videoFrameRequestCallback)}get isValid(){return!!this.resource.videoWidth&&!!this.resource.videoHeight}async load(){if(this._load)return this._load;const e=this.resource,t=this.options;return(e.readyState===e.HAVE_ENOUGH_DATA||e.readyState===e.HAVE_FUTURE_DATA)&&e.width&&e.height&&(e.complete=!0),e.addEventListener("play",this._onPlayStart),e.addEventListener("pause",this._onPlayStop),e.addEventListener("seeked",this._onSeeked),this._isSourceReady()?this._mediaReady():(t.preload||e.addEventListener("canplay",this._onCanPlay),e.addEventListener("canplaythrough",this._onCanPlayThrough),e.addEventListener("error",this._onError,!0)),this.alphaMode=await au(),this._load=new Promise((s,n)=>{this.isValid?s(this):(this._resolve=s,this._reject=n,t.preloadTimeoutMs!==void 0&&(this._preloadTimeout=setTimeout(()=>{this._onError(new ErrorEvent(`Preload exceeded timeout of ${t.preloadTimeoutMs}ms`))})),e.load())}),this._load}_onError(e){this.resource.removeEventListener("error",this._onError,!0),this.emit("error",e),this._reject&&(this._reject(e),this._reject=null,this._resolve=null)}_isSourcePlaying(){const e=this.resource;return!e.paused&&!e.ended}_isSourceReady(){return this.resource.readyState>2}_onPlayStart(){this.isValid||this._mediaReady(),this._configureAutoUpdate()}_onPlayStop(){this._configureAutoUpdate()}_onSeeked(){this._autoUpdate&&!this._isSourcePlaying()&&(this._msToNextUpdate=0,this.updateFrame(),this._msToNextUpdate=0)}_onCanPlay(){this.resource.removeEventListener("canplay",this._onCanPlay),this._mediaReady()}_onCanPlayThrough(){this.resource.removeEventListener("canplaythrough",this._onCanPlay),this._preloadTimeout&&(clearTimeout(this._preloadTimeout),this._preloadTimeout=void 0),this._mediaReady()}_mediaReady(){const e=this.resource;this.isValid&&(this.isReady=!0,this.resize(e.videoWidth,e.videoHeight)),this._msToNextUpdate=0,this.updateFrame(),this._msToNextUpdate=0,this._resolve&&(this._resolve(this),this._resolve=null,this._reject=null),this._isSourcePlaying()?this._onPlayStart():this.autoPlay&&this.resource.play()}destroy(){this._configureAutoUpdate();const e=this.resource;e&&(e.removeEventListener("play",this._onPlayStart),e.removeEventListener("pause",this._onPlayStop),e.removeEventListener("seeked",this._onSeeked),e.removeEventListener("canplay",this._onCanPlay),e.removeEventListener("canplaythrough",this._onCanPlayThrough),e.removeEventListener("error",this._onError,!0),e.pause(),e.src="",e.load()),super.destroy()}get autoUpdate(){return this._autoUpdate}set autoUpdate(e){e!==this._autoUpdate&&(this._autoUpdate=e,this._configureAutoUpdate())}get updateFPS(){return this._updateFPS}set updateFPS(e){e!==this._updateFPS&&(this._updateFPS=e,this._configureAutoUpdate())}_configureAutoUpdate(){this._autoUpdate&&this._isSourcePlaying()?!this._updateFPS&&this.resource.requestVideoFrameCallback?(this._isConnectedToTicker&&(Sa.shared.remove(this.updateFrame,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0),this._videoFrameRequestCallbackHandle===null&&(this._videoFrameRequestCallbackHandle=this.resource.requestVideoFrameCallback(this._videoFrameRequestCallback))):(this._videoFrameRequestCallbackHandle!==null&&(this.resource.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker||(Sa.shared.add(this.updateFrame,this),this._isConnectedToTicker=!0,this._msToNextUpdate=0)):(this._videoFrameRequestCallbackHandle!==null&&(this.resource.cancelVideoFrameCallback(this._videoFrameRequestCallbackHandle),this._videoFrameRequestCallbackHandle=null),this._isConnectedToTicker&&(Sa.shared.remove(this.updateFrame,this),this._isConnectedToTicker=!1,this._msToNextUpdate=0))}static test(e){return globalThis.HTMLVideoElement&&e instanceof HTMLVideoElement}};Ti.extension=J.TextureSource;Ti.defaultOptions={...Xt.defaultOptions,autoLoad:!0,autoPlay:!0,updateFPS:0,crossorigin:!0,loop:!1,muted:!0,playsinline:!0,preload:!1};Ti.MIME_TYPES={ogv:"video/ogg",mov:"video/quicktime",m4v:"video/mp4"};let Rn=Ti;const Vt=(r,e,t=!1)=>(Array.isArray(r)||(r=[r]),e?r.map(s=>typeof s=="string"||t?e(s):s):r);class Km{constructor(){this._parsers=[],this._cache=new Map,this._cacheMap=new Map}reset(){this._cacheMap.clear(),this._cache.clear()}has(e){return this._cache.has(e)}get(e){const t=this._cache.get(e);return t||Ae(`[Assets] Asset id ${e} was not found in the Cache`),t}set(e,t){const s=Vt(e);let n;for(let c=0;c<this.parsers.length;c++){const l=this.parsers[c];if(l.test(t)){n=l.getCacheableAssets(s,t);break}}const a=new Map(Object.entries(n||{}));n||s.forEach(c=>{a.set(c,t)});const i=[...a.keys()],o={cacheKeys:i,keys:s};s.forEach(c=>{this._cacheMap.set(c,o)}),i.forEach(c=>{const l=n?n[c]:t;this._cache.has(c)&&this._cache.get(c)!==l&&Ae("[Cache] already has key:",c),this._cache.set(c,a.get(c))})}remove(e){if(!this._cacheMap.has(e)){Ae(`[Assets] Asset id ${e} was not found in the Cache`);return}const t=this._cacheMap.get(e);t.cacheKeys.forEach(n=>{this._cache.delete(n)}),t.keys.forEach(n=>{this._cacheMap.delete(n)})}get parsers(){return this._parsers}}const Ie=new Km,Yo=[];at.handleByList(J.TextureSource,Yo);function ou(r={}){const e=r&&r.resource,t=e?r.resource:r,s=e?r:{resource:r};for(let n=0;n<Yo.length;n++){const a=Yo[n];if(a.test(t))return new a(s)}throw new Error(`Could not find a source type for resource: ${s.resource}`)}function Jm(r={},e=!1){const t=r&&r.resource,s=t?r.resource:r,n=t?r:{resource:r};if(!e&&Ie.has(s))return Ie.get(s);const a=new me({source:ou(n)});return a.on("destroy",()=>{Ie.has(s)&&Ie.remove(s)}),e||Ie.set(s,a),a}function Qm(r,e=!1){return typeof r=="string"?Ie.get(r):r instanceof Xt?new me({source:r}):Jm(r,e)}me.from=Qm;Xt.from=ou;at.add(eu,tu,ru,Rn,hs,su,Mc);var jr=(r=>(r[r.Low=0]="Low",r[r.Normal=1]="Normal",r[r.High=2]="High",r))(jr||{});function Nt(r){if(typeof r!="string")throw new TypeError(`Path must be a string. Received ${JSON.stringify(r)}`)}function mn(r){return r.split("?")[0].split("#")[0]}function Zm(r){return r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function eg(r,e,t){return r.replace(new RegExp(Zm(e),"g"),t)}function tg(r,e){let t="",s=0,n=-1,a=0,i=-1;for(let o=0;o<=r.length;++o){if(o<r.length)i=r.charCodeAt(o);else{if(i===47)break;i=47}if(i===47){if(!(n===o-1||a===1))if(n!==o-1&&a===2){if(t.length<2||s!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){const c=t.lastIndexOf("/");if(c!==t.length-1){c===-1?(t="",s=0):(t=t.slice(0,c),s=t.length-1-t.lastIndexOf("/")),n=o,a=0;continue}}else if(t.length===2||t.length===1){t="",s=0,n=o,a=0;continue}}}else t.length>0?t+=`/${r.slice(n+1,o)}`:t=r.slice(n+1,o),s=o-n-1;n=o,a=0}else i===46&&a!==-1?++a:a=-1}return t}const Et={toPosix(r){return eg(r,"\\","/")},isUrl(r){return/^https?:/.test(this.toPosix(r))},isDataUrl(r){return/^data:([a-z]+\/[a-z0-9-+.]+(;[a-z0-9-.!#$%*+.{}|~`]+=[a-z0-9-.!#$%*+.{}()_|~`]+)*)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s<>]*?)$/i.test(r)},isBlobUrl(r){return r.startsWith("blob:")},hasProtocol(r){return/^[^/:]+:/.test(this.toPosix(r))},getProtocol(r){Nt(r),r=this.toPosix(r);const e=/^file:\/\/\//.exec(r);if(e)return e[0];const t=/^[^/:]+:\/{0,2}/.exec(r);return t?t[0]:""},toAbsolute(r,e,t){if(Nt(r),this.isDataUrl(r)||this.isBlobUrl(r))return r;const s=mn(this.toPosix(e??ke.get().getBaseUrl())),n=mn(this.toPosix(t??this.rootname(s)));return r=this.toPosix(r),r.startsWith("/")?Et.join(n,r.slice(1)):this.isAbsolute(r)?r:this.join(s,r)},normalize(r){if(Nt(r),r.length===0)return".";if(this.isDataUrl(r)||this.isBlobUrl(r))return r;r=this.toPosix(r);let e="";const t=r.startsWith("/");this.hasProtocol(r)&&(e=this.rootname(r),r=r.slice(e.length));const s=r.endsWith("/");return r=tg(r),r.length>0&&s&&(r+="/"),t?`/${r}`:e+r},isAbsolute(r){return Nt(r),r=this.toPosix(r),this.hasProtocol(r)?!0:r.startsWith("/")},join(...r){if(r.length===0)return".";let e;for(let t=0;t<r.length;++t){const s=r[t];if(Nt(s),s.length>0)if(e===void 0)e=s;else{const n=r[t-1]??"";this.joinExtensions.includes(this.extname(n).toLowerCase())?e+=`/../${s}`:e+=`/${s}`}}return e===void 0?".":this.normalize(e)},dirname(r){if(Nt(r),r.length===0)return".";r=this.toPosix(r);let e=r.charCodeAt(0);const t=e===47;let s=-1,n=!0;const a=this.getProtocol(r),i=r;r=r.slice(a.length);for(let o=r.length-1;o>=1;--o)if(e=r.charCodeAt(o),e===47){if(!n){s=o;break}}else n=!1;return s===-1?t?"/":this.isUrl(i)?a+r:a:t&&s===1?"//":a+r.slice(0,s)},rootname(r){Nt(r),r=this.toPosix(r);let e="";if(r.startsWith("/")?e="/":e=this.getProtocol(r),this.isUrl(r)){const t=r.indexOf("/",e.length);t!==-1?e=r.slice(0,t):e=r,e.endsWith("/")||(e+="/")}return e},basename(r,e){Nt(r),e&&Nt(e),r=mn(this.toPosix(r));let t=0,s=-1,n=!0,a;if(e!==void 0&&e.length>0&&e.length<=r.length){if(e.length===r.length&&e===r)return"";let i=e.length-1,o=-1;for(a=r.length-1;a>=0;--a){const c=r.charCodeAt(a);if(c===47){if(!n){t=a+1;break}}else o===-1&&(n=!1,o=a+1),i>=0&&(c===e.charCodeAt(i)?--i===-1&&(s=a):(i=-1,s=o))}return t===s?s=o:s===-1&&(s=r.length),r.slice(t,s)}for(a=r.length-1;a>=0;--a)if(r.charCodeAt(a)===47){if(!n){t=a+1;break}}else s===-1&&(n=!1,s=a+1);return s===-1?"":r.slice(t,s)},extname(r){Nt(r),r=mn(this.toPosix(r));let e=-1,t=0,s=-1,n=!0,a=0;for(let i=r.length-1;i>=0;--i){const o=r.charCodeAt(i);if(o===47){if(!n){t=i+1;break}continue}s===-1&&(n=!1,s=i+1),o===46?e===-1?e=i:a!==1&&(a=1):e!==-1&&(a=-1)}return e===-1||s===-1||a===0||a===1&&e===s-1&&e===t+1?"":r.slice(e,s)},parse(r){Nt(r);const e={root:"",dir:"",base:"",ext:"",name:""};if(r.length===0)return e;r=mn(this.toPosix(r));let t=r.charCodeAt(0);const s=this.isAbsolute(r);let n;e.root=this.rootname(r),s||this.hasProtocol(r)?n=1:n=0;let a=-1,i=0,o=-1,c=!0,l=r.length-1,h=0;for(;l>=n;--l){if(t=r.charCodeAt(l),t===47){if(!c){i=l+1;break}continue}o===-1&&(c=!1,o=l+1),t===46?a===-1?a=l:h!==1&&(h=1):a!==-1&&(h=-1)}return a===-1||o===-1||h===0||h===1&&a===o-1&&a===i+1?o!==-1&&(i===0&&s?e.base=e.name=r.slice(1,o):e.base=e.name=r.slice(i,o)):(i===0&&s?(e.name=r.slice(1,a),e.base=r.slice(1,o)):(e.name=r.slice(i,a),e.base=r.slice(i,o)),e.ext=r.slice(a,o)),e.dir=this.dirname(r),e},sep:"/",delimiter:":",joinExtensions:[".html"]};function cu(r,e,t,s,n){const a=e[t];for(let i=0;i<a.length;i++){const o=a[i];t<e.length-1?cu(r.replace(s[t],o),e,t+1,s,n):n.push(r.replace(s[t],o))}}function rg(r){const e=/\{(.*?)\}/g,t=r.match(e),s=[];if(t){const n=[];t.forEach(a=>{const i=a.substring(1,a.length-1).split(",");n.push(i)}),cu(r,n,0,t,s)}else s.push(r);return s}const pi=r=>!Array.isArray(r);class qs{constructor(){this._defaultBundleIdentifierOptions={connector:"-",createBundleAssetId:(e,t)=>`${e}${this._bundleIdConnector}${t}`,extractAssetIdFromBundle:(e,t)=>t.replace(`${e}${this._bundleIdConnector}`,"")},this._bundleIdConnector=this._defaultBundleIdentifierOptions.connector,this._createBundleAssetId=this._defaultBundleIdentifierOptions.createBundleAssetId,this._extractAssetIdFromBundle=this._defaultBundleIdentifierOptions.extractAssetIdFromBundle,this._assetMap={},this._preferredOrder=[],this._parsers=[],this._resolverHash={},this._bundles={}}setBundleIdentifier(e){if(this._bundleIdConnector=e.connector??this._bundleIdConnector,this._createBundleAssetId=e.createBundleAssetId??this._createBundleAssetId,this._extractAssetIdFromBundle=e.extractAssetIdFromBundle??this._extractAssetIdFromBundle,this._extractAssetIdFromBundle("foo",this._createBundleAssetId("foo","bar"))!=="bar")throw new Error("[Resolver] GenerateBundleAssetId are not working correctly")}prefer(...e){e.forEach(t=>{this._preferredOrder.push(t),t.priority||(t.priority=Object.keys(t.params))}),this._resolverHash={}}set basePath(e){this._basePath=e}get basePath(){return this._basePath}set rootPath(e){this._rootPath=e}get rootPath(){return this._rootPath}get parsers(){return this._parsers}reset(){this.setBundleIdentifier(this._defaultBundleIdentifierOptions),this._assetMap={},this._preferredOrder=[],this._resolverHash={},this._rootPath=null,this._basePath=null,this._manifest=null,this._bundles={},this._defaultSearchParams=null}setDefaultSearchParams(e){if(typeof e=="string")this._defaultSearchParams=e;else{const t=e;this._defaultSearchParams=Object.keys(t).map(s=>`${encodeURIComponent(s)}=${encodeURIComponent(t[s])}`).join("&")}}getAlias(e){const{alias:t,src:s}=e;return Vt(t||s,a=>typeof a=="string"?a:Array.isArray(a)?a.map(i=>(i==null?void 0:i.src)??i):a!=null&&a.src?a.src:a,!0)}addManifest(e){this._manifest&&Ae("[Resolver] Manifest already exists, this will be overwritten"),this._manifest=e,e.bundles.forEach(t=>{this.addBundle(t.name,t.assets)})}addBundle(e,t){const s=[];let n=t;Array.isArray(t)||(n=Object.entries(t).map(([a,i])=>typeof i=="string"||Array.isArray(i)?{alias:a,src:i}:{alias:a,...i})),n.forEach(a=>{const i=a.src,o=a.alias;let c;if(typeof o=="string"){const l=this._createBundleAssetId(e,o);s.push(l),c=[o,l]}else{const l=o.map(h=>this._createBundleAssetId(e,h));s.push(...l),c=[...o,...l]}this.add({...a,alias:c,src:i})}),this._bundles[e]=s}add(e){const t=[];Array.isArray(e)?t.push(...e):t.push(e);let s;s=a=>{this.hasKey(a)&&Ae(`[Resolver] already has key: ${a} overwriting`)},Vt(t).forEach(a=>{const{src:i}=a;let{data:o,format:c,loadParser:l,parser:h}=a;const d=Vt(i).map(p=>typeof p=="string"?rg(p):Array.isArray(p)?p:[p]),u=this.getAlias(a);Array.isArray(u)?u.forEach(s):s(u);const f=[];d.forEach(p=>{p.forEach(g=>{let m={};if(typeof g!="object"){m.src=g;for(let _=0;_<this._parsers.length;_++){const b=this._parsers[_];if(b.test(g)){m=b.parse(g);break}}}else o=g.data??o,c=g.format??c,(g.loadParser||g.parser)&&(l=g.loadParser??l,h=g.parser??h),m={...m,...g};if(!u)throw new Error(`[Resolver] alias is undefined for this asset: ${m.src}`);m=this._buildResolvedAsset(m,{aliases:u,data:o,format:c,loadParser:l,parser:h,progressSize:a.progressSize}),f.push(m)})}),u.forEach(p=>{this._assetMap[p]=f})})}resolveBundle(e){const t=pi(e);e=Vt(e);const s={};return e.forEach(n=>{const a=this._bundles[n];if(a){const i=this.resolve(a),o={};for(const c in i){const l=i[c];o[this._extractAssetIdFromBundle(n,c)]=l}s[n]=o}}),t?s[e[0]]:s}resolveUrl(e){const t=this.resolve(e);if(typeof e!="string"){const s={};for(const n in t)s[n]=t[n].src;return s}return t.src}resolve(e){const t=pi(e);e=Vt(e);const s={};return e.forEach(n=>{if(!this._resolverHash[n])if(this._assetMap[n]){let a=this._assetMap[n];const i=this._getPreferredOrder(a);i==null||i.priority.forEach(o=>{i.params[o].forEach(c=>{const l=a.filter(h=>h[o]?h[o]===c:!1);l.length&&(a=l)})}),this._resolverHash[n]=a[0]}else this._resolverHash[n]=this._buildResolvedAsset({alias:[n],src:n},{});s[n]=this._resolverHash[n]}),t?s[e[0]]:s}hasKey(e){return!!this._assetMap[e]}hasBundle(e){return!!this._bundles[e]}_getPreferredOrder(e){for(let t=0;t<e.length;t++){const s=e[t],n=this._preferredOrder.find(a=>a.params.format.includes(s.format));if(n)return n}return this._preferredOrder[0]}_appendDefaultSearchParams(e){if(!this._defaultSearchParams)return e;const t=/\?/.test(e)?"&":"?";return`${e}${t}${this._defaultSearchParams}`}_buildResolvedAsset(e,t){const{aliases:s,data:n,loadParser:a,parser:i,format:o,progressSize:c}=t;return(this._basePath||this._rootPath)&&(e.src=Et.toAbsolute(e.src,this._basePath,this._rootPath)),e.alias=s??e.alias??[e.src],e.src=this._appendDefaultSearchParams(e.src),e.data={...n||{},...e.data},e.loadParser=a??e.loadParser,e.parser=i??e.parser,e.format=o??e.format??sg(e.src),c!==void 0&&(e.progressSize=c),e}}qs.RETINA_PREFIX=/@([0-9\.]+)x/;function sg(r){return r.split(".").pop().split("?").shift().split("#").shift()}const Ko=(r,e)=>{const t=e.split("?")[1];return t&&(r+=`?${t}`),r},lu=class In{constructor(e,t){this.linkedSheets=[];let s=e;(e==null?void 0:e.source)instanceof Xt&&(s={texture:e,data:t});const{texture:n,data:a,cachePrefix:i=""}=s;this.cachePrefix=i,this._texture=n instanceof me?n:null,this.textureSource=n.source,this.textures={},this.animations={},this.data=a;const o=parseFloat(a.meta.scale);o?(this.resolution=o,n.source.resolution=this.resolution):this.resolution=n.source._resolution,this._frames=this.data.frames,this._frameKeys=Object.keys(this._frames),this._batchIndex=0,this._callback=null}parse(){return new Promise(e=>{this._callback=e,this._batchIndex=0,this._frameKeys.length<=In.BATCH_SIZE?(this._processFrames(0),this._processAnimations(),this._parseComplete()):this._nextBatch()})}_processFrames(e){let t=e;const s=In.BATCH_SIZE;for(;t-e<s&&t<this._frameKeys.length;){const n=this._frameKeys[t],a=this._frames[n],i=a.frame;if(i){let o=null,c=null;const l=a.trimmed!==!1&&a.sourceSize?a.sourceSize:a.frame,h=new Re(0,0,Math.floor(l.w)/this.resolution,Math.floor(l.h)/this.resolution);a.rotated?o=new Re(Math.floor(i.x)/this.resolution,Math.floor(i.y)/this.resolution,Math.floor(i.h)/this.resolution,Math.floor(i.w)/this.resolution):o=new Re(Math.floor(i.x)/this.resolution,Math.floor(i.y)/this.resolution,Math.floor(i.w)/this.resolution,Math.floor(i.h)/this.resolution),a.trimmed!==!1&&a.spriteSourceSize&&(c=new Re(Math.floor(a.spriteSourceSize.x)/this.resolution,Math.floor(a.spriteSourceSize.y)/this.resolution,Math.floor(i.w)/this.resolution,Math.floor(i.h)/this.resolution)),this.textures[n]=new me({source:this.textureSource,frame:o,orig:h,trim:c,rotate:a.rotated?2:0,defaultAnchor:a.anchor,defaultBorders:a.borders,label:n.toString()})}t++}}_processAnimations(){const e=this.data.animations||{};for(const t in e){this.animations[t]=[];for(let s=0;s<e[t].length;s++){const n=e[t][s];this.animations[t].push(this.textures[n])}}}_parseComplete(){const e=this._callback;this._callback=null,this._batchIndex=0,e.call(this,this.textures)}_nextBatch(){this._processFrames(this._batchIndex*In.BATCH_SIZE),this._batchIndex++,setTimeout(()=>{this._batchIndex*In.BATCH_SIZE<this._frameKeys.length?this._nextBatch():(this._processAnimations(),this._parseComplete())},0)}destroy(e=!1){var t;for(const s in this.textures)this.textures[s].destroy();this._frames=null,this._frameKeys=null,this.data=null,this.textures=null,e&&((t=this._texture)==null||t.destroy(),this.textureSource.destroy()),this._texture=null,this.textureSource=null,this.linkedSheets=[]}};lu.BATCH_SIZE=1e3;let Ul=lu;const ng=["jpg","png","jpeg","avif","webp","basis","etc2","bc7","bc6h","bc5","bc4","bc3","bc2","bc1","eac","astc"];function hu(r,e,t){const s={};if(r.forEach(n=>{s[n]=e}),Object.keys(e.textures).forEach(n=>{s[`${e.cachePrefix}${n}`]=e.textures[n]}),!t){const n=Et.dirname(r[0]);e.linkedSheets.forEach((a,i)=>{const o=hu([`${n}/${e.data.meta.related_multi_packs[i]}`],a,!0);Object.assign(s,o)})}return s}const ag={extension:J.Asset,cache:{test:r=>r instanceof Ul,getCacheableAssets:(r,e)=>hu(r,e,!1)},resolver:{extension:{type:J.ResolveParser,name:"resolveSpritesheet"},test:r=>{const t=r.split("?")[0].split("."),s=t.pop(),n=t.pop();return s==="json"&&ng.includes(n)},parse:r=>{var t;const e=r.split(".");return{resolution:parseFloat(((t=qs.RETINA_PREFIX.exec(r))==null?void 0:t[1])??"1"),format:e[e.length-2],src:r}}},loader:{name:"spritesheetLoader",id:"spritesheet",extension:{type:J.LoadParser,priority:jr.Normal,name:"spritesheetLoader"},async testParse(r,e){return Et.extname(e.src).toLowerCase()===".json"&&!!r.frames},async parse(r,e,t){var d,u;const{texture:s,imageFilename:n,textureOptions:a,cachePrefix:i}=(e==null?void 0:e.data)??{};let o=Et.dirname(e.src);o&&o.lastIndexOf("/")!==o.length-1&&(o+="/");let c;if(s instanceof me)c=s;else{const f=Ko(o+(n??r.meta.image),e.src);c=(await t.load([{src:f,data:a}]))[f]}const l=new Ul({texture:c.source,data:r,cachePrefix:i});await l.parse();const h=(d=r==null?void 0:r.meta)==null?void 0:d.related_multi_packs;if(Array.isArray(h)){const f=[];for(const g of h){if(typeof g!="string")continue;let m=o+g;(u=e.data)!=null&&u.ignoreMultiPack||(m=Ko(m,e.src),f.push(t.load({src:m,data:{textureOptions:a,ignoreMultiPack:!0}})))}const p=await Promise.all(f);l.linkedSheets=p,p.forEach(g=>{g.linkedSheets=[l].concat(l.linkedSheets.filter(m=>m!==g))})}return l},async unload(r,e,t){await t.unload(r.textureSource._sourceOrigin),r.destroy(!1)}}};at.add(ag);const lo=Object.create(null),Gl=Object.create(null);function Bc(r,e){let t=Gl[r];return t===void 0&&(lo[e]===void 0&&(lo[e]=1),Gl[r]=t=lo[e]++),t}let xs;function du(){return(!xs||xs!=null&&xs.isContextLost())&&(xs=ke.get().createCanvas().getContext("webgl",{})),xs}let ka;function ig(){if(!ka){ka="mediump";const r=du();r&&r.getShaderPrecisionFormat&&(ka=r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.HIGH_FLOAT).precision?"highp":"mediump")}return ka}function og(r,e,t){return e?r:t?(r=r.replace("out vec4 finalColor;",""),`

        #ifdef GL_ES // This checks if it is WebGL1
        #define in varying
        #define finalColor gl_FragColor
        #define texture texture2D
        #endif
        ${r}
        `):`

        #ifdef GL_ES // This checks if it is WebGL1
        #define in attribute
        #define out varying
        #endif
        ${r}
        `}function cg(r,e,t){const s=t?e.maxSupportedFragmentPrecision:e.maxSupportedVertexPrecision;if(r.substring(0,9)!=="precision"){let n=t?e.requestedFragmentPrecision:e.requestedVertexPrecision;return n==="highp"&&s!=="highp"&&(n="mediump"),`precision ${n} float;
${r}`}else if(s!=="highp"&&r.substring(0,15)==="precision highp")return r.replace("precision highp","precision mediump");return r}function lg(r,e){return e?`#version 300 es
${r}`:r}const hg={},dg={};function ug(r,{name:e="pixi-program"},t=!0){e=e.replace(/\s+/g,"-"),e+=t?"-fragment":"-vertex";const s=t?hg:dg;return s[e]?(s[e]++,e+=`-${s[e]}`):s[e]=1,r.indexOf("#define SHADER_NAME")!==-1?r:`${`#define SHADER_NAME ${e}`}
${r}`}function fg(r,e){return e?r.replace("#version 300 es",""):r}const ho={stripVersion:fg,ensurePrecision:cg,addProgramDefines:og,setProgramName:ug,insertVersion:lg},gn=Object.create(null),uu=class Jo{constructor(e){e={...Jo.defaultOptions,...e};const t=e.fragment.indexOf("#version 300 es")!==-1,s={stripVersion:t,ensurePrecision:{requestedFragmentPrecision:e.preferredFragmentPrecision,requestedVertexPrecision:e.preferredVertexPrecision,maxSupportedVertexPrecision:"highp",maxSupportedFragmentPrecision:ig()},setProgramName:{name:e.name},addProgramDefines:t,insertVersion:t};let n=e.fragment,a=e.vertex;Object.keys(ho).forEach(i=>{const o=s[i];n=ho[i](n,o,!0),a=ho[i](a,o,!1)}),this.fragment=n,this.vertex=a,this.transformFeedbackVaryings=e.transformFeedbackVaryings,this._key=Bc(`${this.vertex}:${this.fragment}`,"gl-program")}destroy(){this.fragment=null,this.vertex=null,this._attributeData=null,this._uniformData=null,this._uniformBlockData=null,this.transformFeedbackVaryings=null,gn[this._cacheKey]=null}static from(e){const t=`${e.vertex}:${e.fragment}`;return gn[t]||(gn[t]=new Jo(e),gn[t]._cacheKey=t),gn[t]}};uu.defaultOptions={preferredVertexPrecision:"highp",preferredFragmentPrecision:"mediump"};let fu=uu;const zl={uint8x2:{size:2,stride:2,normalised:!1},uint8x4:{size:4,stride:4,normalised:!1},sint8x2:{size:2,stride:2,normalised:!1},sint8x4:{size:4,stride:4,normalised:!1},unorm8x2:{size:2,stride:2,normalised:!0},unorm8x4:{size:4,stride:4,normalised:!0},snorm8x2:{size:2,stride:2,normalised:!0},snorm8x4:{size:4,stride:4,normalised:!0},uint16x2:{size:2,stride:4,normalised:!1},uint16x4:{size:4,stride:8,normalised:!1},sint16x2:{size:2,stride:4,normalised:!1},sint16x4:{size:4,stride:8,normalised:!1},unorm16x2:{size:2,stride:4,normalised:!0},unorm16x4:{size:4,stride:8,normalised:!0},snorm16x2:{size:2,stride:4,normalised:!0},snorm16x4:{size:4,stride:8,normalised:!0},float16x2:{size:2,stride:4,normalised:!1},float16x4:{size:4,stride:8,normalised:!1},float32:{size:1,stride:4,normalised:!1},float32x2:{size:2,stride:8,normalised:!1},float32x3:{size:3,stride:12,normalised:!1},float32x4:{size:4,stride:16,normalised:!1},uint32:{size:1,stride:4,normalised:!1},uint32x2:{size:2,stride:8,normalised:!1},uint32x3:{size:3,stride:12,normalised:!1},uint32x4:{size:4,stride:16,normalised:!1},sint32:{size:1,stride:4,normalised:!1},sint32x2:{size:2,stride:8,normalised:!1},sint32x3:{size:3,stride:12,normalised:!1},sint32x4:{size:4,stride:16,normalised:!1}};function pg(r){return zl[r]??zl.float32}const mg={f32:"float32","vec2<f32>":"float32x2","vec3<f32>":"float32x3","vec4<f32>":"float32x4",vec2f:"float32x2",vec3f:"float32x3",vec4f:"float32x4",i32:"sint32","vec2<i32>":"sint32x2","vec3<i32>":"sint32x3","vec4<i32>":"sint32x4",u32:"uint32","vec2<u32>":"uint32x2","vec3<u32>":"uint32x3","vec4<u32>":"uint32x4",bool:"uint32","vec2<bool>":"uint32x2","vec3<bool>":"uint32x3","vec4<bool>":"uint32x4"};function gg({source:r,entryPoint:e}){const t={},s=r.indexOf(`fn ${e}`);if(s!==-1){const n=r.indexOf("->",s);if(n!==-1){const a=r.substring(s,n),i=/@location\((\d+)\)\s+([a-zA-Z0-9_]+)\s*:\s*([a-zA-Z0-9_<>]+)(?:,|\s|$)/g;let o;for(;(o=i.exec(a))!==null;){const c=mg[o[3]]??"float32";t[o[2]]={location:parseInt(o[1],10),format:c,stride:pg(c).stride,offset:0,instance:!1,start:0}}}}return t}function uo(r){var d,u;const e=/(^|[^/])@(group|binding)\(\d+\)[^;]+;/g,t=/@group\((\d+)\)/,s=/@binding\((\d+)\)/,n=/var(<[^>]+>)? (\w+)/,a=/:\s*(\w+)/,i=/struct\s+(\w+)\s*{([^}]+)}/g,o=/(\w+)\s*:\s*([\w\<\>]+)/g,c=/struct\s+(\w+)/,l=(d=r.match(e))==null?void 0:d.map(f=>({group:parseInt(f.match(t)[1],10),binding:parseInt(f.match(s)[1],10),name:f.match(n)[2],isUniform:f.match(n)[1]==="<uniform>",type:f.match(a)[1]}));if(!l)return{groups:[],structs:[]};const h=((u=r.match(i))==null?void 0:u.map(f=>{const p=f.match(c)[1],g=f.match(o).reduce((m,_)=>{const[b,x]=_.split(":");return m[b.trim()]=x.trim(),m},{});return g?{name:p,members:g}:null}).filter(({name:f})=>l.some(p=>p.type===f)))??[];return{groups:l,structs:h}}var An=(r=>(r[r.VERTEX=1]="VERTEX",r[r.FRAGMENT=2]="FRAGMENT",r[r.COMPUTE=4]="COMPUTE",r))(An||{});function yg({groups:r}){const e=[];for(let t=0;t<r.length;t++){const s=r[t];e[s.group]||(e[s.group]=[]),s.isUniform?e[s.group].push({binding:s.binding,visibility:An.VERTEX|An.FRAGMENT,buffer:{type:"uniform"}}):s.type==="sampler"?e[s.group].push({binding:s.binding,visibility:An.FRAGMENT,sampler:{type:"filtering"}}):s.type==="texture_2d"&&e[s.group].push({binding:s.binding,visibility:An.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d",multisampled:!1}})}return e}function _g({groups:r}){const e=[];for(let t=0;t<r.length;t++){const s=r[t];e[s.group]||(e[s.group]={}),e[s.group][s.name]=s.binding}return e}function bg(r,e){const t=new Set,s=new Set,n=[...r.structs,...e.structs].filter(i=>t.has(i.name)?!1:(t.add(i.name),!0)),a=[...r.groups,...e.groups].filter(i=>{const o=`${i.name}-${i.binding}`;return s.has(o)?!1:(s.add(o),!0)});return{structs:n,groups:a}}const yn=Object.create(null);class Pi{constructor(e){var o,c;this._layoutKey=0,this._attributeLocationsKey=0;const{fragment:t,vertex:s,layout:n,gpuLayout:a,name:i}=e;if(this.name=i,this.fragment=t,this.vertex=s,t.source===s.source){const l=uo(t.source);this.structsAndGroups=l}else{const l=uo(s.source),h=uo(t.source);this.structsAndGroups=bg(l,h)}this.layout=n??_g(this.structsAndGroups),this.gpuLayout=a??yg(this.structsAndGroups),this.autoAssignGlobalUniforms=((o=this.layout[0])==null?void 0:o.globalUniforms)!==void 0,this.autoAssignLocalUniforms=((c=this.layout[1])==null?void 0:c.localUniforms)!==void 0,this._generateProgramKey()}_generateProgramKey(){const{vertex:e,fragment:t}=this,s=e.source+t.source+e.entryPoint+t.entryPoint;this._layoutKey=Bc(s,"program")}get attributeData(){return this._attributeData??(this._attributeData=gg(this.vertex)),this._attributeData}destroy(){this.gpuLayout=null,this.layout=null,this.structsAndGroups=null,this.fragment=null,this.vertex=null,yn[this._cacheKey]=null}static from(e){const t=`${e.vertex.source}:${e.fragment.source}:${e.fragment.entryPoint}:${e.vertex.entryPoint}`;return yn[t]||(yn[t]=new Pi(e),yn[t]._cacheKey=t),yn[t]}}const pu=["f32","i32","vec2<f32>","vec3<f32>","vec4<f32>","mat2x2<f32>","mat3x3<f32>","mat4x4<f32>","mat3x2<f32>","mat4x2<f32>","mat2x3<f32>","mat4x3<f32>","mat2x4<f32>","mat3x4<f32>","vec2<i32>","vec3<i32>","vec4<i32>"],xg=pu.reduce((r,e)=>(r[e]=!0,r),{});function wg(r,e){switch(r){case"f32":return 0;case"vec2<f32>":return new Float32Array(2*e);case"vec3<f32>":return new Float32Array(3*e);case"vec4<f32>":return new Float32Array(4*e);case"mat2x2<f32>":return new Float32Array([1,0,0,1]);case"mat3x3<f32>":return new Float32Array([1,0,0,0,1,0,0,0,1]);case"mat4x4<f32>":return new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return null}const mu=class gu{constructor(e,t){this._touched=0,this.uid=je("uniform"),this._resourceType="uniformGroup",this._resourceId=je("resource"),this.isUniformGroup=!0,this._dirtyId=0,this.destroyed=!1,t={...gu.defaultOptions,...t},this.uniformStructures=e;const s={};for(const n in e){const a=e[n];if(a.name=n,a.size=a.size??1,!xg[a.type]){const i=a.type.match(/^array<(\w+(?:<\w+>)?),\s*(\d+)>$/);if(i){const[,o,c]=i;throw new Error(`Uniform type ${a.type} is not supported. Use type: '${o}', size: ${c} instead.`)}throw new Error(`Uniform type ${a.type} is not supported. Supported uniform types are: ${pu.join(", ")}`)}a.value??(a.value=wg(a.type,a.size)),s[n]=a.value}this.uniforms=s,this._dirtyId=1,this.ubo=t.ubo,this.isStatic=t.isStatic,this._signature=Bc(Object.keys(s).map(n=>`${n}-${e[n].type}`).join("-"),"uniform-group")}update(){this._dirtyId++}};mu.defaultOptions={ubo:!1,isStatic:!1};let yu=mu;class ai{constructor(e){this.resources=Object.create(null),this._dirty=!0;let t=0;for(const s in e){const n=e[s];this.setResource(n,t++)}this._updateKey()}_updateKey(){if(!this._dirty)return;this._dirty=!1;const e=[];let t=0;for(const s in this.resources)e[t++]=this.resources[s]._resourceId;this._key=e.join("|")}setResource(e,t){var n,a;const s=this.resources[t];e!==s&&(s&&((n=e.off)==null||n.call(e,"change",this.onResourceChange,this)),(a=e.on)==null||a.call(e,"change",this.onResourceChange,this),this.resources[t]=e,this._dirty=!0)}getResource(e){return this.resources[e]}_touch(e){const t=this.resources;for(const s in t)t[s]._touched=e}destroy(){var t;const e=this.resources;for(const s in e){const n=e[s];(t=n==null?void 0:n.off)==null||t.call(n,"change",this.onResourceChange,this)}this.resources=null}onResourceChange(e){if(this._dirty=!0,e.destroyed){const t=this.resources;for(const s in t)t[s]===e&&(t[s]=null)}else this._updateKey()}}var Qo=(r=>(r[r.WEBGL=1]="WEBGL",r[r.WEBGPU=2]="WEBGPU",r[r.BOTH=3]="BOTH",r))(Qo||{});class Dc extends qt{constructor(e){super(),this.uid=je("shader"),this._uniformBindMap=Object.create(null),this._ownedBindGroups=[];let{gpuProgram:t,glProgram:s,groups:n,resources:a,compatibleRenderers:i,groupMap:o}=e;this.gpuProgram=t,this.glProgram=s,i===void 0&&(i=0,t&&(i|=Qo.WEBGPU),s&&(i|=Qo.WEBGL)),this.compatibleRenderers=i;const c={};if(!a&&!n&&(a={}),a&&n)throw new Error("[Shader] Cannot have both resources and groups");if(!t&&n&&!o)throw new Error("[Shader] No group map or WebGPU shader provided - consider using resources instead.");if(!t&&n&&o)for(const l in o)for(const h in o[l]){const d=o[l][h];c[d]={group:l,binding:h,name:d}}else if(t&&n&&!o){const l=t.structsAndGroups.groups;o={},l.forEach(h=>{o[h.group]=o[h.group]||{},o[h.group][h.binding]=h.name,c[h.name]=h})}else if(a){n={},o={},t&&t.structsAndGroups.groups.forEach(d=>{o[d.group]=o[d.group]||{},o[d.group][d.binding]=d.name,c[d.name]=d});let l=0;for(const h in a)c[h]||(n[99]||(n[99]=new ai,this._ownedBindGroups.push(n[99])),c[h]={group:99,binding:l,name:h},o[99]=o[99]||{},o[99][l]=h,l++);for(const h in a){const d=h;let u=a[h];!u.source&&!u._resourceType&&(u=new yu(u));const f=c[d];f&&(n[f.group]||(n[f.group]=new ai,this._ownedBindGroups.push(n[f.group])),n[f.group].setResource(u,f.binding))}}this.groups=n,this._uniformBindMap=o,this.resources=this._buildResourceAccessor(n,c)}addResource(e,t,s){var n,a;(n=this._uniformBindMap)[t]||(n[t]={}),(a=this._uniformBindMap[t])[s]||(a[s]=e),this.groups[t]||(this.groups[t]=new ai,this._ownedBindGroups.push(this.groups[t]))}_buildResourceAccessor(e,t){const s={};for(const n in t){const a=t[n];Object.defineProperty(s,a.name,{get(){return e[a.group].getResource(a.binding)},set(i){e[a.group].setResource(i,a.binding)}})}return s}destroy(e=!1){var t,s;this.emit("destroy",this),e&&((t=this.gpuProgram)==null||t.destroy(),(s=this.glProgram)==null||s.destroy()),this.gpuProgram=null,this.glProgram=null,this.removeAllListeners(),this._uniformBindMap=null,this._ownedBindGroups.forEach(n=>{n.destroy()}),this._ownedBindGroups=null,this.resources=null,this.groups=null}static from(e){const{gpu:t,gl:s,...n}=e;let a,i;return t&&(a=Pi.from(t)),s&&(i=fu.from(s)),new Dc({gpuProgram:a,glProgram:i,...n})}}const Zo=[];at.handleByNamedList(J.Environment,Zo);async function vg(r){if(!r)for(let e=0;e<Zo.length;e++){const t=Zo[e];if(t.value.test()){await t.value.load();return}}}let _n;function Sg(){if(typeof _n=="boolean")return _n;try{_n=new Function("param1","param2","param3","return param1[param2] === param3;")({a:"b"},"a","b")===!0}catch{_n=!1}return _n}function Vl(r,e,t=2){const s=e&&e.length,n=s?e[0]*t:r.length;let a=_u(r,0,n,t,!0);const i=[];if(!a||a.next===a.prev)return i;let o,c,l;if(s&&(a=Eg(r,e,a,t)),r.length>80*t){o=r[0],c=r[1];let h=o,d=c;for(let u=t;u<n;u+=t){const f=r[u],p=r[u+1];f<o&&(o=f),p<c&&(c=p),f>h&&(h=f),p>d&&(d=p)}l=Math.max(h-o,d-c),l=l!==0?32767/l:0}return jn(a,i,t,o,c,l,0),i}function _u(r,e,t,s,n){let a;if(n===jg(r,e,t,s)>0)for(let i=e;i<t;i+=s)a=Wl(i/s|0,r[i],r[i+1],a);else for(let i=t-s;i>=e;i-=s)a=Wl(i/s|0,r[i],r[i+1],a);return a&&Gs(a,a.next)&&(Hn(a),a=a.next),a}function ds(r,e){if(!r)return r;e||(e=r);let t=r,s;do if(s=!1,!t.steiner&&(Gs(t,t.next)||Le(t.prev,t,t.next)===0)){if(Hn(t),t=e=t.prev,t===t.next)break;s=!0}else t=t.next;while(s||t!==e);return e}function jn(r,e,t,s,n,a,i){if(!r)return;!i&&a&&$g(r,s,n,a);let o=r;for(;r.prev!==r.next;){const c=r.prev,l=r.next;if(a?Ig(r,s,n,a):kg(r)){e.push(c.i,r.i,l.i),Hn(r),r=l.next,o=l.next;continue}if(r=l,r===o){i?i===1?(r=Ag(ds(r),e),jn(r,e,t,s,n,a,2)):i===2&&Cg(r,e,t,s,n,a):jn(ds(r),e,t,s,n,a,1);break}}}function kg(r){const e=r.prev,t=r,s=r.next;if(Le(e,t,s)>=0)return!1;const n=e.x,a=t.x,i=s.x,o=e.y,c=t.y,l=s.y,h=Math.min(n,a,i),d=Math.min(o,c,l),u=Math.max(n,a,i),f=Math.max(o,c,l);let p=s.next;for(;p!==e;){if(p.x>=h&&p.x<=u&&p.y>=d&&p.y<=f&&Cn(n,o,a,c,i,l,p.x,p.y)&&Le(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function Ig(r,e,t,s){const n=r.prev,a=r,i=r.next;if(Le(n,a,i)>=0)return!1;const o=n.x,c=a.x,l=i.x,h=n.y,d=a.y,u=i.y,f=Math.min(o,c,l),p=Math.min(h,d,u),g=Math.max(o,c,l),m=Math.max(h,d,u),_=ec(f,p,e,t,s),b=ec(g,m,e,t,s);let x=r.prevZ,S=r.nextZ;for(;x&&x.z>=_&&S&&S.z<=b;){if(x.x>=f&&x.x<=g&&x.y>=p&&x.y<=m&&x!==n&&x!==i&&Cn(o,h,c,d,l,u,x.x,x.y)&&Le(x.prev,x,x.next)>=0||(x=x.prevZ,S.x>=f&&S.x<=g&&S.y>=p&&S.y<=m&&S!==n&&S!==i&&Cn(o,h,c,d,l,u,S.x,S.y)&&Le(S.prev,S,S.next)>=0))return!1;S=S.nextZ}for(;x&&x.z>=_;){if(x.x>=f&&x.x<=g&&x.y>=p&&x.y<=m&&x!==n&&x!==i&&Cn(o,h,c,d,l,u,x.x,x.y)&&Le(x.prev,x,x.next)>=0)return!1;x=x.prevZ}for(;S&&S.z<=b;){if(S.x>=f&&S.x<=g&&S.y>=p&&S.y<=m&&S!==n&&S!==i&&Cn(o,h,c,d,l,u,S.x,S.y)&&Le(S.prev,S,S.next)>=0)return!1;S=S.nextZ}return!0}function Ag(r,e){let t=r;do{const s=t.prev,n=t.next.next;!Gs(s,n)&&xu(s,t,t.next,n)&&Nn(s,n)&&Nn(n,s)&&(e.push(s.i,t.i,n.i),Hn(t),Hn(t.next),t=r=n),t=t.next}while(t!==r);return ds(t)}function Cg(r,e,t,s,n,a){let i=r;do{let o=i.next.next;for(;o!==i.prev;){if(i.i!==o.i&&Dg(i,o)){let c=wu(i,o);i=ds(i,i.next),c=ds(c,c.next),jn(i,e,t,s,n,a,0),jn(c,e,t,s,n,a,0);return}o=o.next}i=i.next}while(i!==r)}function Eg(r,e,t,s){const n=[];for(let a=0,i=e.length;a<i;a++){const o=e[a]*s,c=a<i-1?e[a+1]*s:r.length,l=_u(r,o,c,s,!1);l===l.next&&(l.steiner=!0),n.push(Bg(l))}n.sort(Tg);for(let a=0;a<n.length;a++)t=Pg(n[a],t);return t}function Tg(r,e){let t=r.x-e.x;if(t===0&&(t=r.y-e.y,t===0)){const s=(r.next.y-r.y)/(r.next.x-r.x),n=(e.next.y-e.y)/(e.next.x-e.x);t=s-n}return t}function Pg(r,e){const t=Rg(r,e);if(!t)return e;const s=wu(t,r);return ds(s,s.next),ds(t,t.next)}function Rg(r,e){let t=e;const s=r.x,n=r.y;let a=-1/0,i;if(Gs(r,t))return t;do{if(Gs(r,t.next))return t.next;if(n<=t.y&&n>=t.next.y&&t.next.y!==t.y){const d=t.x+(n-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(d<=s&&d>a&&(a=d,i=t.x<t.next.x?t:t.next,d===s))return i}t=t.next}while(t!==e);if(!i)return null;const o=i,c=i.x,l=i.y;let h=1/0;t=i;do{if(s>=t.x&&t.x>=c&&s!==t.x&&bu(n<l?s:a,n,c,l,n<l?a:s,n,t.x,t.y)){const d=Math.abs(n-t.y)/(s-t.x);Nn(t,r)&&(d<h||d===h&&(t.x>i.x||t.x===i.x&&Mg(i,t)))&&(i=t,h=d)}t=t.next}while(t!==o);return i}function Mg(r,e){return Le(r.prev,r,e.prev)<0&&Le(e.next,r,r.next)<0}function $g(r,e,t,s){let n=r;do n.z===0&&(n.z=ec(n.x,n.y,e,t,s)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next;while(n!==r);n.prevZ.nextZ=null,n.prevZ=null,Og(n)}function Og(r){let e,t=1;do{let s=r,n;r=null;let a=null;for(e=0;s;){e++;let i=s,o=0;for(let l=0;l<t&&(o++,i=i.nextZ,!!i);l++);let c=t;for(;o>0||c>0&&i;)o!==0&&(c===0||!i||s.z<=i.z)?(n=s,s=s.nextZ,o--):(n=i,i=i.nextZ,c--),a?a.nextZ=n:r=n,n.prevZ=a,a=n;s=i}a.nextZ=null,t*=2}while(e>1);return r}function ec(r,e,t,s,n){return r=(r-t)*n|0,e=(e-s)*n|0,r=(r|r<<8)&16711935,r=(r|r<<4)&252645135,r=(r|r<<2)&858993459,r=(r|r<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,r|e<<1}function Bg(r){let e=r,t=r;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==r);return t}function bu(r,e,t,s,n,a,i,o){return(n-i)*(e-o)>=(r-i)*(a-o)&&(r-i)*(s-o)>=(t-i)*(e-o)&&(t-i)*(a-o)>=(n-i)*(s-o)}function Cn(r,e,t,s,n,a,i,o){return!(r===i&&e===o)&&bu(r,e,t,s,n,a,i,o)}function Dg(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!Lg(r,e)&&(Nn(r,e)&&Nn(e,r)&&Fg(r,e)&&(Le(r.prev,r,e.prev)||Le(r,e.prev,e))||Gs(r,e)&&Le(r.prev,r,r.next)>0&&Le(e.prev,e,e.next)>0)}function Le(r,e,t){return(e.y-r.y)*(t.x-e.x)-(e.x-r.x)*(t.y-e.y)}function Gs(r,e){return r.x===e.x&&r.y===e.y}function xu(r,e,t,s){const n=Aa(Le(r,e,t)),a=Aa(Le(r,e,s)),i=Aa(Le(t,s,r)),o=Aa(Le(t,s,e));return!!(n!==a&&i!==o||n===0&&Ia(r,t,e)||a===0&&Ia(r,s,e)||i===0&&Ia(t,r,s)||o===0&&Ia(t,e,s))}function Ia(r,e,t){return e.x<=Math.max(r.x,t.x)&&e.x>=Math.min(r.x,t.x)&&e.y<=Math.max(r.y,t.y)&&e.y>=Math.min(r.y,t.y)}function Aa(r){return r>0?1:r<0?-1:0}function Lg(r,e){let t=r;do{if(t.i!==r.i&&t.next.i!==r.i&&t.i!==e.i&&t.next.i!==e.i&&xu(t,t.next,r,e))return!0;t=t.next}while(t!==r);return!1}function Nn(r,e){return Le(r.prev,r,r.next)<0?Le(r,e,r.next)>=0&&Le(r,r.prev,e)>=0:Le(r,e,r.prev)<0||Le(r,r.next,e)<0}function Fg(r,e){let t=r,s=!1;const n=(r.x+e.x)/2,a=(r.y+e.y)/2;do t.y>a!=t.next.y>a&&t.next.y!==t.y&&n<(t.next.x-t.x)*(a-t.y)/(t.next.y-t.y)+t.x&&(s=!s),t=t.next;while(t!==r);return s}function wu(r,e){const t=tc(r.i,r.x,r.y),s=tc(e.i,e.x,e.y),n=r.next,a=e.prev;return r.next=e,e.prev=r,t.next=n,n.prev=t,s.next=t,t.prev=s,a.next=s,s.prev=a,s}function Wl(r,e,t,s){const n=tc(r,e,t);return s?(n.next=s.next,n.prev=s,s.next.prev=n,s.next=n):(n.prev=n,n.next=n),n}function Hn(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function tc(r,e,t){return{i:r,x:e,y:t,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function jg(r,e,t,s){let n=0;for(let a=e,i=t-s;a<t;a+=s)n+=(r[i]-r[a])*(r[a+1]+r[i+1]),i=a;return n}const Ng=Vl.default||Vl;var vu=(r=>(r[r.NONE=0]="NONE",r[r.COLOR=16384]="COLOR",r[r.STENCIL=1024]="STENCIL",r[r.DEPTH=256]="DEPTH",r[r.COLOR_DEPTH=16640]="COLOR_DEPTH",r[r.COLOR_STENCIL=17408]="COLOR_STENCIL",r[r.DEPTH_STENCIL=1280]="DEPTH_STENCIL",r[r.ALL=17664]="ALL",r))(vu||{});class Hg{constructor(e){this.items=[],this._name=e}emit(e,t,s,n,a,i,o,c){const{name:l,items:h}=this;for(let d=0,u=h.length;d<u;d++)h[d][l](e,t,s,n,a,i,o,c);return this}add(e){return e[this._name]&&(this.remove(e),this.items.push(e)),this}remove(e){const t=this.items.indexOf(e);return t!==-1&&this.items.splice(t,1),this}contains(e){return this.items.indexOf(e)!==-1}removeAll(){return this.items.length=0,this}destroy(){this.removeAll(),this.items=null,this._name=null}get empty(){return this.items.length===0}get name(){return this._name}}const Ug=["init","destroy","contextChange","resolutionChange","resetState","renderEnd","renderStart","render","update","postrender","prerender"],Su=class ku extends qt{constructor(e){super(),this.uid=je("renderer"),this.runners=Object.create(null),this.renderPipes=Object.create(null),this._initOptions={},this._systemsHash=Object.create(null),this.type=e.type,this.name=e.name,this.config=e;const t=[...Ug,...this.config.runners??[]];this._addRunners(...t),this._unsafeEvalCheck()}async init(e={}){const t=e.skipExtensionImports===!0?!0:e.manageImports===!1;await vg(t),this._addSystems(this.config.systems),this._addPipes(this.config.renderPipes,this.config.renderPipeAdaptors);for(const s in this._systemsHash)e={...this._systemsHash[s].constructor.defaultOptions,...e};e={...ku.defaultOptions,...e},this._roundPixels=e.roundPixels?1:0;for(let s=0;s<this.runners.init.items.length;s++)await this.runners.init.items[s].init(e);this._initOptions=e}render(e,t){let s=e;if(s instanceof ve&&(s={container:s},t&&(he(_e,"passing a second argument is deprecated, please use render options instead"),s.target=t.renderTexture)),s.target||(s.target=this.view.renderTarget),s.target===this.view.renderTarget&&(this._lastObjectRendered=s.container,s.clearColor??(s.clearColor=this.background.colorRgba),s.clear??(s.clear=this.background.clearBeforeRender)),s.clearColor){const n=Array.isArray(s.clearColor)&&s.clearColor.length===4;s.clearColor=n?s.clearColor:qe.shared.setValue(s.clearColor).toArray()}s.transform||(s.container.updateLocalTransform(),s.transform=s.container.localTransform),s.container.visible&&(s.container.enableRenderGroup(),this.runners.prerender.emit(s),this.runners.renderStart.emit(s),this.runners.render.emit(s),this.runners.renderEnd.emit(s),this.runners.postrender.emit(s))}resize(e,t,s){const n=this.view.resolution;this.view.resize(e,t,s),this.emit("resize",this.view.screen.width,this.view.screen.height,this.view.resolution),s!==void 0&&s!==n&&this.runners.resolutionChange.emit(s)}clear(e={}){const t=this;e.target||(e.target=t.renderTarget.renderTarget),e.clearColor||(e.clearColor=this.background.colorRgba),e.clear??(e.clear=vu.ALL);const{clear:s,clearColor:n,target:a}=e;qe.shared.setValue(n??this.background.colorRgba),t.renderTarget.clear(a,s,qe.shared.toArray())}get resolution(){return this.view.resolution}set resolution(e){this.view.resolution=e,this.runners.resolutionChange.emit(e)}get width(){return this.view.texture.frame.width}get height(){return this.view.texture.frame.height}get canvas(){return this.view.canvas}get lastObjectRendered(){return this._lastObjectRendered}get renderingToScreen(){return this.renderTarget.renderingToScreen}get screen(){return this.view.screen}_addRunners(...e){e.forEach(t=>{this.runners[t]=new Hg(t)})}_addSystems(e){let t;for(t in e){const s=e[t];this._addSystem(s.value,s.name)}}_addSystem(e,t){const s=new e(this);if(this[t])throw new Error(`Whoops! The name "${t}" is already in use`);this[t]=s,this._systemsHash[t]=s;for(const n in this.runners)this.runners[n].add(s);return this}_addPipes(e,t){const s=t.reduce((n,a)=>(n[a.name]=a.value,n),{});e.forEach(n=>{const a=n.value,i=n.name,o=s[i];this.renderPipes[i]=new a(this,o?new o:null),this.runners.destroy.add(this.renderPipes[i])})}destroy(e=!1){this.runners.destroy.items.reverse(),this.runners.destroy.emit(e),Object.values(this.runners).forEach(t=>{t.destroy()}),(e===!0||typeof e=="object"&&e.releaseGlobalResources)&&Kn.release(),this._systemsHash=null,this.renderPipes=null}generateTexture(e){return this.textureGenerator.generateTexture(e)}get roundPixels(){return!!this._roundPixels}_unsafeEvalCheck(){if(!Sg())throw new Error("Current environment does not allow unsafe-eval, please use pixi.js/unsafe-eval module to enable support.")}resetState(){this.runners.resetState.emit()}};Su.defaultOptions={resolution:1,failIfMajorPerformanceCaveat:!1,roundPixels:!1};let Iu=Su,Ca;function Gg(r){return Ca!==void 0||(Ca=(()=>{var t;const e={stencil:!0,failIfMajorPerformanceCaveat:r??Iu.defaultOptions.failIfMajorPerformanceCaveat};try{if(!ke.get().getWebGLRenderingContext())return!1;let n=ke.get().createCanvas().getContext("webgl",e);const a=!!((t=n==null?void 0:n.getContextAttributes())!=null&&t.stencil);if(n){const i=n.getExtension("WEBGL_lose_context");i&&i.loseContext()}return n=null,a}catch{return!1}})()),Ca}let Ea;async function zg(r={}){return Ea!==void 0||(Ea=await(async()=>{const e=ke.get().getNavigator().gpu;if(!e)return!1;try{return await(await e.requestAdapter(r)).requestDevice(),!0}catch{return!1}})()),Ea}const ql=["webgl","webgpu","canvas"];async function Vg(r){let e=[];r.preference?(e.push(r.preference),ql.forEach(a=>{a!==r.preference&&e.push(a)})):e=ql.slice();let t,s={};for(let a=0;a<e.length;a++){const i=e[a];if(i==="webgpu"&&await zg()){const{WebGPURenderer:o}=await fi(async()=>{const{WebGPURenderer:c}=await import("./WebGPURenderer-DtnNeq-x.js");return{WebGPURenderer:c}},__vite__mapDeps([3,2,4]));t=o,s={...r,...r.webgpu};break}else if(i==="webgl"&&Gg(r.failIfMajorPerformanceCaveat??Iu.defaultOptions.failIfMajorPerformanceCaveat)){const{WebGLRenderer:o}=await fi(async()=>{const{WebGLRenderer:c}=await import("./WebGLRenderer-CehUSIvP.js");return{WebGLRenderer:c}},__vite__mapDeps([5,2,4]));t=o,s={...r,...r.webgl};break}else if(i==="canvas")throw s={...r},new Error("CanvasRenderer is not yet implemented")}if(delete s.webgpu,delete s.webgl,!t)throw new Error("No available renderer for the current environment");const n=new t;return await n.init(s),n}const Au="8.14.0";class Cu{static init(){var e;(e=globalThis.__PIXI_APP_INIT__)==null||e.call(globalThis,this,Au)}static destroy(){}}Cu.extension=J.Application;class Wg{constructor(e){this._renderer=e}init(){var e;(e=globalThis.__PIXI_RENDERER_INIT__)==null||e.call(globalThis,this._renderer,Au)}destroy(){this._renderer=null}}Wg.extension={type:[J.WebGLSystem,J.WebGPUSystem],name:"initHook",priority:-10};const Eu=class rc{constructor(...e){this.stage=new ve,e[0]!==void 0&&he(_e,"Application constructor options are deprecated, please use Application.init() instead.")}async init(e){e={...e},this.renderer=await Vg(e),rc._plugins.forEach(t=>{t.init.call(this,e)})}render(){this.renderer.render({container:this.stage})}get canvas(){return this.renderer.canvas}get view(){return he(_e,"Application.view is deprecated, please use Application.canvas instead."),this.renderer.canvas}get screen(){return this.renderer.screen}destroy(e=!1,t=!1){const s=rc._plugins.slice(0);s.reverse(),s.forEach(n=>{n.destroy.call(this)}),this.stage.destroy(t),this.stage=null,this.renderer.destroy(e),this.renderer=null}};Eu._plugins=[];let Tu=Eu;at.handleByList(J.Application,Tu._plugins);at.add(Cu);class Pu extends qt{constructor(){super(...arguments),this.chars=Object.create(null),this.lineHeight=0,this.fontFamily="",this.fontMetrics={fontSize:0,ascent:0,descent:0},this.baseLineOffset=0,this.distanceField={type:"none",range:0},this.pages=[],this.applyFillAsTint=!0,this.baseMeasurementFontSize=100,this.baseRenderedFontSize=100}get font(){return he(_e,"BitmapFont.font is deprecated, please use BitmapFont.fontFamily instead."),this.fontFamily}get pageTextures(){return he(_e,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}get size(){return he(_e,"BitmapFont.size is deprecated, please use BitmapFont.fontMetrics.fontSize instead."),this.fontMetrics.fontSize}get distanceFieldRange(){return he(_e,"BitmapFont.distanceFieldRange is deprecated, please use BitmapFont.distanceField.range instead."),this.distanceField.range}get distanceFieldType(){return he(_e,"BitmapFont.distanceFieldType is deprecated, please use BitmapFont.distanceField.type instead."),this.distanceField.type}destroy(e=!1){var t;this.emit("destroy",this),this.removeAllListeners();for(const s in this.chars)(t=this.chars[s].texture)==null||t.destroy();this.chars=null,e&&(this.pages.forEach(s=>s.texture.destroy(!0)),this.pages=null)}}/**
 * tiny-lru
 *
 * @copyright 2025 Jason Mulligan <jason.mulligan@avoidwork.com>
 * @license BSD-3-Clause
 * @version 11.4.5
 */class qg{constructor(e=0,t=0,s=!1){this.first=null,this.items=Object.create(null),this.last=null,this.max=e,this.resetTtl=s,this.size=0,this.ttl=t}clear(){return this.first=null,this.items=Object.create(null),this.last=null,this.size=0,this}delete(e){if(this.has(e)){const t=this.items[e];delete this.items[e],this.size--,t.prev!==null&&(t.prev.next=t.next),t.next!==null&&(t.next.prev=t.prev),this.first===t&&(this.first=t.next),this.last===t&&(this.last=t.prev)}return this}entries(e=this.keys()){return e.map(t=>[t,this.get(t)])}evict(e=!1){if(e||this.size>0){const t=this.first;delete this.items[t.key],--this.size===0?(this.first=null,this.last=null):(this.first=t.next,this.first.prev=null)}return this}expiresAt(e){let t;return this.has(e)&&(t=this.items[e].expiry),t}get(e){const t=this.items[e];if(t!==void 0){if(this.ttl>0&&t.expiry<=Date.now()){this.delete(e);return}return this.moveToEnd(t),t.value}}has(e){return e in this.items}moveToEnd(e){this.last!==e&&(e.prev!==null&&(e.prev.next=e.next),e.next!==null&&(e.next.prev=e.prev),this.first===e&&(this.first=e.next),e.prev=this.last,e.next=null,this.last!==null&&(this.last.next=e),this.last=e,this.first===null&&(this.first=e))}keys(){const e=[];let t=this.first;for(;t!==null;)e.push(t.key),t=t.next;return e}setWithEvicted(e,t,s=this.resetTtl){let n=null;if(this.has(e))this.set(e,t,!0,s);else{this.max>0&&this.size===this.max&&(n={...this.first},this.evict(!0));let a=this.items[e]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:e,prev:this.last,next:null,value:t};++this.size===1?this.first=a:this.last.next=a,this.last=a}return n}set(e,t,s=!1,n=this.resetTtl){let a=this.items[e];return s||a!==void 0?(a.value=t,s===!1&&n&&(a.expiry=this.ttl>0?Date.now()+this.ttl:this.ttl),this.moveToEnd(a)):(this.max>0&&this.size===this.max&&this.evict(!0),a=this.items[e]={expiry:this.ttl>0?Date.now()+this.ttl:this.ttl,key:e,prev:this.last,next:null,value:t},++this.size===1?this.first=a:this.last.next=a,this.last=a),this}values(e=this.keys()){return e.map(t=>this.get(t))}}function Ru(r=1e3,e=0,t=!1){if(isNaN(r)||r<0)throw new TypeError("Invalid max value");if(isNaN(e)||e<0)throw new TypeError("Invalid ttl value");if(typeof t!="boolean")throw new TypeError("Invalid resetTtl value");return new qg(r,e,t)}const Xg=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];function mi(r){const e=typeof r.fontSize=="number"?`${r.fontSize}px`:r.fontSize;let t=r.fontFamily;Array.isArray(r.fontFamily)||(t=r.fontFamily.split(","));for(let s=t.length-1;s>=0;s--){let n=t[s].trim();!/([\"\'])[^\'\"]+\1/.test(n)&&!Xg.includes(n)&&(n=`"${n}"`),t[s]=n}return`${r.fontStyle} ${r.fontVariant} ${r.fontWeight} ${e} ${t.join(",")}`}const fo={willReadFrequently:!0},Yt=class W{static get experimentalLetterSpacingSupported(){let e=W._experimentalLetterSpacingSupported;if(e===void 0){const t=ke.get().getCanvasRenderingContext2D().prototype;e=W._experimentalLetterSpacingSupported="letterSpacing"in t||"textLetterSpacing"in t}return e}constructor(e,t,s,n,a,i,o,c,l){this.text=e,this.style=t,this.width=s,this.height=n,this.lines=a,this.lineWidths=i,this.lineHeight=o,this.maxLineWidth=c,this.fontProperties=l}static measureText(e=" ",t,s=W._canvas,n=t.wordWrap){var b;const a=`${e}-${t.styleKey}-wordWrap-${n}`;if(W._measurementCache.has(a))return W._measurementCache.get(a);const i=mi(t),o=W.measureFont(i);o.fontSize===0&&(o.fontSize=t.fontSize,o.ascent=t.fontSize);const c=W.__context;c.font=i;const h=(n?W._wordWrap(e,t,s):e).split(/(?:\r\n|\r|\n)/),d=new Array(h.length);let u=0;for(let x=0;x<h.length;x++){const S=W._measureText(h[x],t.letterSpacing,c);d[x]=S,u=Math.max(u,S)}const f=((b=t._stroke)==null?void 0:b.width)||0;let p=u+f;t.dropShadow&&(p+=t.dropShadow.distance);const g=t.lineHeight||o.fontSize;let m=Math.max(g,o.fontSize+f)+(h.length-1)*(g+t.leading);t.dropShadow&&(m+=t.dropShadow.distance);const _=new W(e,t,p,m,h,d,g+t.leading,u,o);return W._measurementCache.set(a,_),_}static _measureText(e,t,s){let n=!1;W.experimentalLetterSpacingSupported&&(W.experimentalLetterSpacing?(s.letterSpacing=`${t}px`,s.textLetterSpacing=`${t}px`,n=!0):(s.letterSpacing="0px",s.textLetterSpacing="0px"));const a=s.measureText(e);let i=a.width;const o=-a.actualBoundingBoxLeft;let l=a.actualBoundingBoxRight-o;if(i>0)if(n)i-=t,l-=t;else{const h=(W.graphemeSegmenter(e).length-1)*t;i+=h,l+=h}return Math.max(i,l)}static _wordWrap(e,t,s=W._canvas){const n=s.getContext("2d",fo);let a=0,i="",o="";const c=Object.create(null),{letterSpacing:l,whiteSpace:h}=t,d=W._collapseSpaces(h),u=W._collapseNewlines(h);let f=!d;const p=t.wordWrapWidth+l,g=W._tokenize(e);for(let m=0;m<g.length;m++){let _=g[m];if(W._isNewline(_)){if(!u){o+=W._addLine(i),f=!d,i="",a=0;continue}_=" "}if(d){const x=W.isBreakingSpace(_),S=W.isBreakingSpace(i[i.length-1]);if(x&&S)continue}const b=W._getFromCache(_,l,c,n);if(b>p)if(i!==""&&(o+=W._addLine(i),i="",a=0),W.canBreakWords(_,t.breakWords)){const x=W.wordWrapSplit(_);for(let S=0;S<x.length;S++){let T=x[S],A=T,C=1;for(;x[S+C];){const $=x[S+C];if(!W.canBreakChars(A,$,_,S,t.breakWords))T+=$;else break;A=$,C++}S+=C-1;const R=W._getFromCache(T,l,c,n);R+a>p&&(o+=W._addLine(i),f=!1,i="",a=0),i+=T,a+=R}}else{i.length>0&&(o+=W._addLine(i),i="",a=0);const x=m===g.length-1;o+=W._addLine(_,!x),f=!1,i="",a=0}else b+a>p&&(f=!1,o+=W._addLine(i),i="",a=0),(i.length>0||!W.isBreakingSpace(_)||f)&&(i+=_,a+=b)}return o+=W._addLine(i,!1),o}static _addLine(e,t=!0){return e=W._trimRight(e),e=t?`${e}
`:e,e}static _getFromCache(e,t,s,n){let a=s[e];return typeof a!="number"&&(a=W._measureText(e,t,n)+t,s[e]=a),a}static _collapseSpaces(e){return e==="normal"||e==="pre-line"}static _collapseNewlines(e){return e==="normal"}static _trimRight(e){if(typeof e!="string")return"";for(let t=e.length-1;t>=0;t--){const s=e[t];if(!W.isBreakingSpace(s))break;e=e.slice(0,-1)}return e}static _isNewline(e){return typeof e!="string"?!1:W._newlines.includes(e.charCodeAt(0))}static isBreakingSpace(e,t){return typeof e!="string"?!1:W._breakingSpaces.includes(e.charCodeAt(0))}static _tokenize(e){const t=[];let s="";if(typeof e!="string")return t;for(let n=0;n<e.length;n++){const a=e[n],i=e[n+1];if(W.isBreakingSpace(a,i)||W._isNewline(a)){s!==""&&(t.push(s),s=""),a==="\r"&&i===`
`?(t.push(`\r
`),n++):t.push(a);continue}s+=a}return s!==""&&t.push(s),t}static canBreakWords(e,t){return t}static canBreakChars(e,t,s,n,a){return!0}static wordWrapSplit(e){return W.graphemeSegmenter(e)}static measureFont(e){if(W._fonts[e])return W._fonts[e];const t=W._context;t.font=e;const s=t.measureText(W.METRICS_STRING+W.BASELINE_SYMBOL),n={ascent:s.actualBoundingBoxAscent,descent:s.actualBoundingBoxDescent,fontSize:s.actualBoundingBoxAscent+s.actualBoundingBoxDescent};return W._fonts[e]=n,n}static clearMetrics(e=""){e?delete W._fonts[e]:W._fonts={}}static get _canvas(){if(!W.__canvas){let e;try{const t=new OffscreenCanvas(0,0),s=t.getContext("2d",fo);if(s!=null&&s.measureText)return W.__canvas=t,t;e=ke.get().createCanvas()}catch{e=ke.get().createCanvas()}e.width=e.height=10,W.__canvas=e}return W.__canvas}static get _context(){return W.__context||(W.__context=W._canvas.getContext("2d",fo)),W.__context}};Yt.METRICS_STRING="|q";Yt.BASELINE_SYMBOL="M";Yt.BASELINE_MULTIPLIER=1.4;Yt.HEIGHT_MULTIPLIER=2;Yt.graphemeSegmenter=(()=>{if(typeof(Intl==null?void 0:Intl.Segmenter)=="function"){const r=new Intl.Segmenter;return e=>{const t=r.segment(e),s=[];let n=0;for(const a of t)s[n++]=a.segment;return s}}return r=>[...r]})();Yt.experimentalLetterSpacing=!1;Yt._fonts={};Yt._newlines=[10,13];Yt._breakingSpaces=[9,32,8192,8193,8194,8195,8196,8197,8198,8200,8201,8202,8287,12288];Yt._measurementCache=Ru(1e3);let nr=Yt;const Xl=[{offset:0,color:"white"},{offset:1,color:"black"}],Lc=class sc{constructor(...e){this.uid=je("fillGradient"),this._tick=0,this.type="linear",this.colorStops=[];let t=Yg(e);t={...t.type==="radial"?sc.defaultRadialOptions:sc.defaultLinearOptions,...Bd(t)},this._textureSize=t.textureSize,this._wrapMode=t.wrapMode,t.type==="radial"?(this.center=t.center,this.outerCenter=t.outerCenter??this.center,this.innerRadius=t.innerRadius,this.outerRadius=t.outerRadius,this.scale=t.scale,this.rotation=t.rotation):(this.start=t.start,this.end=t.end),this.textureSpace=t.textureSpace,this.type=t.type,t.colorStops.forEach(n=>{this.addColorStop(n.offset,n.color)})}addColorStop(e,t){return this.colorStops.push({offset:e,color:qe.shared.setValue(t).toHexa()}),this}buildLinearGradient(){if(this.texture)return;let{x:e,y:t}=this.start,{x:s,y:n}=this.end,a=s-e,i=n-t;const o=a<0||i<0;if(this._wrapMode==="clamp-to-edge"){if(a<0){const m=e;e=s,s=m,a*=-1}if(i<0){const m=t;t=n,n=m,i*=-1}}const c=this.colorStops.length?this.colorStops:Xl,l=this._textureSize,{canvas:h,context:d}=Kl(l,1),u=o?d.createLinearGradient(this._textureSize,0,0,0):d.createLinearGradient(0,0,this._textureSize,0);Yl(u,c),d.fillStyle=u,d.fillRect(0,0,l,1),this.texture=new me({source:new hs({resource:h,addressMode:this._wrapMode})});const f=Math.sqrt(a*a+i*i),p=Math.atan2(i,a),g=new pe;g.scale(f/l,1),g.rotate(p),g.translate(e,t),this.textureSpace==="local"&&g.scale(l,l),this.transform=g}buildGradient(){this.texture||this._tick++,this.type==="linear"?this.buildLinearGradient():this.buildRadialGradient()}buildRadialGradient(){if(this.texture)return;const e=this.colorStops.length?this.colorStops:Xl,t=this._textureSize,{canvas:s,context:n}=Kl(t,t),{x:a,y:i}=this.center,{x:o,y:c}=this.outerCenter,l=this.innerRadius,h=this.outerRadius,d=o-h,u=c-h,f=t/(h*2),p=(a-d)*f,g=(i-u)*f,m=n.createRadialGradient(p,g,l*f,(o-d)*f,(c-u)*f,h*f);Yl(m,e),n.fillStyle=e[e.length-1].color,n.fillRect(0,0,t,t),n.fillStyle=m,n.translate(p,g),n.rotate(this.rotation),n.scale(1,this.scale),n.translate(-p,-g),n.fillRect(0,0,t,t),this.texture=new me({source:new hs({resource:s,addressMode:this._wrapMode})});const _=new pe;_.scale(1/f,1/f),_.translate(d,u),this.textureSpace==="local"&&_.scale(t,t),this.transform=_}destroy(){var e;(e=this.texture)==null||e.destroy(!0),this.texture=null,this.transform=null,this.colorStops=[],this.start=null,this.end=null,this.center=null,this.outerCenter=null}get styleKey(){return`fill-gradient-${this.uid}-${this._tick}`}};Lc.defaultLinearOptions={start:{x:0,y:0},end:{x:0,y:1},colorStops:[],textureSpace:"local",type:"linear",textureSize:256,wrapMode:"clamp-to-edge"};Lc.defaultRadialOptions={center:{x:.5,y:.5},innerRadius:0,outerRadius:.5,colorStops:[],scale:1,textureSpace:"local",type:"radial",textureSize:256,wrapMode:"clamp-to-edge"};let br=Lc;function Yl(r,e){for(let t=0;t<e.length;t++){const s=e[t];r.addColorStop(s.offset,s.color)}}function Kl(r,e){const t=ke.get().createCanvas(r,e),s=t.getContext("2d");return{canvas:t,context:s}}function Yg(r){let e=r[0]??{};return(typeof e=="number"||r[1])&&(he("8.5.2","use options object instead"),e={type:"linear",start:{x:r[0],y:r[1]},end:{x:r[2],y:r[3]},textureSpace:r[4],textureSize:r[5]??br.defaultLinearOptions.textureSize}),e}const Jl={repeat:{addressModeU:"repeat",addressModeV:"repeat"},"repeat-x":{addressModeU:"repeat",addressModeV:"clamp-to-edge"},"repeat-y":{addressModeU:"clamp-to-edge",addressModeV:"repeat"},"no-repeat":{addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}};class Ri{constructor(e,t){this.uid=je("fillPattern"),this._tick=0,this.transform=new pe,this.texture=e,this.transform.scale(1/e.frame.width,1/e.frame.height),t&&(e.source.style.addressModeU=Jl[t].addressModeU,e.source.style.addressModeV=Jl[t].addressModeV)}setTransform(e){const t=this.texture;this.transform.copyFrom(e),this.transform.invert(),this.transform.scale(1/t.frame.width,1/t.frame.height),this._tick++}get texture(){return this._texture}set texture(e){this._texture!==e&&(this._texture=e,this._tick++)}get styleKey(){return`fill-pattern-${this.uid}-${this._tick}`}destroy(){this.texture.destroy(!0),this.texture=null}}var Kg=Qg,po={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},Jg=/([astvzqmhlc])([^astvzqmhlc]*)/ig;function Qg(r){var e=[];return r.replace(Jg,function(t,s,n){var a=s.toLowerCase();for(n=ey(n),a=="m"&&n.length>2&&(e.push([s].concat(n.splice(0,2))),a="l",s=s=="m"?"l":"L");;){if(n.length==po[a])return n.unshift(s),e.push(n);if(n.length<po[a])throw new Error("malformed path data");e.push([s].concat(n.splice(0,po[a])))}}),e}var Zg=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function ey(r){var e=r.match(Zg);return e?e.map(Number):[]}const ty=Ei(Kg);function ry(r,e){const t=ty(r),s=[];let n=null,a=0,i=0;for(let o=0;o<t.length;o++){const c=t[o],l=c[0],h=c;switch(l){case"M":a=h[1],i=h[2],e.moveTo(a,i);break;case"m":a+=h[1],i+=h[2],e.moveTo(a,i);break;case"H":a=h[1],e.lineTo(a,i);break;case"h":a+=h[1],e.lineTo(a,i);break;case"V":i=h[1],e.lineTo(a,i);break;case"v":i+=h[1],e.lineTo(a,i);break;case"L":a=h[1],i=h[2],e.lineTo(a,i);break;case"l":a+=h[1],i+=h[2],e.lineTo(a,i);break;case"C":a=h[5],i=h[6],e.bezierCurveTo(h[1],h[2],h[3],h[4],a,i);break;case"c":e.bezierCurveTo(a+h[1],i+h[2],a+h[3],i+h[4],a+h[5],i+h[6]),a+=h[5],i+=h[6];break;case"S":a=h[3],i=h[4],e.bezierCurveToShort(h[1],h[2],a,i);break;case"s":e.bezierCurveToShort(a+h[1],i+h[2],a+h[3],i+h[4]),a+=h[3],i+=h[4];break;case"Q":a=h[3],i=h[4],e.quadraticCurveTo(h[1],h[2],a,i);break;case"q":e.quadraticCurveTo(a+h[1],i+h[2],a+h[3],i+h[4]),a+=h[3],i+=h[4];break;case"T":a=h[1],i=h[2],e.quadraticCurveToShort(a,i);break;case"t":a+=h[1],i+=h[2],e.quadraticCurveToShort(a,i);break;case"A":a=h[6],i=h[7],e.arcToSvg(h[1],h[2],h[3],h[4],h[5],a,i);break;case"a":a+=h[6],i+=h[7],e.arcToSvg(h[1],h[2],h[3],h[4],h[5],a,i);break;case"Z":case"z":e.closePath(),s.length>0&&(n=s.pop(),n?(a=n.startX,i=n.startY):(a=0,i=0)),n=null;break;default:Ae(`Unknown SVG path command: ${l}`)}l!=="Z"&&l!=="z"&&n===null&&(n={startX:a,startY:i},s.push(n))}return e}class Fc{constructor(e=0,t=0,s=0){this.type="circle",this.x=e,this.y=t,this.radius=s}clone(){return new Fc(this.x,this.y,this.radius)}contains(e,t){if(this.radius<=0)return!1;const s=this.radius*this.radius;let n=this.x-e,a=this.y-t;return n*=n,a*=a,n+a<=s}strokeContains(e,t,s,n=.5){if(this.radius===0)return!1;const a=this.x-e,i=this.y-t,o=this.radius,c=(1-n)*s,l=Math.sqrt(a*a+i*i);return l<=o+c&&l>o-(s-c)}getBounds(e){return e||(e=new Re),e.x=this.x-this.radius,e.y=this.y-this.radius,e.width=this.radius*2,e.height=this.radius*2,e}copyFrom(e){return this.x=e.x,this.y=e.y,this.radius=e.radius,this}copyTo(e){return e.copyFrom(this),e}toString(){return`[pixi.js/math:Circle x=${this.x} y=${this.y} radius=${this.radius}]`}}class jc{constructor(e=0,t=0,s=0,n=0){this.type="ellipse",this.x=e,this.y=t,this.halfWidth=s,this.halfHeight=n}clone(){return new jc(this.x,this.y,this.halfWidth,this.halfHeight)}contains(e,t){if(this.halfWidth<=0||this.halfHeight<=0)return!1;let s=(e-this.x)/this.halfWidth,n=(t-this.y)/this.halfHeight;return s*=s,n*=n,s+n<=1}strokeContains(e,t,s,n=.5){const{halfWidth:a,halfHeight:i}=this;if(a<=0||i<=0)return!1;const o=s*(1-n),c=s-o,l=a-c,h=i-c,d=a+o,u=i+o,f=e-this.x,p=t-this.y,g=f*f/(l*l)+p*p/(h*h),m=f*f/(d*d)+p*p/(u*u);return g>1&&m<=1}getBounds(e){return e||(e=new Re),e.x=this.x-this.halfWidth,e.y=this.y-this.halfHeight,e.width=this.halfWidth*2,e.height=this.halfHeight*2,e}copyFrom(e){return this.x=e.x,this.y=e.y,this.halfWidth=e.halfWidth,this.halfHeight=e.halfHeight,this}copyTo(e){return e.copyFrom(this),e}toString(){return`[pixi.js/math:Ellipse x=${this.x} y=${this.y} halfWidth=${this.halfWidth} halfHeight=${this.halfHeight}]`}}function sy(r,e,t,s,n,a){const i=r-t,o=e-s,c=n-t,l=a-s,h=i*c+o*l,d=c*c+l*l;let u=-1;d!==0&&(u=h/d);let f,p;u<0?(f=t,p=s):u>1?(f=n,p=a):(f=t+u*c,p=s+u*l);const g=r-f,m=e-p;return g*g+m*m}let ny,ay;class Mn{constructor(...e){this.type="polygon";let t=Array.isArray(e[0])?e[0]:e;if(typeof t[0]!="number"){const s=[];for(let n=0,a=t.length;n<a;n++)s.push(t[n].x,t[n].y);t=s}this.points=t,this.closePath=!0}isClockwise(){let e=0;const t=this.points,s=t.length;for(let n=0;n<s;n+=2){const a=t[n],i=t[n+1],o=t[(n+2)%s],c=t[(n+3)%s];e+=(o-a)*(c+i)}return e<0}containsPolygon(e){const t=this.getBounds(ny),s=e.getBounds(ay);if(!t.containsRect(s))return!1;const n=e.points;for(let a=0;a<n.length;a+=2){const i=n[a],o=n[a+1];if(!this.contains(i,o))return!1}return!0}clone(){const e=this.points.slice(),t=new Mn(e);return t.closePath=this.closePath,t}contains(e,t){let s=!1;const n=this.points.length/2;for(let a=0,i=n-1;a<n;i=a++){const o=this.points[a*2],c=this.points[a*2+1],l=this.points[i*2],h=this.points[i*2+1];c>t!=h>t&&e<(l-o)*((t-c)/(h-c))+o&&(s=!s)}return s}strokeContains(e,t,s,n=.5){const a=s*s,i=a*(1-n),o=a-i,{points:c}=this,l=c.length-(this.closePath?0:2);for(let h=0;h<l;h+=2){const d=c[h],u=c[h+1],f=c[(h+2)%c.length],p=c[(h+3)%c.length],g=sy(e,t,d,u,f,p),m=Math.sign((f-d)*(t-u)-(p-u)*(e-d));if(g<=(m<0?o:i))return!0}return!1}getBounds(e){e||(e=new Re);const t=this.points;let s=1/0,n=-1/0,a=1/0,i=-1/0;for(let o=0,c=t.length;o<c;o+=2){const l=t[o],h=t[o+1];s=l<s?l:s,n=l>n?l:n,a=h<a?h:a,i=h>i?h:i}return e.x=s,e.width=n-s,e.y=a,e.height=i-a,e}copyFrom(e){return this.points=e.points.slice(),this.closePath=e.closePath,this}copyTo(e){return e.copyFrom(this),e}toString(){return`[pixi.js/math:PolygoncloseStroke=${this.closePath}points=${this.points.reduce((e,t)=>`${e}, ${t}`,"")}]`}get lastX(){return this.points[this.points.length-2]}get lastY(){return this.points[this.points.length-1]}get x(){return he("8.11.0","Polygon.lastX is deprecated, please use Polygon.lastX instead."),this.points[this.points.length-2]}get y(){return he("8.11.0","Polygon.y is deprecated, please use Polygon.lastY instead."),this.points[this.points.length-1]}get startX(){return this.points[0]}get startY(){return this.points[1]}}const Ta=(r,e,t,s,n,a,i)=>{const o=r-t,c=e-s,l=Math.sqrt(o*o+c*c);return l>=n-a&&l<=n+i};class Nc{constructor(e=0,t=0,s=0,n=0,a=20){this.type="roundedRectangle",this.x=e,this.y=t,this.width=s,this.height=n,this.radius=a}getBounds(e){return e||(e=new Re),e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e}clone(){return new Nc(this.x,this.y,this.width,this.height,this.radius)}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}copyTo(e){return e.copyFrom(this),e}contains(e,t){if(this.width<=0||this.height<=0)return!1;if(e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height){const s=Math.max(0,Math.min(this.radius,Math.min(this.width,this.height)/2));if(t>=this.y+s&&t<=this.y+this.height-s||e>=this.x+s&&e<=this.x+this.width-s)return!0;let n=e-(this.x+s),a=t-(this.y+s);const i=s*s;if(n*n+a*a<=i||(n=e-(this.x+this.width-s),n*n+a*a<=i)||(a=t-(this.y+this.height-s),n*n+a*a<=i)||(n=e-(this.x+s),n*n+a*a<=i))return!0}return!1}strokeContains(e,t,s,n=.5){const{x:a,y:i,width:o,height:c,radius:l}=this,h=s*(1-n),d=s-h,u=a+l,f=i+l,p=o-l*2,g=c-l*2,m=a+o,_=i+c;return(e>=a-h&&e<=a+d||e>=m-d&&e<=m+h)&&t>=f&&t<=f+g||(t>=i-h&&t<=i+d||t>=_-d&&t<=_+h)&&e>=u&&e<=u+p?!0:e<u&&t<f&&Ta(e,t,u,f,l,d,h)||e>m-l&&t<f&&Ta(e,t,m-l,f,l,d,h)||e>m-l&&t>_-l&&Ta(e,t,m-l,_-l,l,d,h)||e<u&&t>_-l&&Ta(e,t,u,_-l,l,d,h)}toString(){return`[pixi.js/math:RoundedRectangle x=${this.x} y=${this.y}width=${this.width} height=${this.height} radius=${this.radius}]`}}const Mu={};function iy(r,e,t){let s=2166136261;for(let n=0;n<e;n++)s^=r[n].uid,s=Math.imul(s,16777619),s>>>=0;return Mu[s]||oy(r,e,s,t)}function oy(r,e,t,s){const n={};let a=0;for(let o=0;o<s;o++){const c=o<e?r[o]:me.EMPTY.source;n[a++]=c.source,n[a++]=c.style}const i=new ai(n);return Mu[t]=i,i}class Ql{constructor(e){typeof e=="number"?this.rawBinaryData=new ArrayBuffer(e):e instanceof Uint8Array?this.rawBinaryData=e.buffer:this.rawBinaryData=e,this.uint32View=new Uint32Array(this.rawBinaryData),this.float32View=new Float32Array(this.rawBinaryData),this.size=this.rawBinaryData.byteLength}get int8View(){return this._int8View||(this._int8View=new Int8Array(this.rawBinaryData)),this._int8View}get uint8View(){return this._uint8View||(this._uint8View=new Uint8Array(this.rawBinaryData)),this._uint8View}get int16View(){return this._int16View||(this._int16View=new Int16Array(this.rawBinaryData)),this._int16View}get int32View(){return this._int32View||(this._int32View=new Int32Array(this.rawBinaryData)),this._int32View}get float64View(){return this._float64Array||(this._float64Array=new Float64Array(this.rawBinaryData)),this._float64Array}get bigUint64View(){return this._bigUint64Array||(this._bigUint64Array=new BigUint64Array(this.rawBinaryData)),this._bigUint64Array}view(e){return this[`${e}View`]}destroy(){this.rawBinaryData=null,this._int8View=null,this._uint8View=null,this._int16View=null,this.uint16View=null,this._int32View=null,this.uint32View=null,this.float32View=null}static sizeOf(e){switch(e){case"int8":case"uint8":return 1;case"int16":case"uint16":return 2;case"int32":case"uint32":case"float32":return 4;default:throw new Error(`${e} isn't a valid view type`)}}}function Zl(r,e){const t=r.byteLength/8|0,s=new Float64Array(r,0,t);new Float64Array(e,0,t).set(s);const a=r.byteLength-t*8;if(a>0){const i=new Uint8Array(r,t*8,a);new Uint8Array(e,t*8,a).set(i)}}const cy={normal:"normal-npm",add:"add-npm",screen:"screen-npm"};var ly=(r=>(r[r.DISABLED=0]="DISABLED",r[r.RENDERING_MASK_ADD=1]="RENDERING_MASK_ADD",r[r.MASK_ACTIVE=2]="MASK_ACTIVE",r[r.INVERSE_MASK_ACTIVE=3]="INVERSE_MASK_ACTIVE",r[r.RENDERING_MASK_REMOVE=4]="RENDERING_MASK_REMOVE",r[r.NONE=5]="NONE",r))(ly||{});function eh(r,e){return e.alphaMode==="no-premultiply-alpha"&&cy[r]||r}const hy=["precision mediump float;","void main(void){","float test = 0.1;","%forloop%","gl_FragColor = vec4(0.0);","}"].join(`
`);function dy(r){let e="";for(let t=0;t<r;++t)t>0&&(e+=`
else `),t<r-1&&(e+=`if(test == ${t}.0){}`);return e}function uy(r,e){if(r===0)throw new Error("Invalid value of `0` passed to `checkMaxIfStatementsInShader`");const t=e.createShader(e.FRAGMENT_SHADER);try{for(;;){const s=hy.replace(/%forloop%/gi,dy(r));if(e.shaderSource(t,s),e.compileShader(t),!e.getShaderParameter(t,e.COMPILE_STATUS))r=r/2|0;else break}}finally{e.deleteShader(t)}return r}let ws=null;function fy(){var e;if(ws)return ws;const r=du();return ws=r.getParameter(r.MAX_TEXTURE_IMAGE_UNITS),ws=uy(ws,r),(e=r.getExtension("WEBGL_lose_context"))==null||e.loseContext(),ws}class py{constructor(){this.ids=Object.create(null),this.textures=[],this.count=0}clear(){for(let e=0;e<this.count;e++){const t=this.textures[e];this.textures[e]=null,this.ids[t.uid]=null}this.count=0}}class my{constructor(){this.renderPipeId="batch",this.action="startBatch",this.start=0,this.size=0,this.textures=new py,this.blendMode="normal",this.topology="triangle-strip",this.canBundle=!0}destroy(){this.textures=null,this.gpuBindGroup=null,this.bindGroup=null,this.batcher=null}}const $n=[];let gi=0;Kn.register({clear:()=>{if($n.length>0)for(const r of $n)r&&r.destroy();$n.length=0,gi=0}});function th(){return gi>0?$n[--gi]:new my}function rh(r){$n[gi++]=r}let bn=0;const $u=class Ou{constructor(e){this.uid=je("batcher"),this.dirty=!0,this.batchIndex=0,this.batches=[],this._elements=[],e={...Ou.defaultOptions,...e},e.maxTextures||(he("v8.8.0","maxTextures is a required option for Batcher now, please pass it in the options"),e.maxTextures=fy());const{maxTextures:t,attributesInitialSize:s,indicesInitialSize:n}=e;this.attributeBuffer=new Ql(s*4),this.indexBuffer=new Uint16Array(n),this.maxTextures=t}begin(){this.elementSize=0,this.elementStart=0,this.indexSize=0,this.attributeSize=0;for(let e=0;e<this.batchIndex;e++)rh(this.batches[e]);this.batchIndex=0,this._batchIndexStart=0,this._batchIndexSize=0,this.dirty=!0}add(e){this._elements[this.elementSize++]=e,e._indexStart=this.indexSize,e._attributeStart=this.attributeSize,e._batcher=this,this.indexSize+=e.indexSize,this.attributeSize+=e.attributeSize*this.vertexSize}checkAndUpdateTexture(e,t){const s=e._batch.textures.ids[t._source.uid];return!s&&s!==0?!1:(e._textureId=s,e.texture=t,!0)}updateElement(e){this.dirty=!0;const t=this.attributeBuffer;e.packAsQuad?this.packQuadAttributes(e,t.float32View,t.uint32View,e._attributeStart,e._textureId):this.packAttributes(e,t.float32View,t.uint32View,e._attributeStart,e._textureId)}break(e){const t=this._elements;if(!t[this.elementStart])return;let s=th(),n=s.textures;n.clear();const a=t[this.elementStart];let i=eh(a.blendMode,a.texture._source),o=a.topology;this.attributeSize*4>this.attributeBuffer.size&&this._resizeAttributeBuffer(this.attributeSize*4),this.indexSize>this.indexBuffer.length&&this._resizeIndexBuffer(this.indexSize);const c=this.attributeBuffer.float32View,l=this.attributeBuffer.uint32View,h=this.indexBuffer;let d=this._batchIndexSize,u=this._batchIndexStart,f="startBatch";const p=this.maxTextures;for(let g=this.elementStart;g<this.elementSize;++g){const m=t[g];t[g]=null;const b=m.texture._source,x=eh(m.blendMode,b),S=i!==x||o!==m.topology;if(b._batchTick===bn&&!S){m._textureId=b._textureBindLocation,d+=m.indexSize,m.packAsQuad?(this.packQuadAttributes(m,c,l,m._attributeStart,m._textureId),this.packQuadIndex(h,m._indexStart,m._attributeStart/this.vertexSize)):(this.packAttributes(m,c,l,m._attributeStart,m._textureId),this.packIndex(m,h,m._indexStart,m._attributeStart/this.vertexSize)),m._batch=s;continue}b._batchTick=bn,(n.count>=p||S)&&(this._finishBatch(s,u,d-u,n,i,o,e,f),f="renderBatch",u=d,i=x,o=m.topology,s=th(),n=s.textures,n.clear(),++bn),m._textureId=b._textureBindLocation=n.count,n.ids[b.uid]=n.count,n.textures[n.count++]=b,m._batch=s,d+=m.indexSize,m.packAsQuad?(this.packQuadAttributes(m,c,l,m._attributeStart,m._textureId),this.packQuadIndex(h,m._indexStart,m._attributeStart/this.vertexSize)):(this.packAttributes(m,c,l,m._attributeStart,m._textureId),this.packIndex(m,h,m._indexStart,m._attributeStart/this.vertexSize))}n.count>0&&(this._finishBatch(s,u,d-u,n,i,o,e,f),u=d,++bn),this.elementStart=this.elementSize,this._batchIndexStart=u,this._batchIndexSize=d}_finishBatch(e,t,s,n,a,i,o,c){e.gpuBindGroup=null,e.bindGroup=null,e.action=c,e.batcher=this,e.textures=n,e.blendMode=a,e.topology=i,e.start=t,e.size=s,++bn,this.batches[this.batchIndex++]=e,o.add(e)}finish(e){this.break(e)}ensureAttributeBuffer(e){e*4<=this.attributeBuffer.size||this._resizeAttributeBuffer(e*4)}ensureIndexBuffer(e){e<=this.indexBuffer.length||this._resizeIndexBuffer(e)}_resizeAttributeBuffer(e){const t=Math.max(e,this.attributeBuffer.size*2),s=new Ql(t);Zl(this.attributeBuffer.rawBinaryData,s.rawBinaryData),this.attributeBuffer=s}_resizeIndexBuffer(e){const t=this.indexBuffer;let s=Math.max(e,t.length*1.5);s+=s%2;const n=s>65535?new Uint32Array(s):new Uint16Array(s);if(n.BYTES_PER_ELEMENT!==t.BYTES_PER_ELEMENT)for(let a=0;a<t.length;a++)n[a]=t[a];else Zl(t.buffer,n.buffer);this.indexBuffer=n}packQuadIndex(e,t,s){e[t]=s+0,e[t+1]=s+1,e[t+2]=s+2,e[t+3]=s+0,e[t+4]=s+2,e[t+5]=s+3}packIndex(e,t,s,n){const a=e.indices,i=e.indexSize,o=e.indexOffset,c=e.attributeOffset;for(let l=0;l<i;l++)t[s++]=n+a[l+o]-c}destroy(){if(this.batches!==null){for(let e=0;e<this.batches.length;e++)rh(this.batches[e]);this.batches=null;for(let e=0;e<this._elements.length;e++)this._elements[e]&&(this._elements[e]._batch=null);this._elements=null,this.indexBuffer=null,this.attributeBuffer.destroy(),this.attributeBuffer=null}}};$u.defaultOptions={maxTextures:null,attributesInitialSize:4,indicesInitialSize:6};let gy=$u;var wt=(r=>(r[r.MAP_READ=1]="MAP_READ",r[r.MAP_WRITE=2]="MAP_WRITE",r[r.COPY_SRC=4]="COPY_SRC",r[r.COPY_DST=8]="COPY_DST",r[r.INDEX=16]="INDEX",r[r.VERTEX=32]="VERTEX",r[r.UNIFORM=64]="UNIFORM",r[r.STORAGE=128]="STORAGE",r[r.INDIRECT=256]="INDIRECT",r[r.QUERY_RESOLVE=512]="QUERY_RESOLVE",r[r.STATIC=1024]="STATIC",r))(wt||{});let Un=class extends qt{constructor(e){let{data:t,size:s}=e;const{usage:n,label:a,shrinkToFit:i}=e;super(),this.uid=je("buffer"),this._resourceType="buffer",this._resourceId=je("resource"),this._touched=0,this._updateID=1,this._dataInt32=null,this.shrinkToFit=!0,this.destroyed=!1,t instanceof Array&&(t=new Float32Array(t)),this._data=t,s??(s=t==null?void 0:t.byteLength);const o=!!t;this.descriptor={size:s,usage:n,mappedAtCreation:o,label:a},this.shrinkToFit=i??!0}get data(){return this._data}set data(e){this.setDataWithSize(e,e.length,!0)}get dataInt32(){return this._dataInt32||(this._dataInt32=new Int32Array(this.data.buffer)),this._dataInt32}get static(){return!!(this.descriptor.usage&wt.STATIC)}set static(e){e?this.descriptor.usage|=wt.STATIC:this.descriptor.usage&=~wt.STATIC}setDataWithSize(e,t,s){if(this._updateID++,this._updateSize=t*e.BYTES_PER_ELEMENT,this._data===e){s&&this.emit("update",this);return}const n=this._data;if(this._data=e,this._dataInt32=null,!n||n.length!==e.length){!this.shrinkToFit&&n&&e.byteLength<n.byteLength?s&&this.emit("update",this):(this.descriptor.size=e.byteLength,this._resourceId=je("resource"),this.emit("change",this));return}s&&this.emit("update",this)}update(e){this._updateSize=e??this._updateSize,this._updateID++,this.emit("update",this)}destroy(){this.destroyed=!0,this.emit("destroy",this),this.emit("change",this),this._data=null,this.descriptor=null,this.removeAllListeners()}};function Bu(r,e){if(!(r instanceof Un)){let t=e?wt.INDEX:wt.VERTEX;r instanceof Array&&(e?(r=new Uint32Array(r),t=wt.INDEX|wt.COPY_DST):(r=new Float32Array(r),t=wt.VERTEX|wt.COPY_DST)),r=new Un({data:r,label:e?"index-mesh-buffer":"vertex-mesh-buffer",usage:t})}return r}function yy(r,e,t){const s=r.getAttribute(e);if(!s)return t.minX=0,t.minY=0,t.maxX=0,t.maxY=0,t;const n=s.buffer.data;let a=1/0,i=1/0,o=-1/0,c=-1/0;const l=n.BYTES_PER_ELEMENT,h=(s.offset||0)/l,d=(s.stride||2*4)/l;for(let u=h;u<n.length;u+=d){const f=n[u],p=n[u+1];f>o&&(o=f),p>c&&(c=p),f<a&&(a=f),p<i&&(i=p)}return t.minX=a,t.minY=i,t.maxX=o,t.maxY=c,t}function _y(r){return(r instanceof Un||Array.isArray(r)||r.BYTES_PER_ELEMENT)&&(r={buffer:r}),r.buffer=Bu(r.buffer,!1),r}class by extends qt{constructor(e={}){super(),this.uid=je("geometry"),this._layoutKey=0,this.instanceCount=1,this._bounds=new Wt,this._boundsDirty=!0;const{attributes:t,indexBuffer:s,topology:n}=e;if(this.buffers=[],this.attributes={},t)for(const a in t)this.addAttribute(a,t[a]);this.instanceCount=e.instanceCount??1,s&&this.addIndex(s),this.topology=n||"triangle-list"}onBufferUpdate(){this._boundsDirty=!0,this.emit("update",this)}getAttribute(e){return this.attributes[e]}getIndex(){return this.indexBuffer}getBuffer(e){return this.getAttribute(e).buffer}getSize(){for(const e in this.attributes){const t=this.attributes[e];return t.buffer.data.length/(t.stride/4||t.size)}return 0}addAttribute(e,t){const s=_y(t);this.buffers.indexOf(s.buffer)===-1&&(this.buffers.push(s.buffer),s.buffer.on("update",this.onBufferUpdate,this),s.buffer.on("change",this.onBufferUpdate,this)),this.attributes[e]=s}addIndex(e){this.indexBuffer=Bu(e,!0),this.buffers.push(this.indexBuffer)}get bounds(){return this._boundsDirty?(this._boundsDirty=!1,yy(this,"aPosition",this._bounds)):this._bounds}destroy(e=!1){this.emit("destroy",this),this.removeAllListeners(),e&&this.buffers.forEach(t=>t.destroy()),this.attributes=null,this.buffers=null,this.indexBuffer=null,this._bounds=null}}const xy=new Float32Array(1),wy=new Uint32Array(1);class vy extends by{constructor(){const t=new Un({data:xy,label:"attribute-batch-buffer",usage:wt.VERTEX|wt.COPY_DST,shrinkToFit:!1}),s=new Un({data:wy,label:"index-batch-buffer",usage:wt.INDEX|wt.COPY_DST,shrinkToFit:!1}),n=6*4;super({attributes:{aPosition:{buffer:t,format:"float32x2",stride:n,offset:0},aUV:{buffer:t,format:"float32x2",stride:n,offset:2*4},aColor:{buffer:t,format:"unorm8x4",stride:n,offset:4*4},aTextureIdAndRound:{buffer:t,format:"uint16x2",stride:n,offset:5*4}},indexBuffer:s})}}function sh(r,e,t){if(r)for(const s in r){const n=s.toLocaleLowerCase(),a=e[n];if(a){let i=r[s];s==="header"&&(i=i.replace(/@in\s+[^;]+;\s*/g,"").replace(/@out\s+[^;]+;\s*/g,"")),t&&a.push(`//----${t}----//`),a.push(i)}else Ae(`${s} placement hook does not exist in shader`)}}const Sy=/\{\{(.*?)\}\}/g;function nh(r){var s;const e={};return(((s=r.match(Sy))==null?void 0:s.map(n=>n.replace(/[{()}]/g,"")))??[]).forEach(n=>{e[n]=[]}),e}function ah(r,e){let t;const s=/@in\s+([^;]+);/g;for(;(t=s.exec(r))!==null;)e.push(t[1])}function ih(r,e,t=!1){const s=[];ah(e,s),r.forEach(o=>{o.header&&ah(o.header,s)});const n=s;t&&n.sort();const a=n.map((o,c)=>`       @location(${c}) ${o},`).join(`
`);let i=e.replace(/@in\s+[^;]+;\s*/g,"");return i=i.replace("{{in}}",`
${a}
`),i}function oh(r,e){let t;const s=/@out\s+([^;]+);/g;for(;(t=s.exec(r))!==null;)e.push(t[1])}function ky(r){const t=/\b(\w+)\s*:/g.exec(r);return t?t[1]:""}function Iy(r){const e=/@.*?\s+/g;return r.replace(e,"")}function Ay(r,e){const t=[];oh(e,t),r.forEach(c=>{c.header&&oh(c.header,t)});let s=0;const n=t.sort().map(c=>c.indexOf("builtin")>-1?c:`@location(${s++}) ${c}`).join(`,
`),a=t.sort().map(c=>`       var ${Iy(c)};`).join(`
`),i=`return VSOutput(
            ${t.sort().map(c=>` ${ky(c)}`).join(`,
`)});`;let o=e.replace(/@out\s+[^;]+;\s*/g,"");return o=o.replace("{{struct}}",`
${n}
`),o=o.replace("{{start}}",`
${a}
`),o=o.replace("{{return}}",`
${i}
`),o}function ch(r,e){let t=r;for(const s in e){const n=e[s];n.join(`
`).length?t=t.replace(`{{${s}}}`,`//-----${s} START-----//
${n.join(`
`)}
//----${s} FINISH----//`):t=t.replace(`{{${s}}}`,"")}return t}const Dr=Object.create(null),mo=new Map;let Cy=0;function Ey({template:r,bits:e}){const t=Du(r,e);if(Dr[t])return Dr[t];const{vertex:s,fragment:n}=Py(r,e);return Dr[t]=Lu(s,n,e),Dr[t]}function Ty({template:r,bits:e}){const t=Du(r,e);return Dr[t]||(Dr[t]=Lu(r.vertex,r.fragment,e)),Dr[t]}function Py(r,e){const t=e.map(i=>i.vertex).filter(i=>!!i),s=e.map(i=>i.fragment).filter(i=>!!i);let n=ih(t,r.vertex,!0);n=Ay(t,n);const a=ih(s,r.fragment,!0);return{vertex:n,fragment:a}}function Du(r,e){return e.map(t=>(mo.has(t)||mo.set(t,Cy++),mo.get(t))).sort((t,s)=>t-s).join("-")+r.vertex+r.fragment}function Lu(r,e,t){const s=nh(r),n=nh(e);return t.forEach(a=>{sh(a.vertex,s,a.name),sh(a.fragment,n,a.name)}),{vertex:ch(r,s),fragment:ch(e,n)}}const Ry=`
    @in aPosition: vec2<f32>;
    @in aUV: vec2<f32>;

    @out @builtin(position) vPosition: vec4<f32>;
    @out vUV : vec2<f32>;
    @out vColor : vec4<f32>;

    {{header}}

    struct VSOutput {
        {{struct}}
    };

    @vertex
    fn main( {{in}} ) -> VSOutput {

        var worldTransformMatrix = globalUniforms.uWorldTransformMatrix;
        var modelMatrix = mat3x3<f32>(
            1.0, 0.0, 0.0,
            0.0, 1.0, 0.0,
            0.0, 0.0, 1.0
          );
        var position = aPosition;
        var uv = aUV;

        {{start}}

        vColor = vec4<f32>(1., 1., 1., 1.);

        {{main}}

        vUV = uv;

        var modelViewProjectionMatrix = globalUniforms.uProjectionMatrix * worldTransformMatrix * modelMatrix;

        vPosition =  vec4<f32>((modelViewProjectionMatrix *  vec3<f32>(position, 1.0)).xy, 0.0, 1.0);

        vColor *= globalUniforms.uWorldColorAlpha;

        {{end}}

        {{return}}
    };
`,My=`
    @in vUV : vec2<f32>;
    @in vColor : vec4<f32>;

    {{header}}

    @fragment
    fn main(
        {{in}}
      ) -> @location(0) vec4<f32> {

        {{start}}

        var outColor:vec4<f32>;

        {{main}}

        var finalColor:vec4<f32> = outColor * vColor;

        {{end}}

        return finalColor;
      };
`,$y=`
    in vec2 aPosition;
    in vec2 aUV;

    out vec4 vColor;
    out vec2 vUV;

    {{header}}

    void main(void){

        mat3 worldTransformMatrix = uWorldTransformMatrix;
        mat3 modelMatrix = mat3(
            1.0, 0.0, 0.0,
            0.0, 1.0, 0.0,
            0.0, 0.0, 1.0
          );
        vec2 position = aPosition;
        vec2 uv = aUV;

        {{start}}

        vColor = vec4(1.);

        {{main}}

        vUV = uv;

        mat3 modelViewProjectionMatrix = uProjectionMatrix * worldTransformMatrix * modelMatrix;

        gl_Position = vec4((modelViewProjectionMatrix * vec3(position, 1.0)).xy, 0.0, 1.0);

        vColor *= uWorldColorAlpha;

        {{end}}
    }
`,Oy=`

    in vec4 vColor;
    in vec2 vUV;

    out vec4 finalColor;

    {{header}}

    void main(void) {

        {{start}}

        vec4 outColor;

        {{main}}

        finalColor = outColor * vColor;

        {{end}}
    }
`,By={name:"global-uniforms-bit",vertex:{header:`
        struct GlobalUniforms {
            uProjectionMatrix:mat3x3<f32>,
            uWorldTransformMatrix:mat3x3<f32>,
            uWorldColorAlpha: vec4<f32>,
            uResolution: vec2<f32>,
        }

        @group(0) @binding(0) var<uniform> globalUniforms : GlobalUniforms;
        `}},Dy={name:"global-uniforms-bit",vertex:{header:`
          uniform mat3 uProjectionMatrix;
          uniform mat3 uWorldTransformMatrix;
          uniform vec4 uWorldColorAlpha;
          uniform vec2 uResolution;
        `}};function Ly({bits:r,name:e}){const t=Ey({template:{fragment:My,vertex:Ry},bits:[By,...r]});return Pi.from({name:e,vertex:{source:t.vertex,entryPoint:"main"},fragment:{source:t.fragment,entryPoint:"main"}})}function Fy({bits:r,name:e}){return new fu({name:e,...Ty({template:{vertex:$y,fragment:Oy},bits:[Dy,...r]})})}const jy={name:"color-bit",vertex:{header:`
            @in aColor: vec4<f32>;
        `,main:`
            vColor *= vec4<f32>(aColor.rgb * aColor.a, aColor.a);
        `}},Ny={name:"color-bit",vertex:{header:`
            in vec4 aColor;
        `,main:`
            vColor *= vec4(aColor.rgb * aColor.a, aColor.a);
        `}},go={};function Hy(r){const e=[];if(r===1)e.push("@group(1) @binding(0) var textureSource1: texture_2d<f32>;"),e.push("@group(1) @binding(1) var textureSampler1: sampler;");else{let t=0;for(let s=0;s<r;s++)e.push(`@group(1) @binding(${t++}) var textureSource${s+1}: texture_2d<f32>;`),e.push(`@group(1) @binding(${t++}) var textureSampler${s+1}: sampler;`)}return e.join(`
`)}function Uy(r){const e=[];if(r===1)e.push("outColor = textureSampleGrad(textureSource1, textureSampler1, vUV, uvDx, uvDy);");else{e.push("switch vTextureId {");for(let t=0;t<r;t++)t===r-1?e.push("  default:{"):e.push(`  case ${t}:{`),e.push(`      outColor = textureSampleGrad(textureSource${t+1}, textureSampler${t+1}, vUV, uvDx, uvDy);`),e.push("      break;}");e.push("}")}return e.join(`
`)}function Gy(r){return go[r]||(go[r]={name:"texture-batch-bit",vertex:{header:`
                @in aTextureIdAndRound: vec2<u32>;
                @out @interpolate(flat) vTextureId : u32;
            `,main:`
                vTextureId = aTextureIdAndRound.y;
            `,end:`
                if(aTextureIdAndRound.x == 1)
                {
                    vPosition = vec4<f32>(roundPixels(vPosition.xy, globalUniforms.uResolution), vPosition.zw);
                }
            `},fragment:{header:`
                @in @interpolate(flat) vTextureId: u32;

                ${Hy(r)}
            `,main:`
                var uvDx = dpdx(vUV);
                var uvDy = dpdy(vUV);

                ${Uy(r)}
            `}}),go[r]}const yo={};function zy(r){const e=[];for(let t=0;t<r;t++)t>0&&e.push("else"),t<r-1&&e.push(`if(vTextureId < ${t}.5)`),e.push("{"),e.push(`	outColor = texture(uTextures[${t}], vUV);`),e.push("}");return e.join(`
`)}function Vy(r){return yo[r]||(yo[r]={name:"texture-batch-bit",vertex:{header:`
                in vec2 aTextureIdAndRound;
                out float vTextureId;

            `,main:`
                vTextureId = aTextureIdAndRound.y;
            `,end:`
                if(aTextureIdAndRound.x == 1.)
                {
                    gl_Position.xy = roundPixels(gl_Position.xy, uResolution);
                }
            `},fragment:{header:`
                in float vTextureId;

                uniform sampler2D uTextures[${r}];

            `,main:`

                ${zy(r)}
            `}}),yo[r]}const Wy={name:"round-pixels-bit",vertex:{header:`
            fn roundPixels(position: vec2<f32>, targetSize: vec2<f32>) -> vec2<f32>
            {
                return (floor(((position * 0.5 + 0.5) * targetSize) + 0.5) / targetSize) * 2.0 - 1.0;
            }
        `}},qy={name:"round-pixels-bit",vertex:{header:`
            vec2 roundPixels(vec2 position, vec2 targetSize)
            {
                return (floor(((position * 0.5 + 0.5) * targetSize) + 0.5) / targetSize) * 2.0 - 1.0;
            }
        `}},lh={};function Xy(r){let e=lh[r];if(e)return e;const t=new Int32Array(r);for(let s=0;s<r;s++)t[s]=s;return e=lh[r]=new yu({uTextures:{value:t,type:"i32",size:r}},{isStatic:!0}),e}class Yy extends Dc{constructor(e){const t=Fy({name:"batch",bits:[Ny,Vy(e),qy]}),s=Ly({name:"batch",bits:[jy,Gy(e),Wy]});super({glProgram:t,gpuProgram:s,resources:{batchSamplers:Xy(e)}})}}let _o=null;const Fu=class ju extends gy{constructor(e){super(e),this.geometry=new vy,this.name=ju.extension.name,this.vertexSize=6,_o??(_o=new Yy(e.maxTextures)),this.shader=_o}packAttributes(e,t,s,n,a){const i=a<<16|e.roundPixels&65535,o=e.transform,c=o.a,l=o.b,h=o.c,d=o.d,u=o.tx,f=o.ty,{positions:p,uvs:g}=e,m=e.color,_=e.attributeOffset,b=_+e.attributeSize;for(let x=_;x<b;x++){const S=x*2,T=p[S],A=p[S+1];t[n++]=c*T+h*A+u,t[n++]=d*A+l*T+f,t[n++]=g[S],t[n++]=g[S+1],s[n++]=m,s[n++]=i}}packQuadAttributes(e,t,s,n,a){const i=e.texture,o=e.transform,c=o.a,l=o.b,h=o.c,d=o.d,u=o.tx,f=o.ty,p=e.bounds,g=p.maxX,m=p.minX,_=p.maxY,b=p.minY,x=i.uvs,S=e.color,T=a<<16|e.roundPixels&65535;t[n+0]=c*m+h*b+u,t[n+1]=d*b+l*m+f,t[n+2]=x.x0,t[n+3]=x.y0,s[n+4]=S,s[n+5]=T,t[n+6]=c*g+h*b+u,t[n+7]=d*b+l*g+f,t[n+8]=x.x1,t[n+9]=x.y1,s[n+10]=S,s[n+11]=T,t[n+12]=c*g+h*_+u,t[n+13]=d*_+l*g+f,t[n+14]=x.x2,t[n+15]=x.y2,s[n+16]=S,s[n+17]=T,t[n+18]=c*m+h*_+u,t[n+19]=d*_+l*m+f,t[n+20]=x.x3,t[n+21]=x.y3,s[n+22]=S,s[n+23]=T}};Fu.extension={type:[J.Batcher],name:"default"};let Ky=Fu;function Jy(r,e,t,s,n,a,i,o=null){let c=0;t*=e,n*=a;const l=o.a,h=o.b,d=o.c,u=o.d,f=o.tx,p=o.ty;for(;c<i;){const g=r[t],m=r[t+1];s[n]=l*g+d*m+f,s[n+1]=h*g+u*m+p,n+=a,t+=e,c++}}function Qy(r,e,t,s){let n=0;for(e*=t;n<s;)r[e]=0,r[e+1]=0,e+=t,n++}function Nu(r,e,t,s,n){const a=e.a,i=e.b,o=e.c,c=e.d,l=e.tx,h=e.ty;t||(t=0),s||(s=2),n||(n=r.length/s-t);let d=t*s;for(let u=0;u<n;u++){const f=r[d],p=r[d+1];r[d]=a*f+o*p+l,r[d+1]=i*f+c*p+h,d+=s}}const Zy=new pe;class Hu{constructor(){this.packAsQuad=!1,this.batcherName="default",this.topology="triangle-list",this.applyTransform=!0,this.roundPixels=0,this._batcher=null,this._batch=null}get uvs(){return this.geometryData.uvs}get positions(){return this.geometryData.vertices}get indices(){return this.geometryData.indices}get blendMode(){return this.renderable&&this.applyTransform?this.renderable.groupBlendMode:"normal"}get color(){const e=this.baseColor,t=e>>16|e&65280|(e&255)<<16,s=this.renderable;return s?Vd(t,s.groupColor)+(this.alpha*s.groupAlpha*255<<24):t+(this.alpha*255<<24)}get transform(){var e;return((e=this.renderable)==null?void 0:e.groupTransform)||Zy}copyTo(e){e.indexOffset=this.indexOffset,e.indexSize=this.indexSize,e.attributeOffset=this.attributeOffset,e.attributeSize=this.attributeSize,e.baseColor=this.baseColor,e.alpha=this.alpha,e.texture=this.texture,e.geometryData=this.geometryData,e.topology=this.topology}reset(){this.applyTransform=!0,this.renderable=null,this.topology="triangle-list"}destroy(){this.renderable=null,this.texture=null,this.geometryData=null,this._batcher=null,this._batch=null}}const Gn={extension:{type:J.ShapeBuilder,name:"circle"},build(r,e){let t,s,n,a,i,o;if(r.type==="circle"){const S=r;if(i=o=S.radius,i<=0)return!1;t=S.x,s=S.y,n=a=0}else if(r.type==="ellipse"){const S=r;if(i=S.halfWidth,o=S.halfHeight,i<=0||o<=0)return!1;t=S.x,s=S.y,n=a=0}else{const S=r,T=S.width/2,A=S.height/2;t=S.x+T,s=S.y+A,i=o=Math.max(0,Math.min(S.radius,Math.min(T,A))),n=T-i,a=A-o}if(n<0||a<0)return!1;const c=Math.ceil(2.3*Math.sqrt(i+o)),l=c*8+(n?4:0)+(a?4:0);if(l===0)return!1;if(c===0)return e[0]=e[6]=t+n,e[1]=e[3]=s+a,e[2]=e[4]=t-n,e[5]=e[7]=s-a,!0;let h=0,d=c*4+(n?2:0)+2,u=d,f=l,p=n+i,g=a,m=t+p,_=t-p,b=s+g;if(e[h++]=m,e[h++]=b,e[--d]=b,e[--d]=_,a){const S=s-g;e[u++]=_,e[u++]=S,e[--f]=S,e[--f]=m}for(let S=1;S<c;S++){const T=Math.PI/2*(S/c),A=n+Math.cos(T)*i,C=a+Math.sin(T)*o,R=t+A,$=t-A,B=s+C,j=s-C;e[h++]=R,e[h++]=B,e[--d]=B,e[--d]=$,e[u++]=$,e[u++]=j,e[--f]=j,e[--f]=R}p=n,g=a+o,m=t+p,_=t-p,b=s+g;const x=s-g;return e[h++]=m,e[h++]=b,e[--f]=x,e[--f]=m,n&&(e[h++]=_,e[h++]=b,e[--f]=x,e[--f]=_),!0},triangulate(r,e,t,s,n,a){if(r.length===0)return;let i=0,o=0;for(let h=0;h<r.length;h+=2)i+=r[h],o+=r[h+1];i/=r.length/2,o/=r.length/2;let c=s;e[c*t]=i,e[c*t+1]=o;const l=c++;for(let h=0;h<r.length;h+=2)e[c*t]=r[h],e[c*t+1]=r[h+1],h>0&&(n[a++]=c,n[a++]=l,n[a++]=c-1),c++;n[a++]=l+1,n[a++]=l,n[a++]=c-1}},e0={...Gn,extension:{...Gn.extension,name:"ellipse"}},t0={...Gn,extension:{...Gn.extension,name:"roundedRectangle"}},Uu=1e-4,hh=1e-4;function r0(r){const e=r.length;if(e<6)return 1;let t=0;for(let s=0,n=r[e-2],a=r[e-1];s<e;s+=2){const i=r[s],o=r[s+1];t+=(i-n)*(o+a),n=i,a=o}return t<0?-1:1}function dh(r,e,t,s,n,a,i,o){const c=r-t*n,l=e-s*n,h=r+t*a,d=e+s*a;let u,f;i?(u=s,f=-t):(u=-s,f=t);const p=c+u,g=l+f,m=h+u,_=d+f;return o.push(p,g),o.push(m,_),2}function zr(r,e,t,s,n,a,i,o){const c=t-r,l=s-e;let h=Math.atan2(c,l),d=Math.atan2(n-r,a-e);o&&h<d?h+=Math.PI*2:!o&&h>d&&(d+=Math.PI*2);let u=h;const f=d-h,p=Math.abs(f),g=Math.sqrt(c*c+l*l),m=(15*p*Math.sqrt(g)/Math.PI>>0)+1,_=f/m;if(u+=_,o){i.push(r,e),i.push(t,s);for(let b=1,x=u;b<m;b++,x+=_)i.push(r,e),i.push(r+Math.sin(x)*g,e+Math.cos(x)*g);i.push(r,e),i.push(n,a)}else{i.push(t,s),i.push(r,e);for(let b=1,x=u;b<m;b++,x+=_)i.push(r+Math.sin(x)*g,e+Math.cos(x)*g),i.push(r,e);i.push(n,a),i.push(r,e)}return m*2}function s0(r,e,t,s,n,a){const i=Uu;if(r.length===0)return;const o=e;let c=o.alignment;if(e.alignment!==.5){let ue=r0(r);c=(c-.5)*ue+.5}const l=new ft(r[0],r[1]),h=new ft(r[r.length-2],r[r.length-1]),d=s,u=Math.abs(l.x-h.x)<i&&Math.abs(l.y-h.y)<i;if(d){r=r.slice(),u&&(r.pop(),r.pop(),h.set(r[r.length-2],r[r.length-1]));const ue=(l.x+h.x)*.5,St=(h.y+l.y)*.5;r.unshift(ue,St),r.push(ue,St)}const f=n,p=r.length/2;let g=r.length;const m=f.length/2,_=o.width/2,b=_*_,x=o.miterLimit*o.miterLimit;let S=r[0],T=r[1],A=r[2],C=r[3],R=0,$=0,B=-(T-C),j=S-A,se=0,z=0,de=Math.sqrt(B*B+j*j);B/=de,j/=de,B*=_,j*=_;const Qe=c,G=(1-Qe)*2,Q=Qe*2;d||(o.cap==="round"?g+=zr(S-B*(G-Q)*.5,T-j*(G-Q)*.5,S-B*G,T-j*G,S+B*Q,T+j*Q,f,!0)+2:o.cap==="square"&&(g+=dh(S,T,B,j,G,Q,!0,f))),f.push(S-B*G,T-j*G),f.push(S+B*Q,T+j*Q);for(let ue=1;ue<p-1;++ue){S=r[(ue-1)*2],T=r[(ue-1)*2+1],A=r[ue*2],C=r[ue*2+1],R=r[(ue+1)*2],$=r[(ue+1)*2+1],B=-(T-C),j=S-A,de=Math.sqrt(B*B+j*j),B/=de,j/=de,B*=_,j*=_,se=-(C-$),z=A-R,de=Math.sqrt(se*se+z*z),se/=de,z/=de,se*=_,z*=_;const St=A-S,wr=T-C,Ze=A-R,Hr=$-C,en=St*Ze+wr*Hr,ar=wr*Ze-Hr*St,vr=ar<0;if(Math.abs(ar)<.001*Math.abs(en)){f.push(A-B*G,C-j*G),f.push(A+B*Q,C+j*Q),en>=0&&(o.join==="round"?g+=zr(A,C,A-B*G,C-j*G,A-se*G,C-z*G,f,!1)+4:g+=2,f.push(A-se*Q,C-z*Q),f.push(A+se*G,C+z*G));continue}const tn=(-B+S)*(-j+C)-(-B+A)*(-j+T),rn=(-se+R)*(-z+C)-(-se+A)*(-z+$),Sr=(St*rn-Ze*tn)/ar,Ur=(Hr*tn-wr*rn)/ar,Gr=(Sr-A)*(Sr-A)+(Ur-C)*(Ur-C),Kt=A+(Sr-A)*G,it=C+(Ur-C)*G,Bt=A-(Sr-A)*Q,Dt=C-(Ur-C)*Q,Qn=Math.min(St*St+wr*wr,Ze*Ze+Hr*Hr),us=vr?G:Q,sn=Qn+us*us*b;Gr<=sn?o.join==="bevel"||Gr/b>x?(vr?(f.push(Kt,it),f.push(A+B*Q,C+j*Q),f.push(Kt,it),f.push(A+se*Q,C+z*Q)):(f.push(A-B*G,C-j*G),f.push(Bt,Dt),f.push(A-se*G,C-z*G),f.push(Bt,Dt)),g+=2):o.join==="round"?vr?(f.push(Kt,it),f.push(A+B*Q,C+j*Q),g+=zr(A,C,A+B*Q,C+j*Q,A+se*Q,C+z*Q,f,!0)+4,f.push(Kt,it),f.push(A+se*Q,C+z*Q)):(f.push(A-B*G,C-j*G),f.push(Bt,Dt),g+=zr(A,C,A-B*G,C-j*G,A-se*G,C-z*G,f,!1)+4,f.push(A-se*G,C-z*G),f.push(Bt,Dt)):(f.push(Kt,it),f.push(Bt,Dt)):(f.push(A-B*G,C-j*G),f.push(A+B*Q,C+j*Q),o.join==="round"?vr?g+=zr(A,C,A+B*Q,C+j*Q,A+se*Q,C+z*Q,f,!0)+2:g+=zr(A,C,A-B*G,C-j*G,A-se*G,C-z*G,f,!1)+2:o.join==="miter"&&Gr/b<=x&&(vr?(f.push(Bt,Dt),f.push(Bt,Dt)):(f.push(Kt,it),f.push(Kt,it)),g+=2),f.push(A-se*G,C-z*G),f.push(A+se*Q,C+z*Q),g+=2)}S=r[(p-2)*2],T=r[(p-2)*2+1],A=r[(p-1)*2],C=r[(p-1)*2+1],B=-(T-C),j=S-A,de=Math.sqrt(B*B+j*j),B/=de,j/=de,B*=_,j*=_,f.push(A-B*G,C-j*G),f.push(A+B*Q,C+j*Q),d||(o.cap==="round"?g+=zr(A-B*(G-Q)*.5,C-j*(G-Q)*.5,A-B*G,C-j*G,A+B*Q,C+j*Q,f,!1)+2:o.cap==="square"&&(g+=dh(A,C,B,j,G,Q,!1,f)));const xr=hh*hh;for(let ue=m;ue<g+m-2;++ue)S=f[ue*2],T=f[ue*2+1],A=f[(ue+1)*2],C=f[(ue+1)*2+1],R=f[(ue+2)*2],$=f[(ue+2)*2+1],!(Math.abs(S*(C-$)+A*($-T)+R*(T-C))<xr)&&a.push(ue,ue+1,ue+2)}function n0(r,e,t,s){const n=Uu;if(r.length===0)return;const a=r[0],i=r[1],o=r[r.length-2],c=r[r.length-1],l=e||Math.abs(a-o)<n&&Math.abs(i-c)<n,h=t,d=r.length/2,u=h.length/2;for(let f=0;f<d;f++)h.push(r[f*2]),h.push(r[f*2+1]);for(let f=0;f<d-1;f++)s.push(u+f,u+f+1);l&&s.push(u+d-1,u)}function Gu(r,e,t,s,n,a,i){const o=Ng(r,e,2);if(!o)return;for(let l=0;l<o.length;l+=3)a[i++]=o[l]+n,a[i++]=o[l+1]+n,a[i++]=o[l+2]+n;let c=n*s;for(let l=0;l<r.length;l+=2)t[c]=r[l],t[c+1]=r[l+1],c+=s}const a0=[],i0={extension:{type:J.ShapeBuilder,name:"polygon"},build(r,e){for(let t=0;t<r.points.length;t++)e[t]=r.points[t];return!0},triangulate(r,e,t,s,n,a){Gu(r,a0,e,t,s,n,a)}},o0={extension:{type:J.ShapeBuilder,name:"rectangle"},build(r,e){const t=r,s=t.x,n=t.y,a=t.width,i=t.height;return a>0&&i>0?(e[0]=s,e[1]=n,e[2]=s+a,e[3]=n,e[4]=s+a,e[5]=n+i,e[6]=s,e[7]=n+i,!0):!1},triangulate(r,e,t,s,n,a){let i=0;s*=t,e[s+i]=r[0],e[s+i+1]=r[1],i+=t,e[s+i]=r[2],e[s+i+1]=r[3],i+=t,e[s+i]=r[6],e[s+i+1]=r[7],i+=t,e[s+i]=r[4],e[s+i+1]=r[5],i+=t;const o=s/t;n[a++]=o,n[a++]=o+1,n[a++]=o+2,n[a++]=o+1,n[a++]=o+3,n[a++]=o+2}},c0={extension:{type:J.ShapeBuilder,name:"triangle"},build(r,e){return e[0]=r.x,e[1]=r.y,e[2]=r.x2,e[3]=r.y2,e[4]=r.x3,e[5]=r.y3,!0},triangulate(r,e,t,s,n,a){let i=0;s*=t,e[s+i]=r[0],e[s+i+1]=r[1],i+=t,e[s+i]=r[2],e[s+i+1]=r[3],i+=t,e[s+i]=r[4],e[s+i+1]=r[5];const o=s/t;n[a++]=o,n[a++]=o+1,n[a++]=o+2}},l0=new pe,h0=new Re;function d0(r,e,t,s){const n=e.matrix?r.copyFrom(e.matrix).invert():r.identity();if(e.textureSpace==="local"){const i=t.getBounds(h0);e.width&&i.pad(e.width);const{x:o,y:c}=i,l=1/i.width,h=1/i.height,d=-o*l,u=-c*h,f=n.a,p=n.b,g=n.c,m=n.d;n.a*=l,n.b*=l,n.c*=h,n.d*=h,n.tx=d*f+u*g+n.tx,n.ty=d*p+u*m+n.ty}else n.translate(e.texture.frame.x,e.texture.frame.y),n.scale(1/e.texture.source.width,1/e.texture.source.height);const a=e.texture.source.style;return!(e.fill instanceof br)&&a.addressMode==="clamp-to-edge"&&(a.addressMode="repeat",a.update()),s&&n.append(l0.copyFrom(s).invert()),n}const Mi={};at.handleByMap(J.ShapeBuilder,Mi);at.add(o0,i0,c0,Gn,e0,t0);const u0=new Re,f0=new pe;function p0(r,e){const{geometryData:t,batches:s}=e;s.length=0,t.indices.length=0,t.vertices.length=0,t.uvs.length=0;for(let n=0;n<r.instructions.length;n++){const a=r.instructions[n];if(a.action==="texture")m0(a.data,s,t);else if(a.action==="fill"||a.action==="stroke"){const i=a.action==="stroke",o=a.data.path.shapePath,c=a.data.style,l=a.data.hole;i&&l&&uh(l.shapePath,c,!0,s,t),l&&(o.shapePrimitives[o.shapePrimitives.length-1].holes=l.shapePath.shapePrimitives),uh(o,c,i,s,t)}}}function m0(r,e,t){const s=[],n=Mi.rectangle,a=u0;a.x=r.dx,a.y=r.dy,a.width=r.dw,a.height=r.dh;const i=r.transform;if(!n.build(a,s))return;const{vertices:o,uvs:c,indices:l}=t,h=l.length,d=o.length/2;i&&Nu(s,i),n.triangulate(s,o,2,d,l,h);const u=r.image,f=u.uvs;c.push(f.x0,f.y0,f.x1,f.y1,f.x3,f.y3,f.x2,f.y2);const p=Ot.get(Hu);p.indexOffset=h,p.indexSize=l.length-h,p.attributeOffset=d,p.attributeSize=o.length/2-d,p.baseColor=r.style,p.alpha=r.alpha,p.texture=u,p.geometryData=t,e.push(p)}function uh(r,e,t,s,n){const{vertices:a,uvs:i,indices:o}=n;r.shapePrimitives.forEach(({shape:c,transform:l,holes:h})=>{const d=[],u=Mi[c.type];if(!u.build(c,d))return;const f=o.length,p=a.length/2;let g="triangle-list";if(l&&Nu(d,l),t){const x=c.closePath??!0,S=e;S.pixelLine?(n0(d,x,a,o),g="line-list"):s0(d,S,!1,x,a,o)}else if(h){const x=[],S=d.slice();g0(h).forEach(A=>{x.push(S.length/2),S.push(...A)}),Gu(S,x,a,2,p,o,f)}else u.triangulate(d,a,2,p,o,f);const m=i.length/2,_=e.texture;if(_!==me.WHITE){const x=d0(f0,e,c,l);Jy(a,2,p,i,m,2,a.length/2-p,x)}else Qy(i,m,2,a.length/2-p);const b=Ot.get(Hu);b.indexOffset=f,b.indexSize=o.length-f,b.attributeOffset=p,b.attributeSize=a.length/2-p,b.baseColor=e.color,b.alpha=e.alpha,b.texture=_,b.geometryData=n,b.topology=g,s.push(b)})}function g0(r){const e=[];for(let t=0;t<r.length;t++){const s=r[t].shape,n=[];Mi[s.type].build(s,n)&&e.push(n)}return e}class y0{constructor(){this.batches=[],this.geometryData={vertices:[],uvs:[],indices:[]}}}class _0{constructor(){this.instructions=new Yd}init(e){this.batcher=new Ky({maxTextures:e}),this.instructions.reset()}get geometry(){return he(dm,"GraphicsContextRenderData#geometry is deprecated, please use batcher.geometry instead."),this.batcher.geometry}destroy(){this.batcher.destroy(),this.instructions.destroy(),this.batcher=null,this.instructions=null}}const Hc=class nc{constructor(e){this._gpuContextHash={},this._graphicsDataContextHash=Object.create(null),this._renderer=e,e.renderableGC.addManagedHash(this,"_gpuContextHash"),e.renderableGC.addManagedHash(this,"_graphicsDataContextHash")}init(e){nc.defaultOptions.bezierSmoothness=(e==null?void 0:e.bezierSmoothness)??nc.defaultOptions.bezierSmoothness}getContextRenderData(e){return this._graphicsDataContextHash[e.uid]||this._initContextRenderData(e)}updateGpuContext(e){let t=this._gpuContextHash[e.uid]||this._initContext(e);if(e.dirty){t?this._cleanGraphicsContextData(e):t=this._initContext(e),p0(e,t);const s=e.batchMode;e.customShader||s==="no-batch"?t.isBatchable=!1:s==="auto"?t.isBatchable=t.geometryData.vertices.length<400:t.isBatchable=!0,e.dirty=!1}return t}getGpuContext(e){return this._gpuContextHash[e.uid]||this._initContext(e)}_initContextRenderData(e){const t=Ot.get(_0,{maxTextures:this._renderer.limits.maxBatchableTextures}),{batches:s,geometryData:n}=this._gpuContextHash[e.uid],a=n.vertices.length,i=n.indices.length;for(let h=0;h<s.length;h++)s[h].applyTransform=!1;const o=t.batcher;o.ensureAttributeBuffer(a),o.ensureIndexBuffer(i),o.begin();for(let h=0;h<s.length;h++){const d=s[h];o.add(d)}o.finish(t.instructions);const c=o.geometry;c.indexBuffer.setDataWithSize(o.indexBuffer,o.indexSize,!0),c.buffers[0].setDataWithSize(o.attributeBuffer.float32View,o.attributeSize,!0);const l=o.batches;for(let h=0;h<l.length;h++){const d=l[h];d.bindGroup=iy(d.textures.textures,d.textures.count,this._renderer.limits.maxBatchableTextures)}return this._graphicsDataContextHash[e.uid]=t,t}_initContext(e){const t=new y0;return t.context=e,this._gpuContextHash[e.uid]=t,e.on("destroy",this.onGraphicsContextDestroy,this),this._gpuContextHash[e.uid]}onGraphicsContextDestroy(e){this._cleanGraphicsContextData(e),e.off("destroy",this.onGraphicsContextDestroy,this),this._gpuContextHash[e.uid]=null}_cleanGraphicsContextData(e){const t=this._gpuContextHash[e.uid];t.isBatchable||this._graphicsDataContextHash[e.uid]&&(Ot.return(this.getContextRenderData(e)),this._graphicsDataContextHash[e.uid]=null),t.batches&&t.batches.forEach(s=>{Ot.return(s)})}destroy(){for(const e in this._gpuContextHash)this._gpuContextHash[e]&&this.onGraphicsContextDestroy(this._gpuContextHash[e].context)}};Hc.extension={type:[J.WebGLSystem,J.WebGPUSystem,J.CanvasSystem],name:"graphicsContext"};Hc.defaultOptions={bezierSmoothness:.5};let zu=Hc;const b0=8,Pa=11920929e-14,x0=1;function Vu(r,e,t,s,n,a,i,o,c,l){const d=Math.min(.99,Math.max(0,l??zu.defaultOptions.bezierSmoothness));let u=(x0-d)/1;return u*=u,w0(e,t,s,n,a,i,o,c,r,u),r}function w0(r,e,t,s,n,a,i,o,c,l){ac(r,e,t,s,n,a,i,o,c,l,0),c.push(i,o)}function ac(r,e,t,s,n,a,i,o,c,l,h){if(h>b0)return;const d=(r+t)/2,u=(e+s)/2,f=(t+n)/2,p=(s+a)/2,g=(n+i)/2,m=(a+o)/2,_=(d+f)/2,b=(u+p)/2,x=(f+g)/2,S=(p+m)/2,T=(_+x)/2,A=(b+S)/2;if(h>0){let C=i-r,R=o-e;const $=Math.abs((t-i)*R-(s-o)*C),B=Math.abs((n-i)*R-(a-o)*C);if($>Pa&&B>Pa){if(($+B)*($+B)<=l*(C*C+R*R)){c.push(T,A);return}}else if($>Pa){if($*$<=l*(C*C+R*R)){c.push(T,A);return}}else if(B>Pa){if(B*B<=l*(C*C+R*R)){c.push(T,A);return}}else if(C=T-(r+i)/2,R=A-(e+o)/2,C*C+R*R<=l){c.push(T,A);return}}ac(r,e,d,u,_,b,T,A,c,l,h+1),ac(T,A,x,S,g,m,i,o,c,l,h+1)}const v0=8,S0=11920929e-14,k0=1;function I0(r,e,t,s,n,a,i,o){const l=Math.min(.99,Math.max(0,o??zu.defaultOptions.bezierSmoothness));let h=(k0-l)/1;return h*=h,A0(e,t,s,n,a,i,r,h),r}function A0(r,e,t,s,n,a,i,o){ic(i,r,e,t,s,n,a,o,0),i.push(n,a)}function ic(r,e,t,s,n,a,i,o,c){if(c>v0)return;const l=(e+s)/2,h=(t+n)/2,d=(s+a)/2,u=(n+i)/2,f=(l+d)/2,p=(h+u)/2;let g=a-e,m=i-t;const _=Math.abs((s-a)*m-(n-i)*g);if(_>S0){if(_*_<=o*(g*g+m*m)){r.push(f,p);return}}else if(g=f-(e+a)/2,m=p-(t+i)/2,g*g+m*m<=o){r.push(f,p);return}ic(r,e,t,l,h,f,p,o,c+1),ic(r,f,p,d,u,a,i,o,c+1)}function Wu(r,e,t,s,n,a,i,o){let c=Math.abs(n-a);(!i&&n>a||i&&a>n)&&(c=2*Math.PI-c),o||(o=Math.max(6,Math.floor(6*Math.pow(s,1/3)*(c/Math.PI)))),o=Math.max(o,3);let l=c/o,h=n;l*=i?-1:1;for(let d=0;d<o+1;d++){const u=Math.cos(h),f=Math.sin(h),p=e+u*s,g=t+f*s;r.push(p,g),h+=l}}function C0(r,e,t,s,n,a){const i=r[r.length-2],c=r[r.length-1]-t,l=i-e,h=n-t,d=s-e,u=Math.abs(c*d-l*h);if(u<1e-8||a===0){(r[r.length-2]!==e||r[r.length-1]!==t)&&r.push(e,t);return}const f=c*c+l*l,p=h*h+d*d,g=c*h+l*d,m=a*Math.sqrt(f)/u,_=a*Math.sqrt(p)/u,b=m*g/f,x=_*g/p,S=m*d+_*l,T=m*h+_*c,A=l*(_+b),C=c*(_+b),R=d*(m+x),$=h*(m+x),B=Math.atan2(C-T,A-S),j=Math.atan2($-T,R-S);Wu(r,S+e,T+t,a,B,j,l*h>d*c)}const On=Math.PI*2,bo={centerX:0,centerY:0,ang1:0,ang2:0},xo=({x:r,y:e},t,s,n,a,i,o,c)=>{r*=t,e*=s;const l=n*r-a*e,h=a*r+n*e;return c.x=l+i,c.y=h+o,c};function E0(r,e){const t=e===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(e/4),s=e===1.5707963267948966?.551915024494:t,n=Math.cos(r),a=Math.sin(r),i=Math.cos(r+e),o=Math.sin(r+e);return[{x:n-a*s,y:a+n*s},{x:i+o*s,y:o-i*s},{x:i,y:o}]}const fh=(r,e,t,s)=>{const n=r*s-e*t<0?-1:1;let a=r*t+e*s;return a>1&&(a=1),a<-1&&(a=-1),n*Math.acos(a)},T0=(r,e,t,s,n,a,i,o,c,l,h,d,u)=>{const f=Math.pow(n,2),p=Math.pow(a,2),g=Math.pow(h,2),m=Math.pow(d,2);let _=f*p-f*m-p*g;_<0&&(_=0),_/=f*m+p*g,_=Math.sqrt(_)*(i===o?-1:1);const b=_*n/a*d,x=_*-a/n*h,S=l*b-c*x+(r+t)/2,T=c*b+l*x+(e+s)/2,A=(h-b)/n,C=(d-x)/a,R=(-h-b)/n,$=(-d-x)/a,B=fh(1,0,A,C);let j=fh(A,C,R,$);o===0&&j>0&&(j-=On),o===1&&j<0&&(j+=On),u.centerX=S,u.centerY=T,u.ang1=B,u.ang2=j};function P0(r,e,t,s,n,a,i,o=0,c=0,l=0){if(a===0||i===0)return;const h=Math.sin(o*On/360),d=Math.cos(o*On/360),u=d*(e-s)/2+h*(t-n)/2,f=-h*(e-s)/2+d*(t-n)/2;if(u===0&&f===0)return;a=Math.abs(a),i=Math.abs(i);const p=Math.pow(u,2)/Math.pow(a,2)+Math.pow(f,2)/Math.pow(i,2);p>1&&(a*=Math.sqrt(p),i*=Math.sqrt(p)),T0(e,t,s,n,a,i,c,l,h,d,u,f,bo);let{ang1:g,ang2:m}=bo;const{centerX:_,centerY:b}=bo;let x=Math.abs(m)/(On/4);Math.abs(1-x)<1e-7&&(x=1);const S=Math.max(Math.ceil(x),1);m/=S;let T=r[r.length-2],A=r[r.length-1];const C={x:0,y:0};for(let R=0;R<S;R++){const $=E0(g,m),{x:B,y:j}=xo($[0],a,i,d,h,_,b,C),{x:se,y:z}=xo($[1],a,i,d,h,_,b,C),{x:de,y:Qe}=xo($[2],a,i,d,h,_,b,C);Vu(r,T,A,B,j,se,z,de,Qe),T=de,A=Qe,g+=m}}function R0(r,e,t){const s=(i,o)=>{const c=o.x-i.x,l=o.y-i.y,h=Math.sqrt(c*c+l*l),d=c/h,u=l/h;return{len:h,nx:d,ny:u}},n=(i,o)=>{i===0?r.moveTo(o.x,o.y):r.lineTo(o.x,o.y)};let a=e[e.length-1];for(let i=0;i<e.length;i++){const o=e[i%e.length],c=o.radius??t;if(c<=0){n(i,o),a=o;continue}const l=e[(i+1)%e.length],h=s(o,a),d=s(o,l);if(h.len<1e-4||d.len<1e-4){n(i,o),a=o;continue}let u=Math.asin(h.nx*d.ny-h.ny*d.nx),f=1,p=!1;h.nx*d.nx-h.ny*-d.ny<0?u<0?u=Math.PI+u:(u=Math.PI-u,f=-1,p=!0):u>0&&(f=-1,p=!0);const g=u/2;let m,_=Math.abs(Math.cos(g)*c/Math.sin(g));_>Math.min(h.len/2,d.len/2)?(_=Math.min(h.len/2,d.len/2),m=Math.abs(_*Math.sin(g)/Math.cos(g))):m=c;const b=o.x+d.nx*_+-d.ny*m*f,x=o.y+d.ny*_+d.nx*m*f,S=Math.atan2(h.ny,h.nx)+Math.PI/2*f,T=Math.atan2(d.ny,d.nx)-Math.PI/2*f;i===0&&r.moveTo(b+Math.cos(S)*m,x+Math.sin(S)*m),r.arc(b,x,m,S,T,p),a=o}}function M0(r,e,t,s){const n=(o,c)=>Math.sqrt((o.x-c.x)**2+(o.y-c.y)**2),a=(o,c,l)=>({x:o.x+(c.x-o.x)*l,y:o.y+(c.y-o.y)*l}),i=e.length;for(let o=0;o<i;o++){const c=e[(o+1)%i],l=c.radius??t;if(l<=0){o===0?r.moveTo(c.x,c.y):r.lineTo(c.x,c.y);continue}const h=e[o],d=e[(o+2)%i],u=n(h,c);let f;if(u<1e-4)f=c;else{const m=Math.min(u/2,l);f=a(c,h,m/u)}const p=n(d,c);let g;if(p<1e-4)g=c;else{const m=Math.min(p/2,l);g=a(c,d,m/p)}o===0?r.moveTo(f.x,f.y):r.lineTo(f.x,f.y),r.quadraticCurveTo(c.x,c.y,g.x,g.y,s)}}const $0=new Re;class O0{constructor(e){this.shapePrimitives=[],this._currentPoly=null,this._bounds=new Wt,this._graphicsPath2D=e,this.signed=e.checkForHoles}moveTo(e,t){return this.startPoly(e,t),this}lineTo(e,t){this._ensurePoly();const s=this._currentPoly.points,n=s[s.length-2],a=s[s.length-1];return(n!==e||a!==t)&&s.push(e,t),this}arc(e,t,s,n,a,i){this._ensurePoly(!1);const o=this._currentPoly.points;return Wu(o,e,t,s,n,a,i),this}arcTo(e,t,s,n,a){this._ensurePoly();const i=this._currentPoly.points;return C0(i,e,t,s,n,a),this}arcToSvg(e,t,s,n,a,i,o){const c=this._currentPoly.points;return P0(c,this._currentPoly.lastX,this._currentPoly.lastY,i,o,e,t,s,n,a),this}bezierCurveTo(e,t,s,n,a,i,o){this._ensurePoly();const c=this._currentPoly;return Vu(this._currentPoly.points,c.lastX,c.lastY,e,t,s,n,a,i,o),this}quadraticCurveTo(e,t,s,n,a){this._ensurePoly();const i=this._currentPoly;return I0(this._currentPoly.points,i.lastX,i.lastY,e,t,s,n,a),this}closePath(){return this.endPoly(!0),this}addPath(e,t){this.endPoly(),t&&!t.isIdentity()&&(e=e.clone(!0),e.transform(t));const s=this.shapePrimitives,n=s.length;for(let a=0;a<e.instructions.length;a++){const i=e.instructions[a];this[i.action](...i.data)}if(e.checkForHoles&&s.length-n>1){let a=null;for(let i=n;i<s.length;i++){const o=s[i];if(o.shape.type==="polygon"){const c=o.shape,l=a==null?void 0:a.shape;l&&l.containsPolygon(c)?(a.holes||(a.holes=[]),a.holes.push(o),s.copyWithin(i,i+1),s.length--,i--):a=o}}}return this}finish(e=!1){this.endPoly(e)}rect(e,t,s,n,a){return this.drawShape(new Re(e,t,s,n),a),this}circle(e,t,s,n){return this.drawShape(new Fc(e,t,s),n),this}poly(e,t,s){const n=new Mn(e);return n.closePath=t,this.drawShape(n,s),this}regularPoly(e,t,s,n,a=0,i){n=Math.max(n|0,3);const o=-1*Math.PI/2+a,c=Math.PI*2/n,l=[];for(let h=0;h<n;h++){const d=o-h*c;l.push(e+s*Math.cos(d),t+s*Math.sin(d))}return this.poly(l,!0,i),this}roundPoly(e,t,s,n,a,i=0,o){if(n=Math.max(n|0,3),a<=0)return this.regularPoly(e,t,s,n,i);const c=s*Math.sin(Math.PI/n)-.001;a=Math.min(a,c);const l=-1*Math.PI/2+i,h=Math.PI*2/n,d=(n-2)*Math.PI/n/2;for(let u=0;u<n;u++){const f=u*h+l,p=e+s*Math.cos(f),g=t+s*Math.sin(f),m=f+Math.PI+d,_=f-Math.PI-d,b=p+a*Math.cos(m),x=g+a*Math.sin(m),S=p+a*Math.cos(_),T=g+a*Math.sin(_);u===0?this.moveTo(b,x):this.lineTo(b,x),this.quadraticCurveTo(p,g,S,T,o)}return this.closePath()}roundShape(e,t,s=!1,n){return e.length<3?this:(s?M0(this,e,t,n):R0(this,e,t),this.closePath())}filletRect(e,t,s,n,a){if(a===0)return this.rect(e,t,s,n);const i=Math.min(s,n)/2,o=Math.min(i,Math.max(-i,a)),c=e+s,l=t+n,h=o<0?-o:0,d=Math.abs(o);return this.moveTo(e,t+d).arcTo(e+h,t+h,e+d,t,d).lineTo(c-d,t).arcTo(c-h,t+h,c,t+d,d).lineTo(c,l-d).arcTo(c-h,l-h,e+s-d,l,d).lineTo(e+d,l).arcTo(e+h,l-h,e,l-d,d).closePath()}chamferRect(e,t,s,n,a,i){if(a<=0)return this.rect(e,t,s,n);const o=Math.min(a,Math.min(s,n)/2),c=e+s,l=t+n,h=[e+o,t,c-o,t,c,t+o,c,l-o,c-o,l,e+o,l,e,l-o,e,t+o];for(let d=h.length-1;d>=2;d-=2)h[d]===h[d-2]&&h[d-1]===h[d-3]&&h.splice(d-1,2);return this.poly(h,!0,i)}ellipse(e,t,s,n,a){return this.drawShape(new jc(e,t,s,n),a),this}roundRect(e,t,s,n,a,i){return this.drawShape(new Nc(e,t,s,n,a),i),this}drawShape(e,t){return this.endPoly(),this.shapePrimitives.push({shape:e,transform:t}),this}startPoly(e,t){let s=this._currentPoly;return s&&this.endPoly(),s=new Mn,s.points.push(e,t),this._currentPoly=s,this}endPoly(e=!1){const t=this._currentPoly;return t&&t.points.length>2&&(t.closePath=e,this.shapePrimitives.push({shape:t})),this._currentPoly=null,this}_ensurePoly(e=!0){if(!this._currentPoly&&(this._currentPoly=new Mn,e)){const t=this.shapePrimitives[this.shapePrimitives.length-1];if(t){let s=t.shape.x,n=t.shape.y;if(t.transform&&!t.transform.isIdentity()){const a=t.transform,i=s;s=a.a*s+a.c*n+a.tx,n=a.b*i+a.d*n+a.ty}this._currentPoly.points.push(s,n)}else this._currentPoly.points.push(0,0)}}buildPath(){const e=this._graphicsPath2D;this.shapePrimitives.length=0,this._currentPoly=null;for(let t=0;t<e.instructions.length;t++){const s=e.instructions[t];this[s.action](...s.data)}this.finish()}get bounds(){const e=this._bounds;e.clear();const t=this.shapePrimitives;for(let s=0;s<t.length;s++){const n=t[s],a=n.shape.getBounds($0);n.transform?e.addRect(a,n.transform):e.addRect(a)}return e}}class _r{constructor(e,t=!1){this.instructions=[],this.uid=je("graphicsPath"),this._dirty=!0,this.checkForHoles=t,typeof e=="string"?ry(e,this):this.instructions=(e==null?void 0:e.slice())??[]}get shapePath(){return this._shapePath||(this._shapePath=new O0(this)),this._dirty&&(this._dirty=!1,this._shapePath.buildPath()),this._shapePath}addPath(e,t){return e=e.clone(),this.instructions.push({action:"addPath",data:[e,t]}),this._dirty=!0,this}arc(...e){return this.instructions.push({action:"arc",data:e}),this._dirty=!0,this}arcTo(...e){return this.instructions.push({action:"arcTo",data:e}),this._dirty=!0,this}arcToSvg(...e){return this.instructions.push({action:"arcToSvg",data:e}),this._dirty=!0,this}bezierCurveTo(...e){return this.instructions.push({action:"bezierCurveTo",data:e}),this._dirty=!0,this}bezierCurveToShort(e,t,s,n,a){const i=this.instructions[this.instructions.length-1],o=this.getLastPoint(ft.shared);let c=0,l=0;if(!i||i.action!=="bezierCurveTo")c=o.x,l=o.y;else{c=i.data[2],l=i.data[3];const h=o.x,d=o.y;c=h+(h-c),l=d+(d-l)}return this.instructions.push({action:"bezierCurveTo",data:[c,l,e,t,s,n,a]}),this._dirty=!0,this}closePath(){return this.instructions.push({action:"closePath",data:[]}),this._dirty=!0,this}ellipse(...e){return this.instructions.push({action:"ellipse",data:e}),this._dirty=!0,this}lineTo(...e){return this.instructions.push({action:"lineTo",data:e}),this._dirty=!0,this}moveTo(...e){return this.instructions.push({action:"moveTo",data:e}),this}quadraticCurveTo(...e){return this.instructions.push({action:"quadraticCurveTo",data:e}),this._dirty=!0,this}quadraticCurveToShort(e,t,s){const n=this.instructions[this.instructions.length-1],a=this.getLastPoint(ft.shared);let i=0,o=0;if(!n||n.action!=="quadraticCurveTo")i=a.x,o=a.y;else{i=n.data[0],o=n.data[1];const c=a.x,l=a.y;i=c+(c-i),o=l+(l-o)}return this.instructions.push({action:"quadraticCurveTo",data:[i,o,e,t,s]}),this._dirty=!0,this}rect(e,t,s,n,a){return this.instructions.push({action:"rect",data:[e,t,s,n,a]}),this._dirty=!0,this}circle(e,t,s,n){return this.instructions.push({action:"circle",data:[e,t,s,n]}),this._dirty=!0,this}roundRect(...e){return this.instructions.push({action:"roundRect",data:e}),this._dirty=!0,this}poly(...e){return this.instructions.push({action:"poly",data:e}),this._dirty=!0,this}regularPoly(...e){return this.instructions.push({action:"regularPoly",data:e}),this._dirty=!0,this}roundPoly(...e){return this.instructions.push({action:"roundPoly",data:e}),this._dirty=!0,this}roundShape(...e){return this.instructions.push({action:"roundShape",data:e}),this._dirty=!0,this}filletRect(...e){return this.instructions.push({action:"filletRect",data:e}),this._dirty=!0,this}chamferRect(...e){return this.instructions.push({action:"chamferRect",data:e}),this._dirty=!0,this}star(e,t,s,n,a,i,o){a||(a=n/2);const c=-1*Math.PI/2+i,l=s*2,h=Math.PI*2/l,d=[];for(let u=0;u<l;u++){const f=u%2?a:n,p=u*h+c;d.push(e+f*Math.cos(p),t+f*Math.sin(p))}return this.poly(d,!0,o),this}clone(e=!1){const t=new _r;if(t.checkForHoles=this.checkForHoles,!e)t.instructions=this.instructions.slice();else for(let s=0;s<this.instructions.length;s++){const n=this.instructions[s];t.instructions.push({action:n.action,data:n.data.slice()})}return t}clear(){return this.instructions.length=0,this._dirty=!0,this}transform(e){if(e.isIdentity())return this;const t=e.a,s=e.b,n=e.c,a=e.d,i=e.tx,o=e.ty;let c=0,l=0,h=0,d=0,u=0,f=0,p=0,g=0;for(let m=0;m<this.instructions.length;m++){const _=this.instructions[m],b=_.data;switch(_.action){case"moveTo":case"lineTo":c=b[0],l=b[1],b[0]=t*c+n*l+i,b[1]=s*c+a*l+o;break;case"bezierCurveTo":h=b[0],d=b[1],u=b[2],f=b[3],c=b[4],l=b[5],b[0]=t*h+n*d+i,b[1]=s*h+a*d+o,b[2]=t*u+n*f+i,b[3]=s*u+a*f+o,b[4]=t*c+n*l+i,b[5]=s*c+a*l+o;break;case"quadraticCurveTo":h=b[0],d=b[1],c=b[2],l=b[3],b[0]=t*h+n*d+i,b[1]=s*h+a*d+o,b[2]=t*c+n*l+i,b[3]=s*c+a*l+o;break;case"arcToSvg":c=b[5],l=b[6],p=b[0],g=b[1],b[0]=t*p+n*g,b[1]=s*p+a*g,b[5]=t*c+n*l+i,b[6]=s*c+a*l+o;break;case"circle":b[4]=xn(b[3],e);break;case"rect":b[4]=xn(b[4],e);break;case"ellipse":b[8]=xn(b[8],e);break;case"roundRect":b[5]=xn(b[5],e);break;case"addPath":b[0].transform(e);break;case"poly":b[2]=xn(b[2],e);break;default:Ae("unknown transform action",_.action);break}}return this._dirty=!0,this}get bounds(){return this.shapePath.bounds}getLastPoint(e){let t=this.instructions.length-1,s=this.instructions[t];if(!s)return e.x=0,e.y=0,e;for(;s.action==="closePath";){if(t--,t<0)return e.x=0,e.y=0,e;s=this.instructions[t]}switch(s.action){case"moveTo":case"lineTo":e.x=s.data[0],e.y=s.data[1];break;case"quadraticCurveTo":e.x=s.data[2],e.y=s.data[3];break;case"bezierCurveTo":e.x=s.data[4],e.y=s.data[5];break;case"arc":case"arcToSvg":e.x=s.data[5],e.y=s.data[6];break;case"addPath":s.data[0].getLastPoint(e);break}return e}}function xn(r,e){return r?r.prepend(e):e.clone()}function Fe(r,e,t){const s=r.getAttribute(e);return s?Number(s):t}function B0(r,e){const t=r.querySelectorAll("defs");for(let s=0;s<t.length;s++){const n=t[s];for(let a=0;a<n.children.length;a++){const i=n.children[a];switch(i.nodeName.toLowerCase()){case"lineargradient":e.defs[i.id]=D0(i);break;case"radialgradient":e.defs[i.id]=L0();break}}}}function D0(r){const e=Fe(r,"x1",0),t=Fe(r,"y1",0),s=Fe(r,"x2",1),n=Fe(r,"y2",0),a=r.getAttribute("gradientUnits")||"objectBoundingBox",i=new br(e,t,s,n,a==="objectBoundingBox"?"local":"global");for(let o=0;o<r.children.length;o++){const c=r.children[o],l=Fe(c,"offset",0),h=qe.shared.setValue(c.getAttribute("stop-color")).toNumber();i.addColorStop(l,h)}return i}function L0(r){return Ae("[SVG Parser] Radial gradients are not yet supported"),new br(0,0,1,0)}function ph(r){const e=r.match(/url\s*\(\s*['"]?\s*#([^'"\s)]+)\s*['"]?\s*\)/i);return e?e[1]:""}const mh={fill:{type:"paint",default:0},"fill-opacity":{type:"number",default:1},stroke:{type:"paint",default:0},"stroke-width":{type:"number",default:1},"stroke-opacity":{type:"number",default:1},"stroke-linecap":{type:"string",default:"butt"},"stroke-linejoin":{type:"string",default:"miter"},"stroke-miterlimit":{type:"number",default:10},"stroke-dasharray":{type:"string",default:"none"},"stroke-dashoffset":{type:"number",default:0},opacity:{type:"number",default:1}};function qu(r,e){const t=r.getAttribute("style"),s={},n={},a={strokeStyle:s,fillStyle:n,useFill:!1,useStroke:!1};for(const i in mh){const o=r.getAttribute(i);o&&gh(e,a,i,o.trim())}if(t){const i=t.split(";");for(let o=0;o<i.length;o++){const c=i[o].trim(),[l,h]=c.split(":");mh[l]&&gh(e,a,l,h.trim())}}return{strokeStyle:a.useStroke?s:null,fillStyle:a.useFill?n:null,useFill:a.useFill,useStroke:a.useStroke}}function gh(r,e,t,s){switch(t){case"stroke":if(s!=="none"){if(s.startsWith("url(")){const n=ph(s);e.strokeStyle.fill=r.defs[n]}else e.strokeStyle.color=qe.shared.setValue(s).toNumber();e.useStroke=!0}break;case"stroke-width":e.strokeStyle.width=Number(s);break;case"fill":if(s!=="none"){if(s.startsWith("url(")){const n=ph(s);e.fillStyle.fill=r.defs[n]}else e.fillStyle.color=qe.shared.setValue(s).toNumber();e.useFill=!0}break;case"fill-opacity":e.fillStyle.alpha=Number(s);break;case"stroke-opacity":e.strokeStyle.alpha=Number(s);break;case"opacity":e.fillStyle.alpha=Number(s),e.strokeStyle.alpha=Number(s);break}}function F0(r){if(r.length<=2)return!0;const e=r.map(o=>o.area).sort((o,c)=>c-o),[t,s]=e,n=e[e.length-1],a=t/s,i=s/n;return!(a>3&&i<2)}function j0(r){return r.split(/(?=[Mm])/).filter(s=>s.trim().length>0)}function N0(r){const e=r.match(/[-+]?[0-9]*\.?[0-9]+/g);if(!e||e.length<4)return 0;const t=e.map(Number),s=[],n=[];for(let h=0;h<t.length;h+=2)h+1<t.length&&(s.push(t[h]),n.push(t[h+1]));if(s.length===0||n.length===0)return 0;const a=Math.min(...s),i=Math.max(...s),o=Math.min(...n),c=Math.max(...n);return(i-a)*(c-o)}function yh(r,e){const t=new _r(r,!1);for(const s of t.instructions)e.instructions.push(s)}function H0(r,e){if(typeof r=="string"){const i=document.createElement("div");i.innerHTML=r.trim(),r=i.querySelector("svg")}const t={context:e,defs:{},path:new _r};B0(r,t);const s=r.children,{fillStyle:n,strokeStyle:a}=qu(r,t);for(let i=0;i<s.length;i++){const o=s[i];o.nodeName.toLowerCase()!=="defs"&&Xu(o,t,n,a)}return e}function Xu(r,e,t,s){const n=r.children,{fillStyle:a,strokeStyle:i}=qu(r,e);a&&t?t={...t,...a}:a&&(t=a),i&&s?s={...s,...i}:i&&(s=i);const o=!t&&!s;o&&(t={color:0});let c,l,h,d,u,f,p,g,m,_,b,x,S,T,A,C,R;switch(r.nodeName.toLowerCase()){case"path":{T=r.getAttribute("d");const $=r.getAttribute("fill-rule"),B=j0(T),j=$==="evenodd",se=B.length>1;if(j&&se){const de=B.map(G=>({path:G,area:N0(G)}));if(de.sort((G,Q)=>Q.area-G.area),B.length>3||!F0(de))for(let G=0;G<de.length;G++){const Q=de[G],xr=G===0;e.context.beginPath();const ue=new _r(void 0,!0);yh(Q.path,ue),e.context.path(ue),xr?(t&&e.context.fill(t),s&&e.context.stroke(s)):e.context.cut()}else for(let G=0;G<de.length;G++){const Q=de[G],xr=G%2===1;e.context.beginPath();const ue=new _r(void 0,!0);yh(Q.path,ue),e.context.path(ue),xr?e.context.cut():(t&&e.context.fill(t),s&&e.context.stroke(s))}}else{const de=$?$==="evenodd":!0;A=new _r(T,de),e.context.path(A),t&&e.context.fill(t),s&&e.context.stroke(s)}break}case"circle":p=Fe(r,"cx",0),g=Fe(r,"cy",0),m=Fe(r,"r",0),e.context.ellipse(p,g,m,m),t&&e.context.fill(t),s&&e.context.stroke(s);break;case"rect":c=Fe(r,"x",0),l=Fe(r,"y",0),C=Fe(r,"width",0),R=Fe(r,"height",0),_=Fe(r,"rx",0),b=Fe(r,"ry",0),_||b?e.context.roundRect(c,l,C,R,_||b):e.context.rect(c,l,C,R),t&&e.context.fill(t),s&&e.context.stroke(s);break;case"ellipse":p=Fe(r,"cx",0),g=Fe(r,"cy",0),_=Fe(r,"rx",0),b=Fe(r,"ry",0),e.context.beginPath(),e.context.ellipse(p,g,_,b),t&&e.context.fill(t),s&&e.context.stroke(s);break;case"line":h=Fe(r,"x1",0),d=Fe(r,"y1",0),u=Fe(r,"x2",0),f=Fe(r,"y2",0),e.context.beginPath(),e.context.moveTo(h,d),e.context.lineTo(u,f),s&&e.context.stroke(s);break;case"polygon":S=r.getAttribute("points"),x=S.match(/\d+/g).map($=>parseInt($,10)),e.context.poly(x,!0),t&&e.context.fill(t),s&&e.context.stroke(s);break;case"polyline":S=r.getAttribute("points"),x=S.match(/\d+/g).map($=>parseInt($,10)),e.context.poly(x,!1),s&&e.context.stroke(s);break;case"g":case"svg":break;default:{Ae(`[SVG parser] <${r.nodeName}> elements unsupported`);break}}o&&(t=null);for(let $=0;$<n.length;$++)Xu(n[$],e,t,s)}function U0(r){return qe.isColorLike(r)}function _h(r){return r instanceof Ri}function bh(r){return r instanceof br}function G0(r){return r instanceof me}function z0(r,e,t){const s=qe.shared.setValue(e??0);return r.color=s.toNumber(),r.alpha=s.alpha===1?t.alpha:s.alpha,r.texture=me.WHITE,{...t,...r}}function V0(r,e,t){return r.texture=e,{...t,...r}}function xh(r,e,t){return r.fill=e,r.color=16777215,r.texture=e.texture,r.matrix=e.transform,{...t,...r}}function wh(r,e,t){return e.buildGradient(),r.fill=e,r.color=16777215,r.texture=e.texture,r.matrix=e.transform,r.textureSpace=e.textureSpace,{...t,...r}}function W0(r,e){const t={...e,...r},s=qe.shared.setValue(t.color);return t.alpha*=s.alpha,t.color=s.toNumber(),t}function ns(r,e){if(r==null)return null;const t={},s=r;return U0(r)?z0(t,r,e):G0(r)?V0(t,r,e):_h(r)?xh(t,r,e):bh(r)?wh(t,r,e):s.fill&&_h(s.fill)?xh(s,s.fill,e):s.fill&&bh(s.fill)?wh(s,s.fill,e):W0(s,e)}function yi(r,e){const{width:t,alignment:s,miterLimit:n,cap:a,join:i,pixelLine:o,...c}=e,l=ns(r,c);return l?{width:t,alignment:s,miterLimit:n,cap:a,join:i,pixelLine:o,...l}:null}const q0=new ft,vh=new pe,Uc=class rr extends qt{constructor(){super(...arguments),this.uid=je("graphicsContext"),this.dirty=!0,this.batchMode="auto",this.instructions=[],this._activePath=new _r,this._transform=new pe,this._fillStyle={...rr.defaultFillStyle},this._strokeStyle={...rr.defaultStrokeStyle},this._stateStack=[],this._tick=0,this._bounds=new Wt,this._boundsDirty=!0}clone(){const e=new rr;return e.batchMode=this.batchMode,e.instructions=this.instructions.slice(),e._activePath=this._activePath.clone(),e._transform=this._transform.clone(),e._fillStyle={...this._fillStyle},e._strokeStyle={...this._strokeStyle},e._stateStack=this._stateStack.slice(),e._bounds=this._bounds.clone(),e._boundsDirty=!0,e}get fillStyle(){return this._fillStyle}set fillStyle(e){this._fillStyle=ns(e,rr.defaultFillStyle)}get strokeStyle(){return this._strokeStyle}set strokeStyle(e){this._strokeStyle=yi(e,rr.defaultStrokeStyle)}setFillStyle(e){return this._fillStyle=ns(e,rr.defaultFillStyle),this}setStrokeStyle(e){return this._strokeStyle=ns(e,rr.defaultStrokeStyle),this}texture(e,t,s,n,a,i){return this.instructions.push({action:"texture",data:{image:e,dx:s||0,dy:n||0,dw:a||e.frame.width,dh:i||e.frame.height,transform:this._transform.clone(),alpha:this._fillStyle.alpha,style:t?qe.shared.setValue(t).toNumber():16777215}}),this.onUpdate(),this}beginPath(){return this._activePath=new _r,this}fill(e,t){let s;const n=this.instructions[this.instructions.length-1];return this._tick===0&&n&&n.action==="stroke"?s=n.data.path:s=this._activePath.clone(),s?(e!=null&&(t!==void 0&&typeof e=="number"&&(he(_e,"GraphicsContext.fill(color, alpha) is deprecated, use GraphicsContext.fill({ color, alpha }) instead"),e={color:e,alpha:t}),this._fillStyle=ns(e,rr.defaultFillStyle)),this.instructions.push({action:"fill",data:{style:this.fillStyle,path:s}}),this.onUpdate(),this._initNextPathLocation(),this._tick=0,this):this}_initNextPathLocation(){const{x:e,y:t}=this._activePath.getLastPoint(ft.shared);this._activePath.clear(),this._activePath.moveTo(e,t)}stroke(e){let t;const s=this.instructions[this.instructions.length-1];return this._tick===0&&s&&s.action==="fill"?t=s.data.path:t=this._activePath.clone(),t?(e!=null&&(this._strokeStyle=yi(e,rr.defaultStrokeStyle)),this.instructions.push({action:"stroke",data:{style:this.strokeStyle,path:t}}),this.onUpdate(),this._initNextPathLocation(),this._tick=0,this):this}cut(){for(let e=0;e<2;e++){const t=this.instructions[this.instructions.length-1-e],s=this._activePath.clone();if(t&&(t.action==="stroke"||t.action==="fill"))if(t.data.hole)t.data.hole.addPath(s);else{t.data.hole=s;break}}return this._initNextPathLocation(),this}arc(e,t,s,n,a,i){this._tick++;const o=this._transform;return this._activePath.arc(o.a*e+o.c*t+o.tx,o.b*e+o.d*t+o.ty,s,n,a,i),this}arcTo(e,t,s,n,a){this._tick++;const i=this._transform;return this._activePath.arcTo(i.a*e+i.c*t+i.tx,i.b*e+i.d*t+i.ty,i.a*s+i.c*n+i.tx,i.b*s+i.d*n+i.ty,a),this}arcToSvg(e,t,s,n,a,i,o){this._tick++;const c=this._transform;return this._activePath.arcToSvg(e,t,s,n,a,c.a*i+c.c*o+c.tx,c.b*i+c.d*o+c.ty),this}bezierCurveTo(e,t,s,n,a,i,o){this._tick++;const c=this._transform;return this._activePath.bezierCurveTo(c.a*e+c.c*t+c.tx,c.b*e+c.d*t+c.ty,c.a*s+c.c*n+c.tx,c.b*s+c.d*n+c.ty,c.a*a+c.c*i+c.tx,c.b*a+c.d*i+c.ty,o),this}closePath(){var e;return this._tick++,(e=this._activePath)==null||e.closePath(),this}ellipse(e,t,s,n){return this._tick++,this._activePath.ellipse(e,t,s,n,this._transform.clone()),this}circle(e,t,s){return this._tick++,this._activePath.circle(e,t,s,this._transform.clone()),this}path(e){return this._tick++,this._activePath.addPath(e,this._transform.clone()),this}lineTo(e,t){this._tick++;const s=this._transform;return this._activePath.lineTo(s.a*e+s.c*t+s.tx,s.b*e+s.d*t+s.ty),this}moveTo(e,t){this._tick++;const s=this._transform,n=this._activePath.instructions,a=s.a*e+s.c*t+s.tx,i=s.b*e+s.d*t+s.ty;return n.length===1&&n[0].action==="moveTo"?(n[0].data[0]=a,n[0].data[1]=i,this):(this._activePath.moveTo(a,i),this)}quadraticCurveTo(e,t,s,n,a){this._tick++;const i=this._transform;return this._activePath.quadraticCurveTo(i.a*e+i.c*t+i.tx,i.b*e+i.d*t+i.ty,i.a*s+i.c*n+i.tx,i.b*s+i.d*n+i.ty,a),this}rect(e,t,s,n){return this._tick++,this._activePath.rect(e,t,s,n,this._transform.clone()),this}roundRect(e,t,s,n,a){return this._tick++,this._activePath.roundRect(e,t,s,n,a,this._transform.clone()),this}poly(e,t){return this._tick++,this._activePath.poly(e,t,this._transform.clone()),this}regularPoly(e,t,s,n,a=0,i){return this._tick++,this._activePath.regularPoly(e,t,s,n,a,i),this}roundPoly(e,t,s,n,a,i){return this._tick++,this._activePath.roundPoly(e,t,s,n,a,i),this}roundShape(e,t,s,n){return this._tick++,this._activePath.roundShape(e,t,s,n),this}filletRect(e,t,s,n,a){return this._tick++,this._activePath.filletRect(e,t,s,n,a),this}chamferRect(e,t,s,n,a,i){return this._tick++,this._activePath.chamferRect(e,t,s,n,a,i),this}star(e,t,s,n,a=0,i=0){return this._tick++,this._activePath.star(e,t,s,n,a,i,this._transform.clone()),this}svg(e){return this._tick++,H0(e,this),this}restore(){const e=this._stateStack.pop();return e&&(this._transform=e.transform,this._fillStyle=e.fillStyle,this._strokeStyle=e.strokeStyle),this}save(){return this._stateStack.push({transform:this._transform.clone(),fillStyle:{...this._fillStyle},strokeStyle:{...this._strokeStyle}}),this}getTransform(){return this._transform}resetTransform(){return this._transform.identity(),this}rotate(e){return this._transform.rotate(e),this}scale(e,t=e){return this._transform.scale(e,t),this}setTransform(e,t,s,n,a,i){return e instanceof pe?(this._transform.set(e.a,e.b,e.c,e.d,e.tx,e.ty),this):(this._transform.set(e,t,s,n,a,i),this)}transform(e,t,s,n,a,i){return e instanceof pe?(this._transform.append(e),this):(vh.set(e,t,s,n,a,i),this._transform.append(vh),this)}translate(e,t=e){return this._transform.translate(e,t),this}clear(){return this._activePath.clear(),this.instructions.length=0,this.resetTransform(),this.onUpdate(),this}onUpdate(){this._boundsDirty=!0,!this.dirty&&(this.emit("update",this,16),this.dirty=!0)}get bounds(){if(!this._boundsDirty)return this._bounds;this._boundsDirty=!1;const e=this._bounds;e.clear();for(let t=0;t<this.instructions.length;t++){const s=this.instructions[t],n=s.action;if(n==="fill"){const a=s.data;e.addBounds(a.path.bounds)}else if(n==="texture"){const a=s.data;e.addFrame(a.dx,a.dy,a.dx+a.dw,a.dy+a.dh,a.transform)}if(n==="stroke"){const a=s.data,i=a.style.alignment,o=a.style.width*(1-i),c=a.path.bounds;e.addFrame(c.minX-o,c.minY-o,c.maxX+o,c.maxY+o)}}return e}containsPoint(e){var n;if(!this.bounds.containsPoint(e.x,e.y))return!1;const t=this.instructions;let s=!1;for(let a=0;a<t.length;a++){const i=t[a],o=i.data,c=o.path;if(!i.action||!c)continue;const l=o.style,h=c.shapePath.shapePrimitives;for(let d=0;d<h.length;d++){const u=h[d].shape;if(!l||!u)continue;const f=h[d].transform,p=f?f.applyInverse(e,q0):e;if(i.action==="fill")s=u.contains(p.x,p.y);else{const m=l;s=u.strokeContains(p.x,p.y,m.width,m.alignment)}const g=o.hole;if(g){const m=(n=g.shapePath)==null?void 0:n.shapePrimitives;if(m)for(let _=0;_<m.length;_++)m[_].shape.contains(p.x,p.y)&&(s=!1)}if(s)return!0}}return s}destroy(e=!1){if(this._stateStack.length=0,this._transform=null,this.emit("destroy",this),this.removeAllListeners(),typeof e=="boolean"?e:e==null?void 0:e.texture){const s=typeof e=="boolean"?e:e==null?void 0:e.textureSource;this._fillStyle.texture&&(this._fillStyle.fill&&"uid"in this._fillStyle.fill?this._fillStyle.fill.destroy():this._fillStyle.texture.destroy(s)),this._strokeStyle.texture&&(this._strokeStyle.fill&&"uid"in this._strokeStyle.fill?this._strokeStyle.fill.destroy():this._strokeStyle.texture.destroy(s))}this._fillStyle=null,this._strokeStyle=null,this.instructions=null,this._activePath=null,this._bounds=null,this._stateStack=null,this.customShader=null,this._transform=null}};Uc.defaultFillStyle={color:16777215,alpha:1,texture:me.WHITE,matrix:null,fill:null,textureSpace:"local"};Uc.defaultStrokeStyle={width:1,color:16777215,alpha:1,alignment:.5,miterLimit:10,cap:"butt",join:"miter",texture:me.WHITE,matrix:null,fill:null,textureSpace:"local",pixelLine:!1};let Mt=Uc;const Gc=class Ts extends qt{constructor(e={}){super(),this.uid=je("textStyle"),this._tick=0,X0(e);const t={...Ts.defaultTextStyle,...e};for(const s in t){const n=s;this[n]=t[s]}this.update(),this._tick=0}get align(){return this._align}set align(e){this._align!==e&&(this._align=e,this.update())}get breakWords(){return this._breakWords}set breakWords(e){this._breakWords!==e&&(this._breakWords=e,this.update())}get dropShadow(){return this._dropShadow}set dropShadow(e){this._dropShadow!==e&&(e!==null&&typeof e=="object"?this._dropShadow=this._createProxy({...Ts.defaultDropShadow,...e}):this._dropShadow=e?this._createProxy({...Ts.defaultDropShadow}):null,this.update())}get fontFamily(){return this._fontFamily}set fontFamily(e){this._fontFamily!==e&&(this._fontFamily=e,this.update())}get fontSize(){return this._fontSize}set fontSize(e){this._fontSize!==e&&(typeof e=="string"?this._fontSize=parseInt(e,10):this._fontSize=e,this.update())}get fontStyle(){return this._fontStyle}set fontStyle(e){this._fontStyle!==e&&(this._fontStyle=e.toLowerCase(),this.update())}get fontVariant(){return this._fontVariant}set fontVariant(e){this._fontVariant!==e&&(this._fontVariant=e,this.update())}get fontWeight(){return this._fontWeight}set fontWeight(e){this._fontWeight!==e&&(this._fontWeight=e,this.update())}get leading(){return this._leading}set leading(e){this._leading!==e&&(this._leading=e,this.update())}get letterSpacing(){return this._letterSpacing}set letterSpacing(e){this._letterSpacing!==e&&(this._letterSpacing=e,this.update())}get lineHeight(){return this._lineHeight}set lineHeight(e){this._lineHeight!==e&&(this._lineHeight=e,this.update())}get padding(){return this._padding}set padding(e){this._padding!==e&&(this._padding=e,this.update())}get filters(){return this._filters}set filters(e){this._filters!==e&&(this._filters=Object.freeze(e),this.update())}get trim(){return this._trim}set trim(e){this._trim!==e&&(this._trim=e,this.update())}get textBaseline(){return this._textBaseline}set textBaseline(e){this._textBaseline!==e&&(this._textBaseline=e,this.update())}get whiteSpace(){return this._whiteSpace}set whiteSpace(e){this._whiteSpace!==e&&(this._whiteSpace=e,this.update())}get wordWrap(){return this._wordWrap}set wordWrap(e){this._wordWrap!==e&&(this._wordWrap=e,this.update())}get wordWrapWidth(){return this._wordWrapWidth}set wordWrapWidth(e){this._wordWrapWidth!==e&&(this._wordWrapWidth=e,this.update())}get fill(){return this._originalFill}set fill(e){e!==this._originalFill&&(this._originalFill=e,this._isFillStyle(e)&&(this._originalFill=this._createProxy({...Mt.defaultFillStyle,...e},()=>{this._fill=ns({...this._originalFill},Mt.defaultFillStyle)})),this._fill=ns(e===0?"black":e,Mt.defaultFillStyle),this.update())}get stroke(){return this._originalStroke}set stroke(e){e!==this._originalStroke&&(this._originalStroke=e,this._isFillStyle(e)&&(this._originalStroke=this._createProxy({...Mt.defaultStrokeStyle,...e},()=>{this._stroke=yi({...this._originalStroke},Mt.defaultStrokeStyle)})),this._stroke=yi(e,Mt.defaultStrokeStyle),this.update())}update(){this._tick++,this.emit("update",this)}reset(){const e=Ts.defaultTextStyle;for(const t in e)this[t]=e[t]}get styleKey(){return`${this.uid}-${this._tick}`}clone(){return new Ts({align:this.align,breakWords:this.breakWords,dropShadow:this._dropShadow?{...this._dropShadow}:null,fill:this._fill,fontFamily:this.fontFamily,fontSize:this.fontSize,fontStyle:this.fontStyle,fontVariant:this.fontVariant,fontWeight:this.fontWeight,leading:this.leading,letterSpacing:this.letterSpacing,lineHeight:this.lineHeight,padding:this.padding,stroke:this._stroke,textBaseline:this.textBaseline,whiteSpace:this.whiteSpace,wordWrap:this.wordWrap,wordWrapWidth:this.wordWrapWidth,filters:this._filters?[...this._filters]:void 0})}_getFinalPadding(){let e=0;if(this._filters)for(let t=0;t<this._filters.length;t++)e+=this._filters[t].padding;return Math.max(this._padding,e)}destroy(e=!1){var s,n,a,i;if(this.removeAllListeners(),typeof e=="boolean"?e:e==null?void 0:e.texture){const o=typeof e=="boolean"?e:e==null?void 0:e.textureSource;(s=this._fill)!=null&&s.texture&&this._fill.texture.destroy(o),(n=this._originalFill)!=null&&n.texture&&this._originalFill.texture.destroy(o),(a=this._stroke)!=null&&a.texture&&this._stroke.texture.destroy(o),(i=this._originalStroke)!=null&&i.texture&&this._originalStroke.texture.destroy(o)}this._fill=null,this._stroke=null,this.dropShadow=null,this._originalStroke=null,this._originalFill=null}_createProxy(e,t){return new Proxy(e,{set:(s,n,a)=>(s[n]===a||(s[n]=a,t==null||t(n,a),this.update()),!0)})}_isFillStyle(e){return(e??null)!==null&&!(qe.isColorLike(e)||e instanceof br||e instanceof Ri)}};Gc.defaultDropShadow={alpha:1,angle:Math.PI/6,blur:0,color:"black",distance:5};Gc.defaultTextStyle={align:"left",breakWords:!1,dropShadow:null,fill:"black",fontFamily:"Arial",fontSize:26,fontStyle:"normal",fontVariant:"normal",fontWeight:"normal",leading:0,letterSpacing:0,lineHeight:0,padding:0,stroke:null,textBaseline:"alphabetic",trim:!1,whiteSpace:"pre",wordWrap:!1,wordWrapWidth:100};let zn=Gc;function X0(r){const e=r;if(typeof e.dropShadow=="boolean"&&e.dropShadow){const t=zn.defaultDropShadow;r.dropShadow={alpha:e.dropShadowAlpha??t.alpha,angle:e.dropShadowAngle??t.angle,blur:e.dropShadowBlur??t.blur,color:e.dropShadowColor??t.color,distance:e.dropShadowDistance??t.distance}}if(e.strokeThickness!==void 0){he(_e,"strokeThickness is now a part of stroke");const t=e.stroke;let s={};if(qe.isColorLike(t))s.color=t;else if(t instanceof br||t instanceof Ri)s.fill=t;else if(Object.hasOwnProperty.call(t,"color")||Object.hasOwnProperty.call(t,"fill"))s=t;else throw new Error("Invalid stroke value.");r.stroke={...s,width:e.strokeThickness}}if(Array.isArray(e.fillGradientStops)){if(he(_e,"gradient fill is now a fill pattern: `new FillGradient(...)`"),!Array.isArray(e.fill)||e.fill.length===0)throw new Error("Invalid fill value. Expected an array of colors for gradient fill.");e.fill.length!==e.fillGradientStops.length&&Ae("The number of fill colors must match the number of fill gradient stops.");const t=new br({start:{x:0,y:0},end:{x:0,y:1},textureSpace:"local"}),s=e.fillGradientStops.slice(),n=e.fill.map(a=>qe.shared.setValue(a).toNumber());s.forEach((a,i)=>{t.addColorStop(a,n[i])}),r.fill={fill:t}}}class Y0{constructor(e){this._canvasPool=Object.create(null),this.canvasOptions=e||{},this.enableFullScreen=!1}_createCanvasAndContext(e,t){const s=ke.get().createCanvas();s.width=e,s.height=t;const n=s.getContext("2d");return{canvas:s,context:n}}getOptimalCanvasAndContext(e,t,s=1){e=Math.ceil(e*s-1e-6),t=Math.ceil(t*s-1e-6),e=Ns(e),t=Ns(t);const n=(e<<17)+(t<<1);this._canvasPool[n]||(this._canvasPool[n]=[]);let a=this._canvasPool[n].pop();return a||(a=this._createCanvasAndContext(e,t)),a}returnCanvasAndContext(e){const t=e.canvas,{width:s,height:n}=t,a=(s<<17)+(n<<1);e.context.resetTransform(),e.context.clearRect(0,0,s,n),this._canvasPool[a].push(e)}clear(){this._canvasPool={}}}const Vn=new Y0;Kn.register(Vn);const Sh=1e5;function _i(r,e,t,s=0){if(r.texture===me.WHITE&&!r.fill)return qe.shared.setValue(r.color).setAlpha(r.alpha??1).toHexa();if(r.fill){if(r.fill instanceof Ri){const n=r.fill,a=e.createPattern(n.texture.source.resource,"repeat"),i=n.transform.copyTo(pe.shared);return i.scale(n.texture.frame.width,n.texture.frame.height),a.setTransform(i),a}else if(r.fill instanceof br){const n=r.fill,a=n.type==="linear",i=n.textureSpace==="local";let o=1,c=1;i&&t&&(o=t.width+s,c=t.height+s);let l,h=!1;if(a){const{start:d,end:u}=n;l=e.createLinearGradient(d.x*o,d.y*c,u.x*o,u.y*c),h=Math.abs(u.x-d.x)<Math.abs((u.y-d.y)*.1)}else{const{center:d,innerRadius:u,outerCenter:f,outerRadius:p}=n;l=e.createRadialGradient(d.x*o,d.y*c,u*o,f.x*o,f.y*c,p*o)}if(h&&i&&t){const d=t.lineHeight/c;for(let u=0;u<t.lines.length;u++){const f=(u*t.lineHeight+s/2)/c;n.colorStops.forEach(p=>{const g=f+p.offset*d;l.addColorStop(Math.floor(g*Sh)/Sh,qe.shared.setValue(p.color).toHex())})}}else n.colorStops.forEach(d=>{l.addColorStop(d.offset,qe.shared.setValue(d.color).toHex())});return l}}else{const n=e.createPattern(r.texture.source.resource,"repeat"),a=r.matrix.copyTo(pe.shared);return a.scale(r.texture.frame.width,r.texture.frame.height),n.setTransform(a),n}return Ae("FillStyle not recognised",r),"red"}const Yu=class Ku extends Pu{constructor(e){super(),this.resolution=1,this.pages=[],this._padding=0,this._measureCache=Object.create(null),this._currentChars=[],this._currentX=0,this._currentY=0,this._currentMaxCharHeight=0,this._currentPageIndex=-1,this._skipKerning=!1;const t={...Ku.defaultOptions,...e};this._textureSize=t.textureSize,this._mipmap=t.mipmap;const s=t.style.clone();t.overrideFill&&(s._fill.color=16777215,s._fill.alpha=1,s._fill.texture=me.WHITE,s._fill.fill=null),this.applyFillAsTint=t.overrideFill;const n=s.fontSize;s.fontSize=this.baseMeasurementFontSize;const a=mi(s);t.overrideSize?s._stroke&&(s._stroke.width*=this.baseRenderedFontSize/n):s.fontSize=this.baseRenderedFontSize=n,this._style=s,this._skipKerning=t.skipKerning??!1,this.resolution=t.resolution??1,this._padding=t.padding??4,t.textureStyle&&(this._textureStyle=t.textureStyle instanceof Hs?t.textureStyle:new Hs(t.textureStyle)),this.fontMetrics=nr.measureFont(a),this.lineHeight=s.lineHeight||this.fontMetrics.fontSize||s.fontSize}ensureCharacters(e){var m,_;const t=nr.graphemeSegmenter(e).filter(b=>!this._currentChars.includes(b)).filter((b,x,S)=>S.indexOf(b)===x);if(!t.length)return;this._currentChars=[...this._currentChars,...t];let s;this._currentPageIndex===-1?s=this._nextPage():s=this.pages[this._currentPageIndex];let{canvas:n,context:a}=s.canvasAndContext,i=s.texture.source;const o=this._style;let c=this._currentX,l=this._currentY,h=this._currentMaxCharHeight;const d=this.baseRenderedFontSize/this.baseMeasurementFontSize,u=this._padding*d;let f=!1;const p=n.width/this.resolution,g=n.height/this.resolution;for(let b=0;b<t.length;b++){const x=t[b],S=nr.measureText(x,o,n,!1);S.lineHeight=S.height;const T=S.width*d,A=Math.ceil((o.fontStyle==="italic"?2:1)*T),C=S.height*d,R=A+u*2,$=C+u*2;if(f=!1,x!==`
`&&x!=="\r"&&x!=="	"&&x!==" "&&(f=!0,h=Math.ceil(Math.max($,h))),c+R>p&&(l+=h,h=$,c=0,l+h>g)){i.update();const j=this._nextPage();n=j.canvasAndContext.canvas,a=j.canvasAndContext.context,i=j.texture.source,c=0,l=0,h=0}const B=T/d-(((m=o.dropShadow)==null?void 0:m.distance)??0)-(((_=o._stroke)==null?void 0:_.width)??0);if(this.chars[x]={id:x.codePointAt(0),xOffset:-this._padding,yOffset:-this._padding,xAdvance:B,kerning:{}},f){this._drawGlyph(a,S,c+u,l+u,d,o);const j=i.width*d,se=i.height*d,z=new Re(c/j*i.width,l/se*i.height,R/j*i.width,$/se*i.height);this.chars[x].texture=new me({source:i,frame:z}),c+=Math.ceil(R)}}i.update(),this._currentX=c,this._currentY=l,this._currentMaxCharHeight=h,this._skipKerning&&this._applyKerning(t,a)}get pageTextures(){return he(_e,"BitmapFont.pageTextures is deprecated, please use BitmapFont.pages instead."),this.pages}_applyKerning(e,t){const s=this._measureCache;for(let n=0;n<e.length;n++){const a=e[n];for(let i=0;i<this._currentChars.length;i++){const o=this._currentChars[i];let c=s[a];c||(c=s[a]=t.measureText(a).width);let l=s[o];l||(l=s[o]=t.measureText(o).width);let h=t.measureText(a+o).width,d=h-(c+l);d&&(this.chars[a].kerning[o]=d),h=t.measureText(a+o).width,d=h-(c+l),d&&(this.chars[o].kerning[a]=d)}}}_nextPage(){this._currentPageIndex++;const e=this.resolution,t=Vn.getOptimalCanvasAndContext(this._textureSize,this._textureSize,e);this._setupContext(t.context,this._style,e);const s=e*(this.baseRenderedFontSize/this.baseMeasurementFontSize),n=new me({source:new hs({resource:t.canvas,resolution:s,alphaMode:"premultiply-alpha-on-upload",autoGenerateMipmaps:this._mipmap})});this._textureStyle&&(n.source.style=this._textureStyle);const a={canvasAndContext:t,texture:n};return this.pages[this._currentPageIndex]=a,a}_setupContext(e,t,s){t.fontSize=this.baseRenderedFontSize,e.scale(s,s),e.font=mi(t),t.fontSize=this.baseMeasurementFontSize,e.textBaseline=t.textBaseline;const n=t._stroke,a=(n==null?void 0:n.width)??0;if(n&&(e.lineWidth=a,e.lineJoin=n.join,e.miterLimit=n.miterLimit,e.strokeStyle=_i(n,e)),t._fill&&(e.fillStyle=_i(t._fill,e)),t.dropShadow){const i=t.dropShadow,o=qe.shared.setValue(i.color).toArray(),c=i.blur*s,l=i.distance*s;e.shadowColor=`rgba(${o[0]*255},${o[1]*255},${o[2]*255},${i.alpha})`,e.shadowBlur=c,e.shadowOffsetX=Math.cos(i.angle)*l,e.shadowOffsetY=Math.sin(i.angle)*l}else e.shadowColor="black",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0}_drawGlyph(e,t,s,n,a,i){const o=t.text,c=t.fontProperties,l=i._stroke,h=((l==null?void 0:l.width)??0)*a,d=s+h/2,u=n-h/2,f=c.descent*a,p=t.lineHeight*a;let g=!1;i.stroke&&h&&(g=!0,e.strokeText(o,d,u+p-f));const{shadowBlur:m,shadowOffsetX:_,shadowOffsetY:b}=e;i._fill&&(g&&(e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0),e.fillText(o,d,u+p-f)),g&&(e.shadowBlur=m,e.shadowOffsetX=_,e.shadowOffsetY=b)}destroy(){super.destroy();for(let e=0;e<this.pages.length;e++){const{canvasAndContext:t,texture:s}=this.pages[e];Vn.returnCanvasAndContext(t),s.destroy(!0)}this.pages=null}};Yu.defaultOptions={textureSize:512,style:new zn,mipmap:!0};let kh=Yu;function K0(r,e,t,s){const n={width:0,height:0,offsetY:0,scale:e.fontSize/t.baseMeasurementFontSize,lines:[{width:0,charPositions:[],spaceWidth:0,spacesIndex:[],chars:[]}]};n.offsetY=t.baseLineOffset;let a=n.lines[0],i=null,o=!0;const c={width:0,start:0,index:0,positions:[],chars:[]},l=t.baseMeasurementFontSize/e.fontSize,h=e.letterSpacing*l,d=e.wordWrapWidth*l,u=e.lineHeight?e.lineHeight*l:t.lineHeight,f=e.wordWrap&&e.breakWords,p=_=>{const b=a.width;for(let x=0;x<c.index;x++){const S=_.positions[x];a.chars.push(_.chars[x]),a.charPositions.push(S+b)}a.width+=_.width,o=!1,c.width=0,c.index=0,c.chars.length=0},g=()=>{let _=a.chars.length-1;if(s){let b=a.chars[_];for(;b===" ";)a.width-=t.chars[b].xAdvance,b=a.chars[--_]}n.width=Math.max(n.width,a.width),a={width:0,charPositions:[],chars:[],spaceWidth:0,spacesIndex:[]},o=!0,n.lines.push(a),n.height+=u},m=_=>_-h>d;for(let _=0;_<r.length+1;_++){let b;const x=_===r.length;x||(b=r[_]);const S=t.chars[b]||t.chars[" "];if(/(?:\s)/.test(b)||b==="\r"||b===`
`||x){if(!o&&e.wordWrap&&m(a.width+c.width)?(g(),p(c),x||a.charPositions.push(0)):(c.start=a.width,p(c),x||a.charPositions.push(0)),b==="\r"||b===`
`)g();else if(!x){const R=S.xAdvance+(S.kerning[i]||0)+h;a.width+=R,a.spaceWidth=R,a.spacesIndex.push(a.charPositions.length),a.chars.push(b)}}else{const C=S.kerning[i]||0,R=S.xAdvance+C+h;f&&m(a.width+c.width+R)&&(p(c),g()),c.positions[c.index++]=c.width+C,c.chars.push(b),c.width+=R}i=b}return g(),e.align==="center"?J0(n):e.align==="right"?Q0(n):e.align==="justify"&&Z0(n),n}function J0(r){for(let e=0;e<r.lines.length;e++){const t=r.lines[e],s=r.width/2-t.width/2;for(let n=0;n<t.charPositions.length;n++)t.charPositions[n]+=s}}function Q0(r){for(let e=0;e<r.lines.length;e++){const t=r.lines[e],s=r.width-t.width;for(let n=0;n<t.charPositions.length;n++)t.charPositions[n]+=s}}function Z0(r){const e=r.width;for(let t=0;t<r.lines.length;t++){const s=r.lines[t];let n=0,a=s.spacesIndex[n++],i=0;const o=s.spacesIndex.length,l=(e-s.width)/o;for(let h=0;h<s.charPositions.length;h++)h===a&&(a=s.spacesIndex[n++],i+=l),s.charPositions[h]+=i}}function e_(r){if(r==="")return[];typeof r=="string"&&(r=[r]);const e=[];for(let t=0,s=r.length;t<s;t++){const n=r[t];if(Array.isArray(n)){if(n.length!==2)throw new Error(`[BitmapFont]: Invalid character range length, expecting 2 got ${n.length}.`);if(n[0].length===0||n[1].length===0)throw new Error("[BitmapFont]: Invalid character delimiter.");const a=n[0].charCodeAt(0),i=n[1].charCodeAt(0);if(i<a)throw new Error("[BitmapFont]: Invalid character range.");for(let o=a,c=i;o<=c;o++)e.push(String.fromCharCode(o))}else e.push(...Array.from(n))}if(e.length===0)throw new Error("[BitmapFont]: Empty set when resolving characters.");return e}let Ra=0;class t_{constructor(){this.ALPHA=[["a","z"],["A","Z"]," "],this.NUMERIC=[["0","9"]],this.ALPHANUMERIC=[["a","z"],["A","Z"],["0","9"]," "],this.ASCII=[[" ","~"]],this.defaultOptions={chars:this.ALPHANUMERIC,resolution:1,padding:4,skipKerning:!1,textureStyle:null},this.measureCache=Ru(1e3)}getFont(e,t){var i;let s=`${t.fontFamily}-bitmap`,n=!0;if(t._fill.fill&&!t._stroke?(s+=t._fill.fill.styleKey,n=!1):(t._stroke||t.dropShadow)&&(s=`${t.styleKey}-bitmap`,n=!1),!Ie.has(s)){const o=Object.create(t);o.lineHeight=0;const c=new kh({style:o,overrideFill:n,overrideSize:!0,...this.defaultOptions});Ra++,Ra>50&&Ae("BitmapText",`You have dynamically created ${Ra} bitmap fonts, this can be inefficient. Try pre installing your font styles using \`BitmapFont.install({name:"style1", style})\``),c.once("destroy",()=>{Ra--,Ie.remove(s)}),Ie.set(s,c)}const a=Ie.get(s);return(i=a.ensureCharacters)==null||i.call(a,e),a}getLayout(e,t,s=!0){const n=this.getFont(e,t),a=`${e}-${t.styleKey}-${s}`;if(this.measureCache.has(a))return this.measureCache.get(a);const i=nr.graphemeSegmenter(e),o=K0(i,t,n,s);return this.measureCache.set(a,o),o}measureText(e,t,s=!0){return this.getLayout(e,t,s)}install(...e){var l,h,d,u;let t=e[0];typeof t=="string"&&(t={name:t,style:e[1],chars:(l=e[2])==null?void 0:l.chars,resolution:(h=e[2])==null?void 0:h.resolution,padding:(d=e[2])==null?void 0:d.padding,skipKerning:(u=e[2])==null?void 0:u.skipKerning},he(_e,"BitmapFontManager.install(name, style, options) is deprecated, use BitmapFontManager.install({name, style, ...options})"));const s=t==null?void 0:t.name;if(!s)throw new Error("[BitmapFontManager] Property `name` is required.");t={...this.defaultOptions,...t};const n=t.style,a=n instanceof zn?n:new zn(n),i=t.dynamicFill??this._canUseTintForStyle(a),o=new kh({style:a,overrideFill:i,skipKerning:t.skipKerning,padding:t.padding,resolution:t.resolution,overrideSize:!1,textureStyle:t.textureStyle}),c=e_(t.chars);return o.ensureCharacters(c.join("")),Ie.set(`${s}-bitmap`,o),o.once("destroy",()=>Ie.remove(`${s}-bitmap`)),o}uninstall(e){const t=`${e}-bitmap`,s=Ie.get(t);s&&s.destroy()}_canUseTintForStyle(e){return!e._stroke&&(!e.dropShadow||e.dropShadow.color===0)&&!e._fill.fill&&e._fill.color===16777215}}const Ih=new t_;class Ju extends Pu{constructor(e,t){super();const{textures:s,data:n}=e;Object.keys(n.pages).forEach(a=>{const i=n.pages[parseInt(a,10)],o=s[i.id];this.pages.push({texture:o})}),Object.keys(n.chars).forEach(a=>{const i=n.chars[a],{frame:o,source:c,rotate:l}=s[i.page],h=xe.transformRectCoords(i,o,l,new Re),d=new me({frame:h,orig:new Re(0,0,i.width,i.height),source:c,rotate:l});this.chars[a]={id:a.codePointAt(0),xOffset:i.xOffset,yOffset:i.yOffset,xAdvance:i.xAdvance,kerning:i.kerning??{},texture:d}}),this.baseRenderedFontSize=n.fontSize,this.baseMeasurementFontSize=n.fontSize,this.fontMetrics={ascent:0,descent:0,fontSize:n.fontSize},this.baseLineOffset=n.baseLineOffset,this.lineHeight=n.lineHeight,this.fontFamily=n.fontFamily,this.distanceField=n.distanceField??{type:"none",range:0},this.url=t}destroy(){super.destroy();for(let e=0;e<this.pages.length;e++){const{texture:t}=this.pages[e];t.destroy(!0)}this.pages=null}static install(e){Ih.install(e)}static uninstall(e){Ih.uninstall(e)}}const wo={test(r){return typeof r=="string"&&r.startsWith("info face=")},parse(r){const e=r.match(/^[a-z]+\s+.+$/gm),t={info:[],common:[],page:[],char:[],chars:[],kerning:[],kernings:[],distanceField:[]};for(const d in e){const u=e[d].match(/^[a-z]+/gm)[0],f=e[d].match(/[a-zA-Z]+=([^\s"']+|"([^"]*)")/gm),p={};for(const g in f){const m=f[g].split("="),_=m[0],b=m[1].replace(/"/gm,""),x=parseFloat(b),S=isNaN(x)?b:x;p[_]=S}t[u].push(p)}const s={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},[n]=t.info,[a]=t.common,[i]=t.distanceField??[];i&&(s.distanceField={range:parseInt(i.distanceRange,10),type:i.fieldType}),s.fontSize=parseInt(n.size,10),s.fontFamily=n.face,s.lineHeight=parseInt(a.lineHeight,10);const o=t.page;for(let d=0;d<o.length;d++)s.pages.push({id:parseInt(o[d].id,10)||0,file:o[d].file});const c={};s.baseLineOffset=s.lineHeight-parseInt(a.base,10);const l=t.char;for(let d=0;d<l.length;d++){const u=l[d],f=parseInt(u.id,10);let p=u.letter??u.char??String.fromCharCode(f);p==="space"&&(p=" "),c[f]=p,s.chars[p]={id:f,page:parseInt(u.page,10)||0,x:parseInt(u.x,10),y:parseInt(u.y,10),width:parseInt(u.width,10),height:parseInt(u.height,10),xOffset:parseInt(u.xoffset,10),yOffset:parseInt(u.yoffset,10),xAdvance:parseInt(u.xadvance,10),kerning:{}}}const h=t.kerning||[];for(let d=0;d<h.length;d++){const u=parseInt(h[d].first,10),f=parseInt(h[d].second,10),p=parseInt(h[d].amount,10);s.chars[c[f]].kerning[c[u]]=p}return s}},Ah={test(r){const e=r;return typeof e!="string"&&"getElementsByTagName"in e&&e.getElementsByTagName("page").length&&e.getElementsByTagName("info")[0].getAttribute("face")!==null},parse(r){const e={chars:{},pages:[],lineHeight:0,fontSize:0,fontFamily:"",distanceField:null,baseLineOffset:0},t=r.getElementsByTagName("info")[0],s=r.getElementsByTagName("common")[0],n=r.getElementsByTagName("distanceField")[0];n&&(e.distanceField={type:n.getAttribute("fieldType"),range:parseInt(n.getAttribute("distanceRange"),10)});const a=r.getElementsByTagName("page"),i=r.getElementsByTagName("char"),o=r.getElementsByTagName("kerning");e.fontSize=parseInt(t.getAttribute("size"),10),e.fontFamily=t.getAttribute("face"),e.lineHeight=parseInt(s.getAttribute("lineHeight"),10);for(let l=0;l<a.length;l++)e.pages.push({id:parseInt(a[l].getAttribute("id"),10)||0,file:a[l].getAttribute("file")});const c={};e.baseLineOffset=e.lineHeight-parseInt(s.getAttribute("base"),10);for(let l=0;l<i.length;l++){const h=i[l],d=parseInt(h.getAttribute("id"),10);let u=h.getAttribute("letter")??h.getAttribute("char")??String.fromCharCode(d);u==="space"&&(u=" "),c[d]=u,e.chars[u]={id:d,page:parseInt(h.getAttribute("page"),10)||0,x:parseInt(h.getAttribute("x"),10),y:parseInt(h.getAttribute("y"),10),width:parseInt(h.getAttribute("width"),10),height:parseInt(h.getAttribute("height"),10),xOffset:parseInt(h.getAttribute("xoffset"),10),yOffset:parseInt(h.getAttribute("yoffset"),10),xAdvance:parseInt(h.getAttribute("xadvance"),10),kerning:{}}}for(let l=0;l<o.length;l++){const h=parseInt(o[l].getAttribute("first"),10),d=parseInt(o[l].getAttribute("second"),10),u=parseInt(o[l].getAttribute("amount"),10);e.chars[c[d]].kerning[c[h]]=u}return e}},Ch={test(r){return typeof r=="string"&&r.includes("<font>")?Ah.test(ke.get().parseXML(r)):!1},parse(r){return Ah.parse(ke.get().parseXML(r))}},r_=[".xml",".fnt"],s_={extension:{type:J.CacheParser,name:"cacheBitmapFont"},test:r=>r instanceof Ju,getCacheableAssets(r,e){const t={};return r.forEach(s=>{t[s]=e,t[`${s}-bitmap`]=e}),t[`${e.fontFamily}-bitmap`]=e,t}},n_={extension:{type:J.LoadParser,priority:jr.Normal},name:"loadBitmapFont",id:"bitmap-font",test(r){return r_.includes(Et.extname(r).toLowerCase())},async testParse(r){return wo.test(r)||Ch.test(r)},async parse(r,e,t){const s=wo.test(r)?wo.parse(r):Ch.parse(r),{src:n}=e,{pages:a}=s,i=[],o=s.distanceField?{scaleMode:"linear",alphaMode:"premultiply-alpha-on-upload",autoGenerateMipmaps:!1,resolution:1}:{};for(let d=0;d<a.length;++d){const u=a[d].file;let f=Et.join(Et.dirname(n),u);f=Ko(f,n),i.push({src:f,data:o})}const c=await t.load(i),l=i.map(d=>c[d.src]);return new Ju({data:s,textures:l},n)},async load(r,e){return await(await ke.get().fetch(r)).text()},async unload(r,e,t){await Promise.all(r.pages.map(s=>t.unload(s.texture.source._sourceOrigin))),r.destroy()}};class a_{constructor(e,t=!1){this._loader=e,this._assetList=[],this._isLoading=!1,this._maxConcurrent=1,this.verbose=t}add(e){e.forEach(t=>{this._assetList.push(t)}),this.verbose&&console.log("[BackgroundLoader] assets: ",this._assetList),this._isActive&&!this._isLoading&&this._next()}async _next(){if(this._assetList.length&&this._isActive){this._isLoading=!0;const e=[],t=Math.min(this._assetList.length,this._maxConcurrent);for(let s=0;s<t;s++)e.push(this._assetList.pop());await this._loader.load(e),this._isLoading=!1,this._next()}}get active(){return this._isActive}set active(e){this._isActive!==e&&(this._isActive=e,e&&!this._isLoading&&this._next())}}const i_={extension:{type:J.CacheParser,name:"cacheTextureArray"},test:r=>Array.isArray(r)&&r.every(e=>e instanceof me),getCacheableAssets:(r,e)=>{const t={};return r.forEach(s=>{e.forEach((n,a)=>{t[s+(a===0?"":a+1)]=n})}),t}};async function Qu(r){if("Image"in globalThis)return new Promise(e=>{const t=new Image;t.onload=()=>{e(!0)},t.onerror=()=>{e(!1)},t.src=r});if("createImageBitmap"in globalThis&&"fetch"in globalThis){try{const e=await(await fetch(r)).blob();await createImageBitmap(e)}catch{return!1}return!0}return!1}const o_={extension:{type:J.DetectionParser,priority:1},test:async()=>Qu("data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A="),add:async r=>[...r,"avif"],remove:async r=>r.filter(e=>e!=="avif")},Eh=["png","jpg","jpeg"],c_={extension:{type:J.DetectionParser,priority:-1},test:()=>Promise.resolve(!0),add:async r=>[...r,...Eh],remove:async r=>r.filter(e=>!Eh.includes(e))},l_="WorkerGlobalScope"in globalThis&&globalThis instanceof globalThis.WorkerGlobalScope;function $i(r){return l_?!1:document.createElement("video").canPlayType(r)!==""}const h_={extension:{type:J.DetectionParser,priority:0},test:async()=>$i("video/mp4"),add:async r=>[...r,"mp4","m4v"],remove:async r=>r.filter(e=>e!=="mp4"&&e!=="m4v")},d_={extension:{type:J.DetectionParser,priority:0},test:async()=>$i("video/ogg"),add:async r=>[...r,"ogv"],remove:async r=>r.filter(e=>e!=="ogv")},u_={extension:{type:J.DetectionParser,priority:0},test:async()=>$i("video/webm"),add:async r=>[...r,"webm"],remove:async r=>r.filter(e=>e!=="webm")},f_={extension:{type:J.DetectionParser,priority:0},test:async()=>Qu("data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAAAAAAfQ//73v/+BiOh/AAA="),add:async r=>[...r,"webp"],remove:async r=>r.filter(e=>e!=="webp")},Zu=class ii{constructor(){this.loadOptions={...ii.defaultOptions},this._parsers=[],this._parsersValidated=!1,this.parsers=new Proxy(this._parsers,{set:(e,t,s)=>(this._parsersValidated=!1,e[t]=s,!0)}),this.promiseCache={}}reset(){this._parsersValidated=!1,this.promiseCache={}}_getLoadPromiseAndParser(e,t){const s={promise:null,parser:null};return s.promise=(async()=>{var i,o;let n=null,a=null;if((t.parser||t.loadParser)&&(a=this._parserHash[t.parser||t.loadParser],t.loadParser&&Ae(`[Assets] "loadParser" is deprecated, use "parser" instead for ${e}`),a||Ae(`[Assets] specified load parser "${t.parser||t.loadParser}" not found while loading ${e}`)),!a){for(let c=0;c<this.parsers.length;c++){const l=this.parsers[c];if(l.load&&((i=l.test)!=null&&i.call(l,e,t,this))){a=l;break}}if(!a)return Ae(`[Assets] ${e} could not be loaded as we don't know how to parse it, ensure the correct parser has been added`),null}n=await a.load(e,t,this),s.parser=a;for(let c=0;c<this.parsers.length;c++){const l=this.parsers[c];l.parse&&l.parse&&await((o=l.testParse)==null?void 0:o.call(l,n,t,this))&&(n=await l.parse(n,t,this)||n,s.parser=l)}return n})(),s}async load(e,t){this._parsersValidated||this._validateParsers();const s=typeof t=="function"?{...ii.defaultOptions,...this.loadOptions,onProgress:t}:{...ii.defaultOptions,...this.loadOptions,...t||{}},{onProgress:n,onError:a,strategy:i,retryCount:o,retryDelay:c}=s;let l=0;const h={},d=pi(e),u=Vt(e,g=>({alias:[g],src:g,data:{}})),f=u.reduce((g,m)=>g+(m.progressSize||1),0),p=u.map(async g=>{const m=Et.toAbsolute(g.src);h[g.src]||(await this._loadAssetWithRetry(m,g,{onProgress:n,onError:a,strategy:i,retryCount:o,retryDelay:c},h),l+=g.progressSize||1,n&&n(l/f))});return await Promise.all(p),d?h[u[0].src]:h}async unload(e){const s=Vt(e,n=>({alias:[n],src:n})).map(async n=>{var o,c;const a=Et.toAbsolute(n.src),i=this.promiseCache[a];if(i){const l=await i.promise;delete this.promiseCache[a],await((c=(o=i.parser)==null?void 0:o.unload)==null?void 0:c.call(o,l,n,this))}});await Promise.all(s)}_validateParsers(){this._parsersValidated=!0,this._parserHash=this._parsers.filter(e=>e.name||e.id).reduce((e,t)=>(!t.name&&!t.id?Ae("[Assets] parser should have an id"):(e[t.name]||e[t.id])&&Ae(`[Assets] parser id conflict "${t.id}"`),e[t.name]=t,t.id&&(e[t.id]=t),e),{})}async _loadAssetWithRetry(e,t,s,n){let a=0;const{onError:i,strategy:o,retryCount:c,retryDelay:l}=s,h=d=>new Promise(u=>setTimeout(u,d));for(;;)try{this.promiseCache[e]||(this.promiseCache[e]=this._getLoadPromiseAndParser(e,t)),n[t.src]=await this.promiseCache[e].promise;return}catch(d){delete this.promiseCache[e],delete n[t.src],a++;const u=o!=="retry"||a>c;if(o==="retry"&&!u){i&&i(d,t),await h(l);continue}if(o==="skip"){i&&i(d,t);return}throw i&&i(d,t),new Error(`[Loader.load] Failed to load ${e}.
${d}`)}}};Zu.defaultOptions={onProgress:void 0,onError:void 0,strategy:"throw",retryCount:3,retryDelay:250};let p_=Zu;function Xs(r,e){if(Array.isArray(e)){for(const t of e)if(r.startsWith(`data:${t}`))return!0;return!1}return r.startsWith(`data:${e}`)}function Ys(r,e){const t=r.split("?")[0],s=Et.extname(t).toLowerCase();return Array.isArray(e)?e.includes(s):s===e}const m_=".json",g_="application/json",y_={extension:{type:J.LoadParser,priority:jr.Low},name:"loadJson",id:"json",test(r){return Xs(r,g_)||Ys(r,m_)},async load(r){return await(await ke.get().fetch(r)).json()}},__=".txt",b_="text/plain",x_={name:"loadTxt",id:"text",extension:{type:J.LoadParser,priority:jr.Low,name:"loadTxt"},test(r){return Xs(r,b_)||Ys(r,__)},async load(r){return await(await ke.get().fetch(r)).text()}},w_=["normal","bold","100","200","300","400","500","600","700","800","900"],v_=[".ttf",".otf",".woff",".woff2"],S_=["font/ttf","font/otf","font/woff","font/woff2"],k_=/^(--|-?[A-Z_])[0-9A-Z_-]*$/i;function I_(r){const e=Et.extname(r),n=Et.basename(r,e).replace(/(-|_)/g," ").toLowerCase().split(" ").map(o=>o.charAt(0).toUpperCase()+o.slice(1));let a=n.length>0;for(const o of n)if(!o.match(k_)){a=!1;break}let i=n.join(" ");return a||(i=`"${i.replace(/[\\"]/g,"\\$&")}"`),i}const A_=/^[0-9A-Za-z%:/?#\[\]@!\$&'()\*\+,;=\-._~]*$/;function C_(r){return A_.test(r)?r:encodeURI(r)}const E_={extension:{type:J.LoadParser,priority:jr.Low},name:"loadWebFont",id:"web-font",test(r){return Xs(r,S_)||Ys(r,v_)},async load(r,e){var s,n,a;const t=ke.get().getFontFaceSet();if(t){const i=[],o=((s=e.data)==null?void 0:s.family)??I_(r),c=((a=(n=e.data)==null?void 0:n.weights)==null?void 0:a.filter(h=>w_.includes(h)))??["normal"],l=e.data??{};for(let h=0;h<c.length;h++){const d=c[h],u=new FontFace(o,`url(${C_(r)})`,{...l,weight:d});await u.load(),t.add(u),i.push(u)}return Ie.has(`${o}-and-url`)?Ie.get(`${o}-and-url`).entries.push({url:r,faces:i}):Ie.set(`${o}-and-url`,{entries:[{url:r,faces:i}]}),i.length===1?i[0]:i}return Ae("[loadWebFont] FontFace API is not supported. Skipping loading font"),null},unload(r){const e=Array.isArray(r)?r:[r],t=e[0].family,s=Ie.get(`${t}-and-url`),n=s.entries.find(a=>a.faces.some(i=>e.indexOf(i)!==-1));n.faces=n.faces.filter(a=>e.indexOf(a)===-1),n.faces.length===0&&(s.entries=s.entries.filter(a=>a!==n)),e.forEach(a=>{ke.get().getFontFaceSet().delete(a)}),s.entries.length===0&&Ie.remove(`${t}-and-url`)}};function zc(r,e=1){var s;const t=(s=qs.RETINA_PREFIX)==null?void 0:s.exec(r);return t?parseFloat(t[1]):e}function Vc(r,e,t){r.label=t,r._sourceOrigin=t;const s=new me({source:r,label:t}),n=()=>{delete e.promiseCache[t],Ie.has(t)&&Ie.remove(t)};return s.source.once("destroy",()=>{e.promiseCache[t]&&(Ae("[Assets] A TextureSource managed by Assets was destroyed instead of unloaded! Use Assets.unload() instead of destroying the TextureSource."),n())}),s.once("destroy",()=>{r.destroyed||(Ae("[Assets] A Texture managed by Assets was destroyed instead of unloaded! Use Assets.unload() instead of destroying the Texture."),n())}),s}const T_=".svg",P_="image/svg+xml",R_={extension:{type:J.LoadParser,priority:jr.Low,name:"loadSVG"},name:"loadSVG",id:"svg",config:{crossOrigin:"anonymous",parseAsGraphicsContext:!1},test(r){return Xs(r,P_)||Ys(r,T_)},async load(r,e,t){var s;return((s=e.data)==null?void 0:s.parseAsGraphicsContext)??this.config.parseAsGraphicsContext?$_(r):M_(r,e,t,this.config.crossOrigin)},unload(r){r.destroy(!0)}};async function M_(r,e,t,s){var m,_,b;const n=await ke.get().fetch(r),a=ke.get().createImage();a.src=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(await n.text())}`,a.crossOrigin=s,await a.decode();const i=((m=e.data)==null?void 0:m.width)??a.width,o=((_=e.data)==null?void 0:_.height)??a.height,c=((b=e.data)==null?void 0:b.resolution)||zc(r),l=Math.ceil(i*c),h=Math.ceil(o*c),d=ke.get().createCanvas(l,h),u=d.getContext("2d");u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(a,0,0,i*c,o*c);const{parseAsGraphicsContext:f,...p}=e.data??{},g=new hs({resource:d,alphaMode:"premultiply-alpha-on-upload",resolution:c,...p});return Vc(g,t,r)}async function $_(r){const t=await(await ke.get().fetch(r)).text(),s=new Mt;return s.svg(t),s}const O_=`(function () {
    'use strict';

    const WHITE_PNG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO+ip1sAAAAASUVORK5CYII=";
    async function checkImageBitmap() {
      try {
        if (typeof createImageBitmap !== "function")
          return false;
        const response = await fetch(WHITE_PNG);
        const imageBlob = await response.blob();
        const imageBitmap = await createImageBitmap(imageBlob);
        return imageBitmap.width === 1 && imageBitmap.height === 1;
      } catch (_e) {
        return false;
      }
    }
    void checkImageBitmap().then((result) => {
      self.postMessage(result);
    });

})();
`;let Ls=null,oc=class{constructor(){Ls||(Ls=URL.createObjectURL(new Blob([O_],{type:"application/javascript"}))),this.worker=new Worker(Ls)}};oc.revokeObjectURL=function(){Ls&&(URL.revokeObjectURL(Ls),Ls=null)};const B_=`(function () {
    'use strict';

    async function loadImageBitmap(url, alphaMode) {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(\`[WorkerManager.loadImageBitmap] Failed to fetch \${url}: \${response.status} \${response.statusText}\`);
      }
      const imageBlob = await response.blob();
      return alphaMode === "premultiplied-alpha" ? createImageBitmap(imageBlob, { premultiplyAlpha: "none" }) : createImageBitmap(imageBlob);
    }
    self.onmessage = async (event) => {
      try {
        const imageBitmap = await loadImageBitmap(event.data.data[0], event.data.data[1]);
        self.postMessage({
          data: imageBitmap,
          uuid: event.data.uuid,
          id: event.data.id
        }, [imageBitmap]);
      } catch (e) {
        self.postMessage({
          error: e,
          uuid: event.data.uuid,
          id: event.data.id
        });
      }
    };

})();
`;let Fs=null;class ef{constructor(){Fs||(Fs=URL.createObjectURL(new Blob([B_],{type:"application/javascript"}))),this.worker=new Worker(Fs)}}ef.revokeObjectURL=function(){Fs&&(URL.revokeObjectURL(Fs),Fs=null)};let Th=0,vo;class D_{constructor(){this._initialized=!1,this._createdWorkers=0,this._workerPool=[],this._queue=[],this._resolveHash={}}isImageBitmapSupported(){return this._isImageBitmapSupported!==void 0?this._isImageBitmapSupported:(this._isImageBitmapSupported=new Promise(e=>{const{worker:t}=new oc;t.addEventListener("message",s=>{t.terminate(),oc.revokeObjectURL(),e(s.data)})}),this._isImageBitmapSupported)}loadImageBitmap(e,t){var s;return this._run("loadImageBitmap",[e,(s=t==null?void 0:t.data)==null?void 0:s.alphaMode])}async _initWorkers(){this._initialized||(this._initialized=!0)}_getWorker(){vo===void 0&&(vo=navigator.hardwareConcurrency||4);let e=this._workerPool.pop();return!e&&this._createdWorkers<vo&&(this._createdWorkers++,e=new ef().worker,e.addEventListener("message",t=>{this._complete(t.data),this._returnWorker(t.target),this._next()})),e}_returnWorker(e){this._workerPool.push(e)}_complete(e){e.error!==void 0?this._resolveHash[e.uuid].reject(e.error):this._resolveHash[e.uuid].resolve(e.data),this._resolveHash[e.uuid]=null}async _run(e,t){await this._initWorkers();const s=new Promise((n,a)=>{this._queue.push({id:e,arguments:t,resolve:n,reject:a})});return this._next(),s}_next(){if(!this._queue.length)return;const e=this._getWorker();if(!e)return;const t=this._queue.pop(),s=t.id;this._resolveHash[Th]={resolve:t.resolve,reject:t.reject},e.postMessage({data:t.arguments,uuid:Th++,id:s})}reset(){this._workerPool.forEach(e=>e.terminate()),this._workerPool.length=0,Object.values(this._resolveHash).forEach(({reject:e})=>{e==null||e(new Error("WorkerManager destroyed"))}),this._resolveHash={},this._queue.length=0,this._initialized=!1,this._createdWorkers=0}}const Ph=new D_,L_=[".jpeg",".jpg",".png",".webp",".avif"],F_=["image/jpeg","image/png","image/webp","image/avif"];async function j_(r,e){var n;const t=await ke.get().fetch(r);if(!t.ok)throw new Error(`[loadImageBitmap] Failed to fetch ${r}: ${t.status} ${t.statusText}`);const s=await t.blob();return((n=e==null?void 0:e.data)==null?void 0:n.alphaMode)==="premultiplied-alpha"?createImageBitmap(s,{premultiplyAlpha:"none"}):createImageBitmap(s)}const tf={name:"loadTextures",id:"texture",extension:{type:J.LoadParser,priority:jr.High,name:"loadTextures"},config:{preferWorkers:!0,preferCreateImageBitmap:!0,crossOrigin:"anonymous"},test(r){return Xs(r,F_)||Ys(r,L_)},async load(r,e,t){var a;let s=null;globalThis.createImageBitmap&&this.config.preferCreateImageBitmap?this.config.preferWorkers&&await Ph.isImageBitmapSupported()?s=await Ph.loadImageBitmap(r,e):s=await j_(r,e):s=await new Promise((i,o)=>{s=ke.get().createImage(),s.crossOrigin=this.config.crossOrigin,s.src=r,s.complete?i(s):(s.onload=()=>{i(s)},s.onerror=o)});const n=new hs({resource:s,alphaMode:"premultiply-alpha-on-upload",resolution:((a=e.data)==null?void 0:a.resolution)||zc(r),...e.data});return Vc(n,t,r)},unload(r){r.destroy(!0)}},N_=[".mp4",".m4v",".webm",".ogg",".ogv",".h264",".avi",".mov"];let So,ko;function H_(r,e,t){t===void 0&&!e.startsWith("data:")?r.crossOrigin=G_(e):t!==!1&&(r.crossOrigin=typeof t=="string"?t:"anonymous")}function U_(r){return new Promise((e,t)=>{r.addEventListener("canplaythrough",s),r.addEventListener("error",n),r.load();function s(){a(),e()}function n(i){a(),t(i)}function a(){r.removeEventListener("canplaythrough",s),r.removeEventListener("error",n)}})}function G_(r,e=globalThis.location){if(r.startsWith("data:"))return"";e||(e=globalThis.location);const t=new URL(r,document.baseURI);return t.hostname!==e.hostname||t.port!==e.port||t.protocol!==e.protocol?"anonymous":""}function z_(){const r=[],e=[];for(const t of N_){const s=Rn.MIME_TYPES[t.substring(1)]||`video/${t.substring(1)}`;$i(s)&&(r.push(t),e.includes(s)||e.push(s))}return{validVideoExtensions:r,validVideoMime:e}}const V_={name:"loadVideo",id:"video",extension:{type:J.LoadParser,name:"loadVideo"},test(r){if(!So||!ko){const{validVideoExtensions:s,validVideoMime:n}=z_();So=s,ko=n}const e=Xs(r,ko),t=Ys(r,So);return e||t},async load(r,e,t){var c,l;const s={...Rn.defaultOptions,resolution:((c=e.data)==null?void 0:c.resolution)||zc(r),alphaMode:((l=e.data)==null?void 0:l.alphaMode)||await au(),...e.data},n=document.createElement("video"),a={preload:s.autoLoad!==!1?"auto":void 0,"webkit-playsinline":s.playsinline!==!1?"":void 0,playsinline:s.playsinline!==!1?"":void 0,muted:s.muted===!0?"":void 0,loop:s.loop===!0?"":void 0,autoplay:s.autoPlay!==!1?"":void 0};Object.keys(a).forEach(h=>{const d=a[h];d!==void 0&&n.setAttribute(h,d)}),s.muted===!0&&(n.muted=!0),H_(n,r,s.crossorigin);const i=document.createElement("source");let o;if(s.mime)o=s.mime;else if(r.startsWith("data:"))o=r.slice(5,r.indexOf(";"));else if(!r.startsWith("blob:")){const h=r.split("?")[0].slice(r.lastIndexOf(".")+1).toLowerCase();o=Rn.MIME_TYPES[h]||`video/${h}`}return i.src=r,o&&(i.type=o),new Promise(h=>{const d=async()=>{const u=new Rn({...s,resource:n});n.removeEventListener("canplay",d),e.data.preload&&await U_(n),h(Vc(u,t,r))};s.preload&&!s.autoPlay&&n.load(),n.addEventListener("canplay",d),n.appendChild(i)})},unload(r){r.destroy(!0)}},rf={extension:{type:J.ResolveParser,name:"resolveTexture"},test:tf.test,parse:r=>{var e;return{resolution:parseFloat(((e=qs.RETINA_PREFIX.exec(r))==null?void 0:e[1])??"1"),format:r.split(".").pop(),src:r}}},W_={extension:{type:J.ResolveParser,priority:-2,name:"resolveJson"},test:r=>qs.RETINA_PREFIX.test(r)&&r.endsWith(".json"),parse:rf.parse};class q_{constructor(){this._detections=[],this._initialized=!1,this.resolver=new qs,this.loader=new p_,this.cache=Ie,this._backgroundLoader=new a_(this.loader),this._backgroundLoader.active=!0,this.reset()}async init(e={}){var a,i;if(this._initialized){Ae("[Assets]AssetManager already initialized, did you load before calling this Assets.init()?");return}if(this._initialized=!0,e.defaultSearchParams&&this.resolver.setDefaultSearchParams(e.defaultSearchParams),e.basePath&&(this.resolver.basePath=e.basePath),e.bundleIdentifier&&this.resolver.setBundleIdentifier(e.bundleIdentifier),e.manifest){let o=e.manifest;typeof o=="string"&&(o=await this.load(o)),this.resolver.addManifest(o)}const t=((a=e.texturePreference)==null?void 0:a.resolution)??1,s=typeof t=="number"?[t]:t,n=await this._detectFormats({preferredFormats:(i=e.texturePreference)==null?void 0:i.format,skipDetections:e.skipDetections,detections:this._detections});this.resolver.prefer({params:{format:n,resolution:s}}),e.preferences&&this.setPreferences(e.preferences),e.loadOptions&&(this.loader.loadOptions={...this.loader.loadOptions,...e.loadOptions})}add(e){this.resolver.add(e)}async load(e,t){this._initialized||await this.init();const s=pi(e),n=Vt(e).map(o=>{if(typeof o!="string"){const c=this.resolver.getAlias(o);return c.some(l=>!this.resolver.hasKey(l))&&this.add(o),Array.isArray(c)?c[0]:c}return this.resolver.hasKey(o)||this.add({alias:o,src:o}),o}),a=this.resolver.resolve(n),i=await this._mapLoadToResolve(a,t);return s?i[n[0]]:i}addBundle(e,t){this.resolver.addBundle(e,t)}async loadBundle(e,t){this._initialized||await this.init();let s=!1;typeof e=="string"&&(s=!0,e=[e]);const n=this.resolver.resolveBundle(e),a={},i=Object.keys(n);let o=0;const c=[],l=()=>{t==null||t(c.reduce((d,u)=>d+u,0)/o)},h=i.map((d,u)=>{const f=n[d],p=Object.values(f),m=[...new Set(p.flat())].reduce((_,b)=>_+(b.progressSize||1),0);return c.push(0),o+=m,this._mapLoadToResolve(f,_=>{c[u]=_*m,l()}).then(_=>{a[d]=_})});return await Promise.all(h),s?a[e[0]]:a}async backgroundLoad(e){this._initialized||await this.init(),typeof e=="string"&&(e=[e]);const t=this.resolver.resolve(e);this._backgroundLoader.add(Object.values(t))}async backgroundLoadBundle(e){this._initialized||await this.init(),typeof e=="string"&&(e=[e]);const t=this.resolver.resolveBundle(e);Object.values(t).forEach(s=>{this._backgroundLoader.add(Object.values(s))})}reset(){this.resolver.reset(),this.loader.reset(),this.cache.reset(),this._initialized=!1}get(e){if(typeof e=="string")return Ie.get(e);const t={};for(let s=0;s<e.length;s++)t[s]=Ie.get(e[s]);return t}async _mapLoadToResolve(e,t){const s=[...new Set(Object.values(e))];this._backgroundLoader.active=!1;const n=await this.loader.load(s,t);this._backgroundLoader.active=!0;const a={};return s.forEach(i=>{const o=n[i.src],c=[i.src];i.alias&&c.push(...i.alias),c.forEach(l=>{a[l]=o}),Ie.set(c,o)}),a}async unload(e){this._initialized||await this.init();const t=Vt(e).map(n=>typeof n!="string"?n.src:n),s=this.resolver.resolve(t);await this._unloadFromResolved(s)}async unloadBundle(e){this._initialized||await this.init(),e=Vt(e);const t=this.resolver.resolveBundle(e),s=Object.keys(t).map(n=>this._unloadFromResolved(t[n]));await Promise.all(s)}async _unloadFromResolved(e){const t=Object.values(e);t.forEach(s=>{Ie.remove(s.src)}),await this.loader.unload(t)}async _detectFormats(e){let t=[];e.preferredFormats&&(t=Array.isArray(e.preferredFormats)?e.preferredFormats:[e.preferredFormats]);for(const s of e.detections)e.skipDetections||await s.test()?t=await s.add(t):e.skipDetections||(t=await s.remove(t));return t=t.filter((s,n)=>t.indexOf(s)===n),t}get detections(){return this._detections}setPreferences(e){this.loader.parsers.forEach(t=>{t.config&&Object.keys(t.config).filter(s=>s in e).forEach(s=>{t.config[s]=e[s]})})}}const st=new q_;at.handleByList(J.LoadParser,st.loader.parsers).handleByList(J.ResolveParser,st.resolver.parsers).handleByList(J.CacheParser,st.cache.parsers).handleByList(J.DetectionParser,st.detections);at.add(i_,c_,o_,f_,h_,d_,u_,y_,x_,E_,R_,tf,V_,n_,s_,rf,W_);const Rh={loader:J.LoadParser,resolver:J.ResolveParser,cache:J.CacheParser,detection:J.DetectionParser};at.handle(J.Asset,r=>{const e=r.ref;Object.entries(Rh).filter(([t])=>!!e[t]).forEach(([t,s])=>at.add(Object.assign(e[t],{extension:e[t].extension??s})))},r=>{const e=r.ref;Object.keys(Rh).filter(t=>!!e[t]).forEach(t=>at.remove(e[t]))});class Pe extends Oc{constructor(e){e instanceof Mt&&(e={context:e});const{context:t,roundPixels:s,...n}=e||{};super({label:"Graphics",...n}),this.renderPipeId="graphics",t?this._context=t:this._context=this._ownedContext=new Mt,this._context.on("update",this.onViewUpdate,this),this.didViewUpdate=!0,this.allowChildren=!1,this.roundPixels=s??!1}set context(e){e!==this._context&&(this._context.off("update",this.onViewUpdate,this),this._context=e,this._context.on("update",this.onViewUpdate,this),this.onViewUpdate())}get context(){return this._context}get bounds(){return this._context.bounds}updateBounds(){}containsPoint(e){return this._context.containsPoint(e)}destroy(e){this._ownedContext&&!e?this._ownedContext.destroy(e):(e===!0||(e==null?void 0:e.context)===!0)&&this._context.destroy(e),this._ownedContext=null,this._context=null,super.destroy(e)}_callContextMethod(e,t){return this.context[e](...t),this}setFillStyle(...e){return this._callContextMethod("setFillStyle",e)}setStrokeStyle(...e){return this._callContextMethod("setStrokeStyle",e)}fill(...e){return this._callContextMethod("fill",e)}stroke(...e){return this._callContextMethod("stroke",e)}texture(...e){return this._callContextMethod("texture",e)}beginPath(){return this._callContextMethod("beginPath",[])}cut(){return this._callContextMethod("cut",[])}arc(...e){return this._callContextMethod("arc",e)}arcTo(...e){return this._callContextMethod("arcTo",e)}arcToSvg(...e){return this._callContextMethod("arcToSvg",e)}bezierCurveTo(...e){return this._callContextMethod("bezierCurveTo",e)}closePath(){return this._callContextMethod("closePath",[])}ellipse(...e){return this._callContextMethod("ellipse",e)}circle(...e){return this._callContextMethod("circle",e)}path(...e){return this._callContextMethod("path",e)}lineTo(...e){return this._callContextMethod("lineTo",e)}moveTo(...e){return this._callContextMethod("moveTo",e)}quadraticCurveTo(...e){return this._callContextMethod("quadraticCurveTo",e)}rect(...e){return this._callContextMethod("rect",e)}roundRect(...e){return this._callContextMethod("roundRect",e)}poly(...e){return this._callContextMethod("poly",e)}regularPoly(...e){return this._callContextMethod("regularPoly",e)}roundPoly(...e){return this._callContextMethod("roundPoly",e)}roundShape(...e){return this._callContextMethod("roundShape",e)}filletRect(...e){return this._callContextMethod("filletRect",e)}chamferRect(...e){return this._callContextMethod("chamferRect",e)}star(...e){return this._callContextMethod("star",e)}svg(...e){return this._callContextMethod("svg",e)}restore(...e){return this._callContextMethod("restore",e)}save(){return this._callContextMethod("save",[])}getTransform(){return this.context.getTransform()}resetTransform(){return this._callContextMethod("resetTransform",[])}rotateTransform(...e){return this._callContextMethod("rotate",e)}scaleTransform(...e){return this._callContextMethod("scale",e)}setTransform(...e){return this._callContextMethod("setTransform",e)}transform(...e){return this._callContextMethod("transform",e)}translateTransform(...e){return this._callContextMethod("translate",e)}clear(){return this._callContextMethod("clear",[])}get fillStyle(){return this._context.fillStyle}set fillStyle(e){this._context.fillStyle=e}get strokeStyle(){return this._context.strokeStyle}set strokeStyle(e){this._context.strokeStyle=e}clone(e=!1){return e?new Pe(this._context.clone()):(this._ownedContext=null,new Pe(this._context))}lineStyle(e,t,s){he(_e,"Graphics#lineStyle is no longer needed. Use Graphics#setStrokeStyle to set the stroke style.");const n={};return e&&(n.width=e),t&&(n.color=t),s&&(n.alpha=s),this.context.strokeStyle=n,this}beginFill(e,t){he(_e,"Graphics#beginFill is no longer needed. Use Graphics#fill to fill the shape with the desired style.");const s={};return e!==void 0&&(s.color=e),t!==void 0&&(s.alpha=t),this.context.fillStyle=s,this}endFill(){he(_e,"Graphics#endFill is no longer needed. Use Graphics#fill to fill the shape with the desired style."),this.context.fill();const e=this.context.strokeStyle;return(e.width!==Mt.defaultStrokeStyle.width||e.color!==Mt.defaultStrokeStyle.color||e.alpha!==Mt.defaultStrokeStyle.alpha)&&this.context.stroke(),this}drawCircle(...e){return he(_e,"Graphics#drawCircle has been renamed to Graphics#circle"),this._callContextMethod("circle",e)}drawEllipse(...e){return he(_e,"Graphics#drawEllipse has been renamed to Graphics#ellipse"),this._callContextMethod("ellipse",e)}drawPolygon(...e){return he(_e,"Graphics#drawPolygon has been renamed to Graphics#poly"),this._callContextMethod("poly",e)}drawRect(...e){return he(_e,"Graphics#drawRect has been renamed to Graphics#rect"),this._callContextMethod("rect",e)}drawRoundedRect(...e){return he(_e,"Graphics#drawRoundedRect has been renamed to Graphics#roundRect"),this._callContextMethod("roundRect",e)}drawStar(...e){return he(_e,"Graphics#drawStar has been renamed to Graphics#star"),this._callContextMethod("star",e)}}class X_ extends Oc{constructor(e,t){const{text:s,resolution:n,style:a,anchor:i,width:o,height:c,roundPixels:l,...h}=e;super({...h}),this.batched=!0,this._resolution=null,this._autoResolution=!0,this._didTextUpdate=!0,this._styleClass=t,this.text=s??"",this.style=a,this.resolution=n??null,this.allowChildren=!1,this._anchor=new nt({_onUpdate:()=>{this.onViewUpdate()}}),i&&(this.anchor=i),this.roundPixels=l??!1,o!==void 0&&(this.width=o),c!==void 0&&(this.height=c)}get anchor(){return this._anchor}set anchor(e){typeof e=="number"?this._anchor.set(e):this._anchor.copyFrom(e)}set text(e){e=e.toString(),this._text!==e&&(this._text=e,this.onViewUpdate())}get text(){return this._text}set resolution(e){this._autoResolution=e===null,this._resolution=e,this.onViewUpdate()}get resolution(){return this._resolution}get style(){return this._style}set style(e){var t;e||(e={}),(t=this._style)==null||t.off("update",this.onViewUpdate,this),e instanceof this._styleClass?this._style=e:this._style=new this._styleClass(e),this._style.on("update",this.onViewUpdate,this),this.onViewUpdate()}get width(){return Math.abs(this.scale.x)*this.bounds.width}set width(e){this._setWidth(e,this.bounds.width)}get height(){return Math.abs(this.scale.y)*this.bounds.height}set height(e){this._setHeight(e,this.bounds.height)}getSize(e){return e||(e={}),e.width=Math.abs(this.scale.x)*this.bounds.width,e.height=Math.abs(this.scale.y)*this.bounds.height,e}setSize(e,t){typeof e=="object"?(t=e.height??e.width,e=e.width):t??(t=e),e!==void 0&&this._setWidth(e,this.bounds.width),t!==void 0&&this._setHeight(t,this.bounds.height)}containsPoint(e){const t=this.bounds.width,s=this.bounds.height,n=-t*this.anchor.x;let a=0;return e.x>=n&&e.x<=n+t&&(a=-s*this.anchor.y,e.y>=a&&e.y<=a+s)}onViewUpdate(){this.didViewUpdate||(this._didTextUpdate=!0),super.onViewUpdate()}destroy(e=!1){super.destroy(e),this.owner=null,this._bounds=null,this._anchor=null,(typeof e=="boolean"?e:e!=null&&e.style)&&this._style.destroy(e),this._style=null,this._text=null}get styleKey(){return`${this._text}:${this._style.styleKey}:${this._resolution}`}}function Y_(r,e){let t=r[0]??{};return(typeof t=="string"||r[1])&&(he(_e,`use new ${e}({ text: "hi!", style }) instead`),t={text:t,style:r[1]}),t}let Vr=null,mr=null;function K_(r,e){Vr||(Vr=ke.get().createCanvas(256,128),mr=Vr.getContext("2d",{willReadFrequently:!0}),mr.globalCompositeOperation="copy",mr.globalAlpha=1),(Vr.width<r||Vr.height<e)&&(Vr.width=Ns(r),Vr.height=Ns(e))}function Mh(r,e,t){for(let s=0,n=4*t*e;s<e;++s,n+=4)if(r[n+3]!==0)return!1;return!0}function $h(r,e,t,s,n){const a=4*e;for(let i=s,o=s*a+4*t;i<=n;++i,o+=a)if(r[o+3]!==0)return!1;return!0}function J_(...r){let e=r[0];e.canvas||(e={canvas:r[0],resolution:r[1]});const{canvas:t}=e,s=Math.min(e.resolution??1,1),n=e.width??t.width,a=e.height??t.height;let i=e.output;if(K_(n,a),!mr)throw new TypeError("Failed to get canvas 2D context");mr.drawImage(t,0,0,n,a,0,0,n*s,a*s);const c=mr.getImageData(0,0,n,a).data;let l=0,h=0,d=n-1,u=a-1;for(;h<a&&Mh(c,n,h);)++h;if(h===a)return Re.EMPTY;for(;Mh(c,n,u);)--u;for(;$h(c,n,l,h,u);)++l;for(;$h(c,n,d,h,u);)--d;return++d,++u,mr.globalCompositeOperation="source-over",mr.strokeRect(l,h,d-l,u-h),mr.globalCompositeOperation="copy",i??(i=new Re),i.set(l/s,h/s,(d-l)/s,(u-h)/s),i}const Oh=new Re;class Q_{getCanvasAndContext(e){const{text:t,style:s,resolution:n=1}=e,a=s._getFinalPadding(),i=nr.measureText(t||" ",s),o=Math.ceil(Math.ceil(Math.max(1,i.width)+a*2)*n),c=Math.ceil(Math.ceil(Math.max(1,i.height)+a*2)*n),l=Vn.getOptimalCanvasAndContext(o,c);this._renderTextToCanvas(t,s,a,n,l);const h=s.trim?J_({canvas:l.canvas,width:o,height:c,resolution:1,output:Oh}):Oh.set(0,0,o,c);return{canvasAndContext:l,frame:h}}returnCanvasAndContext(e){Vn.returnCanvasAndContext(e)}_renderTextToCanvas(e,t,s,n,a){var x,S,T,A;const{canvas:i,context:o}=a,c=mi(t),l=nr.measureText(e||" ",t),h=l.lines,d=l.lineHeight,u=l.lineWidths,f=l.maxLineWidth,p=l.fontProperties,g=i.height;if(o.resetTransform(),o.scale(n,n),o.textBaseline=t.textBaseline,(x=t._stroke)!=null&&x.width){const C=t._stroke;o.lineWidth=C.width,o.miterLimit=C.miterLimit,o.lineJoin=C.join,o.lineCap=C.cap}o.font=c;let m,_;const b=t.dropShadow?2:1;for(let C=0;C<b;++C){const R=t.dropShadow&&C===0,$=R?Math.ceil(Math.max(1,g)+s*2):0,B=$*n;if(R){o.fillStyle="black",o.strokeStyle="black";const z=t.dropShadow,de=z.color,Qe=z.alpha;o.shadowColor=qe.shared.setValue(de).setAlpha(Qe).toRgbaString();const G=z.blur*n,Q=z.distance*n;o.shadowBlur=G,o.shadowOffsetX=Math.cos(z.angle)*Q,o.shadowOffsetY=Math.sin(z.angle)*Q+B}else{if(o.fillStyle=t._fill?_i(t._fill,o,l,s*2):null,(S=t._stroke)!=null&&S.width){const z=t._stroke.width*.5+s*2;o.strokeStyle=_i(t._stroke,o,l,z)}o.shadowColor="black"}let j=(d-p.fontSize)/2;d-p.fontSize<0&&(j=0);const se=((T=t._stroke)==null?void 0:T.width)??0;for(let z=0;z<h.length;z++)m=se/2,_=se/2+z*d+p.ascent+j,t.align==="right"?m+=f-u[z]:t.align==="center"&&(m+=(f-u[z])/2),(A=t._stroke)!=null&&A.width&&this._drawLetterSpacing(h[z],t,a,m+s,_+s-$,!0),t._fill!==void 0&&this._drawLetterSpacing(h[z],t,a,m+s,_+s-$)}}_drawLetterSpacing(e,t,s,n,a,i=!1){const{context:o}=s,c=t.letterSpacing;let l=!1;if(nr.experimentalLetterSpacingSupported&&(nr.experimentalLetterSpacing?(o.letterSpacing=`${c}px`,o.textLetterSpacing=`${c}px`,l=!0):(o.letterSpacing="0px",o.textLetterSpacing="0px")),c===0||l){i?o.strokeText(e,n,a):o.fillText(e,n,a);return}let h=n;const d=nr.graphemeSegmenter(e);let u=o.measureText(e).width,f=0;for(let p=0;p<d.length;++p){const g=d[p];i?o.strokeText(g,h,a):o.fillText(g,h,a);let m="";for(let _=p+1;_<d.length;++_)m+=d[_];f=o.measureText(m).width,h+=u-f+c,u=f}}}const Bh=new Q_;class sr extends X_{constructor(...e){const t=Y_(e,"Text");super(t,zn),this.renderPipeId="text",t.textureStyle&&(this.textureStyle=t.textureStyle instanceof Hs?t.textureStyle:new Hs(t.textureStyle))}updateBounds(){const e=this._bounds,t=this._anchor;let s=0,n=0;if(this._style.trim){const{frame:a,canvasAndContext:i}=Bh.getCanvasAndContext({text:this.text,style:this._style,resolution:1});Bh.returnCanvasAndContext(i),s=a.width,n=a.height}else{const a=nr.measureText(this._text,this._style);s=a.width,n=a.height}e.minX=-t._x*s,e.maxX=e.minX+s,e.minY=-t._y*n,e.maxY=e.minY+n}}at.add(tm,rm);function Z_(r){const e=r.split("_");if(e.length>=2){const t=e[1];return t.charAt(0)+t.slice(1).toLowerCase()}return"Ariana"}function Ma(r){const e=Z_(r.id),t=r.type,s=r.rarity;return`cards/${`${e}_${t}_${s}`}.webp`}const eb={"ui.profile.title":"","ui.currency.gold":"","ui.currency.shard":"","ui.currency.ticket":"","ui.btn.ok":"","ui.btn.cancel":"","ui.btn.confirm":"","ui.btn.back":"","ui.mode.campaign":"","ui.mode.daily":" ","ui.mode.draft":"","ui.mode.pvp":"","ui.mode.deck":" ","ui.mode.shop":"","ui.mode.archive":"","battle.energy":"","battle.round":"","battle.initiative":"","battle.lockin":" ","battle.reveal":"","battle.pass":"","battle.endTurn":" ","battle.declared":"","battle.reservedEnergy":" ","battle.noCards":"  ","battle.player":"","battle.enemy":"","battle.victory":"!","battle.defeat":"!","battle.hp":"HP","battle.seed":"","tuto.select_card":" 1  .","tuto.lockin":" .","tuto.reveal":"  .","tuto.use_fire":"   .","tuto.burn_tick":"    .","tuto.use_ice":"   -1  .","tuto.nullify_hint":"    .","shop.daily_deal":" ","shop.buy":"","reward.first_clear":"  ","reward.repeat":" ","log.view.all":"","log.view.summary":"","log.filter.all":"","log.filter.card":"","log.filter.effect":"","log.filter.system":"","log.search":"...","log.noResults":"  ","card.type.Attack":"","card.type.Heal":"","card.type.Defense":"","card.type.Special":"","status.none":""},tb={"ui.profile.title":"Profile","ui.currency.gold":"Gold","ui.currency.shard":"Shards","ui.currency.ticket":"Tickets","ui.btn.ok":"OK","ui.btn.cancel":"Cancel","ui.btn.confirm":"Confirm","ui.btn.back":"Back","ui.mode.campaign":"Campaign","ui.mode.daily":"Daily Dungeon","ui.mode.draft":"Draft","ui.mode.pvp":"PvP","ui.mode.deck":"Deck Editor","ui.mode.shop":"Shop","ui.mode.archive":"Archive","battle.energy":"Energy","battle.round":"Round","battle.initiative":"Initiative","battle.lockin":"Lock-in","battle.reveal":"Reveal","battle.pass":"Pass","battle.endTurn":"End Turn","battle.declared":"Declared","battle.reservedEnergy":"Reserved Energy","battle.noCards":"No cards declared","battle.player":"Player","battle.enemy":"Enemy","battle.victory":"Victory!","battle.defeat":"Defeat!","battle.hp":"HP","battle.seed":"Seed","tuto.select_card":"Select and declare a card.","tuto.lockin":"Declaration locked.","tuto.reveal":"Revealing both declarations.","tuto.use_fire":"Try applying Burn with Fireball.","tuto.burn_tick":"Burn damage applies at turn start.","tuto.use_ice":"Try reducing actions with Ice Spike.","tuto.nullify_hint":"Try using Nullify before reveal.","shop.daily_deal":"Daily Deal","shop.buy":"Buy","reward.first_clear":"First Clear Reward","reward.repeat":"Repeat Reward","log.view.all":"Detailed","log.view.summary":"Summary","log.filter.all":"All","log.filter.card":"Cards","log.filter.effect":"Effects","log.filter.system":"System","log.search":"Search...","log.noResults":"No results","card.type.Attack":"Attack","card.type.Heal":"Heal","card.type.Defense":"Defense","card.type.Special":"Special","status.none":"None"},sf={ko:eb,en:tb},nf="gals_locale";let bi=localStorage.getItem(nf)||"ko";const Dh=new Set;function rb(r){const e=r in sf?r:"ko";bi=e,localStorage.setItem(nf,e),console.log(`[i18n] Locale changed to: ${e}`)}function Be(r){const t=(sf[bi]||{})[r];return t||(Dh.has(r)||(Dh.add(r),console.warn(`[i18n] Missing translation key: "${r}" (locale: ${bi})`)),r)}function Lh(){return bi}const sb={},Fh=r=>{let e;const t=new Set,s=(h,d)=>{const u=typeof h=="function"?h(e):h;if(!Object.is(u,e)){const f=e;e=d??(typeof u!="object"||u===null)?u:Object.assign({},e,u),t.forEach(p=>p(e,f))}},n=()=>e,c={setState:s,getState:n,getInitialState:()=>l,subscribe:h=>(t.add(h),()=>t.delete(h)),destroy:()=>{(sb?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),t.clear()}},l=e=r(s,n,c);return c},nb=r=>r?Fh(r):Fh;var af={exports:{}},ae={};/**
 * @license React
 * react.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Wc=Symbol.for("react.transitional.element"),ab=Symbol.for("react.portal"),ib=Symbol.for("react.fragment"),ob=Symbol.for("react.strict_mode"),cb=Symbol.for("react.profiler"),lb=Symbol.for("react.consumer"),hb=Symbol.for("react.context"),db=Symbol.for("react.forward_ref"),ub=Symbol.for("react.suspense"),fb=Symbol.for("react.memo"),of=Symbol.for("react.lazy"),pb=Symbol.for("react.activity"),jh=Symbol.iterator;function mb(r){return r===null||typeof r!="object"?null:(r=jh&&r[jh]||r["@@iterator"],typeof r=="function"?r:null)}var cf={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},lf=Object.assign,hf={};function Ks(r,e,t){this.props=r,this.context=e,this.refs=hf,this.updater=t||cf}Ks.prototype.isReactComponent={};Ks.prototype.setState=function(r,e){if(typeof r!="object"&&typeof r!="function"&&r!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,r,e,"setState")};Ks.prototype.forceUpdate=function(r){this.updater.enqueueForceUpdate(this,r,"forceUpdate")};function df(){}df.prototype=Ks.prototype;function qc(r,e,t){this.props=r,this.context=e,this.refs=hf,this.updater=t||cf}var Xc=qc.prototype=new df;Xc.constructor=qc;lf(Xc,Ks.prototype);Xc.isPureReactComponent=!0;var Nh=Array.isArray;function cc(){}var Ce={H:null,A:null,T:null,S:null},uf=Object.prototype.hasOwnProperty;function Yc(r,e,t){var s=t.ref;return{$$typeof:Wc,type:r,key:e,ref:s!==void 0?s:null,props:t}}function gb(r,e){return Yc(r.type,e,r.props)}function Kc(r){return typeof r=="object"&&r!==null&&r.$$typeof===Wc}function yb(r){var e={"=":"=0",":":"=2"};return"$"+r.replace(/[=:]/g,function(t){return e[t]})}var Hh=/\/+/g;function Io(r,e){return typeof r=="object"&&r!==null&&r.key!=null?yb(""+r.key):e.toString(36)}function _b(r){switch(r.status){case"fulfilled":return r.value;case"rejected":throw r.reason;default:switch(typeof r.status=="string"?r.then(cc,cc):(r.status="pending",r.then(function(e){r.status==="pending"&&(r.status="fulfilled",r.value=e)},function(e){r.status==="pending"&&(r.status="rejected",r.reason=e)})),r.status){case"fulfilled":return r.value;case"rejected":throw r.reason}}throw r}function Ps(r,e,t,s,n){var a=typeof r;(a==="undefined"||a==="boolean")&&(r=null);var i=!1;if(r===null)i=!0;else switch(a){case"bigint":case"string":case"number":i=!0;break;case"object":switch(r.$$typeof){case Wc:case ab:i=!0;break;case of:return i=r._init,Ps(i(r._payload),e,t,s,n)}}if(i)return n=n(r),i=s===""?"."+Io(r,0):s,Nh(n)?(t="",i!=null&&(t=i.replace(Hh,"$&/")+"/"),Ps(n,e,t,"",function(l){return l})):n!=null&&(Kc(n)&&(n=gb(n,t+(n.key==null||r&&r.key===n.key?"":(""+n.key).replace(Hh,"$&/")+"/")+i)),e.push(n)),1;i=0;var o=s===""?".":s+":";if(Nh(r))for(var c=0;c<r.length;c++)s=r[c],a=o+Io(s,c),i+=Ps(s,e,t,a,n);else if(c=mb(r),typeof c=="function")for(r=c.call(r),c=0;!(s=r.next()).done;)s=s.value,a=o+Io(s,c++),i+=Ps(s,e,t,a,n);else if(a==="object"){if(typeof r.then=="function")return Ps(_b(r),e,t,s,n);throw e=String(r),Error("Objects are not valid as a React child (found: "+(e==="[object Object]"?"object with keys {"+Object.keys(r).join(", ")+"}":e)+"). If you meant to render a collection of children, use an array instead.")}return i}function $a(r,e,t){if(r==null)return r;var s=[],n=0;return Ps(r,s,"","",function(a){return e.call(t,a,n++)}),s}function bb(r){if(r._status===-1){var e=r._result;e=e(),e.then(function(t){(r._status===0||r._status===-1)&&(r._status=1,r._result=t)},function(t){(r._status===0||r._status===-1)&&(r._status=2,r._result=t)}),r._status===-1&&(r._status=0,r._result=e)}if(r._status===1)return r._result.default;throw r._result}var Uh=typeof reportError=="function"?reportError:function(r){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var e=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof r=="object"&&r!==null&&typeof r.message=="string"?String(r.message):String(r),error:r});if(!window.dispatchEvent(e))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",r);return}console.error(r)},xb={map:$a,forEach:function(r,e,t){$a(r,function(){e.apply(this,arguments)},t)},count:function(r){var e=0;return $a(r,function(){e++}),e},toArray:function(r){return $a(r,function(e){return e})||[]},only:function(r){if(!Kc(r))throw Error("React.Children.only expected to receive a single React element child.");return r}};ae.Activity=pb;ae.Children=xb;ae.Component=Ks;ae.Fragment=ib;ae.Profiler=cb;ae.PureComponent=qc;ae.StrictMode=ob;ae.Suspense=ub;ae.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=Ce;ae.__COMPILER_RUNTIME={__proto__:null,c:function(r){return Ce.H.useMemoCache(r)}};ae.cache=function(r){return function(){return r.apply(null,arguments)}};ae.cacheSignal=function(){return null};ae.cloneElement=function(r,e,t){if(r==null)throw Error("The argument must be a React element, but you passed "+r+".");var s=lf({},r.props),n=r.key;if(e!=null)for(a in e.key!==void 0&&(n=""+e.key),e)!uf.call(e,a)||a==="key"||a==="__self"||a==="__source"||a==="ref"&&e.ref===void 0||(s[a]=e[a]);var a=arguments.length-2;if(a===1)s.children=t;else if(1<a){for(var i=Array(a),o=0;o<a;o++)i[o]=arguments[o+2];s.children=i}return Yc(r.type,n,s)};ae.createContext=function(r){return r={$$typeof:hb,_currentValue:r,_currentValue2:r,_threadCount:0,Provider:null,Consumer:null},r.Provider=r,r.Consumer={$$typeof:lb,_context:r},r};ae.createElement=function(r,e,t){var s,n={},a=null;if(e!=null)for(s in e.key!==void 0&&(a=""+e.key),e)uf.call(e,s)&&s!=="key"&&s!=="__self"&&s!=="__source"&&(n[s]=e[s]);var i=arguments.length-2;if(i===1)n.children=t;else if(1<i){for(var o=Array(i),c=0;c<i;c++)o[c]=arguments[c+2];n.children=o}if(r&&r.defaultProps)for(s in i=r.defaultProps,i)n[s]===void 0&&(n[s]=i[s]);return Yc(r,a,n)};ae.createRef=function(){return{current:null}};ae.forwardRef=function(r){return{$$typeof:db,render:r}};ae.isValidElement=Kc;ae.lazy=function(r){return{$$typeof:of,_payload:{_status:-1,_result:r},_init:bb}};ae.memo=function(r,e){return{$$typeof:fb,type:r,compare:e===void 0?null:e}};ae.startTransition=function(r){var e=Ce.T,t={};Ce.T=t;try{var s=r(),n=Ce.S;n!==null&&n(t,s),typeof s=="object"&&s!==null&&typeof s.then=="function"&&s.then(cc,Uh)}catch(a){Uh(a)}finally{e!==null&&t.types!==null&&(e.types=t.types),Ce.T=e}};ae.unstable_useCacheRefresh=function(){return Ce.H.useCacheRefresh()};ae.use=function(r){return Ce.H.use(r)};ae.useActionState=function(r,e,t){return Ce.H.useActionState(r,e,t)};ae.useCallback=function(r,e){return Ce.H.useCallback(r,e)};ae.useContext=function(r){return Ce.H.useContext(r)};ae.useDebugValue=function(){};ae.useDeferredValue=function(r,e){return Ce.H.useDeferredValue(r,e)};ae.useEffect=function(r,e){return Ce.H.useEffect(r,e)};ae.useEffectEvent=function(r){return Ce.H.useEffectEvent(r)};ae.useId=function(){return Ce.H.useId()};ae.useImperativeHandle=function(r,e,t){return Ce.H.useImperativeHandle(r,e,t)};ae.useInsertionEffect=function(r,e){return Ce.H.useInsertionEffect(r,e)};ae.useLayoutEffect=function(r,e){return Ce.H.useLayoutEffect(r,e)};ae.useMemo=function(r,e){return Ce.H.useMemo(r,e)};ae.useOptimistic=function(r,e){return Ce.H.useOptimistic(r,e)};ae.useReducer=function(r,e,t){return Ce.H.useReducer(r,e,t)};ae.useRef=function(r){return Ce.H.useRef(r)};ae.useState=function(r){return Ce.H.useState(r)};ae.useSyncExternalStore=function(r,e,t){return Ce.H.useSyncExternalStore(r,e,t)};ae.useTransition=function(){return Ce.H.useTransition()};ae.version="19.2.0";af.exports=ae;var Jc=af.exports;const wb=Ei(Jc);var ff={exports:{}},pf={},mf={exports:{}},gf={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var zs=Jc;function vb(r,e){return r===e&&(r!==0||1/r===1/e)||r!==r&&e!==e}var Sb=typeof Object.is=="function"?Object.is:vb,kb=zs.useState,Ib=zs.useEffect,Ab=zs.useLayoutEffect,Cb=zs.useDebugValue;function Eb(r,e){var t=e(),s=kb({inst:{value:t,getSnapshot:e}}),n=s[0].inst,a=s[1];return Ab(function(){n.value=t,n.getSnapshot=e,Ao(n)&&a({inst:n})},[r,t,e]),Ib(function(){return Ao(n)&&a({inst:n}),r(function(){Ao(n)&&a({inst:n})})},[r]),Cb(t),t}function Ao(r){var e=r.getSnapshot;r=r.value;try{var t=e();return!Sb(r,t)}catch{return!0}}function Tb(r,e){return e()}var Pb=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?Tb:Eb;gf.useSyncExternalStore=zs.useSyncExternalStore!==void 0?zs.useSyncExternalStore:Pb;mf.exports=gf;var Rb=mf.exports;/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Oi=Jc,Mb=Rb;function $b(r,e){return r===e&&(r!==0||1/r===1/e)||r!==r&&e!==e}var Ob=typeof Object.is=="function"?Object.is:$b,Bb=Mb.useSyncExternalStore,Db=Oi.useRef,Lb=Oi.useEffect,Fb=Oi.useMemo,jb=Oi.useDebugValue;pf.useSyncExternalStoreWithSelector=function(r,e,t,s,n){var a=Db(null);if(a.current===null){var i={hasValue:!1,value:null};a.current=i}else i=a.current;a=Fb(function(){function c(f){if(!l){if(l=!0,h=f,f=s(f),n!==void 0&&i.hasValue){var p=i.value;if(n(p,f))return d=p}return d=f}if(p=d,Ob(h,f))return p;var g=s(f);return n!==void 0&&n(p,g)?(h=f,p):(h=f,d=g)}var l=!1,h,d,u=t===void 0?null:t;return[function(){return c(e())},u===null?void 0:function(){return c(u())}]},[e,t,s,n]);var o=Bb(r,a[0],a[1]);return Lb(function(){i.hasValue=!0,i.value=o},[o]),jb(o),o};ff.exports=pf;var Nb=ff.exports;const Hb=Ei(Nb),yf={},{useDebugValue:Ub}=wb,{useSyncExternalStoreWithSelector:Gb}=Hb;let Gh=!1;const zb=r=>r;function Vb(r,e=zb,t){(yf?"production":void 0)!=="production"&&t&&!Gh&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Gh=!0);const s=Gb(r.subscribe,r.getState,r.getServerState||r.getInitialState,e,t);return Ub(s),s}const zh=r=>{(yf?"production":void 0)!=="production"&&typeof r!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const e=typeof r=="function"?nb(r):r,t=(s,n)=>Vb(e,s,n);return Object.assign(t,e),t},_f=r=>r?zh(r):zh;var lc=function(r,e){return lc=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var n in s)Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])},lc(r,e)};function bf(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");lc(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}var xi=function(){return xi=Object.assign||function(e){for(var t,s=1,n=arguments.length;s<n;s++){t=arguments[s];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},xi.apply(this,arguments)};function Js(r,e){var t={};for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&e.indexOf(s)<0&&(t[s]=r[s]);if(r!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,s=Object.getOwnPropertySymbols(r);n<s.length;n++)e.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(r,s[n])&&(t[s[n]]=r[s[n]]);return t}function xf(r,e,t,s){var n=arguments.length,a=n<3?e:s===null?s=Object.getOwnPropertyDescriptor(e,t):s,i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")a=Reflect.decorate(r,e,t,s);else for(var o=r.length-1;o>=0;o--)(i=r[o])&&(a=(n<3?i(a):n>3?i(e,t,a):i(e,t))||a);return n>3&&a&&Object.defineProperty(e,t,a),a}function wf(r,e){return function(t,s){e(t,s,r)}}function vf(r,e,t,s,n,a){function i(_){if(_!==void 0&&typeof _!="function")throw new TypeError("Function expected");return _}for(var o=s.kind,c=o==="getter"?"get":o==="setter"?"set":"value",l=!e&&r?s.static?r:r.prototype:null,h=e||(l?Object.getOwnPropertyDescriptor(l,s.name):{}),d,u=!1,f=t.length-1;f>=0;f--){var p={};for(var g in s)p[g]=g==="access"?{}:s[g];for(var g in s.access)p.access[g]=s.access[g];p.addInitializer=function(_){if(u)throw new TypeError("Cannot add initializers after decoration has completed");a.push(i(_||null))};var m=(0,t[f])(o==="accessor"?{get:h.get,set:h.set}:h[c],p);if(o==="accessor"){if(m===void 0)continue;if(m===null||typeof m!="object")throw new TypeError("Object expected");(d=i(m.get))&&(h.get=d),(d=i(m.set))&&(h.set=d),(d=i(m.init))&&n.unshift(d)}else(d=i(m))&&(o==="field"?n.unshift(d):h[c]=d)}l&&Object.defineProperty(l,s.name,h),u=!0}function Sf(r,e,t){for(var s=arguments.length>2,n=0;n<e.length;n++)t=s?e[n].call(r,t):e[n].call(r);return s?t:void 0}function kf(r){return typeof r=="symbol"?r:"".concat(r)}function If(r,e,t){return typeof e=="symbol"&&(e=e.description?"[".concat(e.description,"]"):""),Object.defineProperty(r,"name",{configurable:!0,value:t?"".concat(t," ",e):e})}function Af(r,e){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(r,e)}function V(r,e,t,s){function n(a){return a instanceof t?a:new t(function(i){i(a)})}return new(t||(t=Promise))(function(a,i){function o(h){try{l(s.next(h))}catch(d){i(d)}}function c(h){try{l(s.throw(h))}catch(d){i(d)}}function l(h){h.done?a(h.value):n(h.value).then(o,c)}l((s=s.apply(r,e||[])).next())})}function Cf(r,e){var t={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},s,n,a,i=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return i.next=o(0),i.throw=o(1),i.return=o(2),typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function o(l){return function(h){return c([l,h])}}function c(l){if(s)throw new TypeError("Generator is already executing.");for(;i&&(i=0,l[0]&&(t=0)),t;)try{if(s=1,n&&(a=l[0]&2?n.return:l[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,l[1])).done)return a;switch(n=0,a&&(l=[l[0]&2,a.value]),l[0]){case 0:case 1:a=l;break;case 4:return t.label++,{value:l[1],done:!1};case 5:t.label++,n=l[1],l=[0];continue;case 7:l=t.ops.pop(),t.trys.pop();continue;default:if(a=t.trys,!(a=a.length>0&&a[a.length-1])&&(l[0]===6||l[0]===2)){t=0;continue}if(l[0]===3&&(!a||l[1]>a[0]&&l[1]<a[3])){t.label=l[1];break}if(l[0]===6&&t.label<a[1]){t.label=a[1],a=l;break}if(a&&t.label<a[2]){t.label=a[2],t.ops.push(l);break}a[2]&&t.ops.pop(),t.trys.pop();continue}l=e.call(r,t)}catch(h){l=[6,h],n=0}finally{s=a=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}}var Bi=Object.create?function(r,e,t,s){s===void 0&&(s=t);var n=Object.getOwnPropertyDescriptor(e,t);(!n||("get"in n?!e.__esModule:n.writable||n.configurable))&&(n={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(r,s,n)}:function(r,e,t,s){s===void 0&&(s=t),r[s]=e[t]};function Ef(r,e){for(var t in r)t!=="default"&&!Object.prototype.hasOwnProperty.call(e,t)&&Bi(e,r,t)}function wi(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],s=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&s>=r.length&&(r=void 0),{value:r&&r[s++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Qc(r,e){var t=typeof Symbol=="function"&&r[Symbol.iterator];if(!t)return r;var s=t.call(r),n,a=[],i;try{for(;(e===void 0||e-- >0)&&!(n=s.next()).done;)a.push(n.value)}catch(o){i={error:o}}finally{try{n&&!n.done&&(t=s.return)&&t.call(s)}finally{if(i)throw i.error}}return a}function Tf(){for(var r=[],e=0;e<arguments.length;e++)r=r.concat(Qc(arguments[e]));return r}function Pf(){for(var r=0,e=0,t=arguments.length;e<t;e++)r+=arguments[e].length;for(var s=Array(r),n=0,e=0;e<t;e++)for(var a=arguments[e],i=0,o=a.length;i<o;i++,n++)s[n]=a[i];return s}function Rf(r,e,t){if(t||arguments.length===2)for(var s=0,n=e.length,a;s<n;s++)(a||!(s in e))&&(a||(a=Array.prototype.slice.call(e,0,s)),a[s]=e[s]);return r.concat(a||Array.prototype.slice.call(e))}function Vs(r){return this instanceof Vs?(this.v=r,this):new Vs(r)}function Mf(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var s=t.apply(r,e||[]),n,a=[];return n=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",i),n[Symbol.asyncIterator]=function(){return this},n;function i(f){return function(p){return Promise.resolve(p).then(f,d)}}function o(f,p){s[f]&&(n[f]=function(g){return new Promise(function(m,_){a.push([f,g,m,_])>1||c(f,g)})},p&&(n[f]=p(n[f])))}function c(f,p){try{l(s[f](p))}catch(g){u(a[0][3],g)}}function l(f){f.value instanceof Vs?Promise.resolve(f.value.v).then(h,d):u(a[0][2],f)}function h(f){c("next",f)}function d(f){c("throw",f)}function u(f,p){f(p),a.shift(),a.length&&c(a[0][0],a[0][1])}}function $f(r){var e,t;return e={},s("next"),s("throw",function(n){throw n}),s("return"),e[Symbol.iterator]=function(){return this},e;function s(n,a){e[n]=r[n]?function(i){return(t=!t)?{value:Vs(r[n](i)),done:!1}:a?a(i):i}:a}}function Of(r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=r[Symbol.asyncIterator],t;return e?e.call(r):(r=typeof wi=="function"?wi(r):r[Symbol.iterator](),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(a){t[a]=r[a]&&function(i){return new Promise(function(o,c){i=r[a](i),n(o,c,i.done,i.value)})}}function n(a,i,o,c){Promise.resolve(c).then(function(l){a({value:l,done:o})},i)}}function Bf(r,e){return Object.defineProperty?Object.defineProperty(r,"raw",{value:e}):r.raw=e,r}var Wb=Object.create?function(r,e){Object.defineProperty(r,"default",{enumerable:!0,value:e})}:function(r,e){r.default=e},hc=function(r){return hc=Object.getOwnPropertyNames||function(e){var t=[];for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[t.length]=s);return t},hc(r)};function Df(r){if(r&&r.__esModule)return r;var e={};if(r!=null)for(var t=hc(r),s=0;s<t.length;s++)t[s]!=="default"&&Bi(e,r,t[s]);return Wb(e,r),e}function Lf(r){return r&&r.__esModule?r:{default:r}}function Ff(r,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?r!==e||!s:!e.has(r))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(r):s?s.value:e.get(r)}function jf(r,e,t,s,n){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?r!==e||!n:!e.has(r))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?n.call(r,t):n?n.value=t:e.set(r,t),t}function Nf(r,e){if(e===null||typeof e!="object"&&typeof e!="function")throw new TypeError("Cannot use 'in' operator on non-object");return typeof r=="function"?e===r:r.has(e)}function Hf(r,e,t){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var s,n;if(t){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");s=e[Symbol.asyncDispose]}if(s===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");s=e[Symbol.dispose],t&&(n=s)}if(typeof s!="function")throw new TypeError("Object not disposable.");n&&(s=function(){try{n.call(this)}catch(a){return Promise.reject(a)}}),r.stack.push({value:e,dispose:s,async:t})}else t&&r.stack.push({async:!0});return e}var qb=typeof SuppressedError=="function"?SuppressedError:function(r,e,t){var s=new Error(t);return s.name="SuppressedError",s.error=r,s.suppressed=e,s};function Uf(r){function e(a){r.error=r.hasError?new qb(a,r.error,"An error was suppressed during disposal."):a,r.hasError=!0}var t,s=0;function n(){for(;t=r.stack.pop();)try{if(!t.async&&s===1)return s=0,r.stack.push(t),Promise.resolve().then(n);if(t.dispose){var a=t.dispose.call(t.value);if(t.async)return s|=2,Promise.resolve(a).then(n,function(i){return e(i),n()})}else s|=1}catch(i){e(i)}if(s===1)return r.hasError?Promise.reject(r.error):Promise.resolve();if(r.hasError)throw r.error}return n()}function Gf(r,e){return typeof r=="string"&&/^\.\.?\//.test(r)?r.replace(/\.(tsx)$|((?:\.d)?)((?:\.[^./]+?)?)\.([cm]?)ts$/i,function(t,s,n,a,i){return s?e?".jsx":".js":n&&(!a||!i)?t:n+a+"."+i.toLowerCase()+"js"}):r}const Xb={__extends:bf,__assign:xi,__rest:Js,__decorate:xf,__param:wf,__esDecorate:vf,__runInitializers:Sf,__propKey:kf,__setFunctionName:If,__metadata:Af,__awaiter:V,__generator:Cf,__createBinding:Bi,__exportStar:Ef,__values:wi,__read:Qc,__spread:Tf,__spreadArrays:Pf,__spreadArray:Rf,__await:Vs,__asyncGenerator:Mf,__asyncDelegator:$f,__asyncValues:Of,__makeTemplateObject:Bf,__importStar:Df,__importDefault:Lf,__classPrivateFieldGet:Ff,__classPrivateFieldSet:jf,__classPrivateFieldIn:Nf,__addDisposableResource:Hf,__disposeResources:Uf,__rewriteRelativeImportExtension:Gf},Yb=Object.freeze(Object.defineProperty({__proto__:null,__addDisposableResource:Hf,get __assign(){return xi},__asyncDelegator:$f,__asyncGenerator:Mf,__asyncValues:Of,__await:Vs,__awaiter:V,__classPrivateFieldGet:Ff,__classPrivateFieldIn:Nf,__classPrivateFieldSet:jf,__createBinding:Bi,__decorate:xf,__disposeResources:Uf,__esDecorate:vf,__exportStar:Ef,__extends:bf,__generator:Cf,__importDefault:Lf,__importStar:Df,__makeTemplateObject:Bf,__metadata:Af,__param:wf,__propKey:kf,__read:Qc,__rest:Js,__rewriteRelativeImportExtension:Gf,__runInitializers:Sf,__setFunctionName:If,__spread:Tf,__spreadArray:Rf,__spreadArrays:Pf,__values:wi,default:Xb},Symbol.toStringTag,{value:"Module"})),Kb=r=>r?(...e)=>r(...e):(...e)=>fetch(...e);class Zc extends Error{constructor(e,t="FunctionsError",s){super(e),this.name=t,this.context=s}}class Vh extends Zc{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class Wh extends Zc{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class qh extends Zc{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var dc;(function(r){r.Any="any",r.ApNortheast1="ap-northeast-1",r.ApNortheast2="ap-northeast-2",r.ApSouth1="ap-south-1",r.ApSoutheast1="ap-southeast-1",r.ApSoutheast2="ap-southeast-2",r.CaCentral1="ca-central-1",r.EuCentral1="eu-central-1",r.EuWest1="eu-west-1",r.EuWest2="eu-west-2",r.EuWest3="eu-west-3",r.SaEast1="sa-east-1",r.UsEast1="us-east-1",r.UsWest1="us-west-1",r.UsWest2="us-west-2"})(dc||(dc={}));class Jb{constructor(e,{headers:t={},customFetch:s,region:n=dc.Any}={}){this.url=e,this.headers=t,this.region=n,this.fetch=Kb(s)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e){return V(this,arguments,void 0,function*(t,s={}){var n;try{const{headers:a,method:i,body:o,signal:c}=s;let l={},{region:h}=s;h||(h=this.region);const d=new URL(`${this.url}/${t}`);h&&h!=="any"&&(l["x-region"]=h,d.searchParams.set("forceFunctionRegion",h));let u;o&&(a&&!Object.prototype.hasOwnProperty.call(a,"Content-Type")||!a)?typeof Blob<"u"&&o instanceof Blob||o instanceof ArrayBuffer?(l["Content-Type"]="application/octet-stream",u=o):typeof o=="string"?(l["Content-Type"]="text/plain",u=o):typeof FormData<"u"&&o instanceof FormData?u=o:(l["Content-Type"]="application/json",u=JSON.stringify(o)):u=o;const f=yield this.fetch(d.toString(),{method:i||"POST",headers:Object.assign(Object.assign(Object.assign({},l),this.headers),a),body:u,signal:c}).catch(_=>{throw _.name==="AbortError"?_:new Vh(_)}),p=f.headers.get("x-relay-error");if(p&&p==="true")throw new Wh(f);if(!f.ok)throw new qh(f);let g=((n=f.headers.get("Content-Type"))!==null&&n!==void 0?n:"text/plain").split(";")[0].trim(),m;return g==="application/json"?m=yield f.json():g==="application/octet-stream"||g==="application/pdf"?m=yield f.blob():g==="text/event-stream"?m=f:g==="multipart/form-data"?m=yield f.formData():m=yield f.text(),{data:m,error:null,response:f}}catch(a){return a instanceof Error&&a.name==="AbortError"?{data:null,error:new Vh(a)}:{data:null,error:a,response:a instanceof qh||a instanceof Wh?a.context:void 0}}})}}var gt={};const Qs=sm(Yb);var Oa={},Ba={},Da={},La={},Fa={},ja={},Xh;function zf(){if(Xh)return ja;Xh=1,Object.defineProperty(ja,"__esModule",{value:!0});class r extends Error{constructor(t){super(t.message),this.name="PostgrestError",this.details=t.details,this.hint=t.hint,this.code=t.code}}return ja.default=r,ja}var Yh;function Vf(){if(Yh)return Fa;Yh=1,Object.defineProperty(Fa,"__esModule",{value:!0});const e=Qs.__importDefault(zf());class t{constructor(n){var a,i;this.shouldThrowOnError=!1,this.method=n.method,this.url=n.url,this.headers=new Headers(n.headers),this.schema=n.schema,this.body=n.body,this.shouldThrowOnError=(a=n.shouldThrowOnError)!==null&&a!==void 0?a:!1,this.signal=n.signal,this.isMaybeSingle=(i=n.isMaybeSingle)!==null&&i!==void 0?i:!1,n.fetch?this.fetch=n.fetch:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(n,a){return this.headers=new Headers(this.headers),this.headers.set(n,a),this}then(n,a){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const i=this.fetch;let o=i(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async c=>{var l,h,d,u;let f=null,p=null,g=null,m=c.status,_=c.statusText;if(c.ok){if(this.method!=="HEAD"){const T=await c.text();T===""||(this.headers.get("Accept")==="text/csv"||this.headers.get("Accept")&&(!((l=this.headers.get("Accept"))===null||l===void 0)&&l.includes("application/vnd.pgrst.plan+text"))?p=T:p=JSON.parse(T))}const x=(h=this.headers.get("Prefer"))===null||h===void 0?void 0:h.match(/count=(exact|planned|estimated)/),S=(d=c.headers.get("content-range"))===null||d===void 0?void 0:d.split("/");x&&S&&S.length>1&&(g=parseInt(S[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(p)&&(p.length>1?(f={code:"PGRST116",details:`Results contain ${p.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},p=null,g=null,m=406,_="Not Acceptable"):p.length===1?p=p[0]:p=null)}else{const x=await c.text();try{f=JSON.parse(x),Array.isArray(f)&&c.status===404&&(p=[],f=null,m=200,_="OK")}catch{c.status===404&&x===""?(m=204,_="No Content"):f={message:x}}if(f&&this.isMaybeSingle&&(!((u=f==null?void 0:f.details)===null||u===void 0)&&u.includes("0 rows"))&&(f=null,m=200,_="OK"),f&&this.shouldThrowOnError)throw new e.default(f)}return{error:f,data:p,count:g,status:m,statusText:_}});return this.shouldThrowOnError||(o=o.catch(c=>{var l,h,d;return{error:{message:`${(l=c==null?void 0:c.name)!==null&&l!==void 0?l:"FetchError"}: ${c==null?void 0:c.message}`,details:`${(h=c==null?void 0:c.stack)!==null&&h!==void 0?h:""}`,hint:"",code:`${(d=c==null?void 0:c.code)!==null&&d!==void 0?d:""}`},data:null,count:null,status:0,statusText:""}})),o.then(n,a)}returns(){return this}overrideTypes(){return this}}return Fa.default=t,Fa}var Kh;function Wf(){if(Kh)return La;Kh=1,Object.defineProperty(La,"__esModule",{value:!0});const e=Qs.__importDefault(Vf());class t extends e.default{select(n){let a=!1;const i=(n??"*").split("").map(o=>/\s/.test(o)&&!a?"":(o==='"'&&(a=!a),o)).join("");return this.url.searchParams.set("select",i),this.headers.append("Prefer","return=representation"),this}order(n,{ascending:a=!0,nullsFirst:i,foreignTable:o,referencedTable:c=o}={}){const l=c?`${c}.order`:"order",h=this.url.searchParams.get(l);return this.url.searchParams.set(l,`${h?`${h},`:""}${n}.${a?"asc":"desc"}${i===void 0?"":i?".nullsfirst":".nullslast"}`),this}limit(n,{foreignTable:a,referencedTable:i=a}={}){const o=typeof i>"u"?"limit":`${i}.limit`;return this.url.searchParams.set(o,`${n}`),this}range(n,a,{foreignTable:i,referencedTable:o=i}={}){const c=typeof o>"u"?"offset":`${o}.offset`,l=typeof o>"u"?"limit":`${o}.limit`;return this.url.searchParams.set(c,`${n}`),this.url.searchParams.set(l,`${a-n+1}`),this}abortSignal(n){return this.signal=n,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:n=!1,verbose:a=!1,settings:i=!1,buffers:o=!1,wal:c=!1,format:l="text"}={}){var h;const d=[n?"analyze":null,a?"verbose":null,i?"settings":null,o?"buffers":null,c?"wal":null].filter(Boolean).join("|"),u=(h=this.headers.get("Accept"))!==null&&h!==void 0?h:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${l}; for="${u}"; options=${d};`),l==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(n){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${n}`),this}}return La.default=t,La}var Jh;function el(){if(Jh)return Da;Jh=1,Object.defineProperty(Da,"__esModule",{value:!0});const e=Qs.__importDefault(Wf()),t=new RegExp("[,()]");class s extends e.default{eq(a,i){return this.url.searchParams.append(a,`eq.${i}`),this}neq(a,i){return this.url.searchParams.append(a,`neq.${i}`),this}gt(a,i){return this.url.searchParams.append(a,`gt.${i}`),this}gte(a,i){return this.url.searchParams.append(a,`gte.${i}`),this}lt(a,i){return this.url.searchParams.append(a,`lt.${i}`),this}lte(a,i){return this.url.searchParams.append(a,`lte.${i}`),this}like(a,i){return this.url.searchParams.append(a,`like.${i}`),this}likeAllOf(a,i){return this.url.searchParams.append(a,`like(all).{${i.join(",")}}`),this}likeAnyOf(a,i){return this.url.searchParams.append(a,`like(any).{${i.join(",")}}`),this}ilike(a,i){return this.url.searchParams.append(a,`ilike.${i}`),this}ilikeAllOf(a,i){return this.url.searchParams.append(a,`ilike(all).{${i.join(",")}}`),this}ilikeAnyOf(a,i){return this.url.searchParams.append(a,`ilike(any).{${i.join(",")}}`),this}is(a,i){return this.url.searchParams.append(a,`is.${i}`),this}in(a,i){const o=Array.from(new Set(i)).map(c=>typeof c=="string"&&t.test(c)?`"${c}"`:`${c}`).join(",");return this.url.searchParams.append(a,`in.(${o})`),this}contains(a,i){return typeof i=="string"?this.url.searchParams.append(a,`cs.${i}`):Array.isArray(i)?this.url.searchParams.append(a,`cs.{${i.join(",")}}`):this.url.searchParams.append(a,`cs.${JSON.stringify(i)}`),this}containedBy(a,i){return typeof i=="string"?this.url.searchParams.append(a,`cd.${i}`):Array.isArray(i)?this.url.searchParams.append(a,`cd.{${i.join(",")}}`):this.url.searchParams.append(a,`cd.${JSON.stringify(i)}`),this}rangeGt(a,i){return this.url.searchParams.append(a,`sr.${i}`),this}rangeGte(a,i){return this.url.searchParams.append(a,`nxl.${i}`),this}rangeLt(a,i){return this.url.searchParams.append(a,`sl.${i}`),this}rangeLte(a,i){return this.url.searchParams.append(a,`nxr.${i}`),this}rangeAdjacent(a,i){return this.url.searchParams.append(a,`adj.${i}`),this}overlaps(a,i){return typeof i=="string"?this.url.searchParams.append(a,`ov.${i}`):this.url.searchParams.append(a,`ov.{${i.join(",")}}`),this}textSearch(a,i,{config:o,type:c}={}){let l="";c==="plain"?l="pl":c==="phrase"?l="ph":c==="websearch"&&(l="w");const h=o===void 0?"":`(${o})`;return this.url.searchParams.append(a,`${l}fts${h}.${i}`),this}match(a){return Object.entries(a).forEach(([i,o])=>{this.url.searchParams.append(i,`eq.${o}`)}),this}not(a,i,o){return this.url.searchParams.append(a,`not.${i}.${o}`),this}or(a,{foreignTable:i,referencedTable:o=i}={}){const c=o?`${o}.or`:"or";return this.url.searchParams.append(c,`(${a})`),this}filter(a,i,o){return this.url.searchParams.append(a,`${i}.${o}`),this}}return Da.default=s,Da}var Qh;function qf(){if(Qh)return Ba;Qh=1,Object.defineProperty(Ba,"__esModule",{value:!0});const e=Qs.__importDefault(el());class t{constructor(n,{headers:a={},schema:i,fetch:o}){this.url=n,this.headers=new Headers(a),this.schema=i,this.fetch=o}select(n,a){const{head:i=!1,count:o}=a??{},c=i?"HEAD":"GET";let l=!1;const h=(n??"*").split("").map(d=>/\s/.test(d)&&!l?"":(d==='"'&&(l=!l),d)).join("");return this.url.searchParams.set("select",h),o&&this.headers.append("Prefer",`count=${o}`),new e.default({method:c,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch})}insert(n,{count:a,defaultToNull:i=!0}={}){var o;const c="POST";if(a&&this.headers.append("Prefer",`count=${a}`),i||this.headers.append("Prefer","missing=default"),Array.isArray(n)){const l=n.reduce((h,d)=>h.concat(Object.keys(d)),[]);if(l.length>0){const h=[...new Set(l)].map(d=>`"${d}"`);this.url.searchParams.set("columns",h.join(","))}}return new e.default({method:c,url:this.url,headers:this.headers,schema:this.schema,body:n,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch})}upsert(n,{onConflict:a,ignoreDuplicates:i=!1,count:o,defaultToNull:c=!0}={}){var l;const h="POST";if(this.headers.append("Prefer",`resolution=${i?"ignore":"merge"}-duplicates`),a!==void 0&&this.url.searchParams.set("on_conflict",a),o&&this.headers.append("Prefer",`count=${o}`),c||this.headers.append("Prefer","missing=default"),Array.isArray(n)){const d=n.reduce((u,f)=>u.concat(Object.keys(f)),[]);if(d.length>0){const u=[...new Set(d)].map(f=>`"${f}"`);this.url.searchParams.set("columns",u.join(","))}}return new e.default({method:h,url:this.url,headers:this.headers,schema:this.schema,body:n,fetch:(l=this.fetch)!==null&&l!==void 0?l:fetch})}update(n,{count:a}={}){var i;const o="PATCH";return a&&this.headers.append("Prefer",`count=${a}`),new e.default({method:o,url:this.url,headers:this.headers,schema:this.schema,body:n,fetch:(i=this.fetch)!==null&&i!==void 0?i:fetch})}delete({count:n}={}){var a;const i="DELETE";return n&&this.headers.append("Prefer",`count=${n}`),new e.default({method:i,url:this.url,headers:this.headers,schema:this.schema,fetch:(a=this.fetch)!==null&&a!==void 0?a:fetch})}}return Ba.default=t,Ba}var Zh;function Qb(){if(Zh)return Oa;Zh=1,Object.defineProperty(Oa,"__esModule",{value:!0});const r=Qs,e=r.__importDefault(qf()),t=r.__importDefault(el());class s{constructor(a,{headers:i={},schema:o,fetch:c}={}){this.url=a,this.headers=new Headers(i),this.schemaName=o,this.fetch=c}from(a){const i=new URL(`${this.url}/${a}`);return new e.default(i,{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(a){return new s(this.url,{headers:this.headers,schema:a,fetch:this.fetch})}rpc(a,i={},{head:o=!1,get:c=!1,count:l}={}){var h;let d;const u=new URL(`${this.url}/rpc/${a}`);let f;o||c?(d=o?"HEAD":"GET",Object.entries(i).filter(([g,m])=>m!==void 0).map(([g,m])=>[g,Array.isArray(m)?`{${m.join(",")}}`:`${m}`]).forEach(([g,m])=>{u.searchParams.append(g,m)})):(d="POST",f=i);const p=new Headers(this.headers);return l&&p.set("Prefer",`count=${l}`),new t.default({method:d,url:u,headers:p,schema:this.schemaName,body:f,fetch:(h=this.fetch)!==null&&h!==void 0?h:fetch})}}return Oa.default=s,Oa}Object.defineProperty(gt,"__esModule",{value:!0});var Xf=gt.PostgrestError=np=gt.PostgrestBuilder=rp=gt.PostgrestTransformBuilder=ep=gt.PostgrestFilterBuilder=Qf=gt.PostgrestQueryBuilder=Kf=gt.PostgrestClient=void 0;const Zs=Qs,Yf=Zs.__importDefault(Qb());var Kf=gt.PostgrestClient=Yf.default;const Jf=Zs.__importDefault(qf());var Qf=gt.PostgrestQueryBuilder=Jf.default;const Zf=Zs.__importDefault(el());var ep=gt.PostgrestFilterBuilder=Zf.default;const tp=Zs.__importDefault(Wf());var rp=gt.PostgrestTransformBuilder=tp.default;const sp=Zs.__importDefault(Vf());var np=gt.PostgrestBuilder=sp.default;const ap=Zs.__importDefault(zf());Xf=gt.PostgrestError=ap.default;var ip=gt.default={PostgrestClient:Yf.default,PostgrestQueryBuilder:Jf.default,PostgrestFilterBuilder:Zf.default,PostgrestTransformBuilder:tp.default,PostgrestBuilder:sp.default,PostgrestError:ap.default};const Zb=Qp({__proto__:null,get PostgrestBuilder(){return np},get PostgrestClient(){return Kf},get PostgrestError(){return Xf},get PostgrestFilterBuilder(){return ep},get PostgrestQueryBuilder(){return Qf},get PostgrestTransformBuilder(){return rp},default:ip},[gt]),{PostgrestClient:ex,PostgrestQueryBuilder:uS,PostgrestFilterBuilder:fS,PostgrestTransformBuilder:pS,PostgrestBuilder:mS,PostgrestError:gS}=ip||Zb;class tx{static detectEnvironment(){var e;if(typeof WebSocket<"u")return{type:"native",constructor:WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocket<"u")return{type:"native",constructor:globalThis.WebSocket};if(typeof global<"u"&&typeof global.WebSocket<"u")return{type:"native",constructor:global.WebSocket};if(typeof globalThis<"u"&&typeof globalThis.WebSocketPair<"u"&&typeof globalThis.WebSocket>"u")return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if(typeof globalThis<"u"&&globalThis.EdgeRuntime||typeof navigator<"u"&&(!((e=navigator.userAgent)===null||e===void 0)&&e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};if(typeof process<"u"){const t=process.versions;if(t&&t.node){const s=t.node,n=parseInt(s.replace(/^v/,"").split(".")[0]);return n>=22?typeof globalThis.WebSocket<"u"?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${n} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${n} detected without native WebSocket support.`,workaround:`For Node.js < 22, install "ws" package and provide it via the transport option:
import ws from "ws"
new RealtimeClient(url, { transport: ws })`}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`

Suggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){const s=this.getWebSocketConstructor();return new s(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return e.type==="native"||e.type==="ws"}catch{return!1}}}const rx="2.80.0",sx=`realtime-js/${rx}`,nx="1.0.0",uc=1e4,ax=1e3,ix=100;var Bn;(function(r){r[r.connecting=0]="connecting",r[r.open=1]="open",r[r.closing=2]="closing",r[r.closed=3]="closed"})(Bn||(Bn={}));var Ye;(function(r){r.closed="closed",r.errored="errored",r.joined="joined",r.joining="joining",r.leaving="leaving"})(Ye||(Ye={}));var zt;(function(r){r.close="phx_close",r.error="phx_error",r.join="phx_join",r.reply="phx_reply",r.leave="phx_leave",r.access_token="access_token"})(zt||(zt={}));var fc;(function(r){r.websocket="websocket"})(fc||(fc={}));var rs;(function(r){r.Connecting="connecting",r.Open="open",r.Closing="closing",r.Closed="closed"})(rs||(rs={}));class ox{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),s=new TextDecoder;return this._decodeBroadcast(e,t,s)}_decodeBroadcast(e,t,s){const n=t.getUint8(1),a=t.getUint8(2);let i=this.HEADER_LENGTH+2;const o=s.decode(e.slice(i,i+n));i=i+n;const c=s.decode(e.slice(i,i+a));i=i+a;const l=JSON.parse(s.decode(e.slice(i,e.byteLength)));return{ref:null,topic:o,event:c,payload:l}}}class op{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}var Se;(function(r){r.abstime="abstime",r.bool="bool",r.date="date",r.daterange="daterange",r.float4="float4",r.float8="float8",r.int2="int2",r.int4="int4",r.int4range="int4range",r.int8="int8",r.int8range="int8range",r.json="json",r.jsonb="jsonb",r.money="money",r.numeric="numeric",r.oid="oid",r.reltime="reltime",r.text="text",r.time="time",r.timestamp="timestamp",r.timestamptz="timestamptz",r.timetz="timetz",r.tsrange="tsrange",r.tstzrange="tstzrange"})(Se||(Se={}));const ed=(r,e,t={})=>{var s;const n=(s=t.skipTypes)!==null&&s!==void 0?s:[];return e?Object.keys(e).reduce((a,i)=>(a[i]=cx(i,r,e,n),a),{}):{}},cx=(r,e,t,s)=>{const n=e.find(o=>o.name===r),a=n==null?void 0:n.type,i=t[r];return a&&!s.includes(a)?cp(a,i):pc(i)},cp=(r,e)=>{if(r.charAt(0)==="_"){const t=r.slice(1,r.length);return ux(e,t)}switch(r){case Se.bool:return lx(e);case Se.float4:case Se.float8:case Se.int2:case Se.int4:case Se.int8:case Se.numeric:case Se.oid:return hx(e);case Se.json:case Se.jsonb:return dx(e);case Se.timestamp:return fx(e);case Se.abstime:case Se.date:case Se.daterange:case Se.int4range:case Se.int8range:case Se.money:case Se.reltime:case Se.text:case Se.time:case Se.timestamptz:case Se.timetz:case Se.tsrange:case Se.tstzrange:return pc(e);default:return pc(e)}},pc=r=>r,lx=r=>{switch(r){case"t":return!0;case"f":return!1;default:return r}},hx=r=>{if(typeof r=="string"){const e=parseFloat(r);if(!Number.isNaN(e))return e}return r},dx=r=>{if(typeof r=="string")try{return JSON.parse(r)}catch(e){return console.log(`JSON parse error: ${e}`),r}return r},ux=(r,e)=>{if(typeof r!="string")return r;const t=r.length-1,s=r[t];if(r[0]==="{"&&s==="}"){let a;const i=r.slice(1,t);try{a=JSON.parse("["+i+"]")}catch{a=i?i.split(","):[]}return a.map(o=>cp(e,o))}return r},fx=r=>typeof r=="string"?r.replace(" ","T"):r,lp=r=>{const e=new URL(r);return e.protocol=e.protocol.replace(/^ws/i,"http"),e.pathname=e.pathname.replace(/\/+$/,"").replace(/\/socket\/websocket$/i,"").replace(/\/socket$/i,"").replace(/\/websocket$/i,""),e.pathname===""||e.pathname==="/"?e.pathname="/api/broadcast":e.pathname=e.pathname+"/api/broadcast",e.href};class Co{constructor(e,t,s={},n=uc){this.channel=e,this.event=t,this.payload=s,this.timeout=n,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var s;return this._hasReceived(e)&&t((s=this.receivedResp)===null||s===void 0?void 0:s.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(s=>s.status===e).forEach(s=>s.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var td;(function(r){r.SYNC="sync",r.JOIN="join",r.LEAVE="leave"})(td||(td={}));class Dn{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},n=>{const{onJoin:a,onLeave:i,onSync:o}=this.caller;this.joinRef=this.channel._joinRef(),this.state=Dn.syncState(this.state,n,a,i),this.pendingDiffs.forEach(c=>{this.state=Dn.syncDiff(this.state,c,a,i)}),this.pendingDiffs=[],o()}),this.channel._on(s.diff,{},n=>{const{onJoin:a,onLeave:i,onSync:o}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(n):(this.state=Dn.syncDiff(this.state,n,a,i),o())}),this.onJoin((n,a,i)=>{this.channel._trigger("presence",{event:"join",key:n,currentPresences:a,newPresences:i})}),this.onLeave((n,a,i)=>{this.channel._trigger("presence",{event:"leave",key:n,currentPresences:a,leftPresences:i})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,s,n){const a=this.cloneDeep(e),i=this.transformState(t),o={},c={};return this.map(a,(l,h)=>{i[l]||(c[l]=h)}),this.map(i,(l,h)=>{const d=a[l];if(d){const u=h.map(m=>m.presence_ref),f=d.map(m=>m.presence_ref),p=h.filter(m=>f.indexOf(m.presence_ref)<0),g=d.filter(m=>u.indexOf(m.presence_ref)<0);p.length>0&&(o[l]=p),g.length>0&&(c[l]=g)}else o[l]=h}),this.syncDiff(a,{joins:o,leaves:c},s,n)}static syncDiff(e,t,s,n){const{joins:a,leaves:i}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return s||(s=()=>{}),n||(n=()=>{}),this.map(a,(o,c)=>{var l;const h=(l=e[o])!==null&&l!==void 0?l:[];if(e[o]=this.cloneDeep(c),h.length>0){const d=e[o].map(f=>f.presence_ref),u=h.filter(f=>d.indexOf(f.presence_ref)<0);e[o].unshift(...u)}s(o,h,c)}),this.map(i,(o,c)=>{let l=e[o];if(!l)return;const h=c.map(d=>d.presence_ref);l=l.filter(d=>h.indexOf(d.presence_ref)<0),e[o]=l,n(o,l,c),l.length===0&&delete e[o]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(s=>t(s,e[s]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,s)=>{const n=e[s];return"metas"in n?t[s]=n.metas.map(a=>(a.presence_ref=a.phx_ref,delete a.phx_ref,delete a.phx_ref_prev,a)):t[s]=n,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var rd;(function(r){r.ALL="*",r.INSERT="INSERT",r.UPDATE="UPDATE",r.DELETE="DELETE"})(rd||(rd={}));var Ln;(function(r){r.BROADCAST="broadcast",r.PRESENCE="presence",r.POSTGRES_CHANGES="postgres_changes",r.SYSTEM="system"})(Ln||(Ln={}));var pr;(function(r){r.SUBSCRIBED="SUBSCRIBED",r.TIMED_OUT="TIMED_OUT",r.CLOSED="CLOSED",r.CHANNEL_ERROR="CHANNEL_ERROR"})(pr||(pr={}));class tl{constructor(e,t={config:{}},s){var n,a;if(this.topic=e,this.params=t,this.socket=s,this.bindings={},this.state=Ye.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new Co(this,zt.join,this.params,this.timeout),this.rejoinTimer=new op(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=Ye.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(i=>i.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=Ye.closed,this.socket._remove(this)}),this._onError(i=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,i),this.state=Ye.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=Ye.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",i=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,i),this.state=Ye.errored,this.rejoinTimer.scheduleTimeout())}),this._on(zt.reply,{},(i,o)=>{this._trigger(this._replyEventName(o),i)}),this.presence=new Dn(this),this.broadcastEndpointURL=lp(this.socket.endPoint),this.private=this.params.config.private||!1,!this.private&&(!((a=(n=this.params.config)===null||n===void 0?void 0:n.broadcast)===null||a===void 0)&&a.replay))throw`tried to use replay on public channel '${this.topic}'. It must be a private channel.`}subscribe(e,t=this.timeout){var s,n,a;if(this.socket.isConnected()||this.socket.connect(),this.state==Ye.closed){const{config:{broadcast:i,presence:o,private:c}}=this.params,l=(n=(s=this.bindings.postgres_changes)===null||s===void 0?void 0:s.map(f=>f.filter))!==null&&n!==void 0?n:[],h=!!this.bindings[Ln.PRESENCE]&&this.bindings[Ln.PRESENCE].length>0||((a=this.params.config.presence)===null||a===void 0?void 0:a.enabled)===!0,d={},u={broadcast:i,presence:Object.assign(Object.assign({},o),{enabled:h}),postgres_changes:l,private:c};this.socket.accessTokenValue&&(d.access_token=this.socket.accessTokenValue),this._onError(f=>e==null?void 0:e(pr.CHANNEL_ERROR,f)),this._onClose(()=>e==null?void 0:e(pr.CLOSED)),this.updateJoinPayload(Object.assign({config:u},d)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",async({postgres_changes:f})=>{var p;if(this.socket.setAuth(),f===void 0){e==null||e(pr.SUBSCRIBED);return}else{const g=this.bindings.postgres_changes,m=(p=g==null?void 0:g.length)!==null&&p!==void 0?p:0,_=[];for(let b=0;b<m;b++){const x=g[b],{filter:{event:S,schema:T,table:A,filter:C}}=x,R=f&&f[b];if(R&&R.event===S&&R.schema===T&&R.table===A&&R.filter===C)_.push(Object.assign(Object.assign({},x),{id:R.id}));else{this.unsubscribe(),this.state=Ye.errored,e==null||e(pr.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=_,e&&e(pr.SUBSCRIBED);return}}).receive("error",f=>{this.state=Ye.errored,e==null||e(pr.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(f).join(", ")||"error")))}).receive("timeout",()=>{e==null||e(pr.TIMED_OUT)})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,s){return this.state===Ye.joined&&e===Ln.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(()=>this.subscribe())),this._on(e,t,s)}async httpSend(e,t,s={}){var n;const a=this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"";if(t==null)return Promise.reject("Payload is required for httpSend()");const i={method:"POST",headers:{Authorization:a,apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:e,payload:t,private:this.private}]})},o=await this._fetchWithTimeout(this.broadcastEndpointURL,i,(n=s.timeout)!==null&&n!==void 0?n:this.timeout);if(o.status===202)return{success:!0};let c=o.statusText;try{const l=await o.json();c=l.error||l.message||c}catch{}return Promise.reject(new Error(c))}async send(e,t={}){var s,n;if(!this._canPush()&&e.type==="broadcast"){console.warn("Realtime send() is automatically falling back to REST API. This behavior will be deprecated in the future. Please use httpSend() explicitly for REST delivery.");const{event:a,payload:i}=e,c={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:a,payload:i,private:this.private}]})};try{const l=await this._fetchWithTimeout(this.broadcastEndpointURL,c,(s=t.timeout)!==null&&s!==void 0?s:this.timeout);return await((n=l.body)===null||n===void 0?void 0:n.cancel()),l.ok?"ok":"error"}catch(l){return l.name==="AbortError"?"timed out":"error"}}else return new Promise(a=>{var i,o,c;const l=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((c=(o=(i=this.params)===null||i===void 0?void 0:i.config)===null||o===void 0?void 0:o.broadcast)===null||c===void 0)&&c.ack)&&a("ok"),l.receive("ok",()=>a("ok")),l.receive("error",()=>a("error")),l.receive("timeout",()=>a("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=Ye.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(zt.close,"leave",this._joinRef())};this.joinPush.destroy();let s=null;return new Promise(n=>{s=new Co(this,zt.leave,{},e),s.receive("ok",()=>{t(),n("ok")}).receive("timeout",()=>{t(),n("timed out")}).receive("error",()=>{n("error")}),s.send(),this._canPush()||s.trigger("ok",{})}).finally(()=>{s==null||s.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=Ye.closed,this.bindings={}}async _fetchWithTimeout(e,t,s){const n=new AbortController,a=setTimeout(()=>n.abort(),s),i=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:n.signal}));return clearTimeout(a),i}_push(e,t,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let n=new Co(this,e,t,s);return this._canPush()?n.send():this._addToPushBuffer(n),n}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>ix){const t=this.pushBuffer.shift();t&&(t.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${t.event}`,t.payload))}}_onMessage(e,t,s){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,s){var n,a;const i=e.toLocaleLowerCase(),{close:o,error:c,leave:l,join:h}=zt;if(s&&[o,c,l,h].indexOf(i)>=0&&s!==this._joinRef())return;let u=this._onMessage(i,t,s);if(t&&!u)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(i)?(n=this.bindings.postgres_changes)===null||n===void 0||n.filter(f=>{var p,g,m;return((p=f.filter)===null||p===void 0?void 0:p.event)==="*"||((m=(g=f.filter)===null||g===void 0?void 0:g.event)===null||m===void 0?void 0:m.toLocaleLowerCase())===i}).map(f=>f.callback(u,s)):(a=this.bindings[i])===null||a===void 0||a.filter(f=>{var p,g,m,_,b,x;if(["broadcast","presence","postgres_changes"].includes(i))if("id"in f){const S=f.id,T=(p=f.filter)===null||p===void 0?void 0:p.event;return S&&((g=t.ids)===null||g===void 0?void 0:g.includes(S))&&(T==="*"||(T==null?void 0:T.toLocaleLowerCase())===((m=t.data)===null||m===void 0?void 0:m.type.toLocaleLowerCase()))}else{const S=(b=(_=f==null?void 0:f.filter)===null||_===void 0?void 0:_.event)===null||b===void 0?void 0:b.toLocaleLowerCase();return S==="*"||S===((x=t==null?void 0:t.event)===null||x===void 0?void 0:x.toLocaleLowerCase())}else return f.type.toLocaleLowerCase()===i}).map(f=>{if(typeof u=="object"&&"ids"in u){const p=u.data,{schema:g,table:m,commit_timestamp:_,type:b,errors:x}=p;u=Object.assign(Object.assign({},{schema:g,table:m,commit_timestamp:_,eventType:b,new:{},old:{},errors:x}),this._getPayloadRecords(p))}f.callback(u,s)})}_isClosed(){return this.state===Ye.closed}_isJoined(){return this.state===Ye.joined}_isJoining(){return this.state===Ye.joining}_isLeaving(){return this.state===Ye.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,s){const n=e.toLocaleLowerCase(),a={type:n,filter:t,callback:s};return this.bindings[n]?this.bindings[n].push(a):this.bindings[n]=[a],this}_off(e,t){const s=e.toLocaleLowerCase();return this.bindings[s]&&(this.bindings[s]=this.bindings[s].filter(n=>{var a;return!(((a=n.type)===null||a===void 0?void 0:a.toLocaleLowerCase())===s&&tl.isEqual(n.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(zt.close,{},e)}_onError(e){this._on(zt.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=Ye.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=ed(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=ed(e.columns,e.old_record)),t}}const Eo=()=>{},Na={HEARTBEAT_INTERVAL:25e3,RECONNECT_DELAY:10,HEARTBEAT_TIMEOUT_FALLBACK:100},px=[1e3,2e3,5e3,1e4],mx=1e4,gx=`
  addEventListener("message", (e) => {
    if (e.data.event === "start") {
      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);
    }
  });`;class yx{constructor(e,t){var s;if(this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=uc,this.transport=null,this.heartbeatIntervalMs=Na.HEARTBEAT_INTERVAL,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=Eo,this.ref=0,this.reconnectTimer=null,this.logger=Eo,this.conn=null,this.sendBuffer=[],this.serializer=new ox,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._resolveFetch=n=>n?(...a)=>n(...a):(...a)=>fetch(...a),!(!((s=t==null?void 0:t.params)===null||s===void 0)&&s.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${fc.websocket}`,this.httpEndpoint=lp(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(t==null?void 0:t.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||this.conn!==null&&this.isConnected())){if(this._setConnectionState("connecting"),this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=tx.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;throw t.includes("Node.js")?new Error(`${t}

To use Realtime in Node.js, you need to provide a WebSocket implementation:

Option 1: Use Node.js 22+ which has native WebSocket support
Option 2: Install and provide the "ws" package:

  npm install ws

  import ws from "ws"
  const client = new RealtimeClient(url, {
    ...options,
    transport: ws
  })`):new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:nx}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const s=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(s),this._setConnectionState("disconnected")},e?this.conn.close(e,t??""):this.conn.close(),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.channels=[],this.disconnect(),e}log(e,t,s){this.logger(e,t,s)}connectionState(){switch(this.conn&&this.conn.readyState){case Bn.connecting:return rs.Connecting;case Bn.open:return rs.Open;case Bn.closing:return rs.Closing;default:return rs.Closed}}isConnected(){return this.connectionState()===rs.Open}isConnecting(){return this._connectionState==="connecting"}isDisconnecting(){return this._connectionState==="disconnecting"}channel(e,t={config:{}}){const s=`realtime:${e}`,n=this.getChannels().find(a=>a.topic===s);if(n)return n;{const a=new tl(`realtime:${e}`,t,this);return this.channels.push(a),a}}push(e){const{topic:t,event:s,payload:n,ref:a}=e,i=()=>{this.encode(e,o=>{var c;(c=this.conn)===null||c===void 0||c.send(o)})};this.log("push",`${t} ${s} (${a})`,n),this.isConnected()?i():this.sendBuffer.push(i)}async setAuth(e=null){this._authPromise=this._performAuth(e);try{await this._authPromise}finally{this._authPromise=null}}async sendHeartbeat(){var e;if(!this.isConnected()){try{this.heartbeatCallback("disconnected")}catch(t){this.log("error","error in heartbeat callback",t)}return}if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(t){this.log("error","error in heartbeat callback",t)}this._wasManualDisconnect=!1,(e=this.conn)===null||e===void 0||e.close(ax,"heartbeat timeout"),setTimeout(()=>{var t;this.isConnected()||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout()},Na.HEARTBEAT_TIMEOUT_FALLBACK);return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(t){this.log("error","error in heartbeat callback",t)}this._setAuthSafely("heartbeat")}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(s=>s.topic===e&&(s._isJoined()||s._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,t=>{if(t.topic==="phoenix"&&t.event==="phx_reply")try{this.heartbeatCallback(t.payload.status==="ok"?"ok":"error")}catch(l){this.log("error","error in heartbeat callback",l)}t.ref&&t.ref===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null);const{topic:s,event:n,payload:a,ref:i}=t,o=i?`(${i})`:"",c=a.status||"";this.log("receive",`${c} ${s} ${n} ${o}`.trim(),a),this.channels.filter(l=>l._isMember(s)).forEach(l=>l._trigger(n,a,i)),this._triggerStateCallbacks("message",t)})}_clearTimer(e){var t;e==="heartbeat"&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):e==="reconnect"&&((t=this.reconnectTimer)===null||t===void 0||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_teardownConnection(){this.conn&&(this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null),this._clearAllTimers(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=t=>{this.log("worker","worker error",t.message),this.workerRef.terminate()},this.workerRef.onmessage=t=>{t.data.event==="keepAlive"&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||(t=this.reconnectTimer)===null||t===void 0||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(zt.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const s=e.match(/\?/)?"&":"?",n=new URLSearchParams(t);return`${e}${s}${n}`}_workerObjectUrl(e){let t;if(e)t=e;else{const s=new Blob([gx],{type:"application/javascript"});t=URL.createObjectURL(s)}return t}_setConnectionState(e,t=!1){this._connectionState=e,e==="connecting"?this._wasManualDisconnect=!1:e==="disconnecting"&&(this._wasManualDisconnect=t)}async _performAuth(e=null){let t;e?t=e:this.accessToken?t=await this.accessToken():t=this.accessTokenValue,this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(s=>{const n={access_token:t,version:sx};t&&s.updateJoinPayload(n),s.joinedOnce&&s._isJoined()&&s._push(zt.access_token,{access_token:t})}))}async _waitForAuthIfNeeded(){this._authPromise&&await this._authPromise}_setAuthSafely(e="general"){this.setAuth().catch(t=>{this.log("error",`error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(s=>{try{s(t)}catch(n){this.log("error",`error in ${e} callback`,n)}})}catch(s){this.log("error",`error triggering ${e} callbacks`,s)}}_setupReconnectionTimer(){this.reconnectTimer=new op(async()=>{setTimeout(async()=>{await this._waitForAuthIfNeeded(),this.isConnected()||this.connect()},Na.RECONNECT_DELAY)},this.reconnectAfterMs)}_initializeOptions(e){var t,s,n,a,i,o,c,l,h;if(this.transport=(t=e==null?void 0:e.transport)!==null&&t!==void 0?t:null,this.timeout=(s=e==null?void 0:e.timeout)!==null&&s!==void 0?s:uc,this.heartbeatIntervalMs=(n=e==null?void 0:e.heartbeatIntervalMs)!==null&&n!==void 0?n:Na.HEARTBEAT_INTERVAL,this.worker=(a=e==null?void 0:e.worker)!==null&&a!==void 0?a:!1,this.accessToken=(i=e==null?void 0:e.accessToken)!==null&&i!==void 0?i:null,this.heartbeatCallback=(o=e==null?void 0:e.heartbeatCallback)!==null&&o!==void 0?o:Eo,e!=null&&e.params&&(this.params=e.params),e!=null&&e.logger&&(this.logger=e.logger),(e!=null&&e.logLevel||e!=null&&e.log_level)&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=(c=e==null?void 0:e.reconnectAfterMs)!==null&&c!==void 0?c:d=>px[d-1]||mx,this.encode=(l=e==null?void 0:e.encode)!==null&&l!==void 0?l:(d,u)=>u(JSON.stringify(d)),this.decode=(h=e==null?void 0:e.decode)!==null&&h!==void 0?h:this.serializer.decode.bind(this.serializer),this.worker){if(typeof window<"u"&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=e==null?void 0:e.workerUrl}}}class rl extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function De(r){return typeof r=="object"&&r!==null&&"__isStorageError"in r}class _x extends rl{constructor(e,t,s){super(e),this.name="StorageApiError",this.status=t,this.statusCode=s}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class mc extends rl{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}const sl=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),bx=()=>Response,gc=r=>{if(Array.isArray(r))return r.map(t=>gc(t));if(typeof r=="function"||r!==Object(r))return r;const e={};return Object.entries(r).forEach(([t,s])=>{const n=t.replace(/([-_][a-z])/gi,a=>a.toUpperCase().replace(/[-_]/g,""));e[n]=gc(s)}),e},xx=r=>{if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)},To=r=>{var e;return r.msg||r.message||r.error_description||(typeof r.error=="string"?r.error:(e=r.error)===null||e===void 0?void 0:e.message)||JSON.stringify(r)},wx=(r,e,t)=>V(void 0,void 0,void 0,function*(){const s=yield bx();r instanceof s&&!(t!=null&&t.noResolveJson)?r.json().then(n=>{const a=r.status||500,i=(n==null?void 0:n.statusCode)||a+"";e(new _x(To(n),a,i))}).catch(n=>{e(new mc(To(n),n))}):e(new mc(To(r),r))}),vx=(r,e,t,s)=>{const n={method:r,headers:(e==null?void 0:e.headers)||{}};return r==="GET"||!s?n:(xx(s)?(n.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),n.body=JSON.stringify(s)):n.body=s,e!=null&&e.duplex&&(n.duplex=e.duplex),Object.assign(Object.assign({},n),t))};function Jn(r,e,t,s,n,a){return V(this,void 0,void 0,function*(){return new Promise((i,o)=>{r(t,vx(e,s,n,a)).then(c=>{if(!c.ok)throw c;return s!=null&&s.noResolveJson?c:c.json()}).then(c=>i(c)).catch(c=>wx(c,o,s))})})}function Wn(r,e,t,s){return V(this,void 0,void 0,function*(){return Jn(r,"GET",e,t,s)})}function Gt(r,e,t,s,n){return V(this,void 0,void 0,function*(){return Jn(r,"POST",e,s,n,t)})}function yc(r,e,t,s,n){return V(this,void 0,void 0,function*(){return Jn(r,"PUT",e,s,n,t)})}function Sx(r,e,t,s){return V(this,void 0,void 0,function*(){return Jn(r,"HEAD",e,Object.assign(Object.assign({},t),{noResolveJson:!0}),s)})}function nl(r,e,t,s,n){return V(this,void 0,void 0,function*(){return Jn(r,"DELETE",e,s,n,t)})}class kx{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t}then(e,t){return this.execute().then(e,t)}execute(){return V(this,void 0,void 0,function*(){try{return{data:(yield this.downloadFn()).body,error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(De(e))return{data:null,error:e};throw e}})}}var hp;class Ix{constructor(e,t){this.downloadFn=e,this.shouldThrowOnError=t,this[hp]="BlobDownloadBuilder",this.promise=null}asStream(){return new kx(this.downloadFn,this.shouldThrowOnError)}then(e,t){return this.getPromise().then(e,t)}catch(e){return this.getPromise().catch(e)}finally(e){return this.getPromise().finally(e)}getPromise(){return this.promise||(this.promise=this.execute()),this.promise}execute(){return V(this,void 0,void 0,function*(){try{return{data:yield(yield this.downloadFn()).blob(),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(De(e))return{data:null,error:e};throw e}})}}hp=Symbol.toStringTag;const Ax={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},sd={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class Cx{constructor(e,t={},s,n){this.shouldThrowOnError=!1,this.url=e,this.headers=t,this.bucketId=s,this.fetch=sl(n)}throwOnError(){return this.shouldThrowOnError=!0,this}uploadOrUpdate(e,t,s,n){return V(this,void 0,void 0,function*(){try{let a;const i=Object.assign(Object.assign({},sd),n);let o=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(i.upsert)});const c=i.metadata;typeof Blob<"u"&&s instanceof Blob?(a=new FormData,a.append("cacheControl",i.cacheControl),c&&a.append("metadata",this.encodeMetadata(c)),a.append("",s)):typeof FormData<"u"&&s instanceof FormData?(a=s,a.has("cacheControl")||a.append("cacheControl",i.cacheControl),c&&!a.has("metadata")&&a.append("metadata",this.encodeMetadata(c))):(a=s,o["cache-control"]=`max-age=${i.cacheControl}`,o["content-type"]=i.contentType,c&&(o["x-metadata"]=this.toBase64(this.encodeMetadata(c))),(typeof ReadableStream<"u"&&a instanceof ReadableStream||a&&typeof a=="object"&&"pipe"in a&&typeof a.pipe=="function")&&!i.duplex&&(i.duplex="half")),n!=null&&n.headers&&(o=Object.assign(Object.assign({},o),n.headers));const l=this._removeEmptyFolders(t),h=this._getFinalPath(l),d=yield(e=="PUT"?yc:Gt)(this.fetch,`${this.url}/object/${h}`,a,Object.assign({headers:o},i!=null&&i.duplex?{duplex:i.duplex}:{}));return{data:{path:l,id:d.Id,fullPath:d.Key},error:null}}catch(a){if(this.shouldThrowOnError)throw a;if(De(a))return{data:null,error:a};throw a}})}upload(e,t,s){return V(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,s)})}uploadToSignedUrl(e,t,s,n){return V(this,void 0,void 0,function*(){const a=this._removeEmptyFolders(e),i=this._getFinalPath(a),o=new URL(this.url+`/object/upload/sign/${i}`);o.searchParams.set("token",t);try{let c;const l=Object.assign({upsert:sd.upsert},n),h=Object.assign(Object.assign({},this.headers),{"x-upsert":String(l.upsert)});typeof Blob<"u"&&s instanceof Blob?(c=new FormData,c.append("cacheControl",l.cacheControl),c.append("",s)):typeof FormData<"u"&&s instanceof FormData?(c=s,c.append("cacheControl",l.cacheControl)):(c=s,h["cache-control"]=`max-age=${l.cacheControl}`,h["content-type"]=l.contentType);const d=yield yc(this.fetch,o.toString(),c,{headers:h});return{data:{path:a,fullPath:d.Key},error:null}}catch(c){if(this.shouldThrowOnError)throw c;if(De(c))return{data:null,error:c};throw c}})}createSignedUploadUrl(e,t){return V(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e);const n=Object.assign({},this.headers);t!=null&&t.upsert&&(n["x-upsert"]="true");const a=yield Gt(this.fetch,`${this.url}/object/upload/sign/${s}`,{},{headers:n}),i=new URL(this.url+a.url),o=i.searchParams.get("token");if(!o)throw new rl("No token returned by API");return{data:{signedUrl:i.toString(),path:e,token:o},error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(De(s))return{data:null,error:s};throw s}})}update(e,t,s){return V(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,s)})}move(e,t,s){return V(this,void 0,void 0,function*(){try{return{data:yield Gt(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:s==null?void 0:s.destinationBucket},{headers:this.headers}),error:null}}catch(n){if(this.shouldThrowOnError)throw n;if(De(n))return{data:null,error:n};throw n}})}copy(e,t,s){return V(this,void 0,void 0,function*(){try{return{data:{path:(yield Gt(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:s==null?void 0:s.destinationBucket},{headers:this.headers})).Key},error:null}}catch(n){if(this.shouldThrowOnError)throw n;if(De(n))return{data:null,error:n};throw n}})}createSignedUrl(e,t,s){return V(this,void 0,void 0,function*(){try{let n=this._getFinalPath(e),a=yield Gt(this.fetch,`${this.url}/object/sign/${n}`,Object.assign({expiresIn:t},s!=null&&s.transform?{transform:s.transform}:{}),{headers:this.headers});const i=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return a={signedUrl:encodeURI(`${this.url}${a.signedURL}${i}`)},{data:a,error:null}}catch(n){if(this.shouldThrowOnError)throw n;if(De(n))return{data:null,error:n};throw n}})}createSignedUrls(e,t,s){return V(this,void 0,void 0,function*(){try{const n=yield Gt(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),a=s!=null&&s.download?`&download=${s.download===!0?"":s.download}`:"";return{data:n.map(i=>Object.assign(Object.assign({},i),{signedUrl:i.signedURL?encodeURI(`${this.url}${i.signedURL}${a}`):null})),error:null}}catch(n){if(this.shouldThrowOnError)throw n;if(De(n))return{data:null,error:n};throw n}})}download(e,t){const n=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",a=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),i=a?`?${a}`:"",o=this._getFinalPath(e),c=()=>Wn(this.fetch,`${this.url}/${n}/${o}${i}`,{headers:this.headers,noResolveJson:!0});return new Ix(c,this.shouldThrowOnError)}info(e){return V(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const s=yield Wn(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:gc(s),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(De(s))return{data:null,error:s};throw s}})}exists(e){return V(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield Sx(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(De(s)&&s instanceof mc){const n=s.originalError;if([400,404].includes(n==null?void 0:n.status))return{data:!1,error:s}}throw s}})}getPublicUrl(e,t){const s=this._getFinalPath(e),n=[],a=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";a!==""&&n.push(a);const o=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",c=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});c!==""&&n.push(c);let l=n.join("&");return l!==""&&(l=`?${l}`),{data:{publicUrl:encodeURI(`${this.url}/${o}/public/${s}${l}`)}}}remove(e){return V(this,void 0,void 0,function*(){try{return{data:yield nl(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(De(t))return{data:null,error:t};throw t}})}list(e,t,s){return V(this,void 0,void 0,function*(){try{const n=Object.assign(Object.assign(Object.assign({},Ax),t),{prefix:e||""});return{data:yield Gt(this.fetch,`${this.url}/object/list/${this.bucketId}`,n,{headers:this.headers},s),error:null}}catch(n){if(this.shouldThrowOnError)throw n;if(De(n))return{data:null,error:n};throw n}})}listV2(e,t){return V(this,void 0,void 0,function*(){try{const s=Object.assign({},e);return{data:yield Gt(this.fetch,`${this.url}/object/list-v2/${this.bucketId}`,s,{headers:this.headers},t),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(De(s))return{data:null,error:s};throw s}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return typeof Buffer<"u"?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e.replace(/^\/+/,"")}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const dp="2.80.0",up={"X-Client-Info":`storage-js/${dp}`};class Ex{constructor(e,t={},s,n){this.shouldThrowOnError=!1;const a=new URL(e);n!=null&&n.useNewHostname&&/supabase\.(co|in|red)$/.test(a.hostname)&&!a.hostname.includes("storage.supabase.")&&(a.hostname=a.hostname.replace("supabase.","storage.supabase.")),this.url=a.href.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},up),t),this.fetch=sl(s)}throwOnError(){return this.shouldThrowOnError=!0,this}listBuckets(e){return V(this,void 0,void 0,function*(){try{const t=this.listBucketOptionsToQueryString(e);return{data:yield Wn(this.fetch,`${this.url}/bucket${t}`,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(De(t))return{data:null,error:t};throw t}})}getBucket(e){return V(this,void 0,void 0,function*(){try{return{data:yield Wn(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(De(t))return{data:null,error:t};throw t}})}createBucket(e){return V(this,arguments,void 0,function*(t,s={public:!1}){try{return{data:yield Gt(this.fetch,`${this.url}/bucket`,{id:t,name:t,type:s.type,public:s.public,file_size_limit:s.fileSizeLimit,allowed_mime_types:s.allowedMimeTypes},{headers:this.headers}),error:null}}catch(n){if(this.shouldThrowOnError)throw n;if(De(n))return{data:null,error:n};throw n}})}updateBucket(e,t){return V(this,void 0,void 0,function*(){try{return{data:yield yc(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(De(s))return{data:null,error:s};throw s}})}emptyBucket(e){return V(this,void 0,void 0,function*(){try{return{data:yield Gt(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(De(t))return{data:null,error:t};throw t}})}deleteBucket(e){return V(this,void 0,void 0,function*(){try{return{data:yield nl(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(De(t))return{data:null,error:t};throw t}})}listBucketOptionsToQueryString(e){const t={};return e&&("limit"in e&&(t.limit=String(e.limit)),"offset"in e&&(t.offset=String(e.offset)),e.search&&(t.search=e.search),e.sortColumn&&(t.sortColumn=e.sortColumn),e.sortOrder&&(t.sortOrder=e.sortOrder)),Object.keys(t).length>0?"?"+new URLSearchParams(t).toString():""}}class Tx{constructor(e,t={},s){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},up),t),this.fetch=sl(s)}throwOnError(){return this.shouldThrowOnError=!0,this}createBucket(e){return V(this,void 0,void 0,function*(){try{return{data:yield Gt(this.fetch,`${this.url}/bucket`,{name:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(De(t))return{data:null,error:t};throw t}})}listBuckets(e){return V(this,void 0,void 0,function*(){try{const t=new URLSearchParams;(e==null?void 0:e.limit)!==void 0&&t.set("limit",e.limit.toString()),(e==null?void 0:e.offset)!==void 0&&t.set("offset",e.offset.toString()),e!=null&&e.sortColumn&&t.set("sortColumn",e.sortColumn),e!=null&&e.sortOrder&&t.set("sortOrder",e.sortOrder),e!=null&&e.search&&t.set("search",e.search);const s=t.toString(),n=s?`${this.url}/bucket?${s}`:`${this.url}/bucket`;return{data:yield Wn(this.fetch,n,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(De(t))return{data:null,error:t};throw t}})}deleteBucket(e){return V(this,void 0,void 0,function*(){try{return{data:yield nl(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(De(t))return{data:null,error:t};throw t}})}}const al={"X-Client-Info":`storage-js/${dp}`,"Content-Type":"application/json"};class fp extends Error{constructor(e){super(e),this.__isStorageVectorsError=!0,this.name="StorageVectorsError"}}function At(r){return typeof r=="object"&&r!==null&&"__isStorageVectorsError"in r}class Po extends fp{constructor(e,t,s){super(e),this.name="StorageVectorsApiError",this.status=t,this.statusCode=s}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class Px extends fp{constructor(e,t){super(e),this.name="StorageVectorsUnknownError",this.originalError=t}}var nd;(function(r){r.InternalError="InternalError",r.S3VectorConflictException="S3VectorConflictException",r.S3VectorNotFoundException="S3VectorNotFoundException",r.S3VectorBucketNotEmpty="S3VectorBucketNotEmpty",r.S3VectorMaxBucketsExceeded="S3VectorMaxBucketsExceeded",r.S3VectorMaxIndexesExceeded="S3VectorMaxIndexesExceeded"})(nd||(nd={}));const il=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),Rx=r=>{if(typeof r!="object"||r===null)return!1;const e=Object.getPrototypeOf(r);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in r)&&!(Symbol.iterator in r)},ad=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),Mx=(r,e,t)=>V(void 0,void 0,void 0,function*(){if(r&&typeof r=="object"&&"status"in r&&"ok"in r&&typeof r.status=="number"&&!(t!=null&&t.noResolveJson)){const n=r.status||500,a=r;if(typeof a.json=="function")a.json().then(i=>{const o=(i==null?void 0:i.statusCode)||(i==null?void 0:i.code)||n+"";e(new Po(ad(i),n,o))}).catch(()=>{const i=n+"",o=a.statusText||`HTTP ${n} error`;e(new Po(o,n,i))});else{const i=n+"",o=a.statusText||`HTTP ${n} error`;e(new Po(o,n,i))}}else e(new Px(ad(r),r))}),$x=(r,e,t,s)=>{const n={method:r,headers:(e==null?void 0:e.headers)||{}};return s?(Rx(s)?(n.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),n.body=JSON.stringify(s)):n.body=s,Object.assign(Object.assign({},n),t)):n};function Ox(r,e,t,s,n,a){return V(this,void 0,void 0,function*(){return new Promise((i,o)=>{r(t,$x(e,s,n,a)).then(c=>{if(!c.ok)throw c;if(s!=null&&s.noResolveJson)return c;const l=c.headers.get("content-type");return!l||!l.includes("application/json")?{}:c.json()}).then(c=>i(c)).catch(c=>Mx(c,o,s))})})}function Ct(r,e,t,s,n){return V(this,void 0,void 0,function*(){return Ox(r,"POST",e,s,n,t)})}class Bx{constructor(e,t={},s){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},al),t),this.fetch=il(s)}throwOnError(){return this.shouldThrowOnError=!0,this}createIndex(e){return V(this,void 0,void 0,function*(){try{return{data:(yield Ct(this.fetch,`${this.url}/CreateIndex`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}getIndex(e,t){return V(this,void 0,void 0,function*(){try{return{data:yield Ct(this.fetch,`${this.url}/GetIndex`,{vectorBucketName:e,indexName:t},{headers:this.headers}),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(At(s))return{data:null,error:s};throw s}})}listIndexes(e){return V(this,void 0,void 0,function*(){try{return{data:yield Ct(this.fetch,`${this.url}/ListIndexes`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}deleteIndex(e,t){return V(this,void 0,void 0,function*(){try{return{data:(yield Ct(this.fetch,`${this.url}/DeleteIndex`,{vectorBucketName:e,indexName:t},{headers:this.headers}))||{},error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(At(s))return{data:null,error:s};throw s}})}}class Dx{constructor(e,t={},s){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},al),t),this.fetch=il(s)}throwOnError(){return this.shouldThrowOnError=!0,this}putVectors(e){return V(this,void 0,void 0,function*(){try{if(e.vectors.length<1||e.vectors.length>500)throw new Error("Vector batch size must be between 1 and 500 items");return{data:(yield Ct(this.fetch,`${this.url}/PutVectors`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}getVectors(e){return V(this,void 0,void 0,function*(){try{return{data:yield Ct(this.fetch,`${this.url}/GetVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}listVectors(e){return V(this,void 0,void 0,function*(){try{if(e.segmentCount!==void 0){if(e.segmentCount<1||e.segmentCount>16)throw new Error("segmentCount must be between 1 and 16");if(e.segmentIndex!==void 0&&(e.segmentIndex<0||e.segmentIndex>=e.segmentCount))throw new Error(`segmentIndex must be between 0 and ${e.segmentCount-1}`)}return{data:yield Ct(this.fetch,`${this.url}/ListVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}queryVectors(e){return V(this,void 0,void 0,function*(){try{return{data:yield Ct(this.fetch,`${this.url}/QueryVectors`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}deleteVectors(e){return V(this,void 0,void 0,function*(){try{if(e.keys.length<1||e.keys.length>500)throw new Error("Keys batch size must be between 1 and 500 items");return{data:(yield Ct(this.fetch,`${this.url}/DeleteVectors`,e,{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}}class Lx{constructor(e,t={},s){this.shouldThrowOnError=!1,this.url=e.replace(/\/$/,""),this.headers=Object.assign(Object.assign({},al),t),this.fetch=il(s)}throwOnError(){return this.shouldThrowOnError=!0,this}createBucket(e){return V(this,void 0,void 0,function*(){try{return{data:(yield Ct(this.fetch,`${this.url}/CreateVectorBucket`,{vectorBucketName:e},{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}getBucket(e){return V(this,void 0,void 0,function*(){try{return{data:yield Ct(this.fetch,`${this.url}/GetVectorBucket`,{vectorBucketName:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}listBuckets(){return V(this,arguments,void 0,function*(e={}){try{return{data:yield Ct(this.fetch,`${this.url}/ListVectorBuckets`,e,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}deleteBucket(e){return V(this,void 0,void 0,function*(){try{return{data:(yield Ct(this.fetch,`${this.url}/DeleteVectorBucket`,{vectorBucketName:e},{headers:this.headers}))||{},error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(At(t))return{data:null,error:t};throw t}})}}class Fx extends Lx{constructor(e,t={}){super(e,t.headers||{},t.fetch)}from(e){return new jx(this.url,this.headers,e,this.fetch)}}class jx extends Bx{constructor(e,t,s,n){super(e,t,n),this.vectorBucketName=s}createIndex(e){const t=Object.create(null,{createIndex:{get:()=>super.createIndex}});return V(this,void 0,void 0,function*(){return t.createIndex.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName}))})}listIndexes(){const e=Object.create(null,{listIndexes:{get:()=>super.listIndexes}});return V(this,arguments,void 0,function*(t={}){return e.listIndexes.call(this,Object.assign(Object.assign({},t),{vectorBucketName:this.vectorBucketName}))})}getIndex(e){const t=Object.create(null,{getIndex:{get:()=>super.getIndex}});return V(this,void 0,void 0,function*(){return t.getIndex.call(this,this.vectorBucketName,e)})}deleteIndex(e){const t=Object.create(null,{deleteIndex:{get:()=>super.deleteIndex}});return V(this,void 0,void 0,function*(){return t.deleteIndex.call(this,this.vectorBucketName,e)})}index(e){return new Nx(this.url,this.headers,this.vectorBucketName,e,this.fetch)}}class Nx extends Dx{constructor(e,t,s,n,a){super(e,t,a),this.vectorBucketName=s,this.indexName=n}putVectors(e){const t=Object.create(null,{putVectors:{get:()=>super.putVectors}});return V(this,void 0,void 0,function*(){return t.putVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}getVectors(e){const t=Object.create(null,{getVectors:{get:()=>super.getVectors}});return V(this,void 0,void 0,function*(){return t.getVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}listVectors(){const e=Object.create(null,{listVectors:{get:()=>super.listVectors}});return V(this,arguments,void 0,function*(t={}){return e.listVectors.call(this,Object.assign(Object.assign({},t),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}queryVectors(e){const t=Object.create(null,{queryVectors:{get:()=>super.queryVectors}});return V(this,void 0,void 0,function*(){return t.queryVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}deleteVectors(e){const t=Object.create(null,{deleteVectors:{get:()=>super.deleteVectors}});return V(this,void 0,void 0,function*(){return t.deleteVectors.call(this,Object.assign(Object.assign({},e),{vectorBucketName:this.vectorBucketName,indexName:this.indexName}))})}}class Hx extends Ex{constructor(e,t={},s,n){super(e,t,s,n)}from(e){return new Cx(this.url,this.headers,e,this.fetch)}get vectors(){return new Fx(this.url+"/vector",{headers:this.headers,fetch:this.fetch})}get analytics(){return new Tx(this.url+"/iceberg",this.headers,this.fetch)}}const Ux="2.80.0";let En="";typeof Deno<"u"?En="deno":typeof document<"u"?En="web":typeof navigator<"u"&&navigator.product==="ReactNative"?En="react-native":En="node";const Gx={"X-Client-Info":`supabase-js-${En}/${Ux}`},zx={headers:Gx},Vx={schema:"public"},Wx={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},qx={},Xx=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),Yx=()=>Headers,Kx=(r,e,t)=>{const s=Xx(t),n=Yx();return async(a,i)=>{var o;const c=(o=await e())!==null&&o!==void 0?o:r;let l=new n(i==null?void 0:i.headers);return l.has("apikey")||l.set("apikey",r),l.has("Authorization")||l.set("Authorization",`Bearer ${c}`),s(a,Object.assign(Object.assign({},i),{headers:l}))}};function Jx(r){return r.endsWith("/")?r:r+"/"}function Qx(r,e){var t,s;const{db:n,auth:a,realtime:i,global:o}=r,{db:c,auth:l,realtime:h,global:d}=e,u={db:Object.assign(Object.assign({},c),n),auth:Object.assign(Object.assign({},l),a),realtime:Object.assign(Object.assign({},h),i),storage:{},global:Object.assign(Object.assign(Object.assign({},d),o),{headers:Object.assign(Object.assign({},(t=d==null?void 0:d.headers)!==null&&t!==void 0?t:{}),(s=o==null?void 0:o.headers)!==null&&s!==void 0?s:{})}),accessToken:async()=>""};return r.accessToken?u.accessToken=r.accessToken:delete u.accessToken,u}function Zx(r){const e=r==null?void 0:r.trim();if(!e)throw new Error("supabaseUrl is required.");if(!e.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL(Jx(e))}catch{throw Error("Invalid supabaseUrl: Provided URL is malformed.")}}const pp="2.80.0",Rs=30*1e3,_c=3,Ro=_c*Rs,ew="http://localhost:9999",tw="supabase.auth.token",rw={"X-Client-Info":`gotrue-js/${pp}`},bc="X-Supabase-Api-Version",mp={"2024-01-01":{timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"}},sw=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i,nw=10*60*1e3;class qn extends Error{constructor(e,t,s){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=s}}function K(r){return typeof r=="object"&&r!==null&&"__isAuthError"in r}class aw extends qn{constructor(e,t,s){super(e,t,s),this.name="AuthApiError",this.status=t,this.code=s}}function iw(r){return K(r)&&r.name==="AuthApiError"}class ss extends qn{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class Nr extends qn{constructor(e,t,s,n){super(e,s,n),this.name=t,this.status=s}}class Ht extends Nr{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}function ow(r){return K(r)&&r.name==="AuthSessionMissingError"}class vs extends Nr{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class Ha extends Nr{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class Ua extends Nr{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}function cw(r){return K(r)&&r.name==="AuthImplicitGrantRedirectError"}class id extends Nr{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class xc extends Nr{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Mo(r){return K(r)&&r.name==="AuthRetryableFetchError"}class od extends Nr{constructor(e,t,s){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=s}}class wc extends Nr{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const vi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),cd=` 	
\r=`.split(""),lw=(()=>{const r=new Array(128);for(let e=0;e<r.length;e+=1)r[e]=-1;for(let e=0;e<cd.length;e+=1)r[cd[e].charCodeAt(0)]=-2;for(let e=0;e<vi.length;e+=1)r[vi[e].charCodeAt(0)]=e;return r})();function ld(r,e,t){if(r!==null)for(e.queue=e.queue<<8|r,e.queuedBits+=8;e.queuedBits>=6;){const s=e.queue>>e.queuedBits-6&63;t(vi[s]),e.queuedBits-=6}else if(e.queuedBits>0)for(e.queue=e.queue<<6-e.queuedBits,e.queuedBits=6;e.queuedBits>=6;){const s=e.queue>>e.queuedBits-6&63;t(vi[s]),e.queuedBits-=6}}function gp(r,e,t){const s=lw[r];if(s>-1)for(e.queue=e.queue<<6|s,e.queuedBits+=6;e.queuedBits>=8;)t(e.queue>>e.queuedBits-8&255),e.queuedBits-=8;else{if(s===-2)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(r)}"`)}}function hd(r){const e=[],t=i=>{e.push(String.fromCodePoint(i))},s={utf8seq:0,codepoint:0},n={queue:0,queuedBits:0},a=i=>{uw(i,s,t)};for(let i=0;i<r.length;i+=1)gp(r.charCodeAt(i),n,a);return e.join("")}function hw(r,e){if(r<=127){e(r);return}else if(r<=2047){e(192|r>>6),e(128|r&63);return}else if(r<=65535){e(224|r>>12),e(128|r>>6&63),e(128|r&63);return}else if(r<=1114111){e(240|r>>18),e(128|r>>12&63),e(128|r>>6&63),e(128|r&63);return}throw new Error(`Unrecognized Unicode codepoint: ${r.toString(16)}`)}function dw(r,e){for(let t=0;t<r.length;t+=1){let s=r.charCodeAt(t);if(s>55295&&s<=56319){const n=(s-55296)*1024&65535;s=(r.charCodeAt(t+1)-56320&65535|n)+65536,t+=1}hw(s,e)}}function uw(r,e,t){if(e.utf8seq===0){if(r<=127){t(r);return}for(let s=1;s<6;s+=1)if(!(r>>7-s&1)){e.utf8seq=s;break}if(e.utf8seq===2)e.codepoint=r&31;else if(e.utf8seq===3)e.codepoint=r&15;else if(e.utf8seq===4)e.codepoint=r&7;else throw new Error("Invalid UTF-8 sequence");e.utf8seq-=1}else if(e.utf8seq>0){if(r<=127)throw new Error("Invalid UTF-8 sequence");e.codepoint=e.codepoint<<6|r&63,e.utf8seq-=1,e.utf8seq===0&&t(e.codepoint)}}function js(r){const e=[],t={queue:0,queuedBits:0},s=n=>{e.push(n)};for(let n=0;n<r.length;n+=1)gp(r.charCodeAt(n),t,s);return new Uint8Array(e)}function fw(r){const e=[];return dw(r,t=>e.push(t)),new Uint8Array(e)}function as(r){const e=[],t={queue:0,queuedBits:0},s=n=>{e.push(n)};return r.forEach(n=>ld(n,t,s)),ld(null,t,s),e.join("")}function pw(r){return Math.round(Date.now()/1e3)+r}function mw(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(r){const e=Math.random()*16|0;return(r=="x"?e:e&3|8).toString(16)})}const dt=()=>typeof window<"u"&&typeof document<"u",Wr={tested:!1,writable:!1},yp=()=>{if(!dt())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(Wr.tested)return Wr.writable;const r=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(r,r),globalThis.localStorage.removeItem(r),Wr.tested=!0,Wr.writable=!0}catch{Wr.tested=!0,Wr.writable=!1}return Wr.writable};function gw(r){const e={},t=new URL(r);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((n,a)=>{e[a]=n})}catch{}return t.searchParams.forEach((s,n)=>{e[n]=s}),e}const _p=r=>r?(...e)=>r(...e):(...e)=>fetch(...e),yw=r=>typeof r=="object"&&r!==null&&"status"in r&&"ok"in r&&"json"in r&&typeof r.json=="function",Ms=async(r,e,t)=>{await r.setItem(e,JSON.stringify(t))},qr=async(r,e)=>{const t=await r.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},Pr=async(r,e)=>{await r.removeItem(e)};class Di{constructor(){this.promise=new Di.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}Di.promiseConstructor=Promise;function $o(r){const e=r.split(".");if(e.length!==3)throw new wc("Invalid JWT structure");for(let s=0;s<e.length;s++)if(!sw.test(e[s]))throw new wc("JWT not in base64url format");return{header:JSON.parse(hd(e[0])),payload:JSON.parse(hd(e[1])),signature:js(e[2]),raw:{header:e[0],payload:e[1]}}}async function _w(r){return await new Promise(e=>{setTimeout(()=>e(null),r)})}function bw(r,e){return new Promise((s,n)=>{(async()=>{for(let a=0;a<1/0;a++)try{const i=await r(a);if(!e(a,null,i)){s(i);return}}catch(i){if(!e(a,i)){n(i);return}}})()})}function xw(r){return("0"+r.toString(16)).substr(-2)}function ww(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",s=t.length;let n="";for(let a=0;a<56;a++)n+=t.charAt(Math.floor(Math.random()*s));return n}return crypto.getRandomValues(e),Array.from(e,xw).join("")}async function vw(r){const t=new TextEncoder().encode(r),s=await crypto.subtle.digest("SHA-256",t),n=new Uint8Array(s);return Array.from(n).map(a=>String.fromCharCode(a)).join("")}async function Sw(r){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),r;const t=await vw(r);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function Ss(r,e,t=!1){const s=ww();let n=s;t&&(n+="/PASSWORD_RECOVERY"),await Ms(r,`${e}-code-verifier`,n);const a=await Sw(s);return[a,s===a?"plain":"s256"]}const kw=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;function Iw(r){const e=r.headers.get(bc);if(!e||!e.match(kw))return null;try{return new Date(`${e}T00:00:00.0Z`)}catch{return null}}function Aw(r){if(!r)throw new Error("Missing exp claim");const e=Math.floor(Date.now()/1e3);if(r<=e)throw new Error("JWT has expired")}function Cw(r){switch(r){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}const Ew=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function ks(r){if(!Ew.test(r))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function Oo(){const r={};return new Proxy(r,{get:(e,t)=>{if(t==="__isUserNotAvailableProxy")return!0;if(typeof t=="symbol"){const s=t.toString();if(s==="Symbol(Symbol.toPrimitive)"||s==="Symbol(Symbol.toStringTag)"||s==="Symbol(util.inspect.custom)")return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function Tw(r,e){return new Proxy(r,{get:(t,s,n)=>{if(s==="__isInsecureUserWarningProxy")return!0;if(typeof s=="symbol"){const a=s.toString();if(a==="Symbol(Symbol.toPrimitive)"||a==="Symbol(Symbol.toStringTag)"||a==="Symbol(util.inspect.custom)"||a==="Symbol(nodejs.util.inspect.custom)")return Reflect.get(t,s,n)}return!e.value&&typeof s=="string"&&(console.warn("Using the user object as returned from supabase.auth.getSession() or from some supabase.auth.onAuthStateChange() events could be insecure! This value comes directly from the storage medium (usually cookies on the server) and may not be authentic. Use supabase.auth.getUser() instead which authenticates the data by contacting the Supabase Auth server."),e.value=!0),Reflect.get(t,s,n)}})}function dd(r){return JSON.parse(JSON.stringify(r))}const es=r=>r.msg||r.message||r.error_description||r.error||JSON.stringify(r),Pw=[502,503,504];async function ud(r){var e;if(!yw(r))throw new xc(es(r),0);if(Pw.includes(r.status))throw new xc(es(r),r.status);let t;try{t=await r.json()}catch(a){throw new ss(es(a),a)}let s;const n=Iw(r);if(n&&n.getTime()>=mp["2024-01-01"].timestamp&&typeof t=="object"&&t&&typeof t.code=="string"?s=t.code:typeof t=="object"&&t&&typeof t.error_code=="string"&&(s=t.error_code),s){if(s==="weak_password")throw new od(es(t),r.status,((e=t.weak_password)===null||e===void 0?void 0:e.reasons)||[]);if(s==="session_not_found")throw new Ht}else if(typeof t=="object"&&t&&typeof t.weak_password=="object"&&t.weak_password&&Array.isArray(t.weak_password.reasons)&&t.weak_password.reasons.length&&t.weak_password.reasons.reduce((a,i)=>a&&typeof i=="string",!0))throw new od(es(t),r.status,t.weak_password.reasons);throw new aw(es(t),r.status||500,s)}const Rw=(r,e,t,s)=>{const n={method:r,headers:(e==null?void 0:e.headers)||{}};return r==="GET"?n:(n.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),n.body=JSON.stringify(s),Object.assign(Object.assign({},n),t))};async function re(r,e,t,s){var n;const a=Object.assign({},s==null?void 0:s.headers);a[bc]||(a[bc]=mp["2024-01-01"].name),s!=null&&s.jwt&&(a.Authorization=`Bearer ${s.jwt}`);const i=(n=s==null?void 0:s.query)!==null&&n!==void 0?n:{};s!=null&&s.redirectTo&&(i.redirect_to=s.redirectTo);const o=Object.keys(i).length?"?"+new URLSearchParams(i).toString():"",c=await Mw(r,e,t+o,{headers:a,noResolveJson:s==null?void 0:s.noResolveJson},{},s==null?void 0:s.body);return s!=null&&s.xform?s==null?void 0:s.xform(c):{data:Object.assign({},c),error:null}}async function Mw(r,e,t,s,n,a){const i=Rw(e,s,n,a);let o;try{o=await r(t,Object.assign({},i))}catch(c){throw console.error(c),new xc(es(c),0)}if(o.ok||await ud(o),s!=null&&s.noResolveJson)return o;try{return await o.json()}catch(c){await ud(c)}}function Ut(r){var e;let t=null;Bw(r)&&(t=Object.assign({},r),r.expires_at||(t.expires_at=pw(r.expires_in)));const s=(e=r.user)!==null&&e!==void 0?e:r;return{data:{session:t,user:s},error:null}}function fd(r){const e=Ut(r);return!e.error&&r.weak_password&&typeof r.weak_password=="object"&&Array.isArray(r.weak_password.reasons)&&r.weak_password.reasons.length&&r.weak_password.message&&typeof r.weak_password.message=="string"&&r.weak_password.reasons.reduce((t,s)=>t&&typeof s=="string",!0)&&(e.data.weak_password=r.weak_password),e}function $r(r){var e;return{data:{user:(e=r.user)!==null&&e!==void 0?e:r},error:null}}function $w(r){return{data:r,error:null}}function Ow(r){const{action_link:e,email_otp:t,hashed_token:s,redirect_to:n,verification_type:a}=r,i=Js(r,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),o={action_link:e,email_otp:t,hashed_token:s,redirect_to:n,verification_type:a},c=Object.assign({},i);return{data:{properties:o,user:c},error:null}}function pd(r){return r}function Bw(r){return r.access_token&&r.refresh_token&&r.expires_in}const Bo=["global","local","others"];class Dw{constructor({url:e="",headers:t={},fetch:s}){this.url=e,this.headers=t,this.fetch=_p(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)},this.oauth={listClients:this._listOAuthClients.bind(this),createClient:this._createOAuthClient.bind(this),getClient:this._getOAuthClient.bind(this),updateClient:this._updateOAuthClient.bind(this),deleteClient:this._deleteOAuthClient.bind(this),regenerateClientSecret:this._regenerateOAuthClientSecret.bind(this)}}async signOut(e,t=Bo[0]){if(Bo.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${Bo.join(", ")}`);try{return await re(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(s){if(K(s))return{data:null,error:s};throw s}}async inviteUserByEmail(e,t={}){try{return await re(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:$r})}catch(s){if(K(s))return{data:{user:null},error:s};throw s}}async generateLink(e){try{const{options:t}=e,s=Js(e,["options"]),n=Object.assign(Object.assign({},s),t);return"newEmail"in s&&(n.new_email=s==null?void 0:s.newEmail,delete n.newEmail),await re(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:n,headers:this.headers,xform:Ow,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(K(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await re(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:$r})}catch(t){if(K(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,s,n,a,i,o,c;try{const l={nextPage:null,lastPage:0,total:0},h=await re(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&s!==void 0?s:"",per_page:(a=(n=e==null?void 0:e.perPage)===null||n===void 0?void 0:n.toString())!==null&&a!==void 0?a:""},xform:pd});if(h.error)throw h.error;const d=await h.json(),u=(i=h.headers.get("x-total-count"))!==null&&i!==void 0?i:0,f=(c=(o=h.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&c!==void 0?c:[];return f.length>0&&(f.forEach(p=>{const g=parseInt(p.split(";")[0].split("=")[1].substring(0,1)),m=JSON.parse(p.split(";")[1].split("=")[1]);l[`${m}Page`]=g}),l.total=parseInt(u)),{data:Object.assign(Object.assign({},d),l),error:null}}catch(l){if(K(l))return{data:{users:[]},error:l};throw l}}async getUserById(e){ks(e);try{return await re(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:$r})}catch(t){if(K(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){ks(e);try{return await re(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:$r})}catch(s){if(K(s))return{data:{user:null},error:s};throw s}}async deleteUser(e,t=!1){ks(e);try{return await re(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:$r})}catch(s){if(K(s))return{data:{user:null},error:s};throw s}}async _listFactors(e){ks(e.userId);try{const{data:t,error:s}=await re(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:n=>({data:{factors:n},error:null})});return{data:t,error:s}}catch(t){if(K(t))return{data:null,error:t};throw t}}async _deleteFactor(e){ks(e.userId),ks(e.id);try{return{data:await re(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(K(t))return{data:null,error:t};throw t}}async _listOAuthClients(e){var t,s,n,a,i,o,c;try{const l={nextPage:null,lastPage:0,total:0},h=await re(this.fetch,"GET",`${this.url}/admin/oauth/clients`,{headers:this.headers,noResolveJson:!0,query:{page:(s=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&s!==void 0?s:"",per_page:(a=(n=e==null?void 0:e.perPage)===null||n===void 0?void 0:n.toString())!==null&&a!==void 0?a:""},xform:pd});if(h.error)throw h.error;const d=await h.json(),u=(i=h.headers.get("x-total-count"))!==null&&i!==void 0?i:0,f=(c=(o=h.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&c!==void 0?c:[];return f.length>0&&(f.forEach(p=>{const g=parseInt(p.split(";")[0].split("=")[1].substring(0,1)),m=JSON.parse(p.split(";")[1].split("=")[1]);l[`${m}Page`]=g}),l.total=parseInt(u)),{data:Object.assign(Object.assign({},d),l),error:null}}catch(l){if(K(l))return{data:{clients:[]},error:l};throw l}}async _createOAuthClient(e){try{return await re(this.fetch,"POST",`${this.url}/admin/oauth/clients`,{body:e,headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(K(t))return{data:null,error:t};throw t}}async _getOAuthClient(e){try{return await re(this.fetch,"GET",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(K(t))return{data:null,error:t};throw t}}async _updateOAuthClient(e,t){try{return await re(this.fetch,"PUT",`${this.url}/admin/oauth/clients/${e}`,{body:t,headers:this.headers,xform:s=>({data:s,error:null})})}catch(s){if(K(s))return{data:null,error:s};throw s}}async _deleteOAuthClient(e){try{return await re(this.fetch,"DELETE",`${this.url}/admin/oauth/clients/${e}`,{headers:this.headers,noResolveJson:!0}),{data:null,error:null}}catch(t){if(K(t))return{data:null,error:t};throw t}}async _regenerateOAuthClientSecret(e){try{return await re(this.fetch,"POST",`${this.url}/admin/oauth/clients/${e}/regenerate_secret`,{headers:this.headers,xform:t=>({data:t,error:null})})}catch(t){if(K(t))return{data:null,error:t};throw t}}}function md(r={}){return{getItem:e=>r[e]||null,setItem:(e,t)=>{r[e]=t},removeItem:e=>{delete r[e]}}}const Is={debug:!!(globalThis&&yp()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class bp extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Lw extends bp{}async function Fw(r,e,t){Is.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",r,e);const s=new globalThis.AbortController;return e>0&&setTimeout(()=>{s.abort(),Is.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",r)},e),await Promise.resolve().then(()=>globalThis.navigator.locks.request(r,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:s.signal},async n=>{if(n){Is.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",r,n.name);try{return await t()}finally{Is.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",r,n.name)}}else{if(e===0)throw Is.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",r),new Lw(`Acquiring an exclusive Navigator LockManager lock "${r}" immediately failed`);if(Is.debug)try{const a=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(a,null,"  "))}catch(a){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",a)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}}))}function jw(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}function xp(r){if(!/^0x[a-fA-F0-9]{40}$/.test(r))throw new Error(`@supabase/auth-js: Address "${r}" is invalid.`);return r.toLowerCase()}function Nw(r){return parseInt(r,16)}function Hw(r){const e=new TextEncoder().encode(r);return"0x"+Array.from(e,s=>s.toString(16).padStart(2,"0")).join("")}function Uw(r){var e;const{chainId:t,domain:s,expirationTime:n,issuedAt:a=new Date,nonce:i,notBefore:o,requestId:c,resources:l,scheme:h,uri:d,version:u}=r;{if(!Number.isInteger(t))throw new Error(`@supabase/auth-js: Invalid SIWE message field "chainId". Chain ID must be a EIP-155 chain ID. Provided value: ${t}`);if(!s)throw new Error('@supabase/auth-js: Invalid SIWE message field "domain". Domain must be provided.');if(i&&i.length<8)throw new Error(`@supabase/auth-js: Invalid SIWE message field "nonce". Nonce must be at least 8 characters. Provided value: ${i}`);if(!d)throw new Error('@supabase/auth-js: Invalid SIWE message field "uri". URI must be provided.');if(u!=="1")throw new Error(`@supabase/auth-js: Invalid SIWE message field "version". Version must be '1'. Provided value: ${u}`);if(!((e=r.statement)===null||e===void 0)&&e.includes(`
`))throw new Error(`@supabase/auth-js: Invalid SIWE message field "statement". Statement must not include '\\n'. Provided value: ${r.statement}`)}const f=xp(r.address),p=h?`${h}://${s}`:s,g=r.statement?`${r.statement}
`:"",m=`${p} wants you to sign in with your Ethereum account:
${f}

${g}`;let _=`URI: ${d}
Version: ${u}
Chain ID: ${t}${i?`
Nonce: ${i}`:""}
Issued At: ${a.toISOString()}`;if(n&&(_+=`
Expiration Time: ${n.toISOString()}`),o&&(_+=`
Not Before: ${o.toISOString()}`),c&&(_+=`
Request ID: ${c}`),l){let b=`
Resources:`;for(const x of l){if(!x||typeof x!="string")throw new Error(`@supabase/auth-js: Invalid SIWE message field "resources". Every resource must be a valid string. Provided value: ${x}`);b+=`
- ${x}`}_+=b}return`${m}
${_}`}class We extends Error{constructor({message:e,code:t,cause:s,name:n}){var a;super(e,{cause:s}),this.__isWebAuthnError=!0,this.name=(a=n??(s instanceof Error?s.name:void 0))!==null&&a!==void 0?a:"Unknown Error",this.code=t}}class Si extends We{constructor(e,t){super({code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:t,message:e}),this.name="WebAuthnUnknownError",this.originalError=t}}function Gw({error:r,options:e}){var t,s,n;const{publicKey:a}=e;if(!a)throw Error("options was missing required publicKey property");if(r.name==="AbortError"){if(e.signal instanceof AbortSignal)return new We({message:"Registration ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:r})}else if(r.name==="ConstraintError"){if(((t=a.authenticatorSelection)===null||t===void 0?void 0:t.requireResidentKey)===!0)return new We({message:"Discoverable credentials were required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_DISCOVERABLE_CREDENTIAL_SUPPORT",cause:r});if(e.mediation==="conditional"&&((s=a.authenticatorSelection)===null||s===void 0?void 0:s.userVerification)==="required")return new We({message:"User verification was required during automatic registration but it could not be performed",code:"ERROR_AUTO_REGISTER_USER_VERIFICATION_FAILURE",cause:r});if(((n=a.authenticatorSelection)===null||n===void 0?void 0:n.userVerification)==="required")return new We({message:"User verification was required but no available authenticator supported it",code:"ERROR_AUTHENTICATOR_MISSING_USER_VERIFICATION_SUPPORT",cause:r})}else{if(r.name==="InvalidStateError")return new We({message:"The authenticator was previously registered",code:"ERROR_AUTHENTICATOR_PREVIOUSLY_REGISTERED",cause:r});if(r.name==="NotAllowedError")return new We({message:r.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r});if(r.name==="NotSupportedError")return a.pubKeyCredParams.filter(o=>o.type==="public-key").length===0?new We({message:'No entry in pubKeyCredParams was of type "public-key"',code:"ERROR_MALFORMED_PUBKEYCREDPARAMS",cause:r}):new We({message:"No available authenticator supported any of the specified pubKeyCredParams algorithms",code:"ERROR_AUTHENTICATOR_NO_SUPPORTED_PUBKEYCREDPARAMS_ALG",cause:r});if(r.name==="SecurityError"){const i=window.location.hostname;if(wp(i)){if(a.rp.id!==i)return new We({message:`The RP ID "${a.rp.id}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:r})}else return new We({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:r})}else if(r.name==="TypeError"){if(a.user.id.byteLength<1||a.user.id.byteLength>64)return new We({message:"User ID was not between 1 and 64 characters",code:"ERROR_INVALID_USER_ID_LENGTH",cause:r})}else if(r.name==="UnknownError")return new We({message:"The authenticator was unable to process the specified options, or could not create a new credential",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:r})}return new We({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r})}function zw({error:r,options:e}){const{publicKey:t}=e;if(!t)throw Error("options was missing required publicKey property");if(r.name==="AbortError"){if(e.signal instanceof AbortSignal)return new We({message:"Authentication ceremony was sent an abort signal",code:"ERROR_CEREMONY_ABORTED",cause:r})}else{if(r.name==="NotAllowedError")return new We({message:r.message,code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r});if(r.name==="SecurityError"){const s=window.location.hostname;if(wp(s)){if(t.rpId!==s)return new We({message:`The RP ID "${t.rpId}" is invalid for this domain`,code:"ERROR_INVALID_RP_ID",cause:r})}else return new We({message:`${window.location.hostname} is an invalid domain`,code:"ERROR_INVALID_DOMAIN",cause:r})}else if(r.name==="UnknownError")return new We({message:"The authenticator was unable to process the specified options, or could not create a new assertion signature",code:"ERROR_AUTHENTICATOR_GENERAL_ERROR",cause:r})}return new We({message:"a Non-Webauthn related error has occurred",code:"ERROR_PASSTHROUGH_SEE_CAUSE_PROPERTY",cause:r})}class Vw{createNewAbortSignal(){if(this.controller){const t=new Error("Cancelling existing WebAuthn API call for new one");t.name="AbortError",this.controller.abort(t)}const e=new AbortController;return this.controller=e,e.signal}cancelCeremony(){if(this.controller){const e=new Error("Manually cancelling existing WebAuthn API call");e.name="AbortError",this.controller.abort(e),this.controller=void 0}}}const Ww=new Vw;function qw(r){if(!r)throw new Error("Credential creation options are required");if(typeof PublicKeyCredential<"u"&&"parseCreationOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseCreationOptionsFromJSON=="function")return PublicKeyCredential.parseCreationOptionsFromJSON(r);const{challenge:e,user:t,excludeCredentials:s}=r,n=Js(r,["challenge","user","excludeCredentials"]),a=js(e).buffer,i=Object.assign(Object.assign({},t),{id:js(t.id).buffer}),o=Object.assign(Object.assign({},n),{challenge:a,user:i});if(s&&s.length>0){o.excludeCredentials=new Array(s.length);for(let c=0;c<s.length;c++){const l=s[c];o.excludeCredentials[c]=Object.assign(Object.assign({},l),{id:js(l.id).buffer,type:l.type||"public-key",transports:l.transports})}}return o}function Xw(r){if(!r)throw new Error("Credential request options are required");if(typeof PublicKeyCredential<"u"&&"parseRequestOptionsFromJSON"in PublicKeyCredential&&typeof PublicKeyCredential.parseRequestOptionsFromJSON=="function")return PublicKeyCredential.parseRequestOptionsFromJSON(r);const{challenge:e,allowCredentials:t}=r,s=Js(r,["challenge","allowCredentials"]),n=js(e).buffer,a=Object.assign(Object.assign({},s),{challenge:n});if(t&&t.length>0){a.allowCredentials=new Array(t.length);for(let i=0;i<t.length;i++){const o=t[i];a.allowCredentials[i]=Object.assign(Object.assign({},o),{id:js(o.id).buffer,type:o.type||"public-key",transports:o.transports})}}return a}function Yw(r){var e;if("toJSON"in r&&typeof r.toJSON=="function")return r.toJSON();const t=r;return{id:r.id,rawId:r.id,response:{attestationObject:as(new Uint8Array(r.response.attestationObject)),clientDataJSON:as(new Uint8Array(r.response.clientDataJSON))},type:"public-key",clientExtensionResults:r.getClientExtensionResults(),authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function Kw(r){var e;if("toJSON"in r&&typeof r.toJSON=="function")return r.toJSON();const t=r,s=r.getClientExtensionResults(),n=r.response;return{id:r.id,rawId:r.id,response:{authenticatorData:as(new Uint8Array(n.authenticatorData)),clientDataJSON:as(new Uint8Array(n.clientDataJSON)),signature:as(new Uint8Array(n.signature)),userHandle:n.userHandle?as(new Uint8Array(n.userHandle)):void 0},type:"public-key",clientExtensionResults:s,authenticatorAttachment:(e=t.authenticatorAttachment)!==null&&e!==void 0?e:void 0}}function wp(r){return r==="localhost"||/^([a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}$/i.test(r)}function gd(){var r,e;return!!(dt()&&"PublicKeyCredential"in window&&window.PublicKeyCredential&&"credentials"in navigator&&typeof((r=navigator==null?void 0:navigator.credentials)===null||r===void 0?void 0:r.create)=="function"&&typeof((e=navigator==null?void 0:navigator.credentials)===null||e===void 0?void 0:e.get)=="function")}async function Jw(r){try{const e=await navigator.credentials.create(r);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Si("Browser returned unexpected credential type",e)}:{data:null,error:new Si("Empty credential response",e)}}catch(e){return{data:null,error:Gw({error:e,options:r})}}}async function Qw(r){try{const e=await navigator.credentials.get(r);return e?e instanceof PublicKeyCredential?{data:e,error:null}:{data:null,error:new Si("Browser returned unexpected credential type",e)}:{data:null,error:new Si("Empty credential response",e)}}catch(e){return{data:null,error:zw({error:e,options:r})}}}const Zw={hints:["security-key"],authenticatorSelection:{authenticatorAttachment:"cross-platform",requireResidentKey:!1,userVerification:"preferred",residentKey:"discouraged"},attestation:"none"},ev={userVerification:"preferred",hints:["security-key"]};function ki(...r){const e=n=>n!==null&&typeof n=="object"&&!Array.isArray(n),t=n=>n instanceof ArrayBuffer||ArrayBuffer.isView(n),s={};for(const n of r)if(n)for(const a in n){const i=n[a];if(i!==void 0)if(Array.isArray(i))s[a]=i;else if(t(i))s[a]=i;else if(e(i)){const o=s[a];e(o)?s[a]=ki(o,i):s[a]=ki(i)}else s[a]=i}return s}function tv(r,e){return ki(Zw,r,e||{})}function rv(r,e){return ki(ev,r,e||{})}class sv{constructor(e){this.client=e,this.enroll=this._enroll.bind(this),this.challenge=this._challenge.bind(this),this.verify=this._verify.bind(this),this.authenticate=this._authenticate.bind(this),this.register=this._register.bind(this)}async _enroll(e){return this.client.mfa.enroll(Object.assign(Object.assign({},e),{factorType:"webauthn"}))}async _challenge({factorId:e,webauthn:t,friendlyName:s,signal:n},a){try{const{data:i,error:o}=await this.client.mfa.challenge({factorId:e,webauthn:t});if(!i)return{data:null,error:o};const c=n??Ww.createNewAbortSignal();if(i.webauthn.type==="create"){const{user:l}=i.webauthn.credential_options.publicKey;l.name||(l.name=`${l.id}:${s}`),l.displayName||(l.displayName=l.name)}switch(i.webauthn.type){case"create":{const l=tv(i.webauthn.credential_options.publicKey,a==null?void 0:a.create),{data:h,error:d}=await Jw({publicKey:l,signal:c});return h?{data:{factorId:e,challengeId:i.id,webauthn:{type:i.webauthn.type,credential_response:h}},error:null}:{data:null,error:d}}case"request":{const l=rv(i.webauthn.credential_options.publicKey,a==null?void 0:a.request),{data:h,error:d}=await Qw(Object.assign(Object.assign({},i.webauthn.credential_options),{publicKey:l,signal:c}));return h?{data:{factorId:e,challengeId:i.id,webauthn:{type:i.webauthn.type,credential_response:h}},error:null}:{data:null,error:d}}}}catch(i){return K(i)?{data:null,error:i}:{data:null,error:new ss("Unexpected error in challenge",i)}}}async _verify({challengeId:e,factorId:t,webauthn:s}){return this.client.mfa.verify({factorId:t,challengeId:e,webauthn:s})}async _authenticate({factorId:e,webauthn:{rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:n}},a){if(!t)return{data:null,error:new qn("rpId is required for WebAuthn authentication")};try{if(!gd())return{data:null,error:new ss("Browser does not support WebAuthn",null)};const{data:i,error:o}=await this.challenge({factorId:e,webauthn:{rpId:t,rpOrigins:s},signal:n},{request:a});if(!i)return{data:null,error:o};const{webauthn:c}=i;return this._verify({factorId:e,challengeId:i.challengeId,webauthn:{type:c.type,rpId:t,rpOrigins:s,credential_response:c.credential_response}})}catch(i){return K(i)?{data:null,error:i}:{data:null,error:new ss("Unexpected error in authenticate",i)}}}async _register({friendlyName:e,rpId:t=typeof window<"u"?window.location.hostname:void 0,rpOrigins:s=typeof window<"u"?[window.location.origin]:void 0,signal:n},a){if(!t)return{data:null,error:new qn("rpId is required for WebAuthn registration")};try{if(!gd())return{data:null,error:new ss("Browser does not support WebAuthn",null)};const{data:i,error:o}=await this._enroll({friendlyName:e});if(!i)return await this.client.mfa.listFactors().then(h=>{var d;return(d=h.data)===null||d===void 0?void 0:d.all.find(u=>u.factor_type==="webauthn"&&u.friendly_name===e&&u.status!=="unverified")}).then(h=>h?this.client.mfa.unenroll({factorId:h==null?void 0:h.id}):void 0),{data:null,error:o};const{data:c,error:l}=await this._challenge({factorId:i.id,friendlyName:i.friendly_name,webauthn:{rpId:t,rpOrigins:s},signal:n},{create:a});return c?this._verify({factorId:i.id,challengeId:c.challengeId,webauthn:{rpId:t,rpOrigins:s,type:c.webauthn.type,credential_response:c.webauthn.credential_response}}):{data:null,error:l}}catch(i){return K(i)?{data:null,error:i}:{data:null,error:new ss("Unexpected error in register",i)}}}}jw();const nv={url:ew,storageKey:tw,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:rw,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1,throwOnError:!1};async function yd(r,e,t){return await t()}const As={};class Xn{get jwks(){var e,t;return(t=(e=As[this.storageKey])===null||e===void 0?void 0:e.jwks)!==null&&t!==void 0?t:{keys:[]}}set jwks(e){As[this.storageKey]=Object.assign(Object.assign({},As[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return(t=(e=As[this.storageKey])===null||e===void 0?void 0:e.cachedAt)!==null&&t!==void 0?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){As[this.storageKey]=Object.assign(Object.assign({},As[this.storageKey]),{cachedAt:e})}constructor(e){var t,s,n;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log;const a=Object.assign(Object.assign({},nv),e);if(this.storageKey=a.storageKey,this.instanceID=(t=Xn.nextInstanceID[this.storageKey])!==null&&t!==void 0?t:0,Xn.nextInstanceID[this.storageKey]=this.instanceID+1,this.logDebugMessages=!!a.debug,typeof a.debug=="function"&&(this.logger=a.debug),this.instanceID>0&&dt()){const i=`${this._logPrefix()} Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.`;console.warn(i),this.logDebugMessages&&console.trace(i)}if(this.persistSession=a.persistSession,this.autoRefreshToken=a.autoRefreshToken,this.admin=new Dw({url:a.url,headers:a.headers,fetch:a.fetch}),this.url=a.url,this.headers=a.headers,this.fetch=_p(a.fetch),this.lock=a.lock||yd,this.detectSessionInUrl=a.detectSessionInUrl,this.flowType=a.flowType,this.hasCustomAuthorizationHeader=a.hasCustomAuthorizationHeader,this.throwOnError=a.throwOnError,a.lock?this.lock=a.lock:dt()&&(!((s=globalThis==null?void 0:globalThis.navigator)===null||s===void 0)&&s.locks)?this.lock=Fw:this.lock=yd,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this),webauthn:new sv(this)},this.oauth={getAuthorizationDetails:this._getAuthorizationDetails.bind(this),approveAuthorization:this._approveAuthorization.bind(this),denyAuthorization:this._denyAuthorization.bind(this)},this.persistSession?(a.storage?this.storage=a.storage:yp()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=md(this.memoryStorage)),a.userStorage&&(this.userStorage=a.userStorage)):(this.memoryStorage={},this.storage=md(this.memoryStorage)),dt()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(i){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",i)}(n=this.broadcastChannel)===null||n===void 0||n.addEventListener("message",async i=>{this._debug("received broadcast notification from other tab or client",i),await this._notifyAllSubscribers(i.data.event,i.data.session,!1)})}this.initialize()}isThrowOnErrorEnabled(){return this.throwOnError}_returnResult(e){if(this.throwOnError&&e&&e.error)throw e.error;return e}_logPrefix(){return`GoTrueClient@${this.storageKey}:${this.instanceID} (${pp}) ${new Date().toISOString()}`}_debug(...e){return this.logDebugMessages&&this.logger(this._logPrefix(),...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){var e;try{let t={},s="none";if(dt()&&(t=gw(window.location.href),this._isImplicitGrantCallback(t)?s="implicit":await this._isPKCECallback(t)&&(s="pkce")),dt()&&this.detectSessionInUrl&&s!=="none"){const{data:n,error:a}=await this._getSessionFromURL(t,s);if(a){if(this._debug("#_initialize()","error detecting session from URL",a),cw(a)){const c=(e=a.details)===null||e===void 0?void 0:e.code;if(c==="identity_already_exists"||c==="identity_not_found"||c==="single_identity_not_deletable")return{error:a}}return await this._removeSession(),{error:a}}const{session:i,redirectType:o}=n;return this._debug("#_initialize()","detected session in URL",i,"redirect type",o),await this._saveSession(i),setTimeout(async()=>{o==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",i):await this._notifyAllSubscribers("SIGNED_IN",i)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(t){return K(t)?this._returnResult({error:t}):this._returnResult({error:new ss("Unexpected error during initialization",t)})}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signInAnonymously(e){var t,s,n;try{const a=await re(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:(s=(t=e==null?void 0:e.options)===null||t===void 0?void 0:t.data)!==null&&s!==void 0?s:{},gotrue_meta_security:{captcha_token:(n=e==null?void 0:e.options)===null||n===void 0?void 0:n.captchaToken}},xform:Ut}),{data:i,error:o}=a;if(o||!i)return this._returnResult({data:{user:null,session:null},error:o});const c=i.session,l=i.user;return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",c)),this._returnResult({data:{user:l,session:c},error:null})}catch(a){if(K(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async signUp(e){var t,s,n;try{let a;if("email"in e){const{email:h,password:d,options:u}=e;let f=null,p=null;this.flowType==="pkce"&&([f,p]=await Ss(this.storage,this.storageKey)),a=await re(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:u==null?void 0:u.emailRedirectTo,body:{email:h,password:d,data:(t=u==null?void 0:u.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken},code_challenge:f,code_challenge_method:p},xform:Ut})}else if("phone"in e){const{phone:h,password:d,options:u}=e;a=await re(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:h,password:d,data:(s=u==null?void 0:u.data)!==null&&s!==void 0?s:{},channel:(n=u==null?void 0:u.channel)!==null&&n!==void 0?n:"sms",gotrue_meta_security:{captcha_token:u==null?void 0:u.captchaToken}},xform:Ut})}else throw new Ha("You must provide either an email or phone number and a password");const{data:i,error:o}=a;if(o||!i)return this._returnResult({data:{user:null,session:null},error:o});const c=i.session,l=i.user;return i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",c)),this._returnResult({data:{user:l,session:c},error:null})}catch(a){if(K(a))return this._returnResult({data:{user:null,session:null},error:a});throw a}}async signInWithPassword(e){try{let t;if("email"in e){const{email:a,password:i,options:o}=e;t=await re(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:a,password:i,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:fd})}else if("phone"in e){const{phone:a,password:i,options:o}=e;t=await re(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:a,password:i,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:fd})}else throw new Ha("You must provide either an email or phone number and a password");const{data:s,error:n}=t;if(n)return this._returnResult({data:{user:null,session:null},error:n});if(!s||!s.session||!s.user){const a=new vs;return this._returnResult({data:{user:null,session:null},error:a})}return s.session&&(await this._saveSession(s.session),await this._notifyAllSubscribers("SIGNED_IN",s.session)),this._returnResult({data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:n})}catch(t){if(K(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOAuth(e){var t,s,n,a;return await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(s=e.options)===null||s===void 0?void 0:s.scopes,queryParams:(n=e.options)===null||n===void 0?void 0:n.queryParams,skipBrowserRedirect:(a=e.options)===null||a===void 0?void 0:a.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async signInWithWeb3(e){const{chain:t}=e;switch(t){case"ethereum":return await this.signInWithEthereum(e);case"solana":return await this.signInWithSolana(e);default:throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)}}async signInWithEthereum(e){var t,s,n,a,i,o,c,l,h,d,u;let f,p;if("message"in e)f=e.message,p=e.signature;else{const{chain:g,wallet:m,statement:_,options:b}=e;let x;if(dt())if(typeof m=="object")x=m;else{const $=window;if("ethereum"in $&&typeof $.ethereum=="object"&&"request"in $.ethereum&&typeof $.ethereum.request=="function")x=$.ethereum;else throw new Error("@supabase/auth-js: No compatible Ethereum wallet interface on the window object (window.ethereum) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'ethereum', wallet: resolvedUserWallet }) instead.")}else{if(typeof m!="object"||!(b!=null&&b.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");x=m}const S=new URL((t=b==null?void 0:b.url)!==null&&t!==void 0?t:window.location.href),T=await x.request({method:"eth_requestAccounts"}).then($=>$).catch(()=>{throw new Error("@supabase/auth-js: Wallet method eth_requestAccounts is missing or invalid")});if(!T||T.length===0)throw new Error("@supabase/auth-js: No accounts available. Please ensure the wallet is connected.");const A=xp(T[0]);let C=(s=b==null?void 0:b.signInWithEthereum)===null||s===void 0?void 0:s.chainId;if(!C){const $=await x.request({method:"eth_chainId"});C=Nw($)}const R={domain:S.host,address:A,statement:_,uri:S.href,version:"1",chainId:C,nonce:(n=b==null?void 0:b.signInWithEthereum)===null||n===void 0?void 0:n.nonce,issuedAt:(i=(a=b==null?void 0:b.signInWithEthereum)===null||a===void 0?void 0:a.issuedAt)!==null&&i!==void 0?i:new Date,expirationTime:(o=b==null?void 0:b.signInWithEthereum)===null||o===void 0?void 0:o.expirationTime,notBefore:(c=b==null?void 0:b.signInWithEthereum)===null||c===void 0?void 0:c.notBefore,requestId:(l=b==null?void 0:b.signInWithEthereum)===null||l===void 0?void 0:l.requestId,resources:(h=b==null?void 0:b.signInWithEthereum)===null||h===void 0?void 0:h.resources};f=Uw(R),p=await x.request({method:"personal_sign",params:[Hw(f),A]})}try{const{data:g,error:m}=await re(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"ethereum",message:f,signature:p},!((d=e.options)===null||d===void 0)&&d.captchaToken?{gotrue_meta_security:{captcha_token:(u=e.options)===null||u===void 0?void 0:u.captchaToken}}:null),xform:Ut});if(m)throw m;if(!g||!g.session||!g.user){const _=new vs;return this._returnResult({data:{user:null,session:null},error:_})}return g.session&&(await this._saveSession(g.session),await this._notifyAllSubscribers("SIGNED_IN",g.session)),this._returnResult({data:Object.assign({},g),error:m})}catch(g){if(K(g))return this._returnResult({data:{user:null,session:null},error:g});throw g}}async signInWithSolana(e){var t,s,n,a,i,o,c,l,h,d,u,f;let p,g;if("message"in e)p=e.message,g=e.signature;else{const{chain:m,wallet:_,statement:b,options:x}=e;let S;if(dt())if(typeof _=="object")S=_;else{const A=window;if("solana"in A&&typeof A.solana=="object"&&("signIn"in A.solana&&typeof A.solana.signIn=="function"||"signMessage"in A.solana&&typeof A.solana.signMessage=="function"))S=A.solana;else throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.")}else{if(typeof _!="object"||!(x!=null&&x.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");S=_}const T=new URL((t=x==null?void 0:x.url)!==null&&t!==void 0?t:window.location.href);if("signIn"in S&&S.signIn){const A=await S.signIn(Object.assign(Object.assign(Object.assign({issuedAt:new Date().toISOString()},x==null?void 0:x.signInWithSolana),{version:"1",domain:T.host,uri:T.href}),b?{statement:b}:null));let C;if(Array.isArray(A)&&A[0]&&typeof A[0]=="object")C=A[0];else if(A&&typeof A=="object"&&"signedMessage"in A&&"signature"in A)C=A;else throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");if("signedMessage"in C&&"signature"in C&&(typeof C.signedMessage=="string"||C.signedMessage instanceof Uint8Array)&&C.signature instanceof Uint8Array)p=typeof C.signedMessage=="string"?C.signedMessage:new TextDecoder().decode(C.signedMessage),g=C.signature;else throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields")}else{if(!("signMessage"in S)||typeof S.signMessage!="function"||!("publicKey"in S)||typeof S!="object"||!S.publicKey||!("toBase58"in S.publicKey)||typeof S.publicKey.toBase58!="function")throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");p=[`${T.host} wants you to sign in with your Solana account:`,S.publicKey.toBase58(),...b?["",b,""]:[""],"Version: 1",`URI: ${T.href}`,`Issued At: ${(n=(s=x==null?void 0:x.signInWithSolana)===null||s===void 0?void 0:s.issuedAt)!==null&&n!==void 0?n:new Date().toISOString()}`,...!((a=x==null?void 0:x.signInWithSolana)===null||a===void 0)&&a.notBefore?[`Not Before: ${x.signInWithSolana.notBefore}`]:[],...!((i=x==null?void 0:x.signInWithSolana)===null||i===void 0)&&i.expirationTime?[`Expiration Time: ${x.signInWithSolana.expirationTime}`]:[],...!((o=x==null?void 0:x.signInWithSolana)===null||o===void 0)&&o.chainId?[`Chain ID: ${x.signInWithSolana.chainId}`]:[],...!((c=x==null?void 0:x.signInWithSolana)===null||c===void 0)&&c.nonce?[`Nonce: ${x.signInWithSolana.nonce}`]:[],...!((l=x==null?void 0:x.signInWithSolana)===null||l===void 0)&&l.requestId?[`Request ID: ${x.signInWithSolana.requestId}`]:[],...!((d=(h=x==null?void 0:x.signInWithSolana)===null||h===void 0?void 0:h.resources)===null||d===void 0)&&d.length?["Resources",...x.signInWithSolana.resources.map(C=>`- ${C}`)]:[]].join(`
`);const A=await S.signMessage(new TextEncoder().encode(p),"utf8");if(!A||!(A instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");g=A}}try{const{data:m,error:_}=await re(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:p,signature:as(g)},!((u=e.options)===null||u===void 0)&&u.captchaToken?{gotrue_meta_security:{captcha_token:(f=e.options)===null||f===void 0?void 0:f.captchaToken}}:null),xform:Ut});if(_)throw _;if(!m||!m.session||!m.user){const b=new vs;return this._returnResult({data:{user:null,session:null},error:b})}return m.session&&(await this._saveSession(m.session),await this._notifyAllSubscribers("SIGNED_IN",m.session)),this._returnResult({data:Object.assign({},m),error:_})}catch(m){if(K(m))return this._returnResult({data:{user:null,session:null},error:m});throw m}}async _exchangeCodeForSession(e){const t=await qr(this.storage,`${this.storageKey}-code-verifier`),[s,n]=(t??"").split("/");try{const{data:a,error:i}=await re(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:s},xform:Ut});if(await Pr(this.storage,`${this.storageKey}-code-verifier`),i)throw i;if(!a||!a.session||!a.user){const o=new vs;return this._returnResult({data:{user:null,session:null,redirectType:null},error:o})}return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",a.session)),this._returnResult({data:Object.assign(Object.assign({},a),{redirectType:n??null}),error:i})}catch(a){if(K(a))return this._returnResult({data:{user:null,session:null,redirectType:null},error:a});throw a}}async signInWithIdToken(e){try{const{options:t,provider:s,token:n,access_token:a,nonce:i}=e,o=await re(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:n,access_token:a,nonce:i,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:Ut}),{data:c,error:l}=o;if(l)return this._returnResult({data:{user:null,session:null},error:l});if(!c||!c.session||!c.user){const h=new vs;return this._returnResult({data:{user:null,session:null},error:h})}return c.session&&(await this._saveSession(c.session),await this._notifyAllSubscribers("SIGNED_IN",c.session)),this._returnResult({data:c,error:l})}catch(t){if(K(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async signInWithOtp(e){var t,s,n,a,i;try{if("email"in e){const{email:o,options:c}=e;let l=null,h=null;this.flowType==="pkce"&&([l,h]=await Ss(this.storage,this.storageKey));const{error:d}=await re(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:o,data:(t=c==null?void 0:c.data)!==null&&t!==void 0?t:{},create_user:(s=c==null?void 0:c.shouldCreateUser)!==null&&s!==void 0?s:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},code_challenge:l,code_challenge_method:h},redirectTo:c==null?void 0:c.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:d})}if("phone"in e){const{phone:o,options:c}=e,{data:l,error:h}=await re(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:o,data:(n=c==null?void 0:c.data)!==null&&n!==void 0?n:{},create_user:(a=c==null?void 0:c.shouldCreateUser)!==null&&a!==void 0?a:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},channel:(i=c==null?void 0:c.channel)!==null&&i!==void 0?i:"sms"}});return this._returnResult({data:{user:null,session:null,messageId:l==null?void 0:l.message_id},error:h})}throw new Ha("You must provide either an email or phone number.")}catch(o){if(K(o))return this._returnResult({data:{user:null,session:null},error:o});throw o}}async verifyOtp(e){var t,s;try{let n,a;"options"in e&&(n=(t=e.options)===null||t===void 0?void 0:t.redirectTo,a=(s=e.options)===null||s===void 0?void 0:s.captchaToken);const{data:i,error:o}=await re(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:a}}),redirectTo:n,xform:Ut});if(o)throw o;if(!i)throw new Error("An error occurred on token verification.");const c=i.session,l=i.user;return c!=null&&c.access_token&&(await this._saveSession(c),await this._notifyAllSubscribers(e.type=="recovery"?"PASSWORD_RECOVERY":"SIGNED_IN",c)),this._returnResult({data:{user:l,session:c},error:null})}catch(n){if(K(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}}async signInWithSSO(e){var t,s,n;try{let a=null,i=null;this.flowType==="pkce"&&([a,i]=await Ss(this.storage,this.storageKey));const o=await re(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&s!==void 0?s:void 0}),!((n=e==null?void 0:e.options)===null||n===void 0)&&n.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:a,code_challenge_method:i}),headers:this.headers,xform:$w});return this._returnResult(o)}catch(a){if(K(a))return this._returnResult({data:null,error:a});throw a}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:s}=e;if(s)throw s;if(!t)throw new Ht;const{error:n}=await re(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return this._returnResult({data:{user:null,session:null},error:n})})}catch(e){if(K(e))return this._returnResult({data:{user:null,session:null},error:e});throw e}}async resend(e){try{const t=`${this.url}/resend`;if("email"in e){const{email:s,type:n,options:a}=e,{error:i}=await re(this.fetch,"POST",t,{headers:this.headers,body:{email:s,type:n,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}},redirectTo:a==null?void 0:a.emailRedirectTo});return this._returnResult({data:{user:null,session:null},error:i})}else if("phone"in e){const{phone:s,type:n,options:a}=e,{data:i,error:o}=await re(this.fetch,"POST",t,{headers:this.headers,body:{phone:s,type:n,gotrue_meta_security:{captcha_token:a==null?void 0:a.captchaToken}}});return this._returnResult({data:{user:null,session:null,messageId:i==null?void 0:i.message_id},error:o})}throw new Ha("You must provide either an email or phone number and a type")}catch(t){if(K(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async getSession(){return await this.initializePromise,await this._acquireLock(-1,async()=>this._useSession(async t=>t))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const s=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),n=(async()=>(await s,await t()))();return this.pendingInLock.push((async()=>{try{await n}catch{}})()),n}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const s=t();for(this.pendingInLock.push((async()=>{try{await s}catch{}})()),await s;this.pendingInLock.length;){const n=[...this.pendingInLock];await Promise.all(n),this.pendingInLock.splice(0,n.length)}return await s}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await qr(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const s=e.expires_at?e.expires_at*1e3-Date.now()<Ro:!1;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s){if(this.userStorage){const i=await qr(this.userStorage,this.storageKey+"-user");i!=null&&i.user?e.user=i.user:e.user=Oo()}if(this.storage.isServer&&e.user&&!e.user.__isUserNotAvailableProxy){const i={value:this.suppressGetSessionWarning};e.user=Tw(e.user,i),i.value&&(this.suppressGetSessionWarning=!0)}return{data:{session:e},error:null}}const{data:n,error:a}=await this._callRefreshToken(e.refresh_token);return a?this._returnResult({data:{session:null},error:a}):this._returnResult({data:{session:n},error:null})}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,await this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await re(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:$r}):await this._useSession(async t=>{var s,n,a;const{data:i,error:o}=t;if(o)throw o;return!(!((s=i.session)===null||s===void 0)&&s.access_token)&&!this.hasCustomAuthorizationHeader?{data:{user:null},error:new Ht}:await re(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(a=(n=i.session)===null||n===void 0?void 0:n.access_token)!==null&&a!==void 0?a:void 0,xform:$r})})}catch(t){if(K(t))return ow(t)&&(await this._removeSession(),await Pr(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({data:{user:null},error:t});throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async s=>{const{data:n,error:a}=s;if(a)throw a;if(!n.session)throw new Ht;const i=n.session;let o=null,c=null;this.flowType==="pkce"&&e.email!=null&&([o,c]=await Ss(this.storage,this.storageKey));const{data:l,error:h}=await re(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:o,code_challenge_method:c}),jwt:i.access_token,xform:$r});if(h)throw h;return i.user=l.user,await this._saveSession(i),await this._notifyAllSubscribers("USER_UPDATED",i),this._returnResult({data:{user:i.user},error:null})})}catch(s){if(K(s))return this._returnResult({data:{user:null},error:s});throw s}}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new Ht;const t=Date.now()/1e3;let s=t,n=!0,a=null;const{payload:i}=$o(e.access_token);if(i.exp&&(s=i.exp,n=s<=t),n){const{data:o,error:c}=await this._callRefreshToken(e.refresh_token);if(c)return this._returnResult({data:{user:null,session:null},error:c});if(!o)return{data:{user:null,session:null},error:null};a=o}else{const{data:o,error:c}=await this._getUser(e.access_token);if(c)throw c;a={access_token:e.access_token,refresh_token:e.refresh_token,user:o.user,token_type:"bearer",expires_in:s-t,expires_at:s},await this._saveSession(a),await this._notifyAllSubscribers("SIGNED_IN",a)}return this._returnResult({data:{user:a.user,session:a},error:null})}catch(t){if(K(t))return this._returnResult({data:{session:null,user:null},error:t});throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var s;if(!e){const{data:i,error:o}=t;if(o)throw o;e=(s=i.session)!==null&&s!==void 0?s:void 0}if(!(e!=null&&e.refresh_token))throw new Ht;const{data:n,error:a}=await this._callRefreshToken(e.refresh_token);return a?this._returnResult({data:{user:null,session:null},error:a}):n?this._returnResult({data:{user:n.user,session:n},error:null}):this._returnResult({data:{user:null,session:null},error:null})})}catch(t){if(K(t))return this._returnResult({data:{user:null,session:null},error:t});throw t}}async _getSessionFromURL(e,t){try{if(!dt())throw new Ua("No browser detected.");if(e.error||e.error_description||e.error_code)throw new Ua(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if(this.flowType==="pkce")throw new id("Not a valid PKCE flow url.");break;case"pkce":if(this.flowType==="implicit")throw new Ua("Not a valid implicit grant flow url.");break;default:}if(t==="pkce"){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new id("No code detected.");const{data:b,error:x}=await this._exchangeCodeForSession(e.code);if(x)throw x;const S=new URL(window.location.href);return S.searchParams.delete("code"),window.history.replaceState(window.history.state,"",S.toString()),{data:{session:b.session,redirectType:null},error:null}}const{provider_token:s,provider_refresh_token:n,access_token:a,refresh_token:i,expires_in:o,expires_at:c,token_type:l}=e;if(!a||!o||!i||!l)throw new Ua("No session defined in URL");const h=Math.round(Date.now()/1e3),d=parseInt(o);let u=h+d;c&&(u=parseInt(c));const f=u-h;f*1e3<=Rs&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${f}s, should have been closer to ${d}s`);const p=u-d;h-p>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",p,u,h):h-p<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clock for skew",p,u,h);const{data:g,error:m}=await this._getUser(a);if(m)throw m;const _={provider_token:s,provider_refresh_token:n,access_token:a,expires_in:d,expires_at:u,refresh_token:i,token_type:l,user:g.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),this._returnResult({data:{session:_,redirectType:e.type},error:null})}catch(s){if(K(s))return this._returnResult({data:{session:null,redirectType:null},error:s});throw s}}_isImplicitGrantCallback(e){return!!(e.access_token||e.error_description)}async _isPKCECallback(e){const t=await qr(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var s;const{data:n,error:a}=t;if(a)return this._returnResult({error:a});const i=(s=n.session)===null||s===void 0?void 0:s.access_token;if(i){const{error:o}=await this.admin.signOut(i,e);if(o&&!(iw(o)&&(o.status===404||o.status===401||o.status===403)))return this._returnResult({error:o})}return e!=="others"&&(await this._removeSession(),await Pr(this.storage,`${this.storageKey}-code-verifier`)),this._returnResult({error:null})})}onAuthStateChange(e){const t=mw(),s={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,s),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:s}}}async _emitInitialSession(e){return await this._useSession(async t=>{var s,n;try{const{data:{session:a},error:i}=t;if(i)throw i;await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",a)),this._debug("INITIAL_SESSION","callback id",e,"session",a)}catch(a){await((n=this.stateChangeEmitters.get(e))===null||n===void 0?void 0:n.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",a),console.error(a)}})}async resetPasswordForEmail(e,t={}){let s=null,n=null;this.flowType==="pkce"&&([s,n]=await Ss(this.storage,this.storageKey,!0));try{return await re(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:s,code_challenge_method:n,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(a){if(K(a))return this._returnResult({data:null,error:a});throw a}}async getUserIdentities(){var e;try{const{data:t,error:s}=await this.getUser();if(s)throw s;return this._returnResult({data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null})}catch(t){if(K(t))return this._returnResult({data:null,error:t});throw t}}async linkIdentity(e){return"token"in e?this.linkIdentityIdToken(e):this.linkIdentityOAuth(e)}async linkIdentityOAuth(e){var t;try{const{data:s,error:n}=await this._useSession(async a=>{var i,o,c,l,h;const{data:d,error:u}=a;if(u)throw u;const f=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(i=e.options)===null||i===void 0?void 0:i.redirectTo,scopes:(o=e.options)===null||o===void 0?void 0:o.scopes,queryParams:(c=e.options)===null||c===void 0?void 0:c.queryParams,skipBrowserRedirect:!0});return await re(this.fetch,"GET",f,{headers:this.headers,jwt:(h=(l=d.session)===null||l===void 0?void 0:l.access_token)!==null&&h!==void 0?h:void 0})});if(n)throw n;return dt()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(s==null?void 0:s.url),this._returnResult({data:{provider:e.provider,url:s==null?void 0:s.url},error:null})}catch(s){if(K(s))return this._returnResult({data:{provider:e.provider,url:null},error:s});throw s}}async linkIdentityIdToken(e){return await this._useSession(async t=>{var s;try{const{error:n,data:{session:a}}=t;if(n)throw n;const{options:i,provider:o,token:c,access_token:l,nonce:h}=e,d=await re(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,jwt:(s=a==null?void 0:a.access_token)!==null&&s!==void 0?s:void 0,body:{provider:o,id_token:c,access_token:l,nonce:h,link_identity:!0,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},xform:Ut}),{data:u,error:f}=d;return f?this._returnResult({data:{user:null,session:null},error:f}):!u||!u.session||!u.user?this._returnResult({data:{user:null,session:null},error:new vs}):(u.session&&(await this._saveSession(u.session),await this._notifyAllSubscribers("USER_UPDATED",u.session)),this._returnResult({data:u,error:f}))}catch(n){if(K(n))return this._returnResult({data:{user:null,session:null},error:n});throw n}})}async unlinkIdentity(e){try{return await this._useSession(async t=>{var s,n;const{data:a,error:i}=t;if(i)throw i;return await re(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(n=(s=a.session)===null||s===void 0?void 0:s.access_token)!==null&&n!==void 0?n:void 0})})}catch(t){if(K(t))return this._returnResult({data:null,error:t});throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const s=Date.now();return await bw(async n=>(n>0&&await _w(200*Math.pow(2,n-1)),this._debug(t,"refreshing attempt",n),await re(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:Ut})),(n,a)=>{const i=200*Math.pow(2,n);return a&&Mo(a)&&Date.now()+i-s<Rs})}catch(s){if(this._debug(t,"error",s),K(s))return this._returnResult({data:{session:null,user:null},error:s});throw s}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const s=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",s),dt()&&!t.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}}async _recoverAndRefresh(){var e,t;const s="#_recoverAndRefresh()";this._debug(s,"begin");try{const n=await qr(this.storage,this.storageKey);if(n&&this.userStorage){let i=await qr(this.userStorage,this.storageKey+"-user");!this.storage.isServer&&Object.is(this.storage,this.userStorage)&&!i&&(i={user:n.user},await Ms(this.userStorage,this.storageKey+"-user",i)),n.user=(e=i==null?void 0:i.user)!==null&&e!==void 0?e:Oo()}else if(n&&!n.user&&!n.user){const i=await qr(this.storage,this.storageKey+"-user");i&&(i!=null&&i.user)?(n.user=i.user,await Pr(this.storage,this.storageKey+"-user"),await Ms(this.storage,this.storageKey,n)):n.user=Oo()}if(this._debug(s,"session from storage",n),!this._isValidSession(n)){this._debug(s,"session is not valid"),n!==null&&await this._removeSession();return}const a=((t=n.expires_at)!==null&&t!==void 0?t:1/0)*1e3-Date.now()<Ro;if(this._debug(s,`session has${a?"":" not"} expired with margin of ${Ro}s`),a){if(this.autoRefreshToken&&n.refresh_token){const{error:i}=await this._callRefreshToken(n.refresh_token);i&&(console.error(i),Mo(i)||(this._debug(s,"refresh failed with a non-retryable error, removing the session",i),await this._removeSession()))}}else if(n.user&&n.user.__isUserNotAvailableProxy===!0)try{const{data:i,error:o}=await this._getUser(n.access_token);!o&&(i!=null&&i.user)?(n.user=i.user,await this._saveSession(n),await this._notifyAllSubscribers("SIGNED_IN",n)):this._debug(s,"could not get user data, skipping SIGNED_IN notification")}catch(i){console.error("Error getting user data:",i),this._debug(s,"error getting user data, skipping SIGNED_IN notification",i)}else await this._notifyAllSubscribers("SIGNED_IN",n)}catch(n){this._debug(s,"error",n),console.error(n);return}finally{this._debug(s,"end")}}async _callRefreshToken(e){var t,s;if(!e)throw new Ht;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const n=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(n,"begin");try{this.refreshingDeferred=new Di;const{data:a,error:i}=await this._refreshAccessToken(e);if(i)throw i;if(!a.session)throw new Ht;await this._saveSession(a.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",a.session);const o={data:a.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(a){if(this._debug(n,"error",a),K(a)){const i={data:null,error:a};return Mo(a)||await this._removeSession(),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(i),i}throw(s=this.refreshingDeferred)===null||s===void 0||s.reject(a),a}finally{this.refreshingDeferred=null,this._debug(n,"end")}}async _notifyAllSubscribers(e,t,s=!0){const n=`#_notifyAllSubscribers(${e})`;this._debug(n,"begin",t,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:t});const a=[],i=Array.from(this.stateChangeEmitters.values()).map(async o=>{try{await o.callback(e,t)}catch(c){a.push(c)}});if(await Promise.all(i),a.length>0){for(let o=0;o<a.length;o+=1)console.error(a[o]);throw a[0]}}finally{this._debug(n,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0;const t=Object.assign({},e),s=t.user&&t.user.__isUserNotAvailableProxy===!0;if(this.userStorage){!s&&t.user&&await Ms(this.userStorage,this.storageKey+"-user",{user:t.user});const n=Object.assign({},t);delete n.user;const a=dd(n);await Ms(this.storage,this.storageKey,a)}else{const n=dd(t);await Ms(this.storage,this.storageKey,n)}}async _removeSession(){this._debug("#_removeSession()"),await Pr(this.storage,this.storageKey),await Pr(this.storage,this.storageKey+"-code-verifier"),await Pr(this.storage,this.storageKey+"-user"),this.userStorage&&await Pr(this.userStorage,this.storageKey+"-user"),await this._notifyAllSubscribers("SIGNED_OUT",null)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&dt()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),Rs);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:s}}=t;if(!s||!s.refresh_token||!s.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const n=Math.floor((s.expires_at*1e3-e)/Rs);this._debug("#_autoRefreshTokenTick()",`access token expires in ${n} ticks, a tick lasts ${Rs}ms, refresh threshold is ${_c} ticks`),n<=_c&&await this._callRefreshToken(s.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof bp)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!dt()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,s){const n=[`provider=${encodeURIComponent(t)}`];if(s!=null&&s.redirectTo&&n.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),s!=null&&s.scopes&&n.push(`scopes=${encodeURIComponent(s.scopes)}`),this.flowType==="pkce"){const[a,i]=await Ss(this.storage,this.storageKey),o=new URLSearchParams({code_challenge:`${encodeURIComponent(a)}`,code_challenge_method:`${encodeURIComponent(i)}`});n.push(o.toString())}if(s!=null&&s.queryParams){const a=new URLSearchParams(s.queryParams);n.push(a.toString())}return s!=null&&s.skipBrowserRedirect&&n.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${e}?${n.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var s;const{data:n,error:a}=t;return a?this._returnResult({data:null,error:a}):await re(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token})})}catch(t){if(K(t))return this._returnResult({data:null,error:t});throw t}}async _enroll(e){try{return await this._useSession(async t=>{var s,n;const{data:a,error:i}=t;if(i)return this._returnResult({data:null,error:i});const o=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},e.factorType==="phone"?{phone:e.phone}:e.factorType==="totp"?{issuer:e.issuer}:{}),{data:c,error:l}=await re(this.fetch,"POST",`${this.url}/factors`,{body:o,headers:this.headers,jwt:(s=a==null?void 0:a.session)===null||s===void 0?void 0:s.access_token});return l?this._returnResult({data:null,error:l}):(e.factorType==="totp"&&c.type==="totp"&&(!((n=c==null?void 0:c.totp)===null||n===void 0)&&n.qr_code)&&(c.totp.qr_code=`data:image/svg+xml;utf-8,${c.totp.qr_code}`),this._returnResult({data:c,error:null}))})}catch(t){if(K(t))return this._returnResult({data:null,error:t});throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var s;const{data:n,error:a}=t;if(a)return this._returnResult({data:null,error:a});const i=Object.assign({challenge_id:e.challengeId},"webauthn"in e?{webauthn:Object.assign(Object.assign({},e.webauthn),{credential_response:e.webauthn.type==="create"?Yw(e.webauthn.credential_response):Kw(e.webauthn.credential_response)})}:{code:e.code}),{data:o,error:c}=await re(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:i,headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token});return c?this._returnResult({data:null,error:c}):(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+o.expires_in},o)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",o),this._returnResult({data:o,error:c}))})}catch(t){if(K(t))return this._returnResult({data:null,error:t});throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var s;const{data:n,error:a}=t;if(a)return this._returnResult({data:null,error:a});const i=await re(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:e,headers:this.headers,jwt:(s=n==null?void 0:n.session)===null||s===void 0?void 0:s.access_token});if(i.error)return i;const{data:o}=i;if(o.type!=="webauthn")return{data:o,error:null};switch(o.webauthn.type){case"create":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:qw(o.webauthn.credential_options.publicKey)})})}),error:null};case"request":return{data:Object.assign(Object.assign({},o),{webauthn:Object.assign(Object.assign({},o.webauthn),{credential_options:Object.assign(Object.assign({},o.webauthn.credential_options),{publicKey:Xw(o.webauthn.credential_options.publicKey)})})}),error:null}}})}catch(t){if(K(t))return this._returnResult({data:null,error:t});throw t}})}async _challengeAndVerify(e){const{data:t,error:s}=await this._challenge({factorId:e.factorId});return s?this._returnResult({data:null,error:s}):await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){var e;const{data:{user:t},error:s}=await this.getUser();if(s)return{data:null,error:s};const n={all:[],phone:[],totp:[],webauthn:[]};for(const a of(e=t==null?void 0:t.factors)!==null&&e!==void 0?e:[])n.all.push(a),a.status==="verified"&&n[a.factor_type].push(a);return{data:n,error:null}}async _getAuthenticatorAssuranceLevel(){var e,t;const{data:{session:s},error:n}=await this.getSession();if(n)return this._returnResult({data:null,error:n});if(!s)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:a}=$o(s.access_token);let i=null;a.aal&&(i=a.aal);let o=i;((t=(e=s.user.factors)===null||e===void 0?void 0:e.filter(h=>h.status==="verified"))!==null&&t!==void 0?t:[]).length>0&&(o="aal2");const l=a.amr||[];return{data:{currentLevel:i,nextLevel:o,currentAuthenticationMethods:l},error:null}}async _getAuthorizationDetails(e){try{return await this._useSession(async t=>{const{data:{session:s},error:n}=t;return n?this._returnResult({data:null,error:n}):s?await re(this.fetch,"GET",`${this.url}/oauth/authorizations/${e}`,{headers:this.headers,jwt:s.access_token,xform:a=>({data:a,error:null})}):this._returnResult({data:null,error:new Ht})})}catch(t){if(K(t))return this._returnResult({data:null,error:t});throw t}}async _approveAuthorization(e,t){try{return await this._useSession(async s=>{const{data:{session:n},error:a}=s;if(a)return this._returnResult({data:null,error:a});if(!n)return this._returnResult({data:null,error:new Ht});const i=await re(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:n.access_token,body:{action:"approve"},xform:o=>({data:o,error:null})});return i.data&&i.data.redirect_url&&dt()&&!(t!=null&&t.skipBrowserRedirect)&&window.location.assign(i.data.redirect_url),i})}catch(s){if(K(s))return this._returnResult({data:null,error:s});throw s}}async _denyAuthorization(e,t){try{return await this._useSession(async s=>{const{data:{session:n},error:a}=s;if(a)return this._returnResult({data:null,error:a});if(!n)return this._returnResult({data:null,error:new Ht});const i=await re(this.fetch,"POST",`${this.url}/oauth/authorizations/${e}/consent`,{headers:this.headers,jwt:n.access_token,body:{action:"deny"},xform:o=>({data:o,error:null})});return i.data&&i.data.redirect_url&&dt()&&!(t!=null&&t.skipBrowserRedirect)&&window.location.assign(i.data.redirect_url),i})}catch(s){if(K(s))return this._returnResult({data:null,error:s});throw s}}async fetchJwk(e,t={keys:[]}){let s=t.keys.find(o=>o.kid===e);if(s)return s;const n=Date.now();if(s=this.jwks.keys.find(o=>o.kid===e),s&&this.jwks_cached_at+nw>n)return s;const{data:a,error:i}=await re(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(i)throw i;return!a.keys||a.keys.length===0||(this.jwks=a,this.jwks_cached_at=n,s=a.keys.find(o=>o.kid===e),!s)?null:s}async getClaims(e,t={}){try{let s=e;if(!s){const{data:f,error:p}=await this.getSession();if(p||!f.session)return this._returnResult({data:null,error:p});s=f.session.access_token}const{header:n,payload:a,signature:i,raw:{header:o,payload:c}}=$o(s);t!=null&&t.allowExpired||Aw(a.exp);const l=!n.alg||n.alg.startsWith("HS")||!n.kid||!("crypto"in globalThis&&"subtle"in globalThis.crypto)?null:await this.fetchJwk(n.kid,t!=null&&t.keys?{keys:t.keys}:t==null?void 0:t.jwks);if(!l){const{error:f}=await this.getUser(s);if(f)throw f;return{data:{claims:a,header:n,signature:i},error:null}}const h=Cw(n.alg),d=await crypto.subtle.importKey("jwk",l,h,!0,["verify"]);if(!await crypto.subtle.verify(h,d,i,fw(`${o}.${c}`)))throw new wc("Invalid JWT signature");return{data:{claims:a,header:n,signature:i},error:null}}catch(s){if(K(s))return this._returnResult({data:null,error:s});throw s}}}Xn.nextInstanceID={};const av=Xn;class iv extends av{constructor(e){super(e)}}class ov{constructor(e,t,s){var n,a,i;this.supabaseUrl=e,this.supabaseKey=t;const o=Zx(e);if(!t)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",o),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",o),this.storageUrl=new URL("storage/v1",o),this.functionsUrl=new URL("functions/v1",o);const c=`sb-${o.hostname.split(".")[0]}-auth-token`,l={db:Vx,realtime:qx,auth:Object.assign(Object.assign({},Wx),{storageKey:c}),global:zx},h=Qx(s??{},l);this.storageKey=(n=h.auth.storageKey)!==null&&n!==void 0?n:"",this.headers=(a=h.global.headers)!==null&&a!==void 0?a:{},h.accessToken?(this.accessToken=h.accessToken,this.auth=new Proxy({},{get:(d,u)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(u)} is not possible`)}})):this.auth=this._initSupabaseAuthClient((i=h.auth)!==null&&i!==void 0?i:{},this.headers,h.global.fetch),this.fetch=Kx(t,this._getAccessToken.bind(this),h.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},h.realtime)),this.rest=new ex(new URL("rest/v1",o).href,{headers:this.headers,schema:h.db.schema,fetch:this.fetch}),this.storage=new Hx(this.storageUrl.href,this.headers,this.fetch,s==null?void 0:s.storage),h.accessToken||this._listenForAuthEvents()}get functions(){return new Jb(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},s={head:!1,get:!1,count:void 0}){return this.rest.rpc(e,t,s)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}async _getAccessToken(){var e,t;if(this.accessToken)return await this.accessToken();const{data:s}=await this.auth.getSession();return(t=(e=s.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:this.supabaseKey}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:n,userStorage:a,storageKey:i,flowType:o,lock:c,debug:l,throwOnError:h},d,u){const f={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new iv({url:this.authUrl.href,headers:Object.assign(Object.assign({},f),d),storageKey:i,autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:n,userStorage:a,flowType:o,lock:c,debug:l,throwOnError:h,fetch:u,hasCustomAuthorizationHeader:Object.keys(this.headers).some(p=>p.toLowerCase()==="authorization")})}_initRealtimeClient(e){return new yx(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,s)=>{this._handleTokenChanged(t,"CLIENT",s==null?void 0:s.access_token)})}_handleTokenChanged(e,t,s){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==s?(this.changedAccessToken=s,this.realtime.setAuth(s)):e==="SIGNED_OUT"&&(this.realtime.setAuth(),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const cv=(r,e,t)=>new ov(r,e,t);function lv(){if(typeof window<"u"||typeof process>"u")return!1;const r=process.version;if(r==null)return!1;const e=r.match(/^v(\d+)\./);return e?parseInt(e[1],10)<=18:!1}lv()&&console.warn("  Node.js 18 and below are deprecated and will no longer be supported in future versions of @supabase/supabase-js. Please upgrade to Node.js 20 or later. For more information, visit: https://github.com/orgs/supabase/discussions/37217");const hv="https://unzrcsljxirdqkcmrcqu.supabase.co",dv="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuenJjc2xqeGlyZHFrY21yY3F1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0OTExNTQsImV4cCI6MjA3ODA2NzE1NH0._bxUkMyVrCHKraQiJIgEq2YFgfssYkQjalcCw8IcnVM",vc=hv,oi=dv,Sc="__gals_supabase_client__",kc=globalThis;kc[Sc]||(kc[Sc]=cv(vc,oi,{auth:{storageKey:"supabase.auth.gals",persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}));const be=kc[Sc];let Do=!1;function _d(){Do||(Do=!0,setTimeout(()=>{Do=!1,ts()},250))}let Ic=null,Ac=null,Cc=null,Ec=null,Ga=null,za=null,Va=null,Wa=null,ci=null,$s=null,Xr=null;const wn=15,uv="cloud-save-force";function ts(){typeof window<"u"&&window.dispatchEvent(new Event(uv))}const vp=r=>r.slice(0,20);function Or(r){const e=r.split("__snap__")[0]??r,t=e.split("_");return t.length<=6?e:t.slice(0,6).join("_")}function fv(r){return vp(r).map(e=>({baseId:Or(e.id),rarity:e.rarity}))}function Lo(r,e){if(!Array.isArray(r)||r.length===0||e.length===0)return[];const t=new Map(e.map(n=>[Or(n.id),n])),s=[];return r.forEach((n,a)=>{const i=t.get(n.baseId);i&&s.push({...i,id:`${Or(i.id)}__snap__${a}`})}),vp(s)}const pv=1664525,mv=1013904223,gv=4294967296;function Sp(r,e){let t=(r^e+2654435769)>>>0;return t=t*2246822507>>>0,t=(t^t>>>13)>>>0,t>>>0}function kp(r){return pv*r+mv>>>0}function bd(r,e,t=0){const s=Sp(r,e+t*9973);return kp(s)}function yv(r,e,t=0){let s=Sp(r,e+t*2654435761);return s=kp(s),s/gv}function _v(r){const{id:e,name:t,type:s,rarity:n,cost:a,effects:i,tags:o,keywords:c,effectText:l,levelCurve:h,vfxKey:d,sfxKey:u,version:f}=r;return{id:e,name:t,type:s,rarity:n,cost:a,effects:i,tags:o,keywords:c,effectText:l,levelCurve:h,vfxKey:d,sfxKey:u,version:f}}function bv(r){return{...r,tags:r.tags??[],keywords:r.keywords??[],effects:r.effects??[]}}function vn(){ci!==null&&(window.clearInterval(ci),ci=null)}function Fn(){if(typeof window>"u"||!$s){$s=null;return}window.removeEventListener("beforeunload",$s),window.removeEventListener("pagehide",$s),$s=null}function xv(r){if(typeof window>"u"||!vc||!oi)return;Fn();const e=`${vc}/rest/v1/pvp_queue?user_id=eq.${r}`,t=()=>{Fn(),fetch(e,{method:"DELETE",headers:{apikey:oi,Authorization:`Bearer ${oi}`,"Content-Type":"application/json",Prefer:"return=minimal"},keepalive:!0}).catch(()=>{})};window.addEventListener("beforeunload",t),window.addEventListener("pagehide",t),$s=t}function wv(r){Ic=r}function vv(r){Ac=r}function Sv(r){Cc=r}function kv(r){Ec=r}function qa(){Ec&&Ec()}function Yr(r,e,t){Ic&&Ic(r,e,t)}async function Xa(r,e,t){Ac&&await Ac(r,e,t)}const Ya={first:{goldMultiplier:15,goldMinimum:6e3,shardMultiplier:8,shardMinimum:40},repeat:{goldMultiplier:10,goldMinimum:3500,shardMultiplier:5,shardMinimum:20},stageGoldBonus:250,stageShardBonus:4};function Ip(r,e,t){const s=t?Ya.repeat:Ya.first,n=r.gold*s.goldMultiplier+e*Ya.stageGoldBonus,a=r.shards*s.shardMultiplier+e*Ya.stageShardBonus;return{gold:Math.max(s.goldMinimum,n),shards:Math.max(s.shardMinimum,a)}}function xd(){try{const e=new Intl.DateTimeFormat("ko-KR",{timeZone:"Asia/Seoul"}).format(new Date).replace(/\./g,"-").replace(/\s/g,"").replace(/-$/,"");if(e)return e}catch{}return new Date().toISOString().slice(0,10)}function Iv(r){let e=r>>>0;return()=>(e=e*1664525+1013904223>>>0,e/4294967296)}function wd(r,e){if(e.length===0)return[];const t=parseInt(r.replace(/-/g,""),10)||Date.now(),s=Iv(t),n=d=>d.length===0?e[Math.floor(s()*e.length)]??e[0]:d[Math.floor(s()*d.length)]??d[0],a=e.filter(d=>d.id<=15),i=e.filter(d=>d.id>15&&d.id<=30),o=e.filter(d=>d.id>30),c=n(a),l=n(i),h=n(o);return[{id:1,name:"  ",stageId:c.id,recommendedPower:c.recommendedPower,description:`${c.name}    .    .`,modifiers:[{type:"playerEnergy",value:1,label:"   +1",description:"       1 ."},{type:"playerShield",value:10,label:"   10",description:"    10    ."}],reward:{gold:1600,shards:6},cleared:!1},{id:2,name:"  ",stageId:l.id,recommendedPower:l.recommendedPower,description:`${l.name}      .    .`,modifiers:[{type:"enemyEnergy",value:1,label:"   +1",description:"     1 ."},{type:"enemyShield",value:15,label:"    15",description:"     15 ."}],reward:{gold:2e3,shards:8},cleared:!1},{id:3,name:"  ",stageId:h.id,recommendedPower:h.recommendedPower,description:`${h.name}    .      .`,modifiers:[{type:"playerShield",value:15,label:"   15",description:"     15   ."},{type:"enemyEnergy",value:1,label:"   +1",description:"     1 ."},{type:"enemyShield",value:20,label:"    20",description:"     20 ."}],reward:{gold:2600,shards:12},cleared:!1}]}const Ka={statuses:[],shield:0,shieldDuration:0,guard:0,guardDuration:0,vulnerable:0,attackBuff:0,regen:0,regenDuration:0,shockStacks:0,evasionCharges:0,evasionDuration:0,nullifyCharges:0,counterValue:0,counterDuration:0,immuneKeywords:[],immuneDuration:0,nextCardDuplicate:void 0};function Av(r,e,t){const s=t.find(A=>A.id===r);if(!s)return Ap(e);const n=s.enemyImage||"",a=Cv(n);let i=[];if(r<=5){if(i=e.filter(A=>er(A.id)===a&&A.rarity==="Normal"&&A.cost<=2),i.length<10){const A=e.filter(C=>C.rarity==="Normal"&&C.cost<=1);i=[...i,...A]}}else if(r<=10){const A=e.filter(R=>er(R.id)===a&&R.rarity==="Normal"&&R.cost<=2),C=e.filter(R=>er(R.id)===a&&R.rarity==="Rare"&&R.cost<=2);i=[...A,...C.slice(0,Math.ceil(C.length*.3))]}else if(r<=20){const A=e.filter($=>er($.id)===a&&$.rarity==="Normal"&&$.cost<=3),C=e.filter($=>er($.id)===a&&$.rarity==="Rare"&&$.cost<=3),R=e.filter($=>er($.id)===a&&$.rarity==="Epic"&&$.cost<=3);i=[...A,...C,...R.slice(0,Math.ceil(R.length*.2))]}else{const A=e.filter(B=>er(B.id)===a&&B.rarity==="Normal"),C=e.filter(B=>er(B.id)===a&&B.rarity==="Rare"),R=e.filter(B=>er(B.id)===a&&B.rarity==="Epic"),$=e.filter(B=>er(B.id)===a&&B.rarity==="Legendary");i=[...A,...C,...R,...$.slice(0,Math.ceil($.length*.1))]}const o=i.filter(A=>A.type==="Attack"),c=i.filter(A=>A.type==="Defense"),l=i.filter(A=>A.type==="Heal"),h=i.filter(A=>A.type==="Special"),d=[],u=Date.now();let f=0;const p=Math.min(8,o.length),g=[...o].sort(()=>Math.random()-.5);for(let A=0;A<p;A++){const C=g[A%g.length];d.push({...C,id:`${C.id}_enemy_${u}_${f++}`})}const m=Math.min(6,c.length),_=[...c].sort(()=>Math.random()-.5);for(let A=0;A<m;A++){const C=_[A%_.length];d.push({...C,id:`${C.id}_enemy_${u}_${f++}`})}const b=Math.min(4,l.length),x=[...l].sort(()=>Math.random()-.5);for(let A=0;A<b;A++){const C=x[A%x.length];d.push({...C,id:`${C.id}_enemy_${u}_${f++}`})}const S=Math.min(2,h.length),T=[...h].sort(()=>Math.random()-.5);for(let A=0;A<S;A++){const C=T[A%T.length];d.push({...C,id:`${C.id}_enemy_${u}_${f++}`})}if(d.length<20){const A=i.filter($=>!d.some(B=>{const j=B.id.split("_enemy_")[0],se=$.id;return j===se})),C=20-d.length,R=[...A].sort(()=>Math.random()-.5);for(let $=0;$<C&&$<R.length;$++){const B=R[$];d.push({...B,id:`${B.id}_enemy_${u}_${f++}`})}}return d.slice(0,20).sort(()=>Math.random()-.5)}function Ap(r){return[...r.filter(s=>s.rarity==="Normal"&&s.cost<=1)].sort(()=>Math.random()-.5).slice(0,20).map((s,n)=>({...s,id:`${s.id}_enemy_basic_${Date.now()}_${n}`}))}function Cv(r){const e=r.match(/\/([^\/]+)\.png$/);return e?e[1].split("_")[0].toUpperCase():""}function er(r){const e=r.split("_");return e.length>=2?e[1]:""}function vd(r){const e=["ATT_ARIANA_NO_001","ATT_ARIANA_NO_001","ATT_ARIANA_NO_001","ATT_DARIUS_NO_017","ATT_ELDER_NO_033","ATT_ELENA_NO_049","ATT_GAREN_NO_065","ATT_IRIS_NO_081","DEF_ARIANA_NO_013","DEF_ARIANA_NO_013","DEF_ARIANA_NO_013","DEF_ELENA_NO_061","DEF_IRIS_NO_093","HEA_ARIANA_NO_005","HEA_ARIANA_NO_005","HEA_ARIANA_NO_005","HEA_DARIUS_NO_021","SPE_ARIANA_NO_009","SPE_ARIANA_NO_009","SPE_ELDER_NO_041"],t=new Map(r.map(n=>[n.id,n])),s=[];for(const n of e){const a=t.get(n);a?s.push({...a,id:`${a.id}_${Date.now()}_${Math.random()}`}):console.warn(`[InitialDeck] Card not found: ${n}`)}if(s.length<20){const n=r.filter(o=>o.rarity==="Normal"&&o.cost<=2),a=20-s.length,i=[...n].sort(()=>Math.random()-.5);for(let o=0;o<a&&o<i.length;o++){const c=i[o];s.push({...c,id:`${c.id}_${Date.now()}_${Math.random()}`})}}return s.slice(0,20)}const N=_f((r,e)=>({gameScreen:"intro",setGameScreen:t=>{e(),r({gameScreen:t}),e()},replayHistory:[],recordReplayAction:t=>{const s=[...e().replayHistory,t];r({replayHistory:s})},exportReplay:()=>{var a;const t=e(),s={timestamp:new Date().toISOString(),stage:t.currentStage,initialSeed:((a=t.replayHistory[0])==null?void 0:a.seed)||t.roundSeed,actions:t.replayHistory,result:t.gameOver};return JSON.stringify(s,null,2)},gold:1e3,shards:50,addGold:t=>{const s=e().gold;r({gold:s+t}),ts()},addShards:t=>{const s=e().shards;r({shards:s+t}),ts()},getCardPacks:()=>[{id:"pack_normal",name:" ",type:"normal",price:100,priceType:"gold",description:" ",rates:{Normal:70,Rare:25,Epic:4,Legendary:1}},{id:"pack_rare",name:" ",type:"rare",price:250,priceType:"gold",description:"   ",rates:{Normal:50,Rare:40,Epic:8,Legendary:2}},{id:"pack_epic",name:" ",type:"epic",price:500,priceType:"gold",description:"   ",rates:{Normal:30,Rare:40,Epic:25,Legendary:5}},{id:"pack_legendary",name:" ",type:"legendary",price:1e3,priceType:"gold",description:"   ",rates:{Normal:0,Rare:20,Epic:50,Legendary:30}},{id:"pack_premium",name:" ",type:"epic",price:50,priceType:"shards",description:"   ",rates:{Normal:20,Rare:30,Epic:40,Legendary:10}}],buyCardPack:t=>{const s=e(),a=e().getCardPacks().find(p=>p.type===t);if(!a)return console.error(`[Shop] Pack type not found: ${t}`),null;if(a.priceType==="gold"){if(s.gold<a.price)return console.warn(`[Shop] Not enough gold: ${s.gold} < ${a.price}`),null;e().addGold(-a.price)}else if(a.priceType==="shards"){if(s.shards<a.price)return console.warn(`[Shop] Not enough shards: ${s.shards} < ${a.price}`),null;e().addShards(-a.price)}const i=Math.random()*100;let o="Normal",c=0;for(const[p,g]of Object.entries(a.rates))if(c+=g,i<c){o=p;break}const l=s.allCardsPool.length>0?s.allCardsPool:s.collection,h=l.filter(p=>p.rarity===o);if(h.length===0){console.warn(`[Shop] No cards available for rarity: ${o}`);const p=l.filter(b=>b.rarity==="Normal");if(p.length===0)return null;const g=Math.floor(Math.random()*p.length),m=p[g],_=[...s.collection,{...m,id:`${m.id}_${Date.now()}`}];return r({collection:_}),ts(),m}const d=Math.floor(Math.random()*h.length),u=h[d],f=[...s.collection,{...u,id:`${u.id}_${Date.now()}`}];return r({collection:f}),ts(),console.log(`[Shop] Pack opened: ${a.name}, Got: ${u.name} (${o})`),u},pvpQueueStatus:"idle",pvpStatusMessage:"",pvpError:null,pvpMatch:null,pvpChannel:null,pvpRealtimeConnected:!1,pvpLocalSubmissionRound:null,pvpRemoteSubmission:null,pvpLastResolvedRound:0,pvpRandomCounter:0,pvpLocalReady:!1,pvpOpponentReady:!1,pvpTurnDuration:wn,pvpTurnTimeLeft:null,pvpTurnTimerActive:!1,startPvpTurnTimer:(t=!1)=>{const s=e();if(s.battleContext.type!=="pvp"||s.gameOver!=="none"||!t&&s.pvpTurnTimerActive||!t&&s.pvpLocalReady)return;Xr!==null&&typeof window<"u"&&(window.clearInterval(Xr),Xr=null);const n=s.pvpTurnDuration||wn;r({pvpTurnDuration:n,pvpTurnTimeLeft:n,pvpTurnTimerActive:!0}),!(typeof window>"u")&&(Xr=window.setInterval(()=>{const a=e();if(a.battleContext.type!=="pvp"||a.gameOver!=="none"){a.stopPvpTurnTimer(!0);return}if(a.pvpLocalReady){a.stopPvpTurnTimer();return}const i=(a.pvpTurnTimeLeft??a.pvpTurnDuration??wn)-1;i<=0?(r({pvpTurnTimeLeft:0}),a.stopPvpTurnTimer(),a.handlePvpTurnTimeout()):r({pvpTurnTimeLeft:i})},1e3))},stopPvpTurnTimer:(t=!1)=>{Xr!==null&&typeof window<"u"&&(window.clearInterval(Xr),Xr=null),r(s=>({pvpTurnTimerActive:!1,pvpTurnTimeLeft:t?null:s.pvpTurnTimeLeft}))},handlePvpTurnTimeout:()=>{const t=e();t.battleContext.type!=="pvp"||t.gameOver!=="none"||t.pvpLocalReady||(e().addLog("      .","system"),e().endPlayerTurn())},startPvpMatchmaking:async()=>{var l,h;const{data:t}=await be.auth.getSession(),s=t.session;if(!s){r({pvpQueueStatus:"error",pvpError:"   ."});return}const n=s.user.id;vn(),e().stopPvpTurnTimer(!0),r(d=>{const u=d.battleContext.type==="pvp";return{pvpQueueStatus:"searching",pvpStatusMessage:"  ...",pvpError:null,pvpMatch:null,pvpLocalSubmissionRound:u?d.pvpLocalSubmissionRound:null,pvpRemoteSubmission:u?d.pvpRemoteSubmission:null,pvpLastResolvedRound:0,pvpLocalReady:!1,pvpOpponentReady:!1,pvpTurnTimeLeft:null,pvpTurnTimerActive:!1}});try{await be.rpc("pvp_cleanup_stale")}catch(d){console.warn("[PvP] cleanup rpc failed (non-blocking)",d)}const a=fv(e().playerDeck),i={user_id:n,status:"waiting",opponent_id:null,match_id:null,deck_snapshot:a,updated_at:new Date().toISOString()},o=await be.from("pvp_queue").upsert(i);if(o.error){r({pvpQueueStatus:"error",pvpError:o.error.message}),console.error("[PvP] Failed to join queue",o.error,i);return}console.log("[PvP] Joined queue",{userId:n,deckSnapshotSize:a.length}),xv(n);const c=await be.from("pvp_queue").select("user_id, deck_snapshot, updated_at").eq("status","waiting").neq("user_id",n).order("updated_at",{ascending:!0}).limit(1);if(c.error){r({pvpQueueStatus:"error",pvpError:c.error.message}),console.error("[PvP] Failed to search opponent",c.error);return}if(console.log("[PvP] Opponent search result",((l=c.data)==null?void 0:l.length)??0),c.data&&c.data.length>0){const d=c.data[0],u=typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`match_${Date.now()}`,f=Math.floor(Math.random()*1e6),p=await be.from("pvp_matches").insert({id:u,player1_id:d.user_id,player2_id:n,seed:f,status:"pending",created_at:new Date().toISOString(),player1_deck:d.deck_snapshot??[],player2_deck:a});if(p.error){r({pvpQueueStatus:"error",pvpError:p.error.message}),console.error("[PvP] Failed to create match row",p.error);return}await Promise.all([be.from("pvp_queue").update({status:"matched",match_id:u,opponent_id:d.user_id}).eq("user_id",n),be.from("pvp_queue").update({status:"matched",match_id:u,opponent_id:n}).eq("user_id",d.user_id)]);const g=await be.from("profiles").select("display_name").eq("user_id",d.user_id).maybeSingle(),m=d.deck_snapshot??[],_=Lo(m,e().allCardsPool);r({pvpQueueStatus:"matched",pvpStatusMessage:" .",pvpMatch:{matchId:u,seed:f,opponentId:d.user_id,opponentName:((h=g.data)==null?void 0:h.display_name)??null,opponentDeckSnapshot:m,opponentDeckCards:_,playerDeckSnapshot:a,playerRole:"player2",status:"pending"}}),Promise.resolve().then(()=>e().acceptPvpMatch());return}vn(),ci=window.setInterval(async()=>{var T,A;const d=await be.from("pvp_queue").select("status, match_id, opponent_id").eq("user_id",n).maybeSingle();if(d.error){r({pvpQueueStatus:"error",pvpError:d.error.message}),vn();return}const u=d.data;if(!u||u.status!=="matched"||!u.match_id)return;vn();const f=await be.from("pvp_matches").select("id, player1_id, player2_id, seed, player1_deck, player2_deck").eq("id",u.match_id).maybeSingle();if(f.error||!f.data){r({pvpQueueStatus:"error",pvpError:((T=f.error)==null?void 0:T.message)??"   ."});return}const p=f.data,g=p.player1_id===n?"player1":"player2",m=g==="player1"?p.player2_id:p.player1_id,_=g==="player1"?p.player2_deck:p.player1_deck,b=g==="player1"?p.player1_deck:p.player2_deck,x=Lo(_??[],e().allCardsPool),S=await be.from("profiles").select("display_name").eq("user_id",m).maybeSingle();r({pvpQueueStatus:"matched",pvpStatusMessage:" .",pvpMatch:{matchId:p.id,seed:p.seed??0,opponentId:m,opponentName:((A=S.data)==null?void 0:A.display_name)??null,opponentDeckSnapshot:_??[],opponentDeckCards:x,playerDeckSnapshot:b??a,playerRole:g,status:"pending"}}),Promise.resolve().then(()=>e().acceptPvpMatch())},2e3)},cancelPvpMatchmaking:async()=>{const{data:t}=await be.auth.getSession(),s=t.session;vn(),Fn(),s&&await be.from("pvp_queue").delete().eq("user_id",s.user.id),r({pvpQueueStatus:"idle",pvpStatusMessage:"",pvpError:null,pvpMatch:null}),await e().disconnectPvpChannel()},acceptPvpMatch:async()=>{const t=e().pvpMatch;if(!t||t.status==="ready")return;const{data:s}=await be.auth.getSession(),n=s.session;if(!n){r({pvpError:"  .",pvpQueueStatus:"error"});return}await be.from("pvp_queue").delete().eq("user_id",n.user.id),Fn(),r(o=>({battleContext:{type:"pvp",pvpMatchId:t.matchId,pvpSeed:t.seed},pvpMatch:t?{...t,status:"ready"}:null})),r({pvpQueueStatus:"idle",pvpStatusMessage:""});const a=e().allCardsPool,i=t.playerRole==="player1"?Lo(t.playerDeckSnapshot,a):e().playerDeck;t.playerRole==="player1"&&r({playerDeck:i}),await e().connectPvpChannel(t),e().initGame(a),e().setGameScreen("battle")},reportPvpResult:async t=>{const s=e().pvpMatch;if(!s)return;const{data:n}=await be.auth.getSession(),a=n.session;if(!a)return;const i=await be.from("pvp_matches").update({status:"completed",result:t,completed_at:new Date().toISOString(),winner_id:t==="victory"?a.user.id:t==="defeat"?s.opponentId:null}).eq("id",s.matchId);i.error&&console.error("[PvP] Failed to report match result",i.error),await be.from("pvp_queue").delete().eq("user_id",a.user.id),Fn(),ts(),r({pvpMatch:{...s,status:"completed"},pvpQueueStatus:"idle",pvpStatusMessage:""}),await e().disconnectPvpChannel()},connectPvpChannel:async t=>{const s=e().pvpChannel;if(s)try{await s.unsubscribe()}catch(i){console.warn("[PvP] Failed to unsubscribe existing channel",i)}const n=be.channel(`pvp:${t.matchId}`,{config:{broadcast:{ack:!0}}});n.on("broadcast",{event:"turn:submit"},({payload:i})=>{const o=i;if(!o||o.matchId!==t.matchId)return;const c=e();if(c.battleContext.type!=="pvp"||o.round<c.round)return;const l=o.cards.map(bv);r(h=>h.battleContext.type!=="pvp"?{}:o.round<h.round?{}:{enemyQueue:l.map(d=>({card:d})),pvpRemoteSubmission:{round:o.round,cards:l,energySnapshot:o.energy},enemyEnergy:o.energy,pvpOpponentReady:!0}),e().addLog(`  . ( ${o.round})`,"system"),e().tryResolvePvpRound(o.round)});let a=null;if(await new Promise((i,o)=>{n.subscribe(c=>{c==="SUBSCRIBED"?(r({pvpRealtimeConnected:!0}),i()):c==="CHANNEL_ERROR"&&o(new Error("PVP   "))})}).catch(i=>{a=i instanceof Error?i:new Error(String(i)),console.error("[PvP] Channel subscribe error",a),r({pvpError:a.message})}),a){try{await n.unsubscribe()}catch{}return}r({pvpChannel:n,pvpRealtimeConnected:!0,pvpOpponentReady:!1})},disconnectPvpChannel:async()=>{const t=e().pvpChannel;if(t)try{await t.unsubscribe()}catch(s){console.warn("[PvP] Failed to unsubscribe channel",s)}e().stopPvpTurnTimer(!0),r({pvpChannel:null,pvpRealtimeConnected:!1,pvpLocalSubmissionRound:null,pvpRemoteSubmission:null,pvpLocalReady:!1,pvpOpponentReady:!1,pvpTurnTimeLeft:null,pvpTurnTimerActive:!1})},submitPvpTurn:async()=>{const t=e();if(t.battleContext.type!=="pvp")return;if(!t.pvpChannel||!t.pvpMatch){r({pvpError:"PVP   ."});return}const s=t.round;if(t.pvpLocalSubmissionRound===s||t.pvpLocalReady)return;t.declarationLocked||r({declarationLocked:!0}),r({isTurnProcessing:!0,pvpError:null}),e().addLog("  ","system");const n={matchId:t.pvpMatch.matchId,round:s,cards:t.playerQueue.map(i=>_v(i.card)),energy:t.energy},a=await t.pvpChannel.send({type:"broadcast",event:"turn:submit",payload:n});if(a!=="ok"){console.error("[PvP] Failed to send turn payload",a),r({pvpError:a==="timed out"?"     .":"   .",isTurnProcessing:!1});return}e().stopPvpTurnTimer(),r({pvpLocalSubmissionRound:s,pvpLocalReady:!0}),await e().tryResolvePvpRound(s)},tryResolvePvpRound:async t=>{var a;const s=e();if(s.battleContext.type!=="pvp"||s.round!==t||s.pvpLocalSubmissionRound!==t)return;const n=s.pvpRemoteSubmission;if(!(!n||n.round!==t)&&!(s.pvpLastResolvedRound>=t)&&!(s.isTurnProcessing&&s.gameOver!=="none"))try{if(r(f=>({enemyQueue:n.cards.map(p=>({card:p})),enemyEnergy:n.energySnapshot,declarationLocked:!0,isTurnProcessing:!0})),await e().revealAndResolve(),e().gameOver!=="none"){r({pvpRandomCounter:0,pvpLastResolvedRound:t,pvpLocalSubmissionRound:null,pvpRemoteSubmission:null,pvpLocalReady:!1,pvpOpponentReady:!1,isTurnProcessing:!1});return}e().processStatusEffects();const i=e(),o=((a=i.pvpMatch)==null?void 0:a.seed)??i.roundSeed,c=t+1,l=bd(o,c),h=Math.min(i.energy+3,10),d=Math.min(i.enemyEnergy+3,10),u=i.pvpTurnDuration||wn;r({round:c,roundSeed:l,energy:h,enemyEnergy:d,pvpRandomCounter:0,pvpLastResolvedRound:t,pvpLocalSubmissionRound:null,pvpRemoteSubmission:null,pvpLocalReady:!1,pvpOpponentReady:!1,pvpTurnTimeLeft:u,pvpTurnTimerActive:!1,isTurnProcessing:!1}),e().addLog(`  ${c}  `,"system"),e().addLog(` : ${h}`,"system"),e().addLog(` : ${d}`,"system"),e().draw(1),i.battleContext.type==="pvp"&&e().enemyDraw(1),e().startPvpTurnTimer(!0)}catch(i){console.error("[PvP] Failed to resolve round",i),r({pvpError:i instanceof Error?i.message:String(i),isTurnProcessing:!1})}},campaignStages:[{id:1,name:"",theme:"Neutral",recommendedPower:100,firstReward:{gold:200,shards:2},repeatReward:{gold:100,shards:1},cleared:!1,story:{description:"        .  Lucian    .",backgroundImage:"backgrounds/stage_01_training_1.png"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/lucian_rosegarden.png",cutscene:{preBattle:[{speaker:"Lucian",text:" ,       .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"...Lucian, ?        ,      .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"        .        .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Lucian",text:"    .           .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"  ?       .",emotion:"surprised",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:". , , ,  ...      .      .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"          .",emotion:"surprised",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:".           .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Lucian",text:"         .       .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"        .    .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"      .          .",emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"         .      ?",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"  .         .",emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:", Lucian.     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:".    .      .",emotion:"happy",characterImage:"characters/lucian_rosegarden"}],postVictory:[{speaker:"Lucian",text:', !   . " ,   ."',emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:", Lucian.    .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"   .       .",emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"?     !",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"      .     .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:".        .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"   .       .",emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:'"    ."      .',emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:" .    .",emotion:"happy",characterImage:"characters/lucian_rosegarden"}],postDefeat:[{speaker:"Lucian",text:", .      .     .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"    ...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:'    . " ,      ."',emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:" .           .",emotion:"angry",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"  .      ,   .",emotion:"happy",characterImage:"characters/lucian_rosegarden"}]}},{id:2,name:" ",theme:"Fire",recommendedPower:120,firstReward:{gold:0,shards:2},repeatReward:{gold:0,shards:2},cleared:!1,story:{description:'  . "     ...     !"     .',backgroundImage:"backgrounds/stage_02_fire_1.png"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/ariana_drake.png",cutscene:{preBattle:[{speaker:"Ariana",text:" ?            .",emotion:"angry",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:".     .  ?",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:".        ?    .",emotion:"angry",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"      .       .",emotion:"angry",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:".     .       !",emotion:"angry",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"          .      .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:" .        !",emotion:"angry",characterImage:"characters/ariana_drake"}],postVictory:[{speaker:"Ariana",text:" ...   .",emotion:"sad",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"   .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"...      .     .",emotion:"angry",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:" .          .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:" ,  .           .",emotion:"angry",characterImage:"characters/ariana_drake"}],postDefeat:[{speaker:"Ariana",text:",      .        .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"   ...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"     .     .",emotion:"angry",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:" .      .",emotion:"determined",characterImage:"characters/seraphina_belmont"}]}},{id:3,name:" ",theme:"Ice",recommendedPower:140,firstReward:{gold:250,shards:3},repeatReward:{gold:120,shards:2},cleared:!1,story:{description:"   Seraphine Winters .      .   .",backgroundImage:"backgrounds/stage_03_ice_1.png"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/seraphine_winters.png",cutscene:{preBattle:[{speaker:"Seraphine Winters",text:"    .  Seraphine Winters,   .",emotion:"normal",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:" Seraphine ,    .",emotion:"surprised",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:"    .      .",emotion:"normal",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:"    .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:".        .   .",emotion:"normal",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:"    .      .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:"  .      .  .",emotion:"happy",characterImage:"characters/elena_drake"}],postVictory:[{speaker:"Seraphine Winters",text:".      .",emotion:"happy",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:".         .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:"    ,    .    .",emotion:"normal",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:".     .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Seraphine Winters",text:"  .      .",emotion:"normal",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:"     .   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:"      .     .",emotion:"happy",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:" .       .",emotion:"determined",characterImage:"characters/seraphina_belmont"}]}},{id:4,name:" ",theme:"Lightning",recommendedPower:160,firstReward:{gold:0,shards:2},repeatReward:{gold:0,shards:2},cleared:!1,story:{description:'    Leon Ardenia. "   ? .    ."       .',backgroundImage:"backgrounds/stage_04_lightning_1.png"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/leon_ardenia.png",cutscene:{preBattle:[{speaker:"Leon Ardenia",text:"   ...    .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"  Leon Ardenia ,   .      .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:"       .      .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"   ,    .   .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:".    .         .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:" ,  ...   .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:"    .     .",emotion:"angry",characterImage:"characters/leon_ardenia"}],postVictory:[{speaker:"Leon Ardenia",text:"....       .",emotion:"surprised",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"  ,     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:"    .         .",emotion:"happy",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:" .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Leon Ardenia",text:".       .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"      ...  .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:'    . ", , ."     .',emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"   .      .",emotion:"determined",characterImage:"characters/seraphina_belmont"}]}},{id:5,name:" ",theme:"Wind",recommendedPower:180,firstReward:{gold:300,shards:3},repeatReward:{gold:150,shards:2},cleared:!1,story:{description:"     .    Iris   .       .",backgroundImage:"backgrounds/stage_05_wind_1.png"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/iris_belmont.png",cutscene:{preBattle:[{speaker:"Iris Belmont",text:"!    ?     !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"Iris,  .       .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Iris Belmont",text:"      .       !",emotion:"normal",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:".  ,    .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Iris Belmont",text:"     .       !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"      ? .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Iris Belmont",text:"!   !     !",emotion:"angry",characterImage:"characters/iris_belmont"}],postVictory:[{speaker:"Iris Belmont",text:"...  !     !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"    .       .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Iris Belmont",text:"    !     !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:".           .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Iris Belmont",text:"?    ?   .",emotion:"surprised",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"     .   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Iris Belmont",text:"    !     !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:", Iris.        .",emotion:"determined",characterImage:"characters/seraphina_belmont"}]}},{id:6,name:" ",theme:"FireIce",recommendedPower:210,firstReward:{gold:320,shards:3},repeatReward:{gold:160,shards:2},cleared:!1,story:{description:"  Ariana   Seraphine     .  ,         .",backgroundImage:"backgrounds/stage_06_fire_ice.png"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/ariana_drake.png",cutscene:{preBattle:[{speaker:"Ariana",text:"     .   ,  Seraphine .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"  ,   ...      .",emotion:"surprised",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:"   .           .",emotion:"normal",characterImage:"characters/seraphine_winters"},{speaker:"Ariana",text:"   .    .    .",emotion:"angry",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"    .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:"   .  ,         .",emotion:"happy",characterImage:"characters/seraphine_winters"},{speaker:"Ariana",text:",    ?     .",emotion:"happy",characterImage:"characters/ariana_drake"}],postVictory:[{speaker:"Ariana",text:"   .        .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphine Winters",text:"      .      .",emotion:"happy",characterImage:"characters/seraphine_winters"},{speaker:"Seraphina",text:"      .    .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"        .     .",emotion:"happy",characterImage:"characters/ariana_drake"}],postDefeat:[{speaker:"Ariana",text:"    .    .",emotion:"angry",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"    .       .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:"      .     .",emotion:"normal",characterImage:"characters/seraphine_winters"},{speaker:"Ariana",text:" .     .     .",emotion:"happy",characterImage:"characters/ariana_drake"}]}},{id:7,name:" ",theme:"Storm",recommendedPower:240,firstReward:{gold:330,shards:3},repeatReward:{gold:170,shards:2},cleared:!1,story:{description:"    .         .",backgroundImage:"backgrounds/stage_07_storm.png"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/garen_stone.png",cutscene:{preBattle:[{speaker:"Garen Stone",text:" .     ?",emotion:"normal",characterImage:"characters/garen_stone"},{speaker:"Iris Belmont",text:",     !   !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"  .        ?",emotion:"surprised",characterImage:"characters/seraphina_belmont"},{speaker:"Garen Stone",text:"  .   ,      .",emotion:"angry",characterImage:"characters/garen_stone"},{speaker:"Iris Belmont",text:"    .         !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"   .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Garen Stone",text:"    .     .",emotion:"surprised",characterImage:"characters/garen_stone"},{speaker:"Iris Belmont",text:",  !      !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"     .      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Garen Stone",text:".       .",emotion:"normal",characterImage:"characters/garen_stone"}],postDefeat:[{speaker:"Garen Stone",text:"     .     .",emotion:"angry",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:" .     .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Iris Belmont",text:" !      !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Garen Stone",text:" ,   .    .",emotion:"normal",characterImage:"characters/garen_stone"}]}},{id:8,name:" ",theme:"Elite",recommendedPower:280,firstReward:{gold:340,shards:3},repeatReward:{gold:170,shards:2},cleared:!1,story:{description:"      . , ,     .",backgroundImage:"backgrounds/stage_08_elite.png"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/marcus_belmont.png",cutscene:{preBattle:[{speaker:"Marcus Belmont",text:"      .     .",emotion:"angry",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"Marcus ,         .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"    ,     .  .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Marcus Belmont",text:"   ,     .        .",emotion:"normal",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"    .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Marcus Belmont",text:".     .",emotion:"normal",characterImage:"characters/marcus_belmont"}],postVictory:[{speaker:"Marcus Belmont",text:"  .      .",emotion:"surprised",characterImage:"characters/marcus_belmont"},{speaker:"Lucian",text:' . "       " .',emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"       .   .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Marcus Belmont",text:"   .   .",emotion:"normal",characterImage:"characters/marcus_belmont"}],postDefeat:[{speaker:"Marcus Belmont",text:" .     .",emotion:"angry",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"      ...  .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"     .    .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Marcus Belmont",text:"  .       .",emotion:"normal",characterImage:"characters/marcus_belmont"}]}},{id:9,name:" ",theme:"Shadow Corridor",recommendedPower:320,firstReward:{gold:360,shards:4},repeatReward:{gold:180,shards:2},cleared:!1,story:{description:"     .         .",backgroundImage:"backgrounds/stage_09_corridor.png"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/darius_blackwood.png",cutscene:{preBattle:[{speaker:"Darius Blackwood",text:"       .    ?",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"  ...    .   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:"   .       .",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:'"" .        .',emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:".     ,   .",emotion:"angry",characterImage:"characters/darius_blackwood"}],postVictory:[{speaker:"Darius Blackwood",text:"   .    .",emotion:"surprised",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"   .      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:",   .       .",emotion:"normal",characterImage:"characters/darius_blackwood"}],postDefeat:[{speaker:"Darius Blackwood",text:"  .    .",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"...   .     .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:' ,   "" .    .',emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Darius Blackwood",text:" .     .",emotion:"happy",characterImage:"characters/darius_blackwood"}]}},{id:10,name:" ",theme:"Estate",recommendedPower:200,firstReward:{gold:380,shards:4},repeatReward:{gold:190,shards:2},cleared:!1,story:{description:"     .        .",backgroundImage:"backgrounds/stage_10_elena.png"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/elena_drake.png",cutscene:{preBattle:[{speaker:"Elena Drake",text:",     .     .",emotion:"happy",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:" ,    .         .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:"    .    .",emotion:"happy",characterImage:"characters/kai_drake"},{speaker:"Elena Drake",text:"   ,     .     .",emotion:"angry",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:".       .       .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:"    .   .",emotion:"happy",characterImage:"characters/kai_drake"}],postVictory:[{speaker:"Elena Drake",text:"  .     .",emotion:"surprised",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:'     .  " " .',emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:"    .      .",emotion:"happy",characterImage:"characters/kai_drake"},{speaker:"Elena Drake",text:"     .        .",emotion:"happy",characterImage:"characters/elena_drake"}],postDefeat:[{speaker:"Elena Drake",text:"  .     .",emotion:"normal",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:"    .      .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:" .         .",emotion:"happy",characterImage:"characters/kai_drake"},{speaker:"Elena Drake",text:"      .    .",emotion:"happy",characterImage:"characters/elena_drake"}]}},{id:11,name:" ",theme:"Lucian2",recommendedPower:220,firstReward:{gold:400,shards:4},repeatReward:{gold:200,shards:2},cleared:!1,story:{description:"     .     Lucian     .",backgroundImage:"backgrounds/stage_11_training_advanced.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/lucian_rosegarden.png",cutscene:{preBattle:[{speaker:"Lucian",text:",       .      .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"    .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"    ,      .   .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:".      .    .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:".          .  .",emotion:"angry",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:" .          .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Lucian",text:"!     ...      .",emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"     .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"      .     .",emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"    .  .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Lucian",text:"   .      .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"...     .  .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"   .         .",emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:" .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"}]}},{id:12,name:" ",theme:"Fire2",recommendedPower:240,firstReward:{gold:450,shards:4},repeatReward:{gold:220,shards:2},cleared:!1,story:{description:"      .     .",backgroundImage:"backgrounds/stage_12_fire_master.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/ariana_drake.png",cutscene:{preBattle:[{speaker:"Ariana",text:"Stage 11  ,  .       .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"Lucian      .   .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"   .    .    .",emotion:"normal",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:" .      .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:".       .      .",emotion:"normal",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:".     .",emotion:"angry",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Ariana",text:".  ,      .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"     .      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"     .    .",emotion:"normal",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:".     .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Ariana",text:"  .    ?",emotion:"normal",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"...    .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:".         .",emotion:"happy",characterImage:"characters/ariana_drake"}]}},{id:13,name:" ",theme:"Ice2",recommendedPower:260,firstReward:{gold:500,shards:5},repeatReward:{gold:250,shards:3},cleared:!1,story:{description:"    .     .",backgroundImage:"backgrounds/stage_13_ice_master.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/seraphine_winters.png",cutscene:{preBattle:[{speaker:"Seraphine Winters",text:"       .   .",emotion:"normal",characterImage:"characters/seraphine_winters"},{speaker:"Seraphina",text:"Ariana   .    .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:" .   ,   .   .",emotion:"normal",characterImage:"characters/seraphine_winters"},{speaker:"Seraphina",text:"Lucian   .      .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:".           .",emotion:"normal",characterImage:"characters/seraphine_winters"},{speaker:"Seraphina",text:"    .",emotion:"angry",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Seraphine Winters",text:".     .",emotion:"surprised",characterImage:"characters/seraphine_winters"},{speaker:"Seraphina",text:"     .       .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:"   .       .",emotion:"normal",characterImage:"characters/seraphine_winters"},{speaker:"Seraphina",text:"   .",emotion:"normal",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Seraphine Winters",text:".     .",emotion:"normal",characterImage:"characters/seraphine_winters"},{speaker:"Seraphina",text:"   ...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:" ,   .   .",emotion:"normal",characterImage:"characters/seraphine_winters"}]}},{id:14,name:" ",theme:"Lightning2",recommendedPower:280,firstReward:{gold:550,shards:5},repeatReward:{gold:280,shards:3},cleared:!1,story:{description:"    .      .",backgroundImage:"backgrounds/stage_14_lightning_master.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/leon_ardenia.png",cutscene:{preBattle:[{speaker:"Leon Ardenia",text:"  .    .   .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"Leon ,     .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:"      .    .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"      .  .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:"  .   .",emotion:"angry",characterImage:"characters/leon_ardenia"}],postVictory:[{speaker:"Leon Ardenia",text:"   .    .",emotion:"surprised",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:" .       .",emotion:"normal",characterImage:"characters/leon_ardenia"}],postDefeat:[{speaker:"Leon Ardenia",text:".   .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:" ...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:" ,    .       .",emotion:"normal",characterImage:"characters/leon_ardenia"}]}},{id:15,name:" ",theme:"Wind2",recommendedPower:300,firstReward:{gold:600,shards:5},repeatReward:{gold:300,shards:3},cleared:!1,story:{description:"     .       .",backgroundImage:"backgrounds/stage_15_wind_master.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/iris_belmont.png",cutscene:{preBattle:[{speaker:"Iris Belmont",text:"!   .       !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"     .       .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:"      .      .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"        .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Iris Belmont",text:" !       !",emotion:"happy",characterImage:"characters/iris_belmont"}],postVictory:[{speaker:"Iris Belmont",text:",     !    !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Leon Ardenia",text:"     .     .",emotion:"happy",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:'    .  " " .',emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Iris Belmont",text:" !      !",emotion:"happy",characterImage:"characters/iris_belmont"}],postDefeat:[{speaker:"Iris Belmont",text:"   ?     ,     .",emotion:"normal",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"...   .   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:"    .       .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Iris Belmont",text:" !     !",emotion:"happy",characterImage:"characters/iris_belmont"}]}},{id:16,name:" ",theme:"Storm2",recommendedPower:320,firstReward:{gold:650,shards:6},repeatReward:{gold:325,shards:3},cleared:!1,story:{description:"      .   .",backgroundImage:"backgrounds/stage_16_earth_master.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/garen_stone.png",cutscene:{preBattle:[{speaker:"Garen Stone",text:"    .        .",emotion:"normal",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"Garen ,      .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Garen Stone",text:"   .    .      .",emotion:"angry",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"Marcus     .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Garen Stone",text:"     .  .",emotion:"surprised",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"     .    .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Garen Stone",text:"       ?",emotion:"normal",characterImage:"characters/garen_stone"}],postDefeat:[{speaker:"Garen Stone",text:" .  .",emotion:"normal",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"  ...  .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Garen Stone",text:"   .    .",emotion:"normal",characterImage:"characters/garen_stone"}]}},{id:17,name:" ",theme:"Fire3",recommendedPower:340,firstReward:{gold:700,shards:6},repeatReward:{gold:350,shards:3},cleared:!1,story:{description:"     . Ariana      .",backgroundImage:"backgrounds/stage_17_fire_challenge.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/ariana_drake.png",cutscene:{preBattle:[{speaker:"Ariana",text:"  .     . ?",emotion:"normal",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"       .      .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"   .  .     .",emotion:"angry",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"  .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:".    .      .",emotion:"happy",characterImage:"characters/ariana_drake"}],postVictory:[{speaker:"Ariana",text:"  .    .",emotion:"surprised",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"      .    .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:" Mira   .      .",emotion:"happy",characterImage:"characters/ariana_drake"}],postDefeat:[{speaker:"Ariana",text:" ?     .",emotion:"angry",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"...  .    .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:" .     .",emotion:"normal",characterImage:"characters/ariana_drake"}]}},{id:18,name:" ",theme:"Friendship",recommendedPower:360,firstReward:{gold:720,shards:7},repeatReward:{gold:360,shards:4},cleared:!1,story:{description:"  Mira    .    .",backgroundImage:"backgrounds/stage_18_friendship.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/mira.png",cutscene:{preBattle:[{speaker:"Mira",text:",    .   .",emotion:"happy",characterImage:"characters/mira"},{speaker:"Seraphina",text:"Mira,      .      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Mira",text:"     .       .",emotion:"determined",characterImage:"characters/mira"},{speaker:"Seraphina",text:"   .       .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Mira",text:" !    ,  !",emotion:"happy",characterImage:"characters/mira"}],postVictory:[{speaker:"Mira",text:"  !      ?",emotion:"happy",characterImage:"characters/mira"},{speaker:"Seraphina",text:".    .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Mira",text:"   !  !",emotion:"happy",characterImage:"characters/mira"}],postDefeat:[{speaker:"Mira",text:"...    .",emotion:"sad",characterImage:"characters/mira"},{speaker:"Seraphina",text:".     .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Mira",text:"!    .    !",emotion:"determined",characterImage:"characters/mira"}]}},{id:19,name:" ",theme:"Shadow2",recommendedPower:380,firstReward:{gold:800,shards:8},repeatReward:{gold:400,shards:4},cleared:!1,story:{description:"    .    .",backgroundImage:"backgrounds/stage_19_shadow.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/darius_blackwood.png",cutscene:{preBattle:[{speaker:"Darius Blackwood",text:"  .       ?",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"  .   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:"  .     .",emotion:"angry",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"      .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Darius Blackwood",text:"   .   .",emotion:"surprised",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"  ...    .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:"   .  2   .",emotion:"normal",characterImage:"characters/darius_blackwood"}],postDefeat:[{speaker:"Darius Blackwood",text:" .    .",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:" ,      .  .",emotion:"normal",characterImage:"characters/darius_blackwood"}]}},{id:20,name:" 2",theme:"Elite2",recommendedPower:400,firstReward:{gold:900,shards:9},repeatReward:{gold:450,shards:5},cleared:!1,story:{description:"    .     .",backgroundImage:"backgrounds/stage_20_elite_advanced.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/marcus_belmont.png",cutscene:{preBattle:[{speaker:"Marcus Belmont",text:"    .      .",emotion:"angry",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"Marcus     .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Marcus Belmont",text:" ,  .  .     .",emotion:"normal",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"     .      .",emotion:"normal",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Marcus Belmont",text:"....       .",emotion:"happy",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:".    .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Marcus Belmont",text:"    .  .",emotion:"normal",characterImage:"characters/marcus_belmont"}],postDefeat:[{speaker:"Marcus Belmont",text:" .      .",emotion:"normal",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Marcus Belmont",text:"   ,    .",emotion:"normal",characterImage:"characters/marcus_belmont"}]}},{id:21,name:" ",theme:"Fusion",recommendedPower:420,firstReward:{gold:950,shards:9},repeatReward:{gold:475,shards:5},cleared:!1,story:{description:"    .      .",backgroundImage:"backgrounds/stage_21_fusion.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Lucian",text:",        .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Ariana",text:"     ,     .  .",emotion:"normal",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"      .    .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:" .    .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:".        .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Lucian",text:"!        .",emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"      .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"    .     .",emotion:"normal",characterImage:"characters/ariana_drake"}],postDefeat:[{speaker:"Lucian",text:"   .    .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"   ...    ?",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:" . , , ...     .",emotion:"normal",characterImage:"characters/leon_ardenia"}]}},{id:22,name:" ",theme:"Kai1",recommendedPower:450,firstReward:{gold:1e3,shards:10},repeatReward:{gold:500,shards:6},cleared:!1,story:{description:"    Kai    .    .",backgroundImage:"backgrounds/stage_22_kai.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/kai_drake.png",cutscene:{preBattle:[{speaker:"Kai Drake",text:",       . ?",emotion:"happy",characterImage:"characters/kai_drake"},{speaker:"Seraphina",text:"Kai  ?      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:"         .    .",emotion:"normal",characterImage:"characters/kai_drake"},{speaker:"Seraphina",text:"     .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:".    .       .",emotion:"happy",characterImage:"characters/kai_drake"}],postVictory:[{speaker:"Kai Drake",text:"....     .",emotion:"surprised",characterImage:"characters/kai_drake"},{speaker:"Seraphina",text:"Kai   .      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:"      .     .",emotion:"happy",characterImage:"characters/kai_drake"}],postDefeat:[{speaker:"Kai Drake",text:".       .",emotion:"normal",characterImage:"characters/kai_drake"},{speaker:"Seraphina",text:"    .   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:"   .      .",emotion:"happy",characterImage:"characters/kai_drake"}]}},{id:23,name:" ",theme:"Lightning3",recommendedPower:470,firstReward:{gold:1050,shards:10},repeatReward:{gold:525,shards:6},cleared:!1,story:{description:"   .     .",backgroundImage:"backgrounds/stage_23_knights.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/leon_ardenia.png",cutscene:{preBattle:[{speaker:"Leon Ardenia",text:"  .      ?",emotion:"angry",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:",     .   .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:" ,      .   .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"      .  .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Leon Ardenia",text:".     .   .",emotion:"happy",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"   .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:"     .     .",emotion:"normal",characterImage:"characters/leon_ardenia"}],postDefeat:[{speaker:"Leon Ardenia",text:" .    .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Leon Ardenia",text:"   ,    .",emotion:"normal",characterImage:"characters/leon_ardenia"}]}},{id:24,name:" ",theme:"Storm3",recommendedPower:490,firstReward:{gold:1100,shards:11},repeatReward:{gold:550,shards:6},cleared:!1,story:{description:"      .     .",backgroundImage:"backgrounds/stage_24_petrification.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/garen_stone.png",cutscene:{preBattle:[{speaker:"Garen Stone",text:"     .    ?",emotion:"angry",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"  ...       .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Garen Stone",text:"    .       .",emotion:"normal",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"   .   .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Garen Stone",text:"  .     .",emotion:"surprised",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"  .      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Garen Stone",text:"       .   .",emotion:"normal",characterImage:"characters/garen_stone"}],postDefeat:[{speaker:"Garen Stone",text:".  .",emotion:"normal",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"   ...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Garen Stone",text:"    .   .",emotion:"normal",characterImage:"characters/garen_stone"}]}},{id:25,name:" ",theme:"ShadowMaster",recommendedPower:510,firstReward:{gold:1150,shards:11},repeatReward:{gold:575,shards:6},cleared:!1,story:{description:"    . Darius     .",backgroundImage:"backgrounds/stage_25_shadow_master.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/darius_blackwood.png",cutscene:{preBattle:[{speaker:"Darius Blackwood",text:"  ?       .",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:",   .   .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:".    .    .",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"        .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Darius Blackwood",text:"  .    .",emotion:"happy",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"   .      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:"   .     .",emotion:"normal",characterImage:"characters/darius_blackwood"}],postDefeat:[{speaker:"Darius Blackwood",text:"  .   .",emotion:"angry",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:" ...    .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:26,name:" ",theme:"Elite3",recommendedPower:530,firstReward:{gold:1200,shards:12},repeatReward:{gold:600,shards:7},cleared:!1,story:{description:"     .     .",backgroundImage:"backgrounds/stage_26_elite_final.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/marcus_belmont.png",cutscene:{preBattle:[{speaker:"Marcus Belmont",text:"    .     ?",emotion:"normal",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"     .",emotion:"normal",characterImage:"characters/seraphina_belmont"},{speaker:"Marcus Belmont",text:".        .",emotion:"normal",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"    .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Marcus Belmont",text:"   .   .",emotion:"happy",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"     .   .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Marcus Belmont",text:"    .     .",emotion:"normal",characterImage:"characters/marcus_belmont"}],postDefeat:[{speaker:"Marcus Belmont",text:"    .     .",emotion:"normal",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"   .    .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Marcus Belmont",text:" .     .",emotion:"normal",characterImage:"characters/marcus_belmont"}]}},{id:27,name:" ",theme:"Sisters",recommendedPower:550,firstReward:{gold:1250,shards:12},repeatReward:{gold:625,shards:7},cleared:!1,story:{description:"  Elena Ariana    .   .",backgroundImage:"backgrounds/stage_27_sisters.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/elena_drake.png",cutscene:{preBattle:[{speaker:"Elena Drake",text:"!    .   ?",emotion:"happy",characterImage:"characters/elena_drake"},{speaker:"Ariana",text:"Elena      .       .",emotion:"normal",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"      .    .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Elena Drake",text:"     !       !",emotion:"happy",characterImage:"characters/elena_drake"},{speaker:"Ariana",text:"Elena,  .        .",emotion:"angry",characterImage:"characters/ariana_drake"}],postVictory:[{speaker:"Elena Drake",text:"! ,  !    !",emotion:"happy",characterImage:"characters/elena_drake"},{speaker:"Ariana",text:"      .     .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:".    .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Elena Drake",text:"?     ?",emotion:"surprised",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:"   ...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"   .     .",emotion:"normal",characterImage:"characters/ariana_drake"}]}},{id:28,name:" ",theme:"Multi",recommendedPower:570,firstReward:{gold:1300,shards:13},repeatReward:{gold:650,shards:7},cleared:!1,story:{description:"    .     .",backgroundImage:"backgrounds/stage_28_multi_tactics.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Lucian",text:"       .     .",emotion:"normal",characterImage:"characters/lucian_rosegarden"},{speaker:"Marcus Belmont",text:" , ,       .  .",emotion:"normal",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"    .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:"  .      .",emotion:"normal",characterImage:"characters/kai_drake"}],postVictory:[{speaker:"Lucian",text:"    .  !",emotion:"happy",characterImage:"characters/lucian_rosegarden"},{speaker:"Seraphina",text:"      .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:"   .  .",emotion:"normal",characterImage:"characters/kai_drake"}],postDefeat:[{speaker:"Marcus Belmont",text:" .      .",emotion:"normal",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"...   .   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Lucian",text:"  ,     .",emotion:"normal",characterImage:"characters/lucian_rosegarden"}]}},{id:29,name:" ",theme:"IrisFinal",recommendedPower:590,firstReward:{gold:1400,shards:14},repeatReward:{gold:700,shards:8},cleared:!1,story:{description:"    Iris   .    .",backgroundImage:"backgrounds/stage_29_wind_final.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/iris_belmont.png",cutscene:{preBattle:[{speaker:"Iris Belmont",text:"!   .    !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"Iris,    .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Iris Belmont",text:"    .     ?",emotion:"determined",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"   .       .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Iris Belmont",text:" !          .",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:"    .    .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Iris Belmont",text:"   .   !",emotion:"happy",characterImage:"characters/iris_belmont"}],postDefeat:[{speaker:"Iris Belmont",text:" !   .   !",emotion:"happy",characterImage:"characters/iris_belmont"},{speaker:"Seraphina",text:", Iris.      .",emotion:"determined",characterImage:"characters/seraphina_belmont"}]}},{id:30,name:" ",theme:"ElderFinal",recommendedPower:650,firstReward:{gold:1500,shards:15},repeatReward:{gold:750,shards:9},cleared:!1,story:{description:"  .  Elder Belmont   .   .",backgroundImage:"backgrounds/stage_30_final_boss.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/elder_belmont.png",cutscene:{preBattle:[{speaker:"Elder Belmont",text:",    .    .",emotion:"normal",characterImage:"characters/elder_belmont"},{speaker:"Seraphina",text:",       .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Elder Belmont",text:"    ,      .    .",emotion:"angry",characterImage:"characters/elder_belmont"},{speaker:"Seraphina",text:"     .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Elder Belmont",text:".        .",emotion:"happy",characterImage:"characters/elder_belmont"},{speaker:"Seraphina",text:".      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Elder Belmont",text:"   .      .",emotion:"normal",characterImage:"characters/elder_belmont"}],postDefeat:[{speaker:"Elder Belmont",text:"   .   .",emotion:"normal",characterImage:"characters/elder_belmont"},{speaker:"Seraphina",text:" .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"}]}},{id:31,name:"",theme:"Wedding",recommendedPower:680,firstReward:{gold:1500,shards:15},repeatReward:{gold:750,shards:9},cleared:!1,story:{description:"     .    .",backgroundImage:"backgrounds/stage_31_wedding.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/ariana_drake.png",cutscene:{preBattle:[{speaker:"Ariana",text:" !      .      ?",emotion:"normal",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"    .   ,     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"        . ,     .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"    .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Ariana",text:"!      .   .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:".        .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"   .      .",emotion:"normal",characterImage:"characters/ariana_drake"}],postDefeat:[{speaker:"Ariana",text:"?  .     .",emotion:"surprised",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"     ...  .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:" .    .",emotion:"happy",characterImage:"characters/ariana_drake"}]}},{id:32,name:" ",theme:"Aldric",recommendedPower:700,firstReward:{gold:1600,shards:16},repeatReward:{gold:800,shards:9},cleared:!1,story:{description:"    .    .",backgroundImage:"backgrounds/stage_32_politics.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Advisor Aldric",text:",      .    .",emotion:"normal"},{speaker:"Seraphina",text:"      .   .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Advisor Aldric",text:"  ,  ,   .      .",emotion:"normal"},{speaker:"Seraphina",text:"   .    .",emotion:"normal",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Advisor Aldric",text:".      .",emotion:"normal"},{speaker:"Seraphina",text:"      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Advisor Aldric",text:"   .   .",emotion:"normal"}],postDefeat:[{speaker:"Advisor Aldric",text:"   .    .",emotion:"normal"},{speaker:"Seraphina",text:" ...    .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Advisor Aldric",text:"     .   .",emotion:"normal"}]}},{id:33,name:" ",theme:"MiraFinal",recommendedPower:720,firstReward:{gold:1700,shards:17},repeatReward:{gold:850,shards:9},cleared:!1,story:{description:"   Mira  .      .",backgroundImage:"backgrounds/stage_33_mira_final.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/mira.png",cutscene:{preBattle:[{speaker:"Mira",text:",           .",emotion:"happy",characterImage:"characters/mira"},{speaker:"Seraphina",text:"    ...      .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Mira",text:"    ,      .",emotion:"determined",characterImage:"characters/mira"},{speaker:"Seraphina",text:"     .       .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Mira",text:",      !",emotion:"happy",characterImage:"characters/mira"}],postVictory:[{speaker:"Mira",text:" !        !",emotion:"happy",characterImage:"characters/mira"},{speaker:"Seraphina",text:"       .         .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Mira",text:"   .      !",emotion:"happy",characterImage:"characters/mira"}],postDefeat:[{speaker:"Mira",text:"?        ...",emotion:"sad",characterImage:"characters/mira"},{speaker:"Seraphina",text:".      .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Mira",text:"     .     !",emotion:"happy",characterImage:"characters/mira"}]}},{id:34,name:"",theme:"Marcus2",recommendedPower:740,firstReward:{gold:1800,shards:18},repeatReward:{gold:900,shards:10},cleared:!1,story:{description:"     .    .",backgroundImage:"backgrounds/stage_34_conflict.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/marcus_belmont.png",cutscene:{preBattle:[{speaker:"Marcus Belmont",text:"       .    .",emotion:"normal",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"    .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Marcus Belmont",text:"     .  .",emotion:"angry",characterImage:"characters/marcus_belmont"}],postVictory:[{speaker:"Marcus Belmont",text:".    .   .",emotion:"happy",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"     .        .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Marcus Belmont",text:"  .    .",emotion:"normal",characterImage:"characters/marcus_belmont"},{speaker:"Seraphina",text:"...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Marcus Belmont",text:"  ,    .",emotion:"normal",characterImage:"characters/marcus_belmont"}]}},{id:35,name:" ",theme:"Conspiracy",recommendedPower:760,firstReward:{gold:1900,shards:19},repeatReward:{gold:950,shards:11},cleared:!1,story:{description:"    .    .",backgroundImage:"backgrounds/stage_35_conspiracy.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Leon Ardenia",text:"    .       .",emotion:"angry",characterImage:"characters/leon_ardenia"},{speaker:"Advisor Aldric",text:"         . ?",emotion:"normal"},{speaker:"Seraphina",text:"  .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Leon Ardenia",text:".    .",emotion:"happy",characterImage:"characters/leon_ardenia"},{speaker:"Advisor Aldric",text:"     .     .",emotion:"normal"}],postDefeat:[{speaker:"Leon Ardenia",text:" .    .",emotion:"normal",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"    .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Advisor Aldric",text:"     .  .",emotion:"normal"}]}},{id:36,name:" ",theme:"Thorne",recommendedPower:780,firstReward:{gold:2e3,shards:20},repeatReward:{gold:1e3,shards:12},cleared:!1,story:{description:"      .     .",backgroundImage:"backgrounds/stage_36_magic_lab.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Archmage Thorne",text:"       .  .",emotion:"normal"},{speaker:"Seraphina",text:"   .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Archmage Thorne",text:"     .     .",emotion:"normal"}],postVictory:[{speaker:"Archmage Thorne",text:".    .",emotion:"normal"},{speaker:"Seraphina",text:"    .    .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Archmage Thorne",text:"   .  .",emotion:"normal"},{speaker:"Seraphina",text:" .   .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:37,name:" ",theme:"AncientMagic",recommendedPower:800,firstReward:{gold:2100,shards:21},repeatReward:{gold:1050,shards:12},cleared:!1,story:{description:"       .      .",backgroundImage:"backgrounds/stage_37_ancient.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Archmage Thorne",text:"  .        .",emotion:"normal"},{speaker:"Seraphine Winters",text:"      .     .",emotion:"normal",characterImage:"characters/seraphine_winters"},{speaker:"Seraphina",text:"      .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Archmage Thorne",text:"    .   .",emotion:"normal"},{speaker:"Seraphine Winters",text:"    . , , ...  !",emotion:"happy",characterImage:"characters/seraphine_winters"}],postVictory:[{speaker:"Archmage Thorne",text:".          .",emotion:"happy"},{speaker:"Seraphine Winters",text:"       .    .",emotion:"happy",characterImage:"characters/seraphine_winters"},{speaker:"Seraphina",text:"    .         .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Archmage Thorne",text:" .   .",emotion:"normal"},{speaker:"Seraphine",text:"  ...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Seraphine Winters",text:",   ?  .",emotion:"happy",characterImage:"characters/seraphine_winters"}]}},{id:38,name:" ",theme:"Ariana4",recommendedPower:820,firstReward:{gold:2200,shards:22},repeatReward:{gold:1100,shards:13},cleared:!1,story:{description:" Ariana    .  .",backgroundImage:"backgrounds/stage_38_reconciliation.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/ariana_drake.png",cutscene:{preBattle:[{speaker:"Ariana",text:"  .         .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"     .    .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Ariana",text:"!    .",emotion:"angry",characterImage:"characters/ariana_drake"}],postVictory:[{speaker:"Ariana",text:".  ,   .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:".    .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Ariana",text:".     .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"  .    .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:39,name:" ",theme:"Kai2",recommendedPower:840,firstReward:{gold:2300,shards:23},repeatReward:{gold:1150,shards:13},cleared:!1,story:{description:"    .     .",backgroundImage:"backgrounds/stage_39_cooperation.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/kai_drake.png",cutscene:{preBattle:[{speaker:"Kai Drake",text:"  ,    .    .",emotion:"happy",characterImage:"characters/kai_drake"},{speaker:"Seraphina",text:"    .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Kai Drake",text:"        .    .",emotion:"normal",characterImage:"characters/kai_drake"}],postVictory:[{speaker:"Kai Drake",text:".      .",emotion:"happy",characterImage:"characters/kai_drake"},{speaker:"Seraphina",text:"   .   .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Kai Drake",text:".     .",emotion:"normal",characterImage:"characters/kai_drake"},{speaker:"Seraphina",text:" .     .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:40,name:" ",theme:"Cult",recommendedPower:860,firstReward:{gold:2500,shards:25},repeatReward:{gold:1250,shards:15},cleared:!1,story:{description:"    .    .",backgroundImage:"backgrounds/stage_40_cult.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Dark Cult Leader",text:"  ,      ...  ?",emotion:"normal"},{speaker:"Seraphina",text:"     .",emotion:"angry",characterImage:"characters/seraphina_belmont"},{speaker:"Dark Cult Leader",text:"    .    ,   .",emotion:"angry"}],postVictory:[{speaker:"Dark Cult Leader",text:"...    ...      ...",emotion:"sad"},{speaker:"Seraphina",text:"   .   .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Dark Cult Leader",text:"    .    ...",emotion:"happy"},{speaker:"Seraphina",text:"  .      .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:41,name:" ",theme:"Invasion",recommendedPower:880,firstReward:{gold:2600,shards:26},repeatReward:{gold:1300,shards:15},cleared:!1,story:{description:"   .     .",backgroundImage:"backgrounds/stage_41_invasion.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Leon Ardenia",text:"    .    .",emotion:"angry",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"  .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:"    .    .",emotion:"normal",characterImage:"characters/darius_blackwood"}],postVictory:[{speaker:"Leon Ardenia",text:" .    .",emotion:"happy",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"   .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Leon Ardenia",text:" !  !",emotion:"angry",characterImage:"characters/leon_ardenia"},{speaker:"Seraphina",text:"...   .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:42,name:" ",theme:"Garen4",recommendedPower:920,firstReward:{gold:2800,shards:28},repeatReward:{gold:1400,shards:17},cleared:!1,story:{description:" Garen      .     .",backgroundImage:"backgrounds/stage_42_corrupted_stone.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/garen_stone.png",cutscene:{preBattle:[{speaker:"Garen Stone",text:"......  ... ...",emotion:"sad",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"Garen !  .  !",emotion:"sad",characterImage:"characters/seraphina_belmont"},{speaker:"Garen Stone",text:"      ...    ...",emotion:"angry",characterImage:"characters/garen_stone"}],postVictory:[{speaker:"Garen Stone",text:"......  ...",emotion:"happy",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"  .     .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Garen Stone",text:"...   ...",emotion:"angry",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"...    .  !",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:43,name:" ",theme:"Darius3",recommendedPower:960,firstReward:{gold:3e3,shards:30},repeatReward:{gold:1500,shards:18},cleared:!1,story:{description:"      .      .",backgroundImage:"backgrounds/stage_43_absolute_darkness.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/darius_blackwood.png",cutscene:{preBattle:[{speaker:"Darius Blackwood",text:"    .        .",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"       .   .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Darius Blackwood",text:"       .     .",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"   .       .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Darius Blackwood",text:".        .     .",emotion:"happy",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:"  ,    .        .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Darius Blackwood",text:"    .    .",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Seraphina",text:" ...       .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:44,name:"Elena ",theme:"Elena2",recommendedPower:1e3,firstReward:{gold:3200,shards:32},repeatReward:{gold:1600,shards:20},cleared:!1,story:{description:" Elena   .     .",backgroundImage:"backgrounds/stage_44_corruption_prison.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/elena_drake.png",cutscene:{preBattle:[{speaker:"Elena Drake",text:"... ... ...   ...",emotion:"sad",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:"Elena!   .   .",emotion:"sad",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Elena Drake",text:"... .      .",emotion:"happy",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:".    .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Elena Drake",text:"... ... ...",emotion:"angry",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:"  !  !",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:45,name:" ",theme:"CultFinal",recommendedPower:1050,firstReward:{gold:3600,shards:36},repeatReward:{gold:1800,shards:22},cleared:!1,story:{description:"   .        .",backgroundImage:"backgrounds/stage_45_cult_final.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Dark Cult Leader",text:"    .      .",emotion:"angry"},{speaker:"Seraphina",text:"   .     .",emotion:"determined",characterImage:"characters/seraphina_belmont"},{speaker:"Dark Cult Leader",text:"      .    .",emotion:"angry"},{speaker:"Seraphina",text:"  ,       .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Dark Cult Leader",text:" ... ...  ...!",emotion:"sad"},{speaker:"Seraphina",text:" .       .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Dark Cult Leader",text:" ...     .",emotion:"happy"},{speaker:"Seraphina",text:"   .     .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:46,name:"",theme:"Mastermind",recommendedPower:1100,firstReward:{gold:3900,shards:39},repeatReward:{gold:1950,shards:24},cleared:!1,story:{description:"      Xander .      .",backgroundImage:"backgrounds/stage_46_mastermind.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Mastermind Xander",text:" , .         .",emotion:"normal"},{speaker:"Seraphina",text:"     ,     .",emotion:"angry",characterImage:"characters/seraphina_belmont"},{speaker:"Mastermind Xander",text:"   ,   .     .",emotion:"angry"},{speaker:"Seraphina",text:"       .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Mastermind Xander",text:"...   ...      ...",emotion:"sad"},{speaker:"Seraphina",text:"         .      .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Mastermind Xander",text:".     .  , .",emotion:"happy"},{speaker:"Seraphina",text:"    .    .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:47,name:"",theme:"Corrupted",recommendedPower:1150,firstReward:{gold:4200,shards:42},repeatReward:{gold:2100,shards:28},cleared:!1,story:{description:"    . Garen, Darius, Elena    .",backgroundImage:"backgrounds/stage_47_corrupted_gathering.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Garen Stone",text:"...    .    .",emotion:"normal",characterImage:"characters/garen_stone"},{speaker:"Darius Blackwood",text:"       .",emotion:"normal",characterImage:"characters/darius_blackwood"},{speaker:"Elena Drake",text:"...     .",emotion:"sad",characterImage:"characters/elena_drake"},{speaker:"Seraphina",text:" .    .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Garen Stone",text:"   .    .",emotion:"happy",characterImage:"characters/garen_stone"},{speaker:"Darius Blackwood",text:"     .",emotion:"happy",characterImage:"characters/darius_blackwood"},{speaker:"Elena Drake",text:"!    !",emotion:"happy",characterImage:"characters/elena_drake"}],postDefeat:[{speaker:"Garen Stone",text:"   ...  .",emotion:"normal",characterImage:"characters/garen_stone"},{speaker:"Seraphina",text:"  .   .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:48,name:" ",theme:"Elder2",recommendedPower:1200,firstReward:{gold:4600,shards:46},repeatReward:{gold:2300,shards:30},cleared:!1,story:{description:"     .     .",backgroundImage:"backgrounds/stage_48_elder_cooperation.webp"},characterImage:"characters/seraphina_belmont.png",enemyImage:"characters/elder_belmont.png",cutscene:{preBattle:[{speaker:"Elder Belmont",text:",     .   .",emotion:"normal",characterImage:"characters/elder_belmont"},{speaker:"Seraphina",text:"     .",emotion:"happy",characterImage:"characters/seraphina_belmont"},{speaker:"Elder Belmont",text:"   .      .",emotion:"happy",characterImage:"characters/elder_belmont"}],postVictory:[{speaker:"Elder Belmont",text:".       .",emotion:"happy",characterImage:"characters/elder_belmont"},{speaker:"Seraphina",text:"   .",emotion:"determined",characterImage:"characters/seraphina_belmont"}],postDefeat:[{speaker:"Elder Belmont",text:".     .",emotion:"normal",characterImage:"characters/elder_belmont"},{speaker:"Seraphina",text:"   .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:49,name:" ",theme:"Family",recommendedPower:1250,firstReward:{gold:5e3,shards:50},repeatReward:{gold:2500,shards:33},cleared:!1,story:{description:" Ariana     .    .",backgroundImage:"backgrounds/stage_49_family.webp"},characterImage:"characters/seraphina_belmont.png",cutscene:{preBattle:[{speaker:"Kai Drake",text:"   .     .",emotion:"happy",characterImage:"characters/kai_drake"},{speaker:"Ariana",text:"   ,    .",emotion:"happy",characterImage:"characters/ariana_drake"},{speaker:"Seraphina",text:"  .    .",emotion:"happy",characterImage:"characters/seraphina_belmont"}],postVictory:[{speaker:"Kai Drake",text:"   .  .",emotion:"happy",characterImage:"characters/kai_drake"},{speaker:"Ariana",text:"  , Seraphina.",emotion:"happy",characterImage:"characters/ariana_drake"}],postDefeat:[{speaker:"Kai Drake",text:".     .",emotion:"normal",characterImage:"characters/kai_drake"},{speaker:"Seraphina",text:".      .",emotion:"sad",characterImage:"characters/seraphina_belmont"}]}},{id:50,name:" ",theme:"Void",recommendedPower:1500,firstReward:{gold:6e3,shards:60},repeatReward:{gold:3e3,shards:40},cleared:!1,story:{description:"    .      .",backgroundImage:"backgrounds/stage_50_void_emperor.webp"}}],completedStageIds:[],dailyDungeon:{dateKey:"",floors:[],currentFloorId:null,completed:!1},currentDailyFloorId:null,currentStage:null,battleContext:{type:null,campaignStageId:null,dailyFloorId:null,pvpMatchId:null,pvpSeed:null},postBattleScreen:null,selectStage:t=>{r({currentStage:t,currentDailyFloorId:null,battleContext:{type:"campaign",campaignStageId:t,dailyFloorId:null,pvpMatchId:null,pvpSeed:null},postBattleScreen:"campaign"})},clearStage:t=>{const s=e().campaignStages,n=s.map(i=>i.id===t?{...i,cleared:!0}:i),a=s.find(i=>i.id===t);if(a){r(l=>l.completedStageIds.includes(t)?{}:{completedStageIds:[...l.completedStageIds,t].sort((d,u)=>d-u)});const i=a.cleared,o=i?a.repeatReward:a.firstReward,c=Ip(o,t,i);r({campaignStages:n,pendingReward:{gold:c.gold,shards:c.shards,cards:[]}}),typeof window<"u"&&window.dispatchEvent(new Event("cloud-save-force"))}},ensureDailyDungeon:()=>{const t=e(),s=xd();if(t.dailyDungeon.dateKey===s&&t.dailyDungeon.floors.length>0)return;const n=wd(s,t.campaignStages);r({dailyDungeon:{dateKey:s,floors:n,currentFloorId:null,completed:n.every(a=>a.cleared)},currentDailyFloorId:null})},resetDailyDungeon:()=>{const t=xd(),s=wd(t,e().campaignStages);r({dailyDungeon:{dateKey:t,floors:s,currentFloorId:null,completed:!1},currentDailyFloorId:null})},enterDailyDungeonFloor:t=>{e().ensureDailyDungeon();const n=e().dailyDungeon,a=n.floors.findIndex(o=>o.id===t);if(a===-1){console.warn(`[DailyDungeon] Floor not found: ${t}`);return}if(a>0&&!n.floors[a-1].cleared){console.warn(`[DailyDungeon] Floor ${t} is locked. Previous floor not cleared.`);return}const i=n.floors[a];r({currentDailyFloorId:t,currentStage:i.stageId,battleContext:{type:"daily",campaignStageId:i.stageId,dailyFloorId:t,pvpMatchId:null,pvpSeed:null},postBattleScreen:"daily",dailyDungeon:{...n,currentFloorId:t}}),e().setGameScreen("battle")},completeDailyFloor:t=>{const n=e().dailyDungeon,a=n.floors.map(c=>c.id===t?{...c,cleared:!0}:c),i=a.find(c=>c.id===t);if(!i)return;const o=a.every(c=>c.cleared);r({dailyDungeon:{dateKey:n.dateKey,floors:a,currentFloorId:null,completed:o},currentDailyFloorId:null,currentStage:null,battleContext:{type:null,campaignStageId:null,dailyFloorId:null,pvpMatchId:null,pvpSeed:null},pendingReward:{gold:i.reward.gold,shards:i.reward.shards,cards:[]}})},handleBattleDefeatNavigation:()=>{const t=e().postBattleScreen;t==="daily"?(r(s=>({currentStage:null,currentDailyFloorId:null,dailyDungeon:{...s.dailyDungeon,currentFloorId:null},battleContext:{type:null,campaignStageId:null,dailyFloorId:null,pvpMatchId:null,pvpSeed:null},postBattleScreen:null})),e().setGameScreen("daily")):(r({battleContext:{type:null,campaignStageId:null,dailyFloorId:null,pvpMatchId:null,pvpSeed:null},postBattleScreen:null}),e().setGameScreen(t??"campaign"))},navigateAfterReward:()=>{const t=e().postBattleScreen;r({postBattleScreen:null}),t==="daily"?e().setGameScreen("daily"):(r({battleContext:{type:null,campaignStageId:null,dailyFloorId:null,pvpMatchId:null,pvpSeed:null}}),e().setGameScreen("campaign"))},pendingReward:null,claimReward:()=>{const t=e().pendingReward;t&&(e().addGold(t.gold),e().addShards(t.shards),r({pendingReward:null}),typeof window<"u"&&window.dispatchEvent(new Event("cloud-save-force")),console.log("[Reward] Claimed!"))},playerDeck:[],collection:[],allCardsPool:[],setCollection:t=>{if(r({collection:t}),e().playerDeck.length===0){const n=e().allCardsPool;if(n.length>0){const a=vd(n);r({playerDeck:a}),console.log("[Deck] Auto-generated initial deck (20 cards)")}else if(t.length>=20){const a=vd(t);r({playerDeck:a}),console.log("[Deck] Auto-generated initial deck from collection (20 cards)")}}ts()},setAllCardsPool:t=>{r({allCardsPool:t}),console.log(`[Shop] All cards pool set: ${t.length} cards`)},addCardToDeck:t=>{const s=e(),n=s.playerDeck;if(n.length>=20)return console.warn("[Deck] Cannot add card: deck is full (20/20)"),!1;const a=Or(t.id),i=n.filter(c=>Or(c.id)===a).length;if(i>=3)return console.warn(`[Deck] Cannot add card: ${t.name} already has 3 copies`),!1;const o=s.collection.filter(c=>Or(c.id)===a).length;return i>=o?(console.warn(`[Deck] Cannot add card: ${t.name} owned ${o}, already in deck ${i}`),!1):t.rarity==="Legendary"&&n.filter(l=>l.rarity==="Legendary").length>=1?(console.warn("[Deck] Cannot add card: Legendary limit (1) reached"),!1):(r({playerDeck:[...n,t]}),_d(),!0)},removeCardFromDeck:t=>{const n=e().playerDeck,a=n.findIndex(o=>o.id===t);if(a===-1){console.warn("[Deck] Cannot remove card: not found in deck");return}const i=[...n];i.splice(a,1),r({playerDeck:i}),_d()},getDeckValidity:()=>{const s=e().playerDeck,n=[];s.length<20?n.push(` ${20-s.length}  (${s.length}/20)`):s.length>20&&n.push(` ${s.length-20}  (${s.length}/20)`);const a=new Map;s.forEach(o=>{const c=Or(o.id),l=a.get(c)||0;a.set(c,l+1)}),a.forEach((o,c)=>{if(o>3){const l=s.find(h=>Or(h.id)===c);n.push(`${(l==null?void 0:l.name)||c}:    3 ( ${o})`)}});const i=s.filter(o=>o.rarity==="Legendary");return i.length>1&&n.push(`Legendary  1  ( ${i.length})`),{valid:n.length===0,errors:n}},energy:3,enemyEnergy:3,round:1,roundSeed:Math.floor(Math.random()*1e6),playerHp:100,playerMaxHp:100,enemyHp:100,enemyMaxHp:100,playerStatus:{...Ka},enemyStatus:{...Ka},gameOver:"none",deck:[],hand:[],discard:[],enemyDeck:[],enemyHand:[],enemyDiscard:[],logs:[],logIdCounter:0,declarationLocked:!1,isTurnProcessing:!1,playerQueue:[],enemyQueue:[],queuedHandIndices:[],getPendingCost:()=>e().playerQueue.reduce((t,s)=>{var n;return t+(((n=s.card)==null?void 0:n.cost)??0)},0),getRemainingEnergy:()=>{const t=e();return Math.max(0,t.energy-t.playerQueue.reduce((s,n)=>{var a;return s+(((a=n.card)==null?void 0:a.cost)??0)},0))},addLog:(t,s="system")=>{const n=e(),a={id:n.logIdCounter++,message:t,type:s,timestamp:Date.now()},i=[...n.logs,a].slice(-100);r({logs:i})},applyStatus:(t,s,n=1,a=1,i=100,o=0)=>{const c=e();if(c.gameOver!=="none")return;const l=t==="player"?c.playerStatus:c.enemyStatus;if(l.immuneKeywords.includes(s)){e().addLog(` ${t==="player"?"":""} : ${s}  `,"effect");return}const h=c.battleContext.type==="pvp";if(i<100){if(h){const g=c.pvpRandomCounter,m=yv(c.roundSeed,g)*100;if(r({pvpRandomCounter:g+1}),m>=i){e().addLog(`${t==="player"?"":""}   : ${s} (${i}%)`,"effect");return}}else if(Math.random()*100>=i){e().addLog(`${t==="player"?"":""}   : ${s} (${i}%)`,"effect");return}}const d=l.statuses.findIndex(g=>g.key===s);let u=[...l.statuses];if(d>=0){const g=u[d];s==="Burn"?(g.stacks=Math.min(3,(g.stacks||1)+(n||1)),g.duration=Math.max(g.duration,a)):(g.duration=Math.max(g.duration,a),n&&(g.stacks=n),o&&(g.value=o)),u[d]=g}else u.push({key:s,stacks:n,duration:a,chance:i,value:o});const f={...l,statuses:u};s==="Vulnerable"&&o>0&&(f.vulnerable=Math.max(f.vulnerable,a)),r(t==="player"?{playerStatus:f}:{enemyStatus:f});const p={Burn:"",Freeze:"",Shock:"",Vulnerable:""};e().addLog(`${t==="player"?"":""} : ${p[s]||s}${n&&n>1?` (${n})`:""} (${a})`,"effect")},_tickEntityStatus:(t,s)=>{const n=t==="player"?"":" ",a={...s},i=[];for(const c of s.statuses){if(c.key==="Burn"&&c.stacks){const h=10*c.stacks;e().dealDamage(t,h),e().addLog(` ${n} : ${h} (${c.stacks}, ${c.duration} )`,"effect"),Yr("burn",t)}else if(c.key==="Poison"&&c.value){const h=c.value;e().dealDamage(t,h),e().addLog(` ${n} : ${h} (${c.duration} )`,"effect"),Yr("vulnerable",t)}else if(c.key==="Regen"){const h=s.regen||0;h>0&&(e().heal(t,h),e().addLog(` ${n} : +${h}`,"effect"))}const l=c.duration-1;l>0?i.push({...c,duration:l}):e().addLog(`${n}${c.key}  `,"effect")}a.statuses=i;const o=i.find(c=>c.key==="Vulnerable");return a.vulnerable=o?o.duration:0,a.guardDuration>0&&(a.guardDuration-=1,a.guardDuration===0&&a.guard>0&&(a.guard=0,e().addLog(`${n}  `,"effect"))),a.shieldDuration>0&&(a.shieldDuration-=1,a.shieldDuration===0&&a.shield>0&&(a.shield=0,e().addLog(`${n}  `,"effect"))),a.evasionDuration>0&&(a.evasionDuration-=1,a.evasionDuration===0&&a.evasionCharges>0&&(a.evasionCharges=0,e().addLog(`${n}  `,"effect"))),a.counterDuration>0&&(a.counterDuration-=1,a.counterDuration===0&&(a.counterValue=0,e().addLog(`${n}  `,"effect"))),a.immuneDuration>0&&(a.immuneDuration-=1,a.immuneDuration===0&&(a.immuneKeywords=[],e().addLog(`${n}  `,"effect"))),a},processStatusEffects:(t="both")=>{const s=e();if(s.gameOver!=="none")return;const n=t==="both"||t==="enemyEnd",a=t==="both"||t==="playerEnd",i=t==="playerEnd"?"   ( )":t==="enemyEnd"?"   ( )":"  ";if(e().addLog(` ${i} `,"system"),n){const l=s.playerStatus.statuses.filter(h=>h.key==="Burn");l.length>0&&e().addLog(`    Burn: ${l.map(h=>`${h.stacks} ${h.duration}`).join(", ")}`,"system")}if(a){const l=s.enemyStatus.statuses.filter(h=>h.key==="Burn");l.length>0&&e().addLog(`    Burn: ${l.map(h=>`${h.stacks} ${h.duration}`).join(", ")}`,"system")}const o={};n&&(o.playerStatus=e()._tickEntityStatus("player",s.playerStatus)),a&&(o.enemyStatus=e()._tickEntityStatus("enemy",s.enemyStatus)),Object.keys(o).length>0&&r(o);const c=t==="playerEnd"?"   ( )":t==="enemyEnd"?"   ( )":"  ";e().addLog(` ${c} `,"system")},checkGameOver:()=>{const t=e();if(console.log(`[CheckGameOver]  Called - playerHp: ${t.playerHp}, enemyHp: ${t.enemyHp}, gameOver: ${t.gameOver}, hand: ${t.hand.length}, enemyHand: ${t.enemyHand.length}`),t.gameOver!=="none"){console.log("[CheckGameOver]  Already over, skipping");return}if(t.playerHp<=0)console.log(`[CheckGameOver]  DEFEAT - playerHp: ${t.playerHp}, hand: ${t.hand.length}, enemyHand: ${t.enemyHand.length}`),r({gameOver:"defeat"}),e().addLog("!  HP 0 .","system"),e().exportReplay(),Yr("defeat","center"),t.battleContext.type==="pvp"&&(e().stopPvpTurnTimer(!0),e().reportPvpResult("defeat")),t.battleContext.type==="daily"&&r(s=>({dailyDungeon:{...s.dailyDungeon,currentFloorId:null},currentDailyFloorId:null}));else if(t.enemyHp<=0){console.log(`[CheckGameOver]  VICTORY - enemyHp: ${t.enemyHp}`),r({gameOver:"victory"}),e().addLog("!  HP 0 .","system"),e().exportReplay(),Yr("victory","center"),t.battleContext.type==="pvp"&&(e().stopPvpTurnTimer(!0),e().reportPvpResult("victory"));const s=t.battleContext;s.type==="campaign"&&t.currentStage!==null?e().clearStage(t.currentStage):s.type==="daily"&&t.currentDailyFloorId!==null&&e().completeDailyFloor(t.currentDailyFloorId)}},dealDamage:(t,s,n=!1)=>{const a=e();if(a.gameOver!=="none")return;const i=t==="player"?a.playerStatus:a.enemyStatus;if(i.evasionCharges>0){i.evasionCharges-=1;const d={...i};r(t==="player"?{playerStatus:d}:{enemyStatus:d}),e().addLog(`${t==="player"?"":""} !   ( : ${i.evasionCharges})`,"effect"),i.evasionCharges===0&&e().addLog(`${t==="player"?"":""}  `,"effect");return}let o=s;const c=i.vulnerable>0||i.statuses.some(d=>d.key==="Vulnerable"&&d.duration>0);c&&(o=Math.floor(s*1.2)),i.guard>0&&(o=Math.max(0,o-i.guard));let l=i.shield,h=o;if(l>0){o<=l?(l-=o,h=0):(h=o-l,l=0);const d={...i,shield:l};r(t==="player"?{playerStatus:d}:{enemyStatus:d}),o>0&&e().addLog(`${t==="player"?"":""} : ${i.shield}  ${l}`,"effect")}if(t==="player"){const d=Math.max(0,a.playerHp-h);r({playerHp:d});const u=c?`  ${o} ( +20%)`:"",f=i.guard>0?`  ${o} ( -${i.guard})`:"",p=l>0?`  ${h} ( ${i.shield}${l})`:"";if(e().addLog(` : ${h} (: ${s}${u}${f}${p}) (HP: ${d}/${a.playerMaxHp})`,"effect"),h>0&&Yr("damage","player",h),h>0&&a.playerStatus.counterValue>0){const g=a.playerStatus.counterValue;e().addLog(`  !  ${g} `,"effect"),e().dealDamage("enemy",g,!0)}}else{const d=Math.max(0,a.enemyHp-h);r({enemyHp:d});const u=c?`  ${o} ( +20%)`:"",f=i.guard>0?`  ${o} ( -${i.guard})`:"",p=l>0?`  ${h} ( ${i.shield}${l})`:"";if(e().addLog(` : ${h} (: ${s}${u}${f}${p}) (HP: ${d}/${a.enemyMaxHp})`,"effect"),h>0&&Yr("damage","enemy",h),h>0&&a.enemyStatus.counterValue>0){const g=a.enemyStatus.counterValue;e().addLog(`   !  ${g} `,"effect"),e().dealDamage("player",g,!0)}}n||e().checkGameOver()},heal:(t,s)=>{const n=e();if(t==="player"){const a=Math.min(n.playerMaxHp,n.playerHp+s);r({playerHp:a}),e().addLog(` : ${s} (HP: ${a}/${n.playerMaxHp})`,"effect"),Yr("heal","player",s)}else{const a=Math.min(n.enemyMaxHp,n.enemyHp+s);r({enemyHp:a}),e().addLog(` : ${s} (HP: ${a}/${n.enemyMaxHp})`,"effect")}},initGame:t=>{var u,f;const s=e();console.log(`[InitGame]  Starting - BEFORE: playerHp: ${s.playerHp}, enemyHp: ${s.enemyHp}, gameOver: ${s.gameOver}, hand: ${s.hand.length}, enemyHand: ${s.enemyHand.length}`);let n=[...s.playerDeck];n.length!==20&&(console.warn("[Battle] playerDeck is invalid, generating random deck"),n=[...t].sort(()=>Math.random()-.5).slice(0,20)),n=n.sort(()=>Math.random()-.5);const a=s.currentStage;let i;const o=s.battleContext.type==="pvp"&&!!s.pvpMatch;o?i=(f=(u=s.pvpMatch)==null?void 0:u.opponentDeckCards)!=null&&f.length?[...s.pvpMatch.opponentDeckCards]:[]:a?i=Av(a,t,s.campaignStages):i=Ap(t);const c=o?s.pvpMatch.seed:Math.floor(Math.random()*1e6),l=o?bd(c,1):c;Ga!==null&&(clearTimeout(Ga),Ga=null,console.log("[Battle] Cleared enemyTurnTimer1")),za!==null&&(clearTimeout(za),za=null,console.log("[Battle] Cleared enemyTurnTimer2")),Va!==null&&(clearTimeout(Va),Va=null,console.log("[Battle] Cleared enemyTurnTimer3")),Wa!==null&&(clearTimeout(Wa),Wa=null,console.log("[Battle] Cleared endTurnTimer")),Cc&&(console.log("[Battle] Resetting hand tracking"),Cc()),r({deck:n,discard:[],enemyDeck:i,enemyDiscard:[],hand:[],enemyHand:[],energy:3,enemyEnergy:3,round:1,roundSeed:l,playerHp:100,playerMaxHp:100,enemyHp:100,enemyMaxHp:100,playerStatus:{...Ka},enemyStatus:{...Ka},gameOver:"none",logs:[],logIdCounter:0,declarationLocked:!1,isTurnProcessing:!1,playerQueue:[],enemyQueue:[],queuedHandIndices:[],replayHistory:[],pvpRandomCounter:0,pvpLastResolvedRound:0,pvpLocalSubmissionRound:null,pvpRemoteSubmission:null,pvpLocalReady:!1,pvpOpponentReady:!1,pvpTurnTimeLeft:o?e().pvpTurnDuration||wn:null,pvpTurnTimerActive:!1});const h=e().battleContext;if(h.type==="daily"&&h.dailyFloorId!==null){const g=e().dailyDungeon.floors.find(m=>m.id===h.dailyFloorId);if(g){let m=0,_=0,b=0,x=0;const S=[];if(g.modifiers.forEach(T=>{switch(T.type){case"playerEnergy":m+=Number(T.value)||0;break;case"enemyEnergy":_+=Number(T.value)||0;break;case"playerShield":b+=Number(T.value)||0;break;case"enemyShield":x+=Number(T.value)||0;break;case"rule":S.push(String(T.description));break}}),m!==0&&(r(T=>({energy:Math.max(0,T.energy+m)})),e().addLog(`   :   +${m}`,"system")),_!==0&&(r(T=>({enemyEnergy:Math.max(0,T.enemyEnergy+_)})),e().addLog(`   :   +${_}`,"system")),b>0){const T=e().playerStatus;r({playerStatus:{...T,shield:T.shield+b}}),e().addLog(`   :   +${b}`,"system")}if(x>0){const T=e().enemyStatus;r({enemyStatus:{...T,shield:T.shield+x}}),e().addLog(`   :   +${x}`,"system")}S.forEach(T=>{e().addLog(`  : ${T}`,"system")})}}const d=e();console.log(`[InitGame]  After init - playerHp: ${d.playerHp}, enemyHp: ${d.enemyHp}, gameOver: ${d.gameOver}, hand: ${d.hand.length}, enemyHand: ${d.enemyHand.length}`),e().addLog(`  -  : ${l}`,"system"),e().drawInitial(5),e().enemyDrawInitial(5),o?(e().addLog(" 5 .","system"),e().startPvpTurnTimer(!0)):e().addLog("   5 ","system")},declareCard:t=>{const s=e();if(s.gameOver!=="none"||s.declarationLocked||s.isTurnProcessing||s.battleContext.type==="pvp"&&s.pvpLocalSubmissionRound===s.round)return!1;const n=s.hand[t];if(!n||s.playerQueue.some(c=>c.handIndex===t))return!1;const a=e().getRemainingEnergy();if(n.cost>a)return e().addLog(` : ${n.name}   (: ${n.cost}, : ${a})`,"system"),!1;const i=[...s.playerQueue,{handIndex:t,card:n}],o=[...s.queuedHandIndices,t];return r({playerQueue:i,queuedHandIndices:o}),e().addLog(`: ${n.name} ( ${n.cost})`,"system"),!0},unDeclareCard:t=>{const s=e(),n=s.playerQueue.find(o=>o.handIndex===t);if(!n)return;const a=s.playerQueue.filter(o=>o.handIndex!==t),i=s.queuedHandIndices.filter(o=>o!==t);r({playerQueue:a,queuedHandIndices:i}),e().addLog(` : ${n.card.name}`,"system")},lockIn:()=>{e().gameOver==="none"&&(r({declarationLocked:!0}),e().addLog(" ","system"))},revealAndResolve:async()=>{const t=e();if(t.gameOver!=="none")return;if(!t.declarationLocked){e().addLog("  ","system");return}const s=d=>new Promise(u=>window.setTimeout(u,d));e().addLog(`  ${t.round} : ${t.roundSeed}`,"system");const n={Special:3,Attack:2,Defense:1,Heal:0},a=d=>n[d]??0,i=e(),o=i.playerQueue.map(d=>{const u=i.hand.findIndex(f=>f.id===d.card.id);return{who:"player",card:d.card,handIndex:u}}).filter(d=>d.handIndex>=0),c=i.enemyQueue.map(d=>({who:"enemy",card:d.card})),l=[...o,...c].map((d,u)=>({...d,priority:a(d.card.type),originalIndex:u})).sort((d,u)=>{if(d.priority!==u.priority)return u.priority-d.priority;if(d.card.cost!==u.card.cost)return u.card.cost-d.card.cost;const f=(i.roundSeed+d.originalIndex)%1e3;return(i.roundSeed+u.originalIndex)%1e3-f});e().addLog(`: ${l.length}   ( )`,"system"),await s(500),l.forEach((d,u)=>{const f={Special:"",Attack:"",Defense:"",Heal:""}[d.card.type]||d.card.type,p=d.who==="player"?"":"";e().addLog(`  ${u+1}: ${p} [${f}/${d.card.cost}] ${d.card.name}`,"system")}),await s(300);for(let d=0;d<l.length;d++){const u=l[d];if(u.who==="player"){const f=e(),p=f.hand.findIndex(g=>g.id===u.card.id);f.energy>=u.card.cost&&p>=0?(e().addLog(`  : ${u.card.name} ( ${u.card.cost})`,"card-play"),await Xa(u.card,!0,p),e().playCard(p)||e().addLog(`: ${u.card.name}  `,"system"),await s(600)):p<0?e().addLog(`: ${u.card.name}()  `,"system"):e().addLog(` : ${u.card.name}   (: ${u.card.cost}, : ${f.energy})`,"system")}else e().enemyEnergy>=u.card.cost&&(e().addLog(`  : ${u.card.name} ( ${u.card.cost})`,"card-play"),await Xa(u.card,!1,-1),e().playEnemyCard(u.card),await s(600))}await s(300),r({declarationLocked:!1,playerQueue:[],enemyQueue:[],queuedHandIndices:[]}),e().addLog(" / ","system");const h=e();e().recordReplayAction({round:h.round,seed:h.roundSeed,player:o.map(d=>({cardId:d.card.id,cardName:d.card.name})),enemy:c.map(d=>({cardId:d.card.id,cardName:d.card.name})),resultHp:{player:h.playerHp,enemy:h.enemyHp}})},drawInitial:t=>{console.log(`[DrawInitial]  drawInitial() called with count: ${t}, current hand: ${e().hand.length}`);let{deck:s,discard:n}=e();const a=[],i=[];let o=[...s],c=[...n];const l=10;for(let u=0;u<t&&a.length+i.length<l&&(o.length===0&&c.length>0&&(o=[...c].sort(()=>Math.random()-.5),c=[],e().addLog(` : ${o.length}`,"system")),o.length>0);u++)i.push(o.shift());const h=a.length;console.log(`[DrawInitial]  set() BEFORE - hand: ${h}, drawn: ${i.length}, newHand will be: ${h+i.length}`),r({deck:o,hand:[...a,...i],discard:c});const d=e().hand.length;console.log(`[DrawInitial]  set() AFTER - hand: ${d}`),i.length>0&&e().addLog(`: ${i.length}`,"system")},draw:t=>{console.log(`[Draw]  draw() called with count: ${t}, current hand: ${e().hand.length}`);let{deck:s,hand:n,discard:a}=e();const i=[];let o=[...s],c=[...a];const l=10;for(let f=0;f<t&&n.length+i.length<l&&(o.length===0&&c.length>0&&(o=[...c].sort(()=>Math.random()-.5),c=[],e().addLog(` : ${o.length}`,"system")),o.length>0);f++)i.push(o.shift());const h=t-i.length;if(h>0&&o.length>0){const f=[];for(let p=0;p<h&&o.length>0;p++)f.push(o.shift());c=[...c,...f],f.length>0&&e().addLog(`  : ${f.length} `,"system")}const d=n.length;console.log(`[Draw]  set() BEFORE - hand: ${d}, drawn: ${i.length}, newHand will be: ${d+i.length}`),r({deck:o,hand:[...n,...i],discard:c});const u=e().hand.length;console.log(`[Draw]  set() AFTER - hand: ${u}`),i.length>0&&e().addLog(`: ${i.length}`,"system")},enemyDrawInitial:t=>{let{enemyDeck:s,enemyDiscard:n}=e();const a=[],i=[];let o=[...s],c=[...n];const l=10;for(let u=0;u<t&&a.length+i.length<l&&(o.length===0&&c.length>0&&(o=[...c].sort(()=>Math.random()-.5),c=[],e().addLog(`  : ${o.length}`,"system")),o.length>0);u++)i.push(o.shift());const h=a.length;console.log(`[EnemyDrawInitial]  set() BEFORE - enemyHand: ${h}, drawn: ${i.length}, newEnemyHand will be: ${h+i.length}`),r({enemyDeck:o,enemyHand:[...a,...i],enemyDiscard:c}),qa(),qa();const d=e().enemyHand.length;console.log(`[EnemyDrawInitial]  set() AFTER - enemyHand: ${d}`),i.length>0&&e().addLog(` : ${i.length}`,"system")},enemyDraw:t=>{let{enemyDeck:s,enemyHand:n,enemyDiscard:a}=e();const i=[];let o=[...s],c=[...a];const l=10;for(let f=0;f<t&&n.length+i.length<l&&(o.length===0&&c.length>0&&(o=[...c].sort(()=>Math.random()-.5),c=[],e().addLog(`  : ${o.length}`,"system")),o.length>0);f++)i.push(o.shift());const h=t-i.length;if(h>0&&o.length>0){const f=[];for(let p=0;p<h&&o.length>0;p++)f.push(o.shift());c=[...c,...f],f.length>0&&e().addLog(`   : ${f.length} `,"system")}const d=n.length;console.log(`[EnemyDraw]  set() BEFORE - enemyHand: ${d}, drawn: ${i.length}, newEnemyHand will be: ${d+i.length}`),r({enemyDeck:o,enemyHand:[...n,...i],enemyDiscard:c});const u=e().enemyHand.length;console.log(`[EnemyDraw]  set() AFTER - enemyHand: ${u}`),i.length>0&&e().addLog(` : ${i.length}`,"system")},playCard:t=>{const s=e();if(s.gameOver!=="none")return!1;const n=s.hand[t];if(!n||s.energy<n.cost)return!1;if(s.enemyStatus.nullifyCharges>0){const c=s.energy-n.cost,l=s.hand.filter((u,f)=>f!==t),h=[...s.discard,n],d={...s.enemyStatus};return d.nullifyCharges-=1,r({energy:c,hand:l,discard:h,enemyStatus:d}),e().addLog(` : ${n.name} ( ${n.cost})`,"card-play"),e().addLog(` !     ( : ${d.nullifyCharges})`,"effect"),!0}const a=s.energy-n.cost,i=s.hand.filter((c,l)=>l!==t),o=[...s.discard,n];if(r({energy:a,hand:i,discard:o}),e().addLog(` : ${n.name} ( ${n.cost})`,"card-play"),n.effects.forEach((c,l)=>{if(c){if(c.type==="Draw"){const h=Number(c.value??0);h>0&&(e().draw(h),e().addLog(`:  ${h}`,"effect"))}else if(c.type==="GainAction"){const h=Number(c.value??0);h>0&&(r({energy:e().energy+h}),e().addLog(`:  +${h}`,"effect"))}else if(c.type==="Damage"){const h=Number(c.value??0);if(h>0){let d=h;if(n.type==="Attack"){const g=s.playerStatus.attackBuff||0;g>0&&(d=Math.floor(h*(1+g/100)));const m=e(),_=m.enemyStatus.shockStacks||0;if(_>0){let b=0,x=0;if(_>=3?(b=.9,x=.5):_===2?(b=.6,x=.4):(b=.3,x=.3),(m.roundSeed+d+_)%100/100<b){const T=Math.floor(d*x);e().addLog(`  ! (${_}, ${Math.floor(b*100)}% )  : ${T}`,"effect"),e().dealDamage("enemy",T,!1);const C={...e().enemyStatus};C.shockStacks=Math.max(0,_-1),r({enemyStatus:C})}else e().addLog(`   (${_}, ${Math.floor(b*100)}% )`,"effect")}}const f=n.effects.slice(l+1).filter(g=>g.type==="Damage").length===0;c.aoe===!0?(e().dealDamage("enemy",d,!f),e().addLog(` :  ${d}`,"effect")):e().dealDamage(n.type==="Attack"?"enemy":"player",d,!f)}}else if(c.type==="Heal"){const h=Number(c.value??0),d=c.aoe===!0;h>0&&(d?(e().heal("player",h),e().heal("enemy",h),e().addLog(` :   ${h}`,"effect")):e().heal("player",h))}else if(c.type==="ApplyStatus"){const h=c.key,d=Number(c.stacks??1),u=Number(c.duration??2),f=Number(c.chance??100),p=n.type==="Attack"?"enemy":"player";if(e().applyStatus(p,h,d,u,f),h==="Shock"&&p==="enemy"){const m={...e().enemyStatus};m.shockStacks=(m.shockStacks||0)+d,r({enemyStatus:m})}}else if(c.type==="Shield"){const h=Number(c.value??0),d=Number(c.duration??1);if(h>0){const u={...s.playerStatus};u.shield=(u.shield||0)+h,u.shieldDuration=Math.max(u.shieldDuration,d),r({playerStatus:u}),e().addLog(`: +${h} (: ${u.shield}, ${u.shieldDuration})`,"effect")}}else if(c.type==="Guard"){const h=Number(c.value??0),d=Number(c.duration??1);if(h>0){const u={...s.playerStatus};u.guard=h,u.guardDuration=d,r({playerStatus:u}),e().addLog(`: ${h} ( , ${d})`,"effect")}}else if(c.type==="Vulnerable"){const h=Number(c.value??0),d=Number(c.duration??1);h>0&&e().applyStatus("enemy","Vulnerable",1,d,100,h)}else if(c.type==="Buff"){const h=c.stat,d=Number(c.value??0),u=Number(c.duration??1);if(d>0&&h==="attack"){const f={...s.playerStatus};f.attackBuff=d,r({playerStatus:f}),e().addLog(` : +${d}% (${u})`,"effect")}}else if(c.type==="Regen"){const h=Number(c.value??0),d=Number(c.duration??3);if(h>0){const u={...s.playerStatus};u.regen=h,r({playerStatus:u}),e().applyStatus("player","Regen",1,d),e().addLog(` :    ${h}  (${d})`,"effect")}}else if(c.type==="Cleanse"){const h=Number(c.maxStacks??2),d={...s.playerStatus},u=d.statuses.filter(f=>f.key==="Burn"&&(f.stacks||0)<=h);d.statuses=d.statuses.filter(f=>!(f.key==="Burn"&&(f.stacks||0)<=h)),r({playerStatus:d}),u.length>0&&e().addLog(`:  ${u.reduce((f,p)=>f+(p.stacks||0),0)} `,"effect")}else if(c.type==="PriorityBoost"){const h=Number(c.value??0),d=Number(c.duration??1);h>0&&e().addLog(` : +${h} (${d})`,"effect")}else if(c.type==="Silence"){const h=Number(c.duration??1);e().addLog(`:   ${h}   `,"effect")}else if(c.type==="Nullify"){const h=Number(c.times??1);if(h>0){const d={...s.playerStatus};d.nullifyCharges=(d.nullifyCharges||0)+h,r({playerStatus:d}),e().addLog(`:   ${h}   `,"effect")}}else if(c.type==="Counter"){const h=Number(c.value??0),d=Number(c.duration??1);if(h>0){const u={...s.playerStatus};u.counterValue=h,u.counterDuration=d,r({playerStatus:u}),e().addLog(`:   ${h}   (${d})`,"effect")}}else if(c.type==="Evasion"){Number(c.value??100);const h=Number(c.charges??1),d=Number(c.duration??1);if(h>0){const u={...s.playerStatus};u.evasionCharges=(u.evasionCharges||0)+h,u.evasionDuration=Math.max(u.evasionDuration,d),r({playerStatus:u}),e().addLog(`: ${h}    (${u.evasionDuration})`,"effect")}}else if(c.type==="Immune"){const h=c.keywords||[],d=Number(c.duration??1);if(h.length>0){const u={...s.playerStatus};u.immuneKeywords=[...new Set([...u.immuneKeywords,...h])],u.immuneDuration=Math.max(u.immuneDuration,d),r({playerStatus:u}),e().addLog(` : ${h.join(", ")}   (${d})`,"effect")}}else if(c.type==="Chain"){const h=Number(c.targets??2),d=Number(c.ratio??.5);let u=0;for(let f=l-1;f>=0;f--){const p=n.effects[f];if(p.type==="Damage"){const g=Number(p.value??0);if(g>0){let m=g;if(n.type==="Attack"){const b=e().playerStatus.attackBuff||0;b>0&&(m=Math.floor(g*(1+b/100)))}u=Math.floor(m*d);break}}}if(u>0){for(let f=0;f<h;f++)e().dealDamage("enemy",u,f<h-1);e().addLog(` :   ${u}  ${h}`,"effect")}else e().addLog(" :   ","effect")}else if(c.type==="Conditional"){const h=c.if;let d=!1;if(h.includes("targetHp<=")){const u=h.match(/targetHp<=(\d+)%/);if(u){const f=Number(u[1]),p=e(),g=n.type==="Attack"?p.enemyHp:p.playerHp,m=n.type==="Attack"?p.enemyMaxHp:p.playerMaxHp;d=g/m*100<=f}}d?(e().addLog(" !   ","effect"),c.then.forEach(u=>{const f=n.effects;if(n.effects=[u],u.type==="Damage"){const p=Number(u.value??0);if(p>0){let g=p;if(n.type==="Attack"){const _=e().playerStatus.attackBuff||0;_>0&&(g=Math.floor(p*(1+_/100)))}e().dealDamage(n.type==="Attack"?"enemy":"player",g,!1),e().addLog(` : ${g}`,"effect")}}else if(u.type==="Heal"){const p=Number(u.value??0);p>0&&(e().heal("player",p),e().addLog(` : ${p}`,"effect"))}n.effects=f})):e().addLog(` : ${h}`,"effect")}else if(c.type==="DuplicateNext"){const h=c.typeFilter,d=Number(c.times??1),u={...s.playerStatus};u.nextCardDuplicate={typeFilter:h,times:d},r({playerStatus:u}),e().addLog(` ${h||""} ${d+1}  `,"effect")}else if(c.type==="CopyCard"){const h=c.from,d=c.filter,u=c.to;if(h==="deck"&&u==="hand"){const f=e();let p=f.deck;if(d&&d.includes("type:")){const g=d.split(":")[1];p=p.filter(m=>m.type===g)}if(p.length>0){const g=Math.floor((f.roundSeed+l)%p.length),m=p[g],_=f.deck.filter(x=>x.id!==m.id),b=[...f.hand,m];r({deck:_,hand:b}),e().addLog(` "${m.name}"   `,"effect")}else e().addLog(" :     ","effect")}}else if(c.type==="TransferHp"){const h=Number(c.value??0),d=c.from,u=c.to;if(h>0){const f=e();let p=d==="player"?f.playerHp:f.enemyHp;u==="player"?f.playerHp:f.enemyHp,u==="player"?f.playerMaxHp:f.enemyMaxHp;const g=Math.min(h,p);g>0&&(r(d==="player"?{playerHp:Math.max(0,f.playerHp-g)}:{enemyHp:Math.max(0,f.enemyHp-g)}),r(u==="player"?{playerHp:Math.min(f.playerMaxHp,f.playerHp+g)}:{enemyHp:Math.min(f.enemyMaxHp,f.enemyHp+g)}),e().addLog(`HP : ${d} ${u} ${g} `,"effect"))}}else if(c.type==="Revive"){const h=Number(c.value??0),d=Number(c.chance??30),u=e();u.playerHp<=0?(u.roundSeed+l)%100<d?(r({playerHp:h}),e().addLog(` ! HP ${h} `,"effect")):e().addLog(`  (${d}% )`,"effect"):e().addLog(" :  ","effect")}else if(c.type==="ElementShift"){const h=c.from,d=c.to,u=Number(c.duration??1);e().addLog(` : ${h}  ${d} (${u})`,"effect")}}}),s.playerStatus.nextCardDuplicate){const c=s.playerStatus.nextCardDuplicate;if(!c.typeFilter||n.type===c.typeFilter){for(let u=0;u<c.times;u++)e().addLog(` : "${n.name}"   (${u+1}/${c.times})`,"effect"),n.effects.forEach(f=>{if(f.type==="Damage"){const p=Number(f.value??0);if(p>0){let g=p;const m=e();if(n.type==="Attack"){const _=m.playerStatus.attackBuff||0;_>0&&(g=Math.floor(p*(1+_/100)))}e().dealDamage(n.type==="Attack"?"enemy":"player",g,!1)}}else if(f.type==="Heal"){const p=Number(f.value??0);p>0&&e().heal("player",p)}else if(f.type==="ApplyStatus"){const p=f.key,g=Number(f.stacks??1),m=Number(f.duration??2),_=Number(f.chance??100),b=n.type==="Attack"?"enemy":"player";e().applyStatus(b,p,g,m,_)}});const d={...e().playerStatus};d.nextCardDuplicate=void 0,r({playerStatus:d})}}return!0},playEnemyCard:t=>{const s=e();if(s.gameOver!=="none"||s.enemyEnergy<t.cost)return!1;const n=s.battleContext.type==="pvp",a=s.enemyHand.findIndex(u=>u.id===t.id),i=a!==-1;if(!n&&!i)return!1;const o=[...s.enemyDeck],c=o.findIndex(u=>u.id===t.id);c!==-1&&o.splice(c,1);const l=i?s.enemyHand.filter((u,f)=>f!==a):[...s.enemyHand];if(s.playerStatus.nullifyCharges>0){const u=s.enemyEnergy-t.cost,f={...s.playerStatus,nullifyCharges:s.playerStatus.nullifyCharges-1},p=[...s.enemyDiscard,t];return r({enemyEnergy:u,enemyHand:l,enemyDeck:c!==-1?o:s.enemyDeck,enemyDiscard:p,playerStatus:f}),qa(),e().addLog(` ${t.name}  ( ${t.cost})`,"card-play"),e().addLog(` !     ( : ${f.nullifyCharges})`,"effect"),!0}const h=s.enemyEnergy-t.cost,d=[...s.enemyDiscard,t];return r({enemyEnergy:h,enemyHand:l,enemyDeck:c!==-1?o:s.enemyDeck,enemyDiscard:d}),qa(),e().addLog(` ${t.name}  ( ${t.cost})`,"card-play"),t.effects.forEach((u,f)=>{if(u&&typeof u=="object"){const p=u.type;if(p==="Draw"){const g=Number(u.value??0);g>0&&(e().enemyDraw(g),e().addLog(` :  ${g}`,"effect"))}else if(p==="GainAction"){const g=Number(u.value??0);g>0&&(r({enemyEnergy:e().enemyEnergy+g}),e().addLog(` :  +${g}`,"effect"))}else if(p==="Damage"){const g=Number(u.value??0),m=u.aoe===!0;if(g>0){let _=g;const x=e().enemyStatus.attackBuff||0;x>0&&(_=Math.floor(g*(1+x/100)));const S=e(),T=S.playerStatus.shockStacks||0;if(T>0){let R=0,$=0;if(T>=3?(R=.9,$=.5):T===2?(R=.6,$=.4):(R=.3,$=.3),(S.roundSeed+_+T+100)%100/100<R){const j=Math.floor(_*$);e().addLog(`  ! (${T}, ${Math.floor(R*100)}% )  : ${j}`,"effect"),e().dealDamage("player",j,!1);const z={...e().playerStatus};z.shockStacks=Math.max(0,T-1),r({playerStatus:z})}else e().addLog(`   (${T}, ${Math.floor(R*100)}% )`,"effect")}const C=t.effects.slice(f+1).filter(R=>R.type==="Damage").length===0;m?(e().dealDamage("player",_,!C),e().addLog(`  : ${_}`,"effect")):e().dealDamage("player",_,!C)}}else if(p==="Heal"){const g=Number(u.value??0),m=u.aoe===!0;g>0&&(m?(e().heal("enemy",g),e().heal("player",g),e().addLog(`  : ${g}`,"effect")):e().heal("enemy",g))}else if(p==="ApplyStatus"){const g=u.key,m=Number(u.stacks??1),_=Number(u.duration??2),b=Number(u.chance??100);if(e().applyStatus("player",g,m,_,b),g==="Shock"){const S={...e().playerStatus};S.shockStacks=(S.shockStacks||0)+m,r({playerStatus:S})}}else if(p==="Shield"){const g=Number(u.value??0),m=Number(u.duration??1);if(g>0){const _={...s.enemyStatus};_.shield=(_.shield||0)+g,_.shieldDuration=Math.max(_.shieldDuration,m),r({enemyStatus:_}),e().addLog(` : +${g} (: ${_.shield}, ${_.shieldDuration})`,"effect")}}else if(p==="Guard"){const g=Number(u.value??0),m=Number(u.duration??1);if(g>0){const _={...s.enemyStatus};_.guard=g,_.guardDuration=m,r({enemyStatus:_}),e().addLog(` : ${g} (${m})`,"effect")}}else if(p==="Vulnerable"){const g=Number(u.value??0),m=Number(u.duration??1);g>0&&e().applyStatus("player","Vulnerable",1,m,100,g)}else if(p==="Nullify"){const g=Number(u.times??1);if(g>0){const m={...s.enemyStatus};m.nullifyCharges=(m.nullifyCharges||0)+g,r({enemyStatus:m}),e().addLog(` :   ${g}   `,"effect")}}else if(p==="Counter"){const g=Number(u.value??0),m=Number(u.duration??1);if(g>0){const _={...s.enemyStatus};_.counterValue=g,_.counterDuration=m,r({enemyStatus:_}),e().addLog(` :    ${g}   (${m})`,"effect")}}else if(p==="Immune"){const g=u.keywords||[],m=Number(u.duration??1);if(g.length>0){const _={...s.enemyStatus};_.immuneKeywords=[...new Set([..._.immuneKeywords,...g])],_.immuneDuration=Math.max(_.immuneDuration,m),r({enemyStatus:_}),e().addLog(` : ${g.join(", ")}   (${m})`,"effect")}}else if(p==="Conditional"){const g=u.if;let m=!1;if(g.includes("targetHp<=")){const _=g.match(/targetHp<=(\d+)%/);if(_){const b=Number(_[1]),x=e(),S=t.type==="Attack"?x.playerHp:x.enemyHp,T=t.type==="Attack"?x.playerMaxHp:x.enemyMaxHp;m=S/T*100<=b}}m&&(e().addLog("  !   ","effect"),(u.then||[]).forEach(b=>{if(b.type==="Damage"){const x=Number(b.value??0);x>0&&(e().dealDamage("player",x,!1),e().addLog(`  : ${x}`,"effect"))}else if(b.type==="Heal"){const x=Number(b.value??0);x>0&&(e().heal("enemy",x),e().addLog(`  : ${x}`,"effect"))}}))}else if(p==="Chain"){const g=Number(u.targets??2),m=Number(u.ratio??.5);let _=0;for(let b=f-1;b>=0;b--){const x=t.effects[b];if(x&&x.type==="Damage"){const S=Number(x.value??0);if(S>0){_=Math.floor(S*m);break}}}if(_>0){for(let b=0;b<g;b++)e().dealDamage("player",_,b<g-1);e().addLog(`  :   ${_}  ${g}`,"effect")}}}}),!0},spendEnergy:()=>{const{energy:t}=e();t>0&&r({energy:t-1})},resetEnergyAndNextRound:()=>{const t=e(),{round:s}=t;e().processStatusEffects(),r({energy:3,round:s+1}),e().addLog(`    ${s+1}`,"system")},endPlayerTurn:async()=>{const t=e();if(!(t.gameOver!=="none"||t.isTurnProcessing)){if(t.battleContext.type==="pvp"){await e().submitPvpTurn();return}r({isTurnProcessing:!0}),t.playerQueue.length>0&&(r({declarationLocked:!0}),await e().revealAndResolve()),e().addLog("  ","system"),e().processStatusEffects("playerEnd"),Wa=window.setTimeout(async()=>{await e().enemyTurn()},500)}},evaluateCard:(t,s)=>{let n=0;const{enemyHp:a,enemyMaxHp:i,playerHp:o,playerMaxHp:c,enemyStatus:l,playerStatus:h}=s,d=a/i,u=o/c;return t.type==="Attack"?(n+=50,u<.3?n+=40:u<.5&&(n+=20),h.vulnerable>0&&(n+=25),h.guard>0&&(n-=15),h.shield>0&&(n-=10),h.evasionCharges>0&&(n-=30)):t.type==="Heal"?(n+=30,d<.3?n+=50:d<.5?n+=30:d>.8&&(n-=20)):t.type==="Defense"?(n+=35,d<.5&&(n+=25),(l.guard>0||l.shield>0)&&(n-=20)):t.type==="Special"&&(n+=40,t.keywords.includes("Nullify")&&h.nullifyCharges===0&&(n+=20)),n-=t.cost*3,t.keywords.forEach(f=>{f==="Burn"?h.immuneKeywords.includes("Burn")?n-=30:n+=15:f==="Shock"?h.immuneKeywords.includes("Shock")?n-=30:n+=12:f==="Vulnerable"?n+=10:(f==="Shield"||f==="Guard")&&d<.6&&(n+=15)}),Math.max(0,n)},enemyTurn:async()=>{const t=e();if(console.log(`[EnemyTurn]  enemyTurn() called, gameOver: ${t.gameOver}`),t.battleContext.type==="pvp"||t.gameOver!=="none")return;e().addLog("  ","system");const s=t.enemyEnergy,n=Math.min(s+3,10);r({enemyEnergy:n}),s>0?e().addLog(` : ${s}() + 3 = ${n}`,"system"):e().addLog(` : ${n}`,"system"),e().enemyDraw(1),Ga=window.setTimeout(async()=>{var c;console.log(`[EnemyTurn]  setTimeout callback 1 triggered, gameOver: ${e().gameOver}, round: ${e().round}`);const a=e();if(a.gameOver!=="none"){console.log(`[EnemyTurn]  Aborted due to gameOver: ${a.gameOver}`);return}const i=a.enemyHand.filter(l=>l.cost<=a.enemyEnergy);if(i.length===0)e().addLog("   ","system");else{const l={enemyHp:a.enemyHp,enemyMaxHp:a.enemyMaxHp,playerHp:a.playerHp,playerMaxHp:a.playerMaxHp,enemyStatus:a.enemyStatus,playerStatus:a.playerStatus},h=i.map(f=>({card:f,score:e().evaluateCard(f,l)}));h.sort((f,p)=>p.score-f.score);const d=h.slice(0,Math.max(1,Math.ceil(h.length*.3))),u=d[Math.floor(Math.random()*d.length)].card;if(u){e().addLog(`[AI] : ${u.name} (: ${(c=h.find(g=>g.card.id===u.id))==null?void 0:c.score})`,"system"),await Xa(u,!1,-1),e().playEnemyCard(u);const f=e();if(f.gameOver!=="none")return;const p=f.enemyHand.filter(g=>g.cost<=f.enemyEnergy);if(p.length>0){const g=p.map(m=>({card:m,score:e().evaluateCard(m,{enemyHp:f.enemyHp,enemyMaxHp:f.enemyMaxHp,playerHp:f.playerHp,playerMaxHp:f.playerMaxHp,enemyStatus:f.enemyStatus,playerStatus:f.playerStatus})}));g.sort((m,_)=>_.score-m.score),g[0].score>=50&&(await Xa(g[0].card,!1,-1),e().playEnemyCard(g[0].card))}}}const o=e();if(console.log(`[EnemyTurn]  Before addLog, gameOver: ${o.gameOver}, round: ${o.round}`),o.gameOver!=="none"){console.log(`[EnemyTurn]  Aborted before addLog due to gameOver: ${o.gameOver}`);return}e().addLog("  ","system"),e().processStatusEffects("enemyEnd"),za=window.setTimeout(()=>{console.log(`[EnemyTurn]  setTimeout callback 2 triggered, gameOver: ${e().gameOver}, round: ${e().round}`);const l=e();if(l.gameOver==="none"){const h=l.round+1,d=Math.floor(Math.random()*1e6),u=l.energy,f=Math.min(u+3,10);r({round:h,roundSeed:d,energy:f}),e().addLog(`  ${h}  `,"system"),e().addLog("  ","system"),u>0?e().addLog(`: ${u}() + 3 = ${f}`,"system"):e().addLog(`: ${f}`,"system"),e().draw(1),Va=window.setTimeout(()=>{r({isTurnProcessing:!1})},500)}},500)},500)}})),Ev=1,Cp="saves";let Ii=null,li=null,is=null,Ws="",os="",Ai=!1,cs=null,Sd="idle",Bs=null;function Fr(r){Sd!==r&&(Sd=r,window.dispatchEvent(new CustomEvent("cloud-sync-status",{detail:r})))}if(typeof window<"u"){let r=!1;if(window.addEventListener("cloud-save-force",()=>Ep()),!r){r=!0;let e=N.getState().gold,t=N.getState().shards,s=N.getState().collection.length,n=N.getState().playerDeck.length,a=N.getState().currentStage;N.subscribe(i=>{i.gold!==e&&(console.log("[CloudSave][Debug] Gold changed",{prev:e,next:i.gold}),e=i.gold),i.shards!==t&&(console.log("[CloudSave][Debug] Shards changed",{prev:t,next:i.shards}),t=i.shards),i.collection.length!==s&&(console.log("[CloudSave][Debug] Collection length changed",{prev:s,next:i.collection.length}),s=i.collection.length),i.playerDeck.length!==n&&(console.log("[CloudSave][Debug] Player deck length changed",{prev:n,next:i.playerDeck.length}),n=i.playerDeck.length),i.currentStage!==a&&(console.log("[CloudSave][Debug] Current stage changed",{prev:a,next:i.currentStage}),a=i.currentStage)})}}function hi(r){const e=r.completedStageIds.length>0?r.completedStageIds:r.campaignStages.filter(n=>n.cleared).map(n=>n.id),t=r.dailyDungeon.floors.filter(n=>n.cleared).map(n=>n.id),s={version:Ev,gold:r.gold,shards:r.shards,collection:r.collection,playerDeck:r.playerDeck,campaignClears:e,daily:{dateKey:r.dailyDungeon.dateKey,clearedFloorIds:t,currentFloorId:r.currentDailyFloorId,completed:r.dailyDungeon.completed},currentStage:r.currentStage,timestamp:new Date().toISOString()};return console.log("[CloudSave] selectPersistentState snapshot",{gold:s.gold,shards:s.shards,collectionLength:s.collection.length,deckLength:s.playerDeck.length,campaignClears:s.campaignClears,currentStage:s.currentStage}),s}function Ci(r){const e=r.split("_");return e.length<=6?r:e.slice(0,6).join("_")}function Tv(r){return r.map(e=>Ci(e.id)).join("|")}function Pv(r){const e=new Map;return r.forEach(t=>{const s=Ci(t.id);e.set(s,(e.get(s)??0)+1)}),Array.from(e.entries()).sort(([t],[s])=>t<s?-1:t>s?1:0).map(([t,s])=>`${t}:${s}`).join("|")}function Rv(r){return(r.completedStageIds.length>0?r.completedStageIds:r.campaignStages.filter(t=>t.cleared).map(t=>t.id)).slice().sort((t,s)=>t-s).join(",")}function Mv(r){const e=r.dailyDungeon.floors.filter(t=>t.cleared).map(t=>t.id).sort((t,s)=>t-s).join(",");return`${r.dailyDungeon.completed?"1":"0"}|${r.dailyDungeon.dateKey}|${e}|${r.currentDailyFloorId??"null"}`}function di(r){return{gold:r.gold,shards:r.shards,deckSignature:Tv(r.playerDeck),collectionSignature:Pv(r.collection),campaignClearsSignature:Rv(r),currentStage:r.currentStage??null,dailySignature:Mv(r)}}function $v(r,e){return r?r.gold!==e.gold||r.shards!==e.shards||r.deckSignature!==e.deckSignature||r.collectionSignature!==e.collectionSignature||r.campaignClearsSignature!==e.campaignClearsSignature||r.currentStage!==e.currentStage||r.dailySignature!==e.dailySignature:!0}async function Ov(r){const{data:e,error:t}=await be.from(Cp).select("save_blob").eq("user_id",r).maybeSingle();if(t)return console.error("[CloudSave] Failed to load save:",t),null;if(!e||!e.save_blob)return console.log("[CloudSave] No existing save for user",r),null;try{const s=e.save_blob;console.log("[CloudSave] Raw save_blob fetched",{type:typeof s,hasContent:!!s});const n=typeof s=="string"?JSON.parse(s):s;return!n||typeof n!="object"?(console.warn("[CloudSave] Save blob is not an object, ignoring load"),null):(console.log("[CloudSave] Parsed save summary",{gold:n.gold,shards:n.shards,collection:Array.isArray(n.collection)?n.collection.length:null,deck:Array.isArray(n.playerDeck)?n.playerDeck.length:null,currentStage:n.currentStage,campaignClears:n.campaignClears}),n)}catch(s){return console.error("[CloudSave] Failed to parse save blob:",s),null}}async function ol(r,e){const t={user_id:r,save_blob:e,updated_at:new Date().toISOString()},{error:s}=await be.from(Cp).upsert(t,{onConflict:"user_id"});s?console.error("[CloudSave] Failed to persist save:",s):console.log("[CloudSave] Save persisted")}function Bv(r,e){const t=new Set(e);return r.campaignStages.map(s=>t.has(s.id)?{...s,cleared:!0}:s)}function Dv(r){N.setState(s=>{var a;const n=Bv(s,r.campaignClears??[]);return{gold:r.gold??s.gold,shards:r.shards??s.shards,campaignStages:n,completedStageIds:Array.isArray(r.campaignClears)?[...r.campaignClears].sort((i,o)=>i-o):s.completedStageIds,currentDailyFloorId:((a=r.daily)==null?void 0:a.currentFloorId)??s.currentDailyFloorId,currentStage:r.currentStage??null}});const e=Array.isArray(r.collection)?r.collection:[],t=Array.isArray(r.playerDeck)?r.playerDeck:[];if(e.length>0&&N.setState({collection:e}),t.length>0){const s=new Map;e.forEach(a=>{const i=Ci(a.id),o=s.get(i);o?o.push(a):s.set(i,[a])});const n=t.map(a=>{const i=Ci(a.id),o=s.get(i);return o&&o.length>0?o.shift():a});N.setState({playerDeck:n}),console.log("[CloudSave] Normalized playerDeck linkage",{originalLength:t.length,normalizedLength:n.length})}console.log("[CloudSave] Applied save to store",{gold:r.gold,shards:r.shards,collectionLength:e.length,deckLength:t.length,currentStage:r.currentStage,clears:r.campaignClears})}function Lv(r){if(!r)return;const e=N.getState();if(!e.dailyDungeon.dateKey||e.dailyDungeon.dateKey!==r.dateKey)return;const t=new Set(r.clearedFloorIds);N.setState({dailyDungeon:{...e.dailyDungeon,floors:e.dailyDungeon.floors.map(s=>({...s,cleared:t.has(s.id)})),completed:r.completed},currentDailyFloorId:r.currentFloorId??null})}function Ep(){if(!Ii)return;Fr("saving");const r=hi(N.getState());Bs=di(N.getState()),os=JSON.stringify(r),ol(Ii,r).then(()=>{Ws=JSON.stringify(r),os="",Fr("idle")}).catch(e=>{console.error("[CloudSave] Immediate flush failed",e),Fr("idle")})}function Fv(r,e){const t=JSON.stringify(e);t===Ws||t===os||(os=t,is&&clearTimeout(is),is=window.setTimeout(async()=>{is=null;try{Fr("saving");const s=os||t,n=JSON.parse(s);await ol(r,n),Ws=s}catch(s){console.error("[CloudSave] Failed to serialize save payload:",s)}finally{os="",Fr("idle")}},1e3))}async function jv(r){Fr("loading");try{const e=await Ov(r);if(e){console.log("[CloudSave] Existing save found, applying"),Dv(e),N.getState().ensureDailyDungeon(),Lv(e.daily);const t=N.getState();Ws=JSON.stringify(hi(t)),Bs=di(t)}else{console.log("[CloudSave] No save found, creating default snapshot"),N.getState().ensureDailyDungeon();const t=hi(N.getState());await ol(r,t),Ws=JSON.stringify(t),Bs=di(N.getState())}li=N.subscribe(t=>{const s=di(t);if(!$v(Bs,s))return;Bs=s;const n=hi(t);Fv(r,n)}),Ai||(cs=()=>Ep(),window.addEventListener("beforeunload",cs),window.addEventListener("pagehide",cs),Ai=!0)}finally{Fr("idle")}}function Nv(){li&&(li(),li=null),is&&(clearTimeout(is),is=null),Ws="",os="",Bs=null,Ai&&cs&&(window.removeEventListener("beforeunload",cs),window.removeEventListener("pagehide",cs),Ai=!1,cs=null),Fr("idle")}async function Hv(r){r!==Ii&&(Nv(),Ii=r,r&&await jv(r))}const Ja="",ut=_f((r,e)=>({session:null,initializing:!0,loading:!1,error:null,message:null,authView:"sign-in",profileNickname:Ja,async initialize(){r({initializing:!0});const{data:t,error:s}=await be.auth.getSession();s?(console.error("[Auth]   ",s),r({error:"   .",initializing:!1})):r({session:t.session??null,initializing:!1,error:null,message:null}),be.auth.onAuthStateChange((n,a)=>{n==="SIGNED_IN"?r({session:a,loading:!1,error:null,message:null}):n==="SIGNED_OUT"?r({session:null,loading:!1,message:null}):n==="TOKEN_REFRESHED"&&r({session:a,loading:!1})})},setAuthView(t){r({authView:t,error:null,message:null})},setProfileNickname(t){r({profileNickname:t||Ja})},async signIn(t,s){r({loading:!0,error:null});const{error:n}=await be.auth.signInWithPassword({email:t,password:s});if(n){console.error("[Auth]  ",n),r({error:n.message,loading:!1});return}r({loading:!1,message:"!"})},async signUp(t,s,n){r({loading:!0,error:null});const{data:a,error:i}=await be.auth.signUp({email:t,password:s,options:{data:{display_name:n||Ja}}});if(i){console.error("[Auth]  ",i),r({error:i.message,loading:!1});return}const o=a.session??null;o&&await be.from("profiles").upsert({user_id:o.user.id,display_name:n||Ja,locale:"ko",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),r({loading:!1,message:" .  ."})},async signOut(){r({loading:!0,error:null});try{const{data:t}=await be.auth.getSession();if(!t.session){r({session:null,loading:!1,message:"  ."});return}const{error:s}=await be.auth.signOut({scope:"local"});if(s&&!/auth session missing/i.test(s.message))throw s;r({session:null,loading:!1,message:" ."}),N.getState().setGameScreen("intro"),typeof window<"u"&&window.dispatchEvent(new CustomEvent("auth-force-overlay"))}catch(t){console.error("[Auth]  ",t),r({error:t instanceof Error?t.message:String(t),loading:!1})}}}));async function Uv(){const r=`/data/cards.json?v=${Date.now()}`,e=await fetch(r);if(!e.ok)throw new Error(`Failed to load cards.json: ${e.status} ${e.statusText}`);const t=await e.json();if(!Array.isArray(t))throw new Error("cards.json is not an array");return t.map(Gv)}function Gv(r){const e={...r};if(e.effectText||(e.effectText=zv(e.effects)),!e.levelCurve){const t={},s=kd(e.effects,"Damage"),n=kd(e.effects,"Heal");typeof s=="number"&&(t.damage=s),typeof n=="number"&&(t.heal=n),e.levelCurve={base:t,perLevel:{}}}return e}function kd(r,e){for(const t of r)if(t.type===e&&"value"in t){const s=Number(t.value??NaN);if(!Number.isNaN(s))return s}}function zv(r){const e=[];for(const t of r)if(t){if(t.type==="Damage"){const s=t.value??0,n=t.aoe?" ()":"";e.push(` ${s}${n}`)}else if(t.type==="Heal"){const s=t.value??0,n=t.aoe?" ()":"";e.push(` ${s}${n}`)}else if(t.type==="ApplyStatus"){const s=t.key??"Status",n=t.stacks??1;e.push(`${s} ${n}`)}else if(t.type==="Shield"){const s=t.value??0;e.push(` ${s}`)}else if(t.type==="Guard"){const s=t.value??0;e.push(` ${s}`)}else if(t.type==="Draw"){const s=t.value??1;e.push(` ${s}`)}else if(t.type==="GainAction"){const s=t.value??1;e.push(` +${s}`)}else if(t.type==="Vulnerable"){const s=t.value??20;e.push(` +${s}%`)}else if(t.type==="Regen"){const s=t.value??0;e.push(`  ${s}/`)}else if(t.type==="Cleanse"){const s=t.maxStacks??2;e.push(`( ${s})`)}}return e.join(", ")}const vt={webp:[],png:[],loaded:new Set,failed:new Set};function Tp(r){const e=r.split("_");if(e.length>=2){const t=e[1];return t.charAt(0)+t.slice(1).toLowerCase()}return"Ariana"}function Pp(r){const t=`${Tp(r.id)}_${r.type}_${r.rarity}`;return{webp:`cards/${t}.webp`,png:`cards/${t}.png`}}async function Id(r,e){if(vt.loaded.has(r))return r;if(vt.loaded.has(e))return e;try{return await st.load(r),vt.loaded.add(r),r}catch{try{return await st.load(e),vt.loaded.add(e),e}catch{throw vt.failed.add(r),vt.failed.add(e),new Error(`Failed to load: ${r} or ${e}`)}}}async function Vv(r){console.log(`[AssetLoader] Preloading ${r.length} card images...`);const e=performance.now(),t=new Map;r.forEach(i=>{const c=`${Tp(i.id)}_${i.type}_${i.rarity}`;t.has(c)||t.set(c,i)});const s=[];for(const i of t.values()){const{webp:o,png:c}=Pp(i);s.push(Id(o,c).then(()=>{}).catch(l=>{console.warn(`[AssetLoader] Failed to load card image for ${i.type}/${i.rarity}:`,l)}))}s.push(Id("cards/card_back.webp","cards/card_back.png").then(()=>{console.log("[AssetLoader] Card back loaded")}).catch(i=>{console.warn("[AssetLoader] Failed to load card back:",i)})),["cardIcons/Type/type_attack.png","cardIcons/Type/type_defense.png","cardIcons/Type/type_heal.png","cardIcons/Type/type_special.png"].forEach(i=>{s.push(st.load(i).then(()=>{vt.loaded.add(i),console.log(`[AssetLoader] Type icon loaded: ${i}`)}).catch(o=>{vt.failed.add(i),console.warn(`[AssetLoader] Failed to load type icon: ${i}`,o)}))}),await Promise.all(s);const a=performance.now()-e;console.log(`[AssetLoader] Preloaded ${vt.loaded.size} images in ${a.toFixed(0)}ms`),console.log(`[AssetLoader] Failed: ${vt.failed.size} images`)}function Fo(r){const{webp:e,png:t}=Pp(r);return vt.loaded.has(e)?e:vt.loaded.has(t)?t:null}function Qa(){return vt.loaded.has("cards/card_back.webp")?"cards/card_back.webp":vt.loaded.has("cards/card_back.png")?"cards/card_back.png":null}class Rp{constructor(){this.pool=[],this.poolSize=0}acquire(e,t){let s=this.pool.find(n=>!n.inUse);if(!s){const n=new ve,a=new Pe,i=new ve,o=new ve,c=new sr({text:"",style:{fontSize:11,fill:16777215,wordWrap:!0,wordWrapWidth:e-10,align:"center"}});c.anchor.set(.5,0),o.x=15,o.y=15,n.addChild(a),n.addChild(o),n.addChild(i),n.addChild(c),s={container:n,sprite:a,costText:i,typeIcon:o,nameText:c,inUse:!1},this.pool.push(s),this.poolSize++}return s.inUse=!0,s}release(e){e.inUse=!1,e.container.visible=!1,e.container.removeAllListeners()}releaseAll(){this.pool.forEach(e=>{e.inUse&&this.release(e)})}getStats(){return{total:this.poolSize,inUse:this.pool.filter(e=>e.inUse).length,available:this.pool.filter(e=>!e.inUse).length}}replaceSprite(e,t){const s=e.container,n=e.sprite;n&&n.parent&&s.removeChild(n),t.x=0,t.y=0,t.alpha=1,t.tint=16777215,t.rotation=0,s.addChildAt(t,0),e.sprite=t}setupTypeIcon(e,t,s){const n=e.container,a=e.typeIcon;a&&a.parent&&n.removeChild(a);const i=new ve;i.x=15,i.y=15;const o=new Pe;o.circle(0,0,14),o.fill({color:t,alpha:1}),i.addChild(o);const c=mt.from(s);c.width=18,c.height=18,c.anchor.set(.5),c.x=0,c.y=0,c.tint=16777215,i.addChild(c),n.addChildAt(i,2),e.typeIcon=i}setupCostText(e,t,s,n){const a=e.container,i=e.costText;i&&i.parent&&a.removeChild(i);const o=new ve;o.x=s-15,o.y=15;const c=new Pe;c.circle(0,0,12),c.fill({color:0,alpha:.8}),o.addChild(c);const l=new sr({text:`${t}`,style:{fontSize:20,fontWeight:"bold",fill:n?16777215:16711680}});l.anchor.set(.5),l.x=0,l.y=0,o.addChild(l),a.addChildAt(o,3),e.costText=o}}const Cs=new Rp,Za=new Rp;class Wv{constructor(e){this.particles=[],this.container=e}createParticle(e,t,s,n,a,i,o,c=!0){const l=new Pe;return l.circle(0,0,i),l.fill({color:a,alpha:1}),l.x=e,l.y=t,this.container.addChild(l),{sprite:l,vx:s,vy:n,life:o,maxLife:o,scale:1,fadeOut:c}}burst(e,t,s,n,a){const i=(a==null?void 0:a.speed)??2,o=(a==null?void 0:a.size)??3,c=(a==null?void 0:a.life)??30;for(let l=0;l<s;l++){const h=Math.PI*2*l/s,d=Math.cos(h)*i,u=Math.sin(h)*i;this.particles.push(this.createParticle(e,t,d,u,n,o,c))}}spray(e,t,s,n,a,i,o){const c=(o==null?void 0:o.speed)??3,l=(o==null?void 0:o.size)??3,h=(o==null?void 0:o.life)??30;for(let d=0;d<s;d++){const u=n+(Math.random()-.5)*a,f=c*(.5+Math.random()*.5),p=Math.cos(u)*f,g=Math.sin(u)*f;this.particles.push(this.createParticle(e,t,p,g,i,l,h))}}rain(e,t,s,n,a){const i=(a==null?void 0:a.width)??100,o=(a==null?void 0:a.speed)??1,c=(a==null?void 0:a.size)??2,l=(a==null?void 0:a.life)??60;for(let h=0;h<s;h++){const d=(Math.random()-.5)*i,u=(Math.random()-.5)*.5,f=o+Math.random()*o;this.particles.push(this.createParticle(e+d,t,u,f,n,c,l))}}flash(e,t,s,n=50){const a=new Pe;a.circle(0,0,n),a.fill({color:s,alpha:.8}),a.x=e,a.y=t,this.container.addChild(a),this.particles.push({sprite:a,vx:0,vy:0,life:15,maxLife:15,scale:2,fadeOut:!0})}rise(e,t,s,n,a){const i=(a==null?void 0:a.speed)??1.5,o=(a==null?void 0:a.size)??4,c=(a==null?void 0:a.life)??40;for(let l=0;l<s;l++){const h=(Math.random()-.5)*30,d=(Math.random()-.5)*.3,u=-i-Math.random()*.5;this.particles.push(this.createParticle(e+h,t,d,u,n,o,c))}}update(){for(let e=this.particles.length-1;e>=0;e--){const t=this.particles[e];if(t.sprite.x+=t.vx,t.sprite.y+=t.vy,t.vy+=.1,t.life--,t.fadeOut){const s=t.life/t.maxLife;t.sprite.alpha=s}if(t.scale!==1){const s=1+(t.scale-1)*(t.life/t.maxLife);t.sprite.scale.set(s)}t.life<=0&&(this.container.removeChild(t.sprite),t.sprite.destroy(),this.particles.splice(e,1))}}clear(){this.particles.forEach(e=>{this.container.removeChild(e.sprite),e.sprite.destroy()}),this.particles=[]}}class qv{constructor(){this.emitter=null,this.container=null}init(e){this.container=e,this.emitter=new Wv(e)}update(){var e;(e=this.emitter)==null||e.update()}playDamageEffect(e,t,s){if(!this.emitter)return;this.emitter.flash(e,t,16711680,80),this.emitter.flash(e,t,16737792,50);const n=Math.min(60,30+Math.floor(s/5));this.emitter.burst(e,t,n,16729156,{speed:5,size:6,life:35}),this.emitter.burst(e,t,15,8921634,{speed:2,size:8,life:40}),setTimeout(()=>{var a;(a=this.emitter)==null||a.burst(e,t,20,16746632,{speed:6,size:4,life:25})},50)}playHealEffect(e,t,s){if(!this.emitter)return;this.emitter.flash(e,t,16776960,70),this.emitter.flash(e,t,65280,90);const n=Math.min(40,20+Math.floor(s/5));this.emitter.rise(e,t,n,16777028,{speed:2,size:7,life:50}),this.emitter.rise(e,t,n,4521796,{speed:1.8,size:6,life:45}),setTimeout(()=>{var a;(a=this.emitter)==null||a.rise(e,t,15,65450,{speed:2.5,size:5,life:40})},100)}playShieldEffect(e,t){if(this.emitter){this.emitter.flash(e,t,65535,100),this.emitter.flash(e,t,4474111,80),this.emitter.burst(e,t,40,6732799,{speed:4,size:7,life:40}),this.emitter.burst(e,t,25,11202303,{speed:3,size:5,life:35});for(let s=0;s<3;s++)setTimeout(()=>{var n;(n=this.emitter)==null||n.burst(e,t,20,8969727,{speed:2+s,size:4,life:30})},s*100)}}playEnergyEffect(e,t){this.emitter&&(this.emitter.flash(e,t,16776960,80),this.emitter.rise(e,t,30,16768324,{speed:2.5,size:7,life:50}),this.emitter.rise(e,t,20,16755200,{speed:2,size:6,life:45}),this.emitter.burst(e,t,15,16777130,{speed:3,size:5,life:35}))}playDrawEffect(e,t){this.emitter&&(this.emitter.flash(e,t,65535,70),this.emitter.spray(e,t,35,-Math.PI/2,Math.PI/3,4513245,{speed:4,size:6,life:40}),this.emitter.spray(e,t,25,-Math.PI/2,Math.PI/3,8974079,{speed:3.5,size:5,life:35}),this.emitter.burst(e,t,15,11206655,{speed:2,size:4,life:30}))}playBurnEffect(e,t){this.emitter&&(this.emitter.flash(e,t,16737792,60),this.emitter.rise(e,t,25,16724736,{speed:2.5,size:8,life:45}),this.emitter.rise(e,t,20,16737792,{speed:2,size:7,life:40}),this.emitter.rise(e,t,15,16755200,{speed:1.8,size:6,life:35}),setTimeout(()=>{var s;(s=this.emitter)==null||s.rise(e,t,10,4465186,{speed:1.2,size:10,life:50})},100))}playFreezeEffect(e,t){this.emitter&&(this.emitter.flash(e,t,16777215,70),this.emitter.flash(e,t,11202303,90),this.emitter.burst(e,t,35,8969727,{speed:4,size:6,life:50}),this.emitter.burst(e,t,30,13434879,{speed:3,size:5,life:45}),this.emitter.burst(e,t,20,4491519,{speed:2,size:7,life:40}),setTimeout(()=>{var s;(s=this.emitter)==null||s.rain(e,t,15,15663103,{width:80,speed:1.5,size:4,life:55})},100))}playShockEffect(e,t){this.emitter&&(this.emitter.flash(e,t,16777215,90),this.emitter.flash(e,t,16776960,70),this.emitter.burst(e,t,50,16777028,{speed:8,size:4,life:20}),this.emitter.burst(e,t,30,8978431,{speed:6,size:3,life:18}),setTimeout(()=>{var s;(s=this.emitter)==null||s.burst(e,t,20,11176191,{speed:7,size:3,life:15})},50),setTimeout(()=>{var s,n;(s=this.emitter)==null||s.flash(e,t,16777028,50),(n=this.emitter)==null||n.burst(e,t,15,16777130,{speed:5,size:2,life:12})},120))}playVulnerableEffect(e,t){this.emitter&&(this.emitter.flash(e,t,8913066,80),this.emitter.flash(e,t,11158698,60),this.emitter.burst(e,t,30,14509789,{speed:3,size:7,life:45}),this.emitter.burst(e,t,20,16746751,{speed:2,size:6,life:40}),setTimeout(()=>{var s;(s=this.emitter)==null||s.rise(e,t,15,6693512,{speed:1.5,size:8,life:50})},100))}playBuffEffect(e,t){this.emitter&&(this.emitter.flash(e,t,16777215,90),this.emitter.flash(e,t,16766720,70),this.emitter.rise(e,t,40,16772676,{speed:2.5,size:8,life:50}),this.emitter.rise(e,t,30,16755200,{speed:2,size:7,life:45}),this.emitter.burst(e,t,20,16777130,{speed:3,size:6,life:40}))}playVictoryEffect(e,t){this.emitter&&(this.emitter.flash(e,t,16777215,120),this.emitter.flash(e,t,16766720,100),this.emitter.burst(e,t,60,16766720,{speed:6,size:10,life:60}),setTimeout(()=>{var s,n,a;(s=this.emitter)==null||s.flash(e,t-50,16737792,80),(n=this.emitter)==null||n.burst(e,t-50,40,16737792,{speed:5,size:8,life:50}),(a=this.emitter)==null||a.burst(e+50,t,30,16729156,{speed:4,size:7,life:45})},200),setTimeout(()=>{var s,n,a;(s=this.emitter)==null||s.flash(e,t+50,4521796,80),(n=this.emitter)==null||n.burst(e,t+50,40,4521796,{speed:5,size:8,life:50}),(a=this.emitter)==null||a.burst(e-50,t,30,4474111,{speed:4,size:7,life:45})},400),setTimeout(()=>{var s;(s=this.emitter)==null||s.burst(e,t,50,16777215,{speed:7,size:6,life:55})},600))}playDefeatEffect(e,t){this.emitter&&(this.emitter.flash(e,t,0,100),this.emitter.flash(e,t,4473924,80),this.emitter.rain(e,t,50,6710886,{width:200,speed:2,size:6,life:80}),this.emitter.rise(e,t,30,3355443,{speed:1,size:10,life:70}),this.emitter.burst(e,t,25,2236962,{speed:3,size:8,life:60}))}playCardTrailEffect(e,t,s){if(!this.emitter)return;this.emitter.flash(e,t,s,60),this.emitter.spray(e,t,25,Math.PI/2,Math.PI/2,s,{speed:3,size:6,life:35});const n=s|8947848;this.emitter.spray(e,t,15,Math.PI/2,Math.PI/3,n,{speed:2.5,size:5,life:30}),this.emitter.burst(e,t,10,16777215,{speed:2,size:4,life:25})}clear(){var e;(e=this.emitter)==null||e.clear()}}const rt=new qv,Mr={linear:r=>r,easeInQuad:r=>r*r,easeOutQuad:r=>r*(2-r),easeInOutQuad:r=>r<.5?2*r*r:-1+(4-2*r)*r,easeInCubic:r=>r*r*r,easeOutCubic:r=>--r*r*r+1,easeInOutCubic:r=>r<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1,easeInQuart:r=>r*r*r*r,easeOutQuart:r=>1- --r*r*r*r,easeInOutQuart:r=>r<.5?8*r*r*r*r:1-8*--r*r*r*r,easeInElastic:r=>r===0||r===1?r:-Math.pow(2,10*(r-1))*Math.sin((r-1.1)*5*Math.PI),easeOutElastic:r=>r===0||r===1?r:Math.pow(2,-10*r)*Math.sin((r-.1)*5*Math.PI)+1,easeOutBounce:r=>r<1/2.75?7.5625*r*r:r<2/2.75?7.5625*(r-=1.5/2.75)*r+.75:r<2.5/2.75?7.5625*(r-=2.25/2.75)*r+.9375:7.5625*(r-=2.625/2.75)*r+.984375};class Xv{constructor(e){this.startTime=null,this.rafId=null,this.running=!1,this.options={from:e.from,to:e.to,duration:e.duration,easing:e.easing||Mr.easeOutQuad,onUpdate:e.onUpdate||(()=>{}),onComplete:e.onComplete||(()=>{})}}start(){if(this.running)return this;this.running=!0,this.startTime=null;const e=t=>{if(!this.running)return;this.startTime||(this.startTime=t);const s=t-this.startTime,n=Math.min(s/this.options.duration,1),a=this.options.easing(n),i=this.options.from+(this.options.to-this.options.from)*a;this.options.onUpdate(i),n<1?this.rafId=requestAnimationFrame(e):(this.running=!1,this.options.onComplete())};return this.rafId=requestAnimationFrame(e),this}stop(){return this.rafId!==null&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.running=!1,this}isRunning(){return this.running}}class Yv{constructor(){this.tweens=new Set}create(e){const t=new Xv(e);this.tweens.add(t);const s=e.onComplete;return t.options.onComplete=()=>{s&&s(),this.tweens.delete(t)},t}stopAll(){this.tweens.forEach(e=>e.stop()),this.tweens.clear()}getActiveTweensCount(){return this.tweens.size}}const Kv=new Yv;function jo(r,e,t,s,n){return Kv.create({from:r,to:e,duration:t,easing:n==null?void 0:n.easing,onUpdate:s,onComplete:n==null?void 0:n.onComplete}).start()}class Jv{constructor(){this.tracks=new Map,this.settings={masterVolume:.7,bgmVolume:.5,sfxVolume:.8,muted:!1},this.currentBGM=null,this.loadSettings()}register(e,t,s="sfx"){if(this.tracks.has(e)){console.warn(`[Audio] Sound "${e}" is already registered.`);return}const n=new Audio;n.preload="auto";const a={name:e,type:s,audio:null,loaded:!1,isPlaying:!1};n.addEventListener("canplaythrough",()=>{a.loaded=!0,console.log(`[Audio] Loaded: ${e}`)}),n.addEventListener("error",i=>{console.warn(`[Audio] Failed to load: ${e}`,i),a.audio=null}),n.src=t,a.audio=n,s==="bgm"&&(n.loop=!0),this.tracks.set(e,a)}playSFX(e,t){if(this.settings.muted)return;const s=this.tracks.get(e);if(!s||!s.audio||!s.loaded){console.warn(`[Audio] SFX not found or not loaded: ${e}`);return}const n=s.audio.cloneNode(),a=(t??1)*this.settings.sfxVolume*this.settings.masterVolume;n.volume=Math.max(0,Math.min(1,a)),n.play().catch(i=>{console.warn(`[Audio] Failed to play SFX: ${e}`,i)})}playBGM(e,t=!0){if(this.currentBGM===e)return;if(this.currentBGM&&this.stopBGM(!0),this.settings.muted){this.currentBGM=e;return}const s=this.tracks.get(e);if(!s||!s.audio||!s.loaded){console.warn(`[Audio] BGM not found or not loaded: ${e}`);return}const n=s.audio,a=this.settings.bgmVolume*this.settings.masterVolume;if(t){n.volume=0,n.play().catch(c=>{console.warn(`[Audio] Failed to play BGM: ${e}`,c)});let i=0;const o=setInterval(()=>{i+=.02,i>=a?(n.volume=a,clearInterval(o)):n.volume=i},40)}else n.volume=a,n.play().catch(i=>{console.warn(`[Audio] Failed to play BGM: ${e}`,i)});s.isPlaying=!0,this.currentBGM=e}stopBGM(e=!0){if(!this.currentBGM)return;const t=this.tracks.get(this.currentBGM);if(!t||!t.audio)return;const s=t.audio;if(e){const n=setInterval(()=>{s.volume>.02?s.volume-=.02:(s.pause(),s.currentTime=0,clearInterval(n))},20)}else s.pause(),s.currentTime=0;t.isPlaying=!1,this.currentBGM=null}pauseBGM(){if(!this.currentBGM)return;const e=this.tracks.get(this.currentBGM);e!=null&&e.audio&&(e.audio.pause(),e.isPlaying=!1)}resumeBGM(){if(!this.currentBGM)return;const e=this.tracks.get(this.currentBGM);e!=null&&e.audio&&!this.settings.muted&&(e.audio.play(),e.isPlaying=!0)}setMasterVolume(e){this.settings.masterVolume=Math.max(0,Math.min(1,e)),this.updateBGMVolume(),this.saveSettings()}setBGMVolume(e){this.settings.bgmVolume=Math.max(0,Math.min(1,e)),this.updateBGMVolume(),this.saveSettings()}setSFXVolume(e){this.settings.sfxVolume=Math.max(0,Math.min(1,e)),this.saveSettings()}updateBGMVolume(){if(!this.currentBGM)return;const e=this.tracks.get(this.currentBGM);e!=null&&e.audio&&(e.audio.volume=this.settings.bgmVolume*this.settings.masterVolume)}setMuted(e){this.settings.muted=e,e?this.pauseBGM():this.resumeBGM(),this.saveSettings()}toggleMute(){return this.setMuted(!this.settings.muted),this.settings.muted}getSettings(){return{...this.settings}}saveSettings(){localStorage.setItem("gals_audio_settings",JSON.stringify(this.settings))}loadSettings(){const e=localStorage.getItem("gals_audio_settings");if(e)try{const t=JSON.parse(e);this.settings={masterVolume:t.masterVolume??.7,bgmVolume:t.bgmVolume??.5,sfxVolume:t.sfxVolume??.8,muted:t.muted??!1},console.log("[Audio] Settings loaded:",this.settings)}catch(t){console.warn("[Audio] Failed to load settings:",t)}}stopAll(){this.stopBGM(!1),this.tracks.forEach(e=>{e.audio&&(e.audio.pause(),e.audio.currentTime=0,e.isPlaying=!1)})}getDebugInfo(){const e=Array.from(this.tracks.values()).filter(s=>s.loaded).length,t=this.tracks.size;return`Audio: ${e}/${t} loaded, BGM: ${this.currentBGM||"none"}, Muted: ${this.settings.muted}`}}const q=new Jv,He={cardPlay:"sounds/sfx/card_play.mp3",cardDraw:"sounds/sfx/card_draw.mp3",cardShuffle:"sounds/sfx/card_shuffle.mp3",damage:"sounds/sfx/damage.mp3",heal:"sounds/sfx/heal.mp3",shield:"sounds/sfx/shield.mp3",critical:"sounds/sfx/critical.mp3",burn:"sounds/sfx/burn.mp3",freeze:"sounds/sfx/freeze.mp3",shock:"sounds/sfx/shock.mp3",buttonClick:"sounds/sfx/button_click.mp3",buttonHover:"sounds/sfx/button_hover.mp3",menuOpen:"sounds/sfx/menu_open.mp3",turnEnd:"sounds/sfx/turn_end.mp3",victory:"sounds/sfx/victory.mp3",defeat:"sounds/sfx/defeat.mp3",levelUp:"sounds/sfx/level_up.mp3",bgmMenu:"sounds/bgm/menu.mp3",bgmBattle:"sounds/bgm/battle.mp3",bgmShop:"sounds/bgm/shop.mp3",bgmVictory:"sounds/bgm/victory_jingle.mp3"};function Qv(){console.log("[Audio] Initializing audio system..."),q.register("card_play",He.cardPlay,"sfx"),q.register("card_draw",He.cardDraw,"sfx"),q.register("card_shuffle",He.cardShuffle,"sfx"),q.register("damage",He.damage,"sfx"),q.register("heal",He.heal,"sfx"),q.register("shield",He.shield,"sfx"),q.register("critical",He.critical,"sfx"),q.register("burn",He.burn,"sfx"),q.register("freeze",He.freeze,"sfx"),q.register("shock",He.shock,"sfx"),q.register("button_click",He.buttonClick,"sfx"),q.register("button_hover",He.buttonHover,"sfx"),q.register("menu_open",He.menuOpen,"sfx"),q.register("turn_end",He.turnEnd,"sfx"),q.register("victory",He.victory,"sfx"),q.register("defeat",He.defeat,"sfx"),q.register("level_up",He.levelUp,"sfx"),q.register("bgm_menu",He.bgmMenu,"bgm"),q.register("bgm_battle",He.bgmBattle,"bgm"),q.register("bgm_shop",He.bgmShop,"bgm"),q.register("bgm_victory",He.bgmVictory,"bgm"),console.log("[Audio] Audio system initialized"),console.log(q.getDebugInfo())}class Zv{constructor(){this.container=null,this.toastId=0}init(){this.container=document.getElementById("toast-container")}show(e,t={}){if(!this.container)return;const{type:s="info",duration:n=3e3,title:a=this.getDefaultTitle(s)}=t,i=++this.toastId,o=document.createElement("div");o.className=`toast ${s}`,o.setAttribute("data-toast-id",String(i));const c=this.getIcon(s);o.innerHTML=`
      <div class="toast-header">
        <span class="toast-icon">${c}</span>
        <span>${a}</span>
        <button class="toast-close" aria-label="Close"></button>
      </div>
      <div class="toast-message">${e}</div>
    `;const l=o.querySelector(".toast-close");return l.onclick=()=>this.close(i),this.container.appendChild(o),n>0&&setTimeout(()=>this.close(i),n),i}close(e){if(!this.container)return;const t=this.container.querySelector(`[data-toast-id="${e}"]`);t&&(t.classList.add("fadeOut"),setTimeout(()=>{t.remove()},300))}getDefaultTitle(e){switch(e){case"success":return" ";case"error":return" ";case"warning":return" ";case"info":return" "}}getIcon(e){switch(e){case"success":return"";case"error":return"";case"warning":return"";case"info":return""}}success(e,t){return this.show(e,{type:"success",duration:t})}error(e,t){return this.show(e,{type:"error",duration:t})}warning(e,t){return this.show(e,{type:"warning",duration:t})}info(e,t){return this.show(e,{type:"info",duration:t})}}const bt=new Zv;class eS{constructor(){this.loadingScreen=null,this.loadingText=null,this.loadingProgress=null}init(){var e;this.loadingScreen=document.getElementById("loading-screen"),this.loadingText=((e=this.loadingScreen)==null?void 0:e.querySelector(".loading-text"))||null,this.loadingProgress=document.getElementById("loading-progress")}show(e="Loading..."){this.loadingScreen&&(this.loadingScreen.classList.remove("hidden"),this.loadingText&&(this.loadingText.textContent=e))}hide(){this.loadingScreen&&this.loadingScreen.classList.add("hidden")}setProgress(e,t){this.loadingProgress&&(this.loadingProgress.textContent=`${Math.round(e)}%`),t&&this.loadingText&&(this.loadingText.textContent=t)}}const Rr=new eS;function Ad(r,e=1){const t=Math.max(1,Math.min(3,e));return`backgrounds/${r}_${t}.png`}const Y=new Tu,ui=document.getElementById("app");ui.replaceChildren();const{setAuthOverlayEnabled:Mp,requestAuthWithCallback:tS}=lS();window.addEventListener("auth-force-overlay",()=>{Mp(!0)});const xt=document.getElementById("intro"),Tc=document.getElementById("menu"),rS=Tc.querySelectorAll(".menu-btn"),Sn=document.getElementById("deck-editor"),ei=document.getElementById("card-gallery"),Cd=["collection","deck","stats"];let fr="collection";const No=document.getElementById("campaign"),Ho=document.getElementById("daily"),ti=document.getElementById("reward"),Uo=document.getElementById("shop"),Ed=document.getElementById("pvp"),Es=document.getElementById("tutorial-overlay"),ri=document.getElementById("victory-screen"),si=document.getElementById("defeat-screen"),Yn=document.getElementById("cloud-sync-overlay"),Pc=document.getElementById("cloud-sync-text");let Br=null;const sS=document.getElementById("pvp-status-text"),Rc=document.getElementById("pvp-opponent-info"),Td=document.getElementById("pvp-opponent-name"),Tn=document.getElementById("pvp-error"),Lr=document.getElementById("pvp-search-btn"),ls=document.getElementById("pvp-cancel-btn"),gr=document.getElementById("pvp-start-btn");ls.disabled=!0;gr.disabled=!0;Rc.classList.add("hidden");Tn.classList.add("hidden");const Pd={ARIANA:"characters/ariana_drake.png",DARIUS:"characters/darius_blackwood.png",ELDER:"characters/elder_belmont.png",ELENA:"characters/elena_drake.png",GAREN:"characters/garen_stone.png",IRIS:"characters/iris_belmont.png",KAI:"characters/kai_drake.png",LEON:"characters/leon_ardenia.png",LUCIAN:"characters/lucian_rosegarden.png",MARCUS:"characters/marcus_belmont.png",MIRA:"characters/mira.png",SERAPHINA:"characters/seraphina_belmont.png",SERAPHINE:"characters/seraphine_winters.png"},nS="characters/seraphina_belmont.png",aS="characters/ariana_drake.png",iS="backgrounds/fallback_1.webp";function Rd(r,e){if(!Array.isArray(r)||r.length===0)return e;const t={};r.forEach(a=>{var l;if(!a||!a.id)return;const o=(a.id.split("__snap__")[0]??a.id).split("_");if(o.length<2)return;const c=(l=o[1])==null?void 0:l.toUpperCase();!c||!Pd[c]||(t[c]=(t[c]??0)+1)});const s=Object.entries(t);if(s.length===0)return e;s.sort((a,i)=>i[1]-a[1]);const[n]=s[0];return Pd[n]??e}function oS(r){!Yn||!Pc||(Br!==null&&(clearTimeout(Br),Br=null),Yn.classList.add("active"),Pc.textContent=r==="loading"?"  ...":"  ...")}function cS(r=!0){if(!Yn)return;Br!==null&&(clearTimeout(Br),Br=null);const e=()=>Yn.classList.remove("active");r?Br=window.setTimeout(()=>{e(),Br=null},200):e()}Yn&&Pc&&window.addEventListener("cloud-sync-status",r=>{const e=r.detail;e==="idle"?cS(!0):oS(e)});N.subscribe(r=>{const e=r.pvpQueueStatus,t=r.pvpStatusMessage,s=r.pvpError,n=r.pvpMatch;console.log("[PvP] State updated:",{status:e,message:t,error:s,matchId:n==null?void 0:n.matchId,matchStatus:n==null?void 0:n.status});const a=e==="idle"?"   .":"   ...";switch(sS.textContent=t||a,s?(Tn.textContent=s,Tn.classList.remove("hidden")):(Tn.textContent="",Tn.classList.add("hidden")),n?(Rc.classList.remove("hidden"),Td.textContent=n.opponentName??" "):(Rc.classList.add("hidden"),Td.textContent="-"),e){case"idle":Lr.disabled=!1,ls.disabled=!0,gr.disabled=!n;break;case"searching":Lr.disabled=!0,ls.disabled=!1,gr.disabled=!0;break;case"matched":Lr.disabled=!0,ls.disabled=!1,gr.disabled=!(n&&n.status==="pending");break;case"error":Lr.disabled=!1,ls.disabled=!0,gr.disabled=!0;break}});function lS(){const r={setAuthOverlayEnabled:R=>{},requestAuthWithCallback:R=>{typeof R=="function"&&R()}},e=document.getElementById("auth-screen"),t=document.getElementById("auth-title"),s=document.getElementById("auth-error"),n=document.getElementById("auth-message"),a=document.getElementById("auth-sign-in"),i=document.getElementById("auth-sign-up"),o=document.getElementById("auth-sign-out");if(!e||!t||!s||!n||!a||!i)return console.warn("[Auth] UI    ."),r;const c=a.querySelector('input[name="email"]'),l=a.querySelector('input[name="password"]'),h=a.querySelector('button[type="submit"]'),d=i.querySelector('input[name="email"]'),u=i.querySelector('input[name="password"]'),f=i.querySelector('input[name="nickname"]'),p=i.querySelector('button[type="submit"]');if(!c||!l||!h||!d||!u||!f||!p)return console.warn("[Auth]     ."),r;const g=Array.from(document.querySelectorAll("[data-auth-view]")),m=Array.from(document.querySelectorAll("[data-auth-visible]"));let _=!1,b=null;g.forEach(R=>{R.addEventListener("click",$=>{$.preventDefault();const B=R.getAttribute("data-auth-view");(B==="sign-in"||B==="sign-up")&&(ut.getState().setAuthView(B),B==="sign-in"?c.focus():d.focus())})}),f.addEventListener("input",R=>{const $=R.target.value;ut.getState().setProfileNickname($)}),a.addEventListener("submit",async R=>{R.preventDefault();const $=c.value.trim(),B=l.value;if(!$||!B){ut.setState({error:"  ."});return}await ut.getState().signIn($,B)}),i.addEventListener("submit",async R=>{R.preventDefault();const $=d.value.trim(),B=u.value,j=f.value.trim();if(!$||!B){ut.setState({error:"  ."});return}await ut.getState().signUp($,B,j);const se=ut.getState();if(!se.error){const z=se.message;ut.setState({authView:"sign-in",error:null,message:z}),c.focus()}}),o&&o.addEventListener("click",async()=>{await ut.getState().signOut()});const x=[c,l,d,u,f],S=()=>{const R=ut.getState(),$=!!R.session,B=_&&(!$||R.initializing),j=B&&!R.initializing;if(_?(e.classList.toggle("auth-hidden",!B),document.body.classList.toggle("auth-locked",B)):(e.classList.add("auth-hidden"),document.body.classList.remove("auth-locked")),o){const z=_&&$;o.classList.toggle("auth-hidden",!z),o.disabled=R.loading}R.initializing&&_?t.textContent="  ...":t.textContent=R.authView==="sign-in"?" ":"",a.classList.toggle("auth-hidden",R.authView!=="sign-in"||!j),i.classList.toggle("auth-hidden",R.authView!=="sign-up"||!j),m.forEach(z=>{const de=z.getAttribute("data-auth-visible");z.classList.toggle("auth-hidden",de!==R.authView||!_)}),R.error&&_?(s.textContent=R.error,s.classList.remove("auth-hidden")):(s.textContent="",s.classList.add("auth-hidden")),_&&(R.message||R.initializing)?(n.textContent=R.message||"  ...",n.classList.remove("auth-hidden")):(n.textContent="",n.classList.add("auth-hidden"));const se=R.loading||R.initializing;x.forEach(z=>{z.disabled=se&&_}),h.disabled=se,p.disabled=se,g.forEach(z=>{z.disabled=se})},T=R=>{_=R,S()},A=R=>{if(ut.getState().session){R();return}b=R,T(!0)};S();let C=null;return ut.subscribe(R=>{var B;S();const $=((B=R.session)==null?void 0:B.user.id)??null;if($!==C&&(C=$,Hv($).catch(j=>{console.error("[CloudSave] Failed to handle session change",j)})),b&&R.session){const j=b;b=null,T(!1),j()}else!R.session&&b&&(b=null,T(!0))}),ut.getState().initialize().catch(R=>{console.error("[Auth]  ",R)}),{setAuthOverlayEnabled:T,requestAuthWithCallback:A}}rS.forEach(r=>{r.addEventListener("click",()=>{const e=r.dataset.mode;if(!e||r.disabled)return;const t=N.getState();e==="campaign"?t.setGameScreen("campaign"):e==="daily"?(t.ensureDailyDungeon(),t.setGameScreen("daily")):e==="deck"?t.setGameScreen("deck-editor"):e==="shop"?t.setGameScreen("shop"):e==="pvp"&&t.setGameScreen("pvp")})});Lr.addEventListener("click",async()=>{Lr.disabled=!0;try{await N.getState().startPvpMatchmaking()}catch(r){console.error("[PvP] Failed to start matchmaking",r),Lr.disabled=!1}});ls.addEventListener("click",async()=>{ls.disabled=!0;try{await N.getState().cancelPvpMatchmaking()}catch(r){console.error("[PvP] Failed to cancel matchmaking",r)}finally{Lr.disabled=!1,gr.disabled=!0}});gr.addEventListener("click",async()=>{gr.disabled=!0;try{await N.getState().acceptPvpMatch()}catch(r){console.error("[PvP] Failed to accept match",r),gr.disabled=!1}});const Ds=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),cl=Ds||window.innerWidth<768,$p=cl?1:Math.min(2,window.devicePixelRatio||1);console.log(`[Performance] Mobile: ${Ds}, LowEnd: ${cl}, Resolution: ${$p}`);Y.init({background:"#0F1A2C",resizeTo:window,resolution:$p,antialias:!1,powerPreference:cl?"low-power":"high-performance",autoDensity:!0}).then(async()=>{ui.appendChild(Y.canvas),bt.init(),Rr.init(),Rr.show("  ..."),Qv();const r=document.getElementById("hud"),e=document.getElementById("controls"),t=document.getElementById("hand"),s=document.getElementById("log"),n=document.getElementById("log-toggle"),a=document.getElementById("tooltip"),i=document.getElementById("card-preview"),o=document.getElementById("card-preview-image"),c=document.getElementById("card-preview-name"),l=document.getElementById("card-preview-cost"),h=document.getElementById("card-preview-effects"),d=document.getElementById("card-preview-keywords"),u=document.getElementById("card-preview-close"),f=document.getElementById("options-toggle"),p=document.getElementById("options-panel"),g=document.getElementById("options-close"),m=document.getElementById("options-language"),_=document.getElementById("options-logout"),b=document.getElementById("volume-master"),x=document.getElementById("volume-bgm"),S=document.getElementById("volume-sfx"),T=document.getElementById("volume-master-val"),A=document.getElementById("volume-bgm-val"),C=document.getElementById("volume-sfx-val"),R=document.getElementById("mute-btn"),$=N.getState(),B=new ve,j=new mt,se=new Pe;B.addChild(j),B.addChild(se),B.visible=!1,Y.stage.addChildAt(B,0);let z=null,de=null,Qe=null;function G(){if(!B.visible||!j.texture)return;const y=j.texture,w=Y.renderer.width,I=Y.renderer.height,k=Math.max(w/y.width,I/y.height);j.scale.set(k),j.position.set((w-y.width*k)/2,(I-y.height*k)/2),se.clear(),se.rect(0,0,w,I),se.fill({color:0,alpha:.55})}async function Q(){var k;const y=N.getState();if(y.gameScreen!=="battle"){B.visible=!1,z=null;return}const w=y.battleContext.type==="pvp";let I=null;if(w)I=iS;else if(y.currentStage){const v=y.campaignStages.find(E=>E.id===y.currentStage);I=((k=v==null?void 0:v.story)==null?void 0:k.backgroundImage)||null}if(!I){B.visible=!1,z=null;return}if(z!==I)try{await st.load(I),j.texture=st.get(I),z=I}catch(v){console.warn("[BattleBG] Failed to load background:",I,v),B.visible=!1,z=null;return}B.visible=!0,G()}window.addEventListener("resize",()=>G()),n.addEventListener("click",()=>{s.classList.toggle("mobile-visible"),n.textContent=s.classList.contains("mobile-visible")?"":""}),(Ds||window.innerWidth<=768)&&document.addEventListener("click",y=>{const w=y.target;s.classList.contains("mobile-visible")&&!s.contains(w)&&!n.contains(w)&&(s.classList.remove("mobile-visible"),n.textContent="")});function xr(){i.classList.remove("active")}u.addEventListener("click",xr),i.addEventListener("click",y=>{y.target===i&&xr()});const ue=q.getSettings();b.value=String(Math.round(ue.masterVolume*100)),x.value=String(Math.round(ue.bgmVolume*100)),S.value=String(Math.round(ue.sfxVolume*100)),T.textContent=b.value,A.textContent=x.value,C.textContent=S.value,ue.muted&&(R.classList.add("muted"),R.textContent="  ");function St(){p.classList.remove("active")}f.addEventListener("click",()=>{const y=!p.classList.contains("active");p.classList.toggle("active",y),q.playSFX("button_click",.5)}),g.addEventListener("click",()=>{St(),q.playSFX("button_click",.5)});function wr(){const y=Lh();m.textContent=y==="ko"?" : ":" Language: English"}m.addEventListener("click",()=>{q.playSFX("button_click",.5);const y=Lh()==="ko"?"en":"ko";rb(y),wr()}),wr(),_.addEventListener("click",async()=>{q.playSFX("button_click",.5);const{session:y,signOut:w}=ut.getState();if(!y){bt.info("  .",1800),St();return}await w();const{error:I}=ut.getState();I?bt.error(" .",2200):bt.success(".",1800),St()}),b.addEventListener("input",()=>{const y=parseInt(b.value);T.textContent=String(y),q.setMasterVolume(y/100)}),x.addEventListener("input",()=>{const y=parseInt(x.value);A.textContent=String(y),q.setBGMVolume(y/100)}),S.addEventListener("input",()=>{const y=parseInt(S.value);C.textContent=String(y),q.setSFXVolume(y/100)}),R.addEventListener("click",()=>{q.toggleMute()?(R.classList.add("muted"),R.textContent="  "):(R.classList.remove("muted"),R.textContent=" "),q.playSFX("button_click",.5)});function Ze(y){var k;const w=Fo(y);if(w){const v=st.get(w);v&&v.source?o.src=((k=v.source.resource)==null?void 0:k.src)||w:o.src=w}else o.src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="280" height="420"><rect width="280" height="420" fill="%23556677"/><text x="50%" y="50%" text-anchor="middle" fill="white" font-size="20">No Image</text></svg>';c.textContent=y.name,l.textContent=` : ${y.cost}`;const I=y.effects.map(v=>v?v.type==="Damage"?`  ${v.value}${v.aoe?" ()":""}`:v.type==="Heal"?`  ${v.value}${v.aoe?" ()":""}`:v.type==="Shield"?`  ${v.value}`:v.type==="Draw"?`  ${v.value}`:v.type==="GainAction"?`  +${v.value}`:v.type:"").filter(Boolean).join(" | ");h.textContent=I||" ",d.innerHTML="",y.keywords.forEach(v=>{const E=document.createElement("span");E.className=`status-badge status-${v.toLowerCase()}`,E.textContent=v,d.appendChild(E)}),i.classList.add("active")}const Hr={Burn:":     10  .",Freeze:":        .",Shock:":          . (1: 30%, 2: 60%, 3+: 90%)",Vulnerable:":   20% .",Regen:":    HP .",Shield:":   .",Guard:":    .",Nullify:":    .",Counter:":      .",Immune:":    .",Evasion:":     .",Haste:":   .",Draw:":   .",Priority:":   .",Duplicate:":      .",Silence:":      .",Cleanse:":  .",Thorns:":     ."};function en(y,w,I){const k=y.keywords.map(P=>{const D=Hr[P];return D?`<strong>${P}</strong>: ${D}`:P}).join("<br>"),v=y.effectText||"  .",E=`card.type.${y.type}`,M=Be(E);a.innerHTML=`
      <div class="tooltip-header">${y.name}</div>
      <div>
        <span class="tooltip-cost"> ${y.cost}</span>
        <span class="tooltip-type">${M}</span>
      </div>
      <div class="tooltip-effect">${v}</div>
      ${y.keywords.length>0?`<div class="tooltip-keywords">${k}</div>`:""}
    `,a.style.display="block",a.style.left=`${Math.min(w+15,window.innerWidth-a.offsetWidth-10)}px`,a.style.top=`${Math.min(I+15,window.innerHeight-a.offsetHeight-10)}px`}function ar(){a.style.display="none"}let vr=$.energy,tn=$.round,rn=$.roundSeed,Sr=$.playerHp,Ur=$.playerMaxHp,Gr=$.enemyHp,Kt=$.enemyMaxHp,it=$.gameOver,Bt=$.playerStatus,Dt=$.enemyStatus,Qn=$.energy,us=$.playerHp,sn=$.enemyHp;function Li(y){const w=[];return y.shield>0&&w.push(`<span class="status-badge status-defense"> ${y.shield}<sub>${y.shieldDuration}T</sub></span>`),y.guard>0&&w.push(`<span class="status-badge status-defense">  ${y.guard}<sub>${y.guardDuration}T</sub></span>`),y.evasionCharges>0&&w.push(`<span class="status-badge status-defense"> ${y.evasionCharges}<sub>${y.evasionDuration}T</sub></span>`),y.nullifyCharges>0&&w.push(`<span class="status-badge status-defense"> ${y.nullifyCharges}</span>`),y.counterValue>0&&w.push(`<span class="status-badge status-buff">  ${y.counterValue}<sub>${y.counterDuration}T</sub></span>`),y.immuneKeywords.length>0&&w.push(`<span class="status-badge status-defense"> ${y.immuneKeywords.join(",")}<sub>${y.immuneDuration}T</sub></span>`),y.attackBuff>0&&w.push(`<span class="status-badge status-buff"> +${y.attackBuff}%</span>`),y.regen>0&&w.push(`<span class="status-badge status-buff"> +${y.regen}/T</span>`),y.vulnerable>0&&w.push(`<span class="status-badge status-debuff"> <sub>${y.vulnerable}T</sub></span>`),y.shockStacks>0&&w.push(`<span class="status-badge status-debuff"> ${y.shockStacks}</span>`),y.statuses.forEach(I=>{const v={Burn:{icon:"",type:"debuff"},Freeze:{icon:"",type:"debuff"},Shock:{icon:"",type:"debuff"},Vulnerable:{icon:"",type:"debuff"},Regen:{icon:"",type:"buff"}}[I.key]||{icon:"",type:"debuff"},E=I.stacks&&I.stacks>1?` ${I.stacks}`:"";w.push(`<span class="status-badge status-${v.type}">${v.icon}${E}<sub>${I.duration}T</sub></span>`)}),w.length>0?w.join(" "):`<span style="color: #777;">${Be("status.none")}</span>`}function fs(){let y="";it==="victory"?y=`<div style="color: #4CAF50; font-weight: bold; font-size: 1.2em;">${Be("battle.victory")}</div>`:it==="defeat"&&(y=`<div style="color: #f44336; font-weight: bold; font-size: 1.2em;">${Be("battle.defeat")}</div>`);const w=Math.round(us),I=Math.round(sn);r.innerHTML=`
      ${y}
      <div>${Be("battle.round")}: ${tn}</div>
      <div style="font-size: 10px; color: #777;">${Be("battle.seed")}: ${rn}</div>
      <div style="margin-top: 8px; padding: 6px; background: rgba(0,0,0,0.3); border-radius: 4px;">
        <div style="font-weight: bold;">${Be("battle.player")}</div>
        <div>${Be("battle.hp")}: <span style="font-weight: bold; color: ${w<Sr*.3?"#f44336":"#4CAF50"}">${w}</span>/${Ur}</div>
        <div style="font-size: 11px; color: #aaa; margin-top: 4px;">${Li(Bt)}</div>
      </div>
      <div style="margin-top: 8px; padding: 6px; background: rgba(139,0,0,0.3); border-radius: 4px;">
        <div style="font-weight: bold;">${Be("battle.enemy")}</div>
        <div>${Be("battle.hp")}: <span style="font-weight: bold; color: ${I<Gr*.3?"#f44336":"#ff9800"}">${I}</span>/${Kt}</div>
        <div style="font-size: 11px; color: #aaa; margin-top: 4px;">${Li(Dt)}</div>
      </div>
    `}fs();function Fi(){e.innerHTML="";const y=N.getState(),w=document.createElement("button");if(w.textContent="  ",w.style.cssText="background: #2a3f5f; color: #fff; border: 1px solid #3a4f75; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 11px; margin-bottom: 8px;",w.onclick=()=>{q.playSFX("button_click",.6),N.getState().setGameScreen("menu")},e.append(w),y.battleContext.type==="pvp"){const M=document.createElement("div");M.style.cssText="padding: 10px; background: linear-gradient(135deg, rgba(33,47,79,0.9), rgba(19,29,51,0.95)); border: 1px solid rgba(102,187,255,0.35); border-radius: 8px; margin-bottom: 10px; color: #e3f2fd; box-shadow: 0 0 8px rgba(33,150,243,0.2);";const P=document.createElement("div");P.style.cssText="display: flex; justify-content: space-between; font-size: 12px; font-weight: 600;";const D=y.pvpLocalReady?"#66bb6a":"#ffeb3b",H=y.pvpOpponentReady?"#66bb6a":"#ff8a65";P.innerHTML=`
        <span style="color:${D}">${y.pvpLocalReady?"   ":"    "}</span>
        <span style="color:${H}">${y.pvpOpponentReady?"   ":"   "}</span>
      `,M.appendChild(P);const L=y.pvpTurnDuration||15,O=y.pvpTurnTimeLeft??L,X=Math.max(0,Math.min(L,Math.round(O))),ne=y.pvpTurnTimerActive&&!y.pvpLocalReady,F=ne?X/L*100:y.pvpLocalReady?100:y.pvpOpponentReady?0:100,fe=Math.max(0,Math.min(100,F)),ie=X<=5&&ne?"#ff5252":"#4caf50",ce=document.createElement("div");ce.style.cssText="display:flex; justify-content:space-between; align-items:center; margin-top:6px; font-size:12px;",ce.innerHTML=`
        <span> </span>
        <span style="font-weight:700; color:${ie};">${X.toString().padStart(2,"0")}s</span>
      `,M.appendChild(ce);const ge=document.createElement("div");ge.style.cssText="width:100%; height:8px; border-radius:999px; background:rgba(255,255,255,0.18); overflow:hidden; margin-top:4px;";const we=document.createElement("div"),Ne=ne?X<=5?"linear-gradient(90deg, #ff6f61, #ff1744)":"linear-gradient(90deg, #4caf50, #2196f3)":y.pvpLocalReady?"linear-gradient(90deg, #66bb6a, #43a047)":"linear-gradient(90deg, #29b6f6, #0288d1)";we.style.cssText=`width:${fe.toFixed(0)}%; height:100%; transition:width 0.2s ease; background:${Ne};`,ge.appendChild(we),M.appendChild(ge);const Oe=document.createElement("div");Oe.style.cssText="margin-top:4px; font-size:10px; color:#b3e5fc;",y.pvpLocalReady&&!y.pvpOpponentReady?Oe.textContent="   ":!y.pvpLocalReady&&!ne?Oe.textContent="   .":Oe.textContent="    .",M.appendChild(Oe),e.appendChild(M)}const I=document.createElement("div");I.style.cssText="padding: 6px 10px; background: rgba(0,0,0,0.5); border-radius: 6px; margin-bottom: 8px; color: #fff; font-size: 12px; border: 1px solid #3a4f75;";const k=y.queuedHandIndices.length,v=y.getPendingCost();k>0?(I.innerHTML=`
        <div style="color: #4a9eff; font-weight: bold;"> ${Be("battle.declared")}: ${k}</div>
        <div style="font-size: 10px; color: #aaa;">${Be("battle.reservedEnergy")}: ${v}</div>
      `,I.style.borderColor="#4a9eff",I.style.animation="pulse 2s ease-in-out infinite"):I.innerHTML=`<div style="color: #777;">${Be("battle.noCards")}</div>`,e.appendChild(I);const E=document.createElement("button");E.textContent=k>0?`${Be("battle.endTurn")} (${k} )`:Be("battle.endTurn"),E.disabled=it!=="none",E.style.cssText=k>0?"background: linear-gradient(135deg, #4a9eff, #1565C0); color: #fff; border: 2px solid #66BB6A; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: bold; box-shadow: 0 2px 8px rgba(74,158,255,0.5); transition: transform 0.1s;":"background: #20304d; color: #fff; border: 1px solid #3a4f75; padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: transform 0.1s;",it!=="none"&&(E.style.opacity="0.5",E.style.cursor="not-allowed"),E.onclick=()=>{const M=N.getState();it==="none"&&!M.isTurnProcessing&&(q.playSFX("turn_end",.8),E.style.transform="scale(0.95)",setTimeout(()=>{E.style.transform="scale(1)",N.getState().endPlayerTurn()},100))},e.append(E)}Fi();let Zn="all",ea="all",ta="";function nn(){const y=N.getState();s.innerHTML="";const w=document.createElement("div");w.style.cssText="padding: 4px; background: rgba(0,0,0,0.5); border-bottom: 1px solid #3a4f75; margin-bottom: 4px;";const I=document.createElement("button");I.textContent=Be(Zn==="all"?"log.view.all":"log.view.summary"),I.style.cssText="padding: 2px 6px; margin-right: 4px; font-size: 10px; background: #2a3f5f; color: #fff; border: 1px solid #3a4f75; border-radius: 3px; cursor: pointer;",I.onclick=()=>{Zn=Zn==="all"?"summary":"all",nn()},w.appendChild(I),[{label:Be("log.filter.all"),value:"all"},{label:Be("log.filter.card"),value:"card-play"},{label:Be("log.filter.effect"),value:"effect"},{label:Be("log.filter.system"),value:"system"}].forEach(P=>{const D=document.createElement("button");D.textContent=P.label,D.style.cssText=`padding: 2px 6px; margin-right: 2px; font-size: 10px; background: ${ea===P.value?"#4a9eff":"#2a3f5f"}; color: #fff; border: 1px solid #3a4f75; border-radius: 3px; cursor: pointer;`,D.onclick=()=>{ea=P.value,nn()},w.appendChild(D)});const v=document.createElement("input");v.type="text",v.placeholder=Be("log.search"),v.value=ta,v.style.cssText="width: 80px; padding: 2px 4px; font-size: 10px; background: #1a2f4f; color: #fff; border: 1px solid #3a4f75; border-radius: 3px; margin-left: 4px;",v.oninput=P=>{ta=P.target.value.toLowerCase(),nn()},w.appendChild(v),s.appendChild(w);const E=y.logs.filter(P=>!(ea!=="all"&&P.type!==ea||ta&&!P.message.toLowerCase().includes(ta))),M=Zn==="summary"?E.slice(-20):E;if(M.forEach(P=>{const D=document.createElement("div");D.className=`entry ${P.type}`,D.textContent=P.message,s.appendChild(D)}),M.length===0&&E.length>0){const P=document.createElement("div");P.style.cssText="padding: 8px; color: #777; text-align: center;",P.textContent=Be("log.noResults"),s.appendChild(P)}s.scrollTop=s.scrollHeight}const ji=new ve;Y.stage.addChild(ji),rt.init(ji),Y.ticker.add(()=>{rt.update()});function ll(y){const w=new ve,I=window.innerWidth<=768,k=window.innerWidth<=480,v=k?90:I?105:130,E=k?124:I?145:180,M=v/2,P=E/2,D=new Pe;D.rect(-M,-P,v,E),D.fill({color:0,alpha:.3}),D.x=6,D.y=6,w.addChild(D);const H=new Pe;H.rect(-M,-P,v,E),H.fill({color:1710638,alpha:.3}),w.addChildAt(H,0);const L=new mt;L.anchor.set(.5),L.width=v,L.height=E,L.alpha=1,L.visible=!1;const O=new mt,X=new mt,ne=new mt,F=new sr({text:": 0",style:{fontSize:k?12:I?14:16,fill:16777215,fontWeight:"bold",stroke:{color:0,width:k?2:3}}});return F.anchor.set(.5),F.y=P-10,w.addChild(F),{container:w,cardBack1:O,cardBack2:X,cardBack3:ne,countText:F,shadow:D,characterSprite:L,characterBackground:H}}const Z=ll(),Ue=Z.container,ee=ll(),Ge=ee.container,Lt=new sr({text:"VS",style:{fontSize:48,fill:16711680,fontWeight:"bold",stroke:{color:0,width:4}}});Lt.anchor.set(.5),Y.stage.addChild(Ue),Y.stage.addChild(Ge),Y.stage.addChild(Lt),Y.stage.setChildIndex(ji,Y.stage.children.length-1);const Op=async()=>{const y=Qa();if(!y){console.warn("[Deck] Card back path not found");return}try{const w=await st.load(y),I=window.innerWidth<=768,k=window.innerWidth<=480,v=k?90:I?105:120,E=k?124:I?145:165;[Z.cardBack1,Z.cardBack2,Z.cardBack3].forEach((M,P)=>{M.texture=w,M.width=v,M.height=E,M.anchor.set(.5),M.x=P*4-4,M.y=P*4-4,M.alpha=.5}),Ue.addChild(Z.cardBack3),Ue.addChild(Z.cardBack2),Ue.addChild(Z.cardBack1),Ue.addChild(Z.characterSprite),Ue.setChildIndex(Z.countText,Ue.children.length-1),[ee.cardBack1,ee.cardBack2,ee.cardBack3].forEach((M,P)=>{M.texture=w,M.width=v,M.height=E,M.anchor.set(.5),M.x=P*4-4,M.y=P*4-4,M.alpha=.5}),Ge.addChild(ee.cardBack3),Ge.addChild(ee.cardBack2),Ge.addChild(ee.cardBack1),Ge.addChild(ee.characterSprite),Ge.setChildIndex(ee.countText,Ge.children.length-1),console.log("[Deck] Player & Enemy deck loaded successfully")}catch(w){console.warn("[Deck] Failed to load card back:",w)}};function Ni(){const y=N.getState(),w=y.deck.length;Z.countText.text=`
: ${w}`,Ue.alpha=w>0?1:.3,Ue.visible=y.gameScreen==="battle";const I=y.enemyDeck.length;if(ee.countText.text=`
: ${I}`,Ge.alpha=I>0?1:.3,Ge.visible=y.gameScreen==="battle",Lt.visible=y.gameScreen==="battle",y.gameScreen==="battle")if(y.currentStage){const k=y.campaignStages.find(v=>v.id===y.currentStage);k&&(k.characterImage?(console.log("[Deck] Loading player character:",k.characterImage),st.load(k.characterImage).then(v=>{console.log("[Deck] Player character loaded successfully:",k.characterImage),Z.characterSprite.texture=v;const E=window.innerWidth<=768,M=window.innerWidth<=480;Z.characterSprite.height=M?120:E?140:180,Z.characterSprite.scale.x=Z.characterSprite.scale.y,Z.characterSprite.parent||(Ue.addChild(Z.characterSprite),Ue.setChildIndex(Z.countText,Ue.children.length-1)),Z.characterSprite.visible=!0,de=k.characterImage??null}).catch(v=>{console.warn("[Deck] Failed to load player character:",k.characterImage,v),Z.characterSprite.visible=!1,de=null})):(Z.characterSprite.visible=!1,de=null),k.enemyImage?(console.log("[Deck] Loading enemy character:",k.enemyImage),st.load(k.enemyImage).then(v=>{console.log("[Deck] Enemy character loaded successfully:",k.enemyImage),ee.characterSprite.texture=v;const E=window.innerWidth<=768,M=window.innerWidth<=480;ee.characterSprite.height=M?120:E?140:180,ee.characterSprite.scale.x=ee.characterSprite.scale.y,ee.characterSprite.parent||(Ge.addChild(ee.characterSprite),Ge.setChildIndex(ee.countText,Ge.children.length-1)),ee.characterSprite.visible=!0,Qe=k.enemyImage??null}).catch(v=>{console.warn("[Deck] Failed to load enemy character:",k.enemyImage,v),ee.characterSprite.visible=!1,Qe=null})):(ee.characterSprite.visible=!1,Qe=null))}else if(y.battleContext.type==="pvp"){const k=Rd(y.playerDeck,nS),v=Rd(y.enemyDeck,aS);k!==de?st.load(k).then(E=>{Z.characterSprite.texture=E;const M=window.innerWidth<=768,P=window.innerWidth<=480;Z.characterSprite.height=P?120:M?140:180,Z.characterSprite.scale.x=Z.characterSprite.scale.y,Z.characterSprite.parent||(Ue.addChild(Z.characterSprite),Ue.setChildIndex(Z.countText,Ue.children.length-1)),Z.characterSprite.visible=!0,de=k}).catch(E=>{console.warn("[Deck] Failed to load PvP player portrait:",k,E),Z.characterSprite.visible=!1,de=null}):Z.characterSprite.texture&&(Z.characterSprite.visible=!0),v!==Qe?st.load(v).then(E=>{ee.characterSprite.texture=E;const M=window.innerWidth<=768,P=window.innerWidth<=480;ee.characterSprite.height=P?120:M?140:180,ee.characterSprite.scale.x=ee.characterSprite.scale.y,ee.characterSprite.parent||(Ge.addChild(ee.characterSprite),Ge.setChildIndex(ee.countText,Ge.children.length-1)),ee.characterSprite.visible=!0,Qe=v}).catch(E=>{console.warn("[Deck] Failed to load PvP enemy portrait:",v,E),ee.characterSprite.visible=!1,Qe=null}):ee.characterSprite.texture&&(ee.characterSprite.visible=!0)}else Z.characterSprite.visible=!1,ee.characterSprite.visible=!1,de=null,Qe=null;else Z.characterSprite.visible=!1,ee.characterSprite.visible=!1,de=null,Qe=null}Op().then(()=>{console.log("[Deck] Initialization complete")}),Ni();function ze(y,w="damage"){if(!y.visible||!y.texture)return;const k={damage:16737894,heal:6750054,shield:6711039,energy:16777062,burn:16737792,freeze:6750207,shock:16772710,vulnerable:16738047,buff:16766720,draw:16777215,"card-trail":4890367}[w]||16777215;y.tint=k,setTimeout(()=>{y.tint=16777215},150)}function Bp(y){const w=Y.renderer.width/2,I=Y.renderer.height/2;switch(y){case"player":return{x:Ue.x,y:Ue.y};case"enemy":return{x:Ge.x,y:Ge.y};case"center":return{x:w,y:I};default:return{x:w,y:I}}}vv(async(y,w,I)=>{await Fp(y,w,I)}),wv((y,w,I)=>{const k=Bp(w);switch(y){case"damage":rt.playDamageEffect(k.x,k.y,I||0),q.playSFX("damage",.8),w==="player"?ze(Z.characterSprite,"damage"):w==="enemy"&&ze(ee.characterSprite,"damage");break;case"heal":rt.playHealEffect(k.x,k.y,I||0),q.playSFX("heal",.7),w==="player"?ze(Z.characterSprite,"heal"):w==="enemy"&&ze(ee.characterSprite,"heal");break;case"shield":rt.playShieldEffect(k.x,k.y),q.playSFX("shield",.6),w==="player"?ze(Z.characterSprite,"shield"):w==="enemy"&&ze(ee.characterSprite,"shield");break;case"energy":rt.playEnergyEffect(k.x,k.y),w==="player"?ze(Z.characterSprite,"energy"):w==="enemy"&&ze(ee.characterSprite,"energy");break;case"draw":rt.playDrawEffect(k.x,k.y),q.playSFX("card_draw",.5),w==="player"?ze(Z.characterSprite,"draw"):w==="enemy"&&ze(ee.characterSprite,"draw");break;case"burn":rt.playBurnEffect(k.x,k.y),q.playSFX("burn",.6),w==="player"?ze(Z.characterSprite,"burn"):w==="enemy"&&ze(ee.characterSprite,"burn");break;case"freeze":rt.playFreezeEffect(k.x,k.y),q.playSFX("freeze",.6),w==="player"?ze(Z.characterSprite,"freeze"):w==="enemy"&&ze(ee.characterSprite,"freeze");break;case"shock":rt.playShockEffect(k.x,k.y),q.playSFX("shock",.7),w==="player"?ze(Z.characterSprite,"shock"):w==="enemy"&&ze(ee.characterSprite,"shock");break;case"vulnerable":rt.playVulnerableEffect(k.x,k.y),w==="player"?ze(Z.characterSprite,"vulnerable"):w==="enemy"&&ze(ee.characterSprite,"vulnerable");break;case"buff":rt.playBuffEffect(k.x,k.y),w==="player"?ze(Z.characterSprite,"buff"):w==="enemy"&&ze(ee.characterSprite,"buff");break;case"victory":rt.playVictoryEffect(k.x,k.y),q.playSFX("victory",1);break;case"defeat":rt.playDefeatEffect(k.x,k.y),q.playSFX("defeat",1);break;case"card-trail":rt.playCardTrailEffect(k.x,k.y,I||4890367),q.playSFX("card_play",.5);break;default:console.warn(`[VFX] Unknown effect type: ${y}`)}});const ra=new ve;ra.y=50,Y.stage.addChild(ra);const Me=new ve,$e=new ve;function sa(y,w,I){y.removeChildren();const k=new Pe;k.rect(0,0,w,20),k.fill({color:3355443}),y.addChild(k);const v=new Pe;v.rect(0,0,w,20),v.fill({color:5025616}),y.addChild(v);const E=new Pe;E.rect(0,0,w,20),E.stroke({color:0,width:2}),y.addChild(E);const M=new sr({text:"100/100",style:{fontSize:14,fill:16777215,fontWeight:"bold",stroke:{color:0,width:3}}});M.anchor.set(.5),M.x=w/2,M.y=10,y.addChild(M);const P=new sr({text:I?"PLAYER":"ENEMY",style:{fontSize:12,fill:I?4890367:16729156,fontWeight:"bold"}});return P.x=0,P.y=-18,y.addChild(P),{hpBar:v,hpText:M,bgBar:k}}let Tt=200,Ft=200,na=sa(Me,Tt,!0),aa=sa($e,Ft,!1);Y.stage.addChild(Me),Y.stage.addChild($e);function ia(y,w,I){y.removeChildren();const k=window.innerWidth<=768,v=window.innerWidth<=480,E=v?12:16,M=v?9:k?10:12,P=new Pe;P.rect(0,0,w,E),P.fill({color:3355443}),y.addChild(P);const D=new Pe;D.rect(0,0,w,E),D.fill({color:16771899}),y.addChild(D);const H=new Pe;H.rect(0,0,w,E),H.stroke({color:0,width:2}),y.addChild(H);const L=new sr({text:"10/10",style:{fontSize:M,fill:0,fontWeight:"bold"}});return L.anchor.set(.5),L.x=w/2,L.y=E/2,y.addChild(L),{energyBar:D,energyText:L,bgBar:P}}const ir=new ve,or=new ve;let oa=ia(ir,200),ca=ia(or,200);Y.stage.addChild(ir),Y.stage.addChild(or);const ot=new ve;ot.x=Me.x,ot.y=Me.y+30,Y.stage.addChild(ot);const ct=new ve;ct.x=$e.x,ct.y=$e.y+30,Y.stage.addChild(ct);function Ke(y,w,I,k){const v=new ve,E=new Pe;E.rect(0,0,50,24),E.fill({color:k,alpha:.8}),E.stroke({color:0,width:1}),v.addChild(E);const M=new sr({text:`${y} ${w}`,style:{fontSize:14,fill:16777215,fontWeight:"bold"}});if(M.x=4,M.y=4,v.addChild(M),I>0){const P=new sr({text:`${I}T`,style:{fontSize:10,fill:13421772}});P.x=38,P.y=2,v.addChild(P)}return v}function hl(){const y=N.getState(),w={Burn:{emoji:"",color:16007990},Freeze:{emoji:"",color:240116},Shock:{emoji:"",color:16771899},Vulnerable:{emoji:"",color:15277667},Weak:{emoji:"",color:7951688},Poison:{emoji:"",color:5025616},Silence:{emoji:"",color:6323595},Strength:{emoji:"",color:16750592},Vigor:{emoji:"",color:16761095},Focus:{emoji:"",color:10233776}};ot.removeChildren();let I=0;if(y.playerStatus.shield>0){const v=Ke("",y.playerStatus.shield,y.playerStatus.shieldDuration,4890367);v.x=I,ot.addChild(v),I+=54}if(y.playerStatus.guard>0){const v=Ke("",y.playerStatus.guard,y.playerStatus.guardDuration,2201331);v.x=I,ot.addChild(v),I+=54}if(y.playerStatus.attackBuff>0){const v=Ke("",y.playerStatus.attackBuff,0,16750592);v.x=I,ot.addChild(v),I+=54}if(y.playerStatus.regen>0){const v=Ke("",y.playerStatus.regen,0,5025616);v.x=I,ot.addChild(v),I+=54}if(y.playerStatus.shockStacks>0){const v=Ke("",y.playerStatus.shockStacks,0,16771899);v.x=I,ot.addChild(v),I+=54}if(y.playerStatus.evasionCharges>0){const v=Ke("",y.playerStatus.evasionCharges,y.playerStatus.evasionDuration,10233776);v.x=I,ot.addChild(v),I+=54}if(y.playerStatus.nullifyCharges>0){const v=Ke("",y.playerStatus.nullifyCharges,0,16750592);v.x=I,ot.addChild(v),I+=54}if(y.playerStatus.counterValue>0){const v=Ke("",y.playerStatus.counterValue,y.playerStatus.counterDuration,15277667);v.x=I,ot.addChild(v),I+=54}y.playerStatus.statuses.forEach(v=>{const E=w[v.key];if(E){const M=Ke(E.emoji,v.stacks||1,v.duration,E.color);M.x=I,ot.addChild(M),I+=54}}),ct.removeChildren();let k=0;if(y.enemyStatus.shield>0){const v=Ke("",y.enemyStatus.shield,y.enemyStatus.shieldDuration,4890367);v.x=k,ct.addChild(v),k+=54}if(y.enemyStatus.guard>0){const v=Ke("",y.enemyStatus.guard,y.enemyStatus.guardDuration,2201331);v.x=k,ct.addChild(v),k+=54}if(y.enemyStatus.attackBuff>0){const v=Ke("",y.enemyStatus.attackBuff,0,16750592);v.x=k,ct.addChild(v),k+=54}if(y.enemyStatus.regen>0){const v=Ke("",y.enemyStatus.regen,0,5025616);v.x=k,ct.addChild(v),k+=54}if(y.enemyStatus.shockStacks>0){const v=Ke("",y.enemyStatus.shockStacks,0,16771899);v.x=k,ct.addChild(v),k+=54}if(y.enemyStatus.evasionCharges>0){const v=Ke("",y.enemyStatus.evasionCharges,y.enemyStatus.evasionDuration,10233776);v.x=k,ct.addChild(v),k+=54}if(y.enemyStatus.nullifyCharges>0){const v=Ke("",y.enemyStatus.nullifyCharges,0,16750592);v.x=k,ct.addChild(v),k+=54}if(y.enemyStatus.counterValue>0){const v=Ke("",y.enemyStatus.counterValue,y.enemyStatus.counterDuration,15277667);v.x=k,ct.addChild(v),k+=54}y.enemyStatus.statuses.forEach(v=>{const E=w[v.key];if(E){const M=Ke(E.emoji,v.stacks||1,v.duration,E.color);M.x=k,ct.addChild(M),k+=54}}),ot.visible=y.gameScreen==="battle",ct.visible=y.gameScreen==="battle"}const Jt=N.getState();ps(Me,na,Jt.playerHp,Jt.playerMaxHp,Tt,Jt.playerHp,!1),ps($e,aa,Jt.enemyHp,Jt.enemyMaxHp,Ft,Jt.enemyHp,!1),ms(ir,oa,Jt.energy,10,Tt),ms(or,ca,Jt.enemyEnergy,10,Ft),hl();const dl=()=>{const y=window.innerWidth<=768,w=window.innerWidth<=480,I=w?120:y?150:200,k=w?120:y?150:200;if(Tt!==I){Tt=I;const F=N.getState();na=sa(Me,Tt,!0),ps(Me,na,F.playerHp,F.playerMaxHp,Tt,F.playerHp,!1),oa=ia(ir,Tt),ms(ir,oa,F.energy,10,Tt)}if(Ft!==k){Ft=k;const F=N.getState();aa=sa($e,Ft,!1),ps($e,aa,F.enemyHp,F.enemyMaxHp,Ft,F.enemyHp,!1),ca=ia(or,Ft),ms(or,ca,F.enemyEnergy,10,Ft)}const v=w?90:y?105:130,E=w?124:y?145:180,M=v/2,P=E/2;Z.shadow.clear(),Z.shadow.rect(-M,-P,v,E),Z.shadow.fill({color:0,alpha:.3}),Z.characterBackground.clear(),Z.characterBackground.rect(-M,-P,v,E),Z.characterBackground.fill({color:1710638,alpha:.3}),ee.shadow.clear(),ee.shadow.rect(-M,-P,v,E),ee.shadow.fill({color:0,alpha:.3}),ee.characterBackground.clear(),ee.characterBackground.rect(-M,-P,v,E),ee.characterBackground.fill({color:1710638,alpha:.3});const D=w?100:y?150:200,H=w?-30:y?-40:-60,L=y?-50:-100,O=w?50:60;Me.x=Y.renderer.width/2-D+L,Me.y=Y.renderer.height/2+O,$e.x=Y.renderer.width/2+D+L,$e.y=Y.renderer.height/2+O;const X=w?20:25;ir.x=Me.x,ir.y=Me.y+X,or.x=$e.x,or.y=$e.y+X,Ue.x=Y.renderer.width/2-D,Ue.y=Y.renderer.height/2+H,Ge.x=Y.renderer.width/2+D,Ge.y=Y.renderer.height/2+H,Lt.x=Y.renderer.width/2,Lt.y=Y.renderer.height/2+H,w?(Lt.style.fontSize=32,Lt.style.stroke={color:0,width:3}):y?(Lt.style.fontSize=40,Lt.style.stroke={color:0,width:3}):(Lt.style.fontSize=48,Lt.style.stroke={color:0,width:4});const ne=w?20:25;ot.x=Me.x,ot.y=ir.y+ne,ct.x=$e.x,ct.y=or.y+ne};dl(),window.addEventListener("resize",dl);let ul=Jt.playerHp,fl=Jt.enemyHp;function Dp(y,w){const I=w<0?16711680:65280;if(!y.getChildAt(0))return;let v=.6;const E=300,M=Date.now(),P=()=>{const D=Date.now()-M,H=Math.min(D/E,1);if(v=.6*(1-H),H<1){y.children.length>4&&y.removeChildAt(4);const L=new Pe;L.rect(0,0,Tt,20),L.fill({color:I,alpha:v}),y.addChildAt(L,4),requestAnimationFrame(P)}else y.children.length>4&&y.removeChildAt(4)};P()}function ps(y,w,I,k,v,E,M=!0){const P=Math.max(0,Math.min(1,I/k)),D=v*P;let H;if(P>.6?H=5025616:P>.3?H=16771899:H=16007990,w.hpBar.clear(),w.hpBar.rect(0,0,D,20),w.hpBar.fill({color:H}),w.hpText.text=`${Math.round(I)}/${k}`,M&&Math.abs(I-E)>.1){const L=I-E;Dp(y,L)}}function ms(y,w,I,k,v){const E=Math.max(0,Math.min(1,I/k)),M=v*E,D=window.innerWidth<=480?12:16;w.energyBar.clear(),w.energyBar.rect(0,0,M,D),w.energyBar.fill({color:16771899}),w.energyText.text=`${Math.round(I)}/${k}`}let pl=[],la=!1,Hi=!1;function kr(){if(la){Hi=!0;return}la=!0;try{const y=N.getState();if(Za.releaseAll(),pl=[],ra.removeChildren(),!y.enemyHand||y.enemyHand.length===0){la=!1;return}const w=lr?Math.min(hr,y.enemyHand.length):y.enemyHand.length,I=window.innerWidth<=768,k=I?90:100,v=I?135:150,E=I?6:8,M=(Y.renderer.width-(w*(k+E)-E))*.5;for(let P=0;P<w;P++){const D=y.enemyHand[P],H=Za.acquire(k,v),{container:L,costText:O,nameText:X}=H;L.x=M+P*(k+E),L.y=0,L.visible=!0,L.scale.set(1),L.alpha=1,L.tint=16777215;const ne=Qa();if(ne){const F=mt.from(ne);F.width=k,F.height=v,F.tint=16777215,Za.replaceSprite(H,F)}else{const F=new Pe;F.rect(0,0,k,v),F.fill({color:2759242});const fe=new sr({text:"?",style:{fontSize:48,fill:16766720}});fe.anchor.set(.5),fe.x=k/2,fe.y=v/2,F.addChild(fe),Za.replaceSprite(H,F)}O.visible=!1,X.visible=!1,L.eventMode="static",L.cursor="help",L.on("pointerenter",F=>{en(D,F.globalX,F.globalY),L.scale.set(1.1)}),L.on("pointerleave",()=>{ar(),L.scale.set(1)}),ra.addChild(L),pl.push({sprite:H.sprite,container:L,index:P})}}finally{la=!1,Hi&&(Hi=!1,kr())}}const kt=new ve;kt.y=Y.renderer.height-200,Y.stage.addChild(kt);let lt={isDragging:!1,startX:0,startContainerX:0,minX:0,maxX:0};function Lp(){const y=N.getState();if(!y.hand||y.hand.length===0){lt.minX=0,lt.maxX=0;return}const w=window.innerWidth<=768,I=w?100:120,k=w?8:10,v=y.hand.length*(I+k)-k,E=Y.renderer.width;v>E?(lt.maxX=0,lt.minX=E-v-50):(lt.minX=0,lt.maxX=0,kt.x=0)}kt.eventMode="static",kt.on("pointerdown",y=>{lt.isDragging=!0,lt.startX=y.global.x,lt.startContainerX=kt.x}),kt.on("pointermove",y=>{if(!lt.isDragging)return;const w=y.global.x-lt.startX;let I=lt.startContainerX+w;I=Math.max(lt.minX,Math.min(lt.maxX,I)),kt.x=I}),kt.on("pointerup",()=>{lt.isDragging=!1}),kt.on("pointerupoutside",()=>{lt.isDragging=!1});let ml=[],Ui=!1,Gi=!1;async function Fp(y,w,I){return new Promise(async k=>{const v=Ma(y);if(!v){console.warn("[CardUse] Card image not found"),k();return}try{const E=await st.load(v),M=N.getState(),P=window.innerWidth<=768,D=P?100:120,H=P?150:180,L=P?8:10,O=w?M.hand.length:M.enemyHand.length,X=(Y.renderer.width-(O*(D+L)-L))*.5;let ne,F;w&&I>=0?(ne=X+I*(D+L)+D/2,F=Y.renderer.height-H/2-20):(ne=Y.renderer.width/2,F=H/2+70);const fe=Y.renderer.width/2,ie=Y.renderer.height/2,ce=new ve;ce.x=ne,ce.y=F,Y.stage.addChild(ce);const ge=new mt(E);ge.anchor.set(.5),ge.width=D,ge.height=H,ce.addChild(ge);const we=new Pe;we.rect(0,0,Y.renderer.width,Y.renderer.height),we.fill({color:0,alpha:0}),Y.stage.addChildAt(we,Y.stage.children.indexOf(ce));const Ne=new Pe,Oe=210;Ne.rect(-Oe/2,-Oe*275/200/2,Oe,Oe*275/200),Ne.stroke({color:w?4890367:16729156,width:4}),Ne.alpha=0,ce.addChild(Ne);const Pt=400,et=Date.now(),tt=()=>{const le=Date.now()-et,U=Math.min(le/Pt,1),ye=Mr.easeOutCubic(U);ce.x=ne+(fe-ne)*ye,ce.y=F+(ie-F)*ye,we.alpha=ye*.3,U<1?requestAnimationFrame(tt):jt()},jt=()=>{const U=Date.now(),ye=ge.width,te=ge.height,Ee=200,ys=275,Te=()=>{const ht=Date.now()-U,Rt=Math.min(ht/500,1),Zt=Mr.easeOutCubic(Rt);ge.width=ye+(Ee-ye)*Zt,ge.height=te+(ys-te)*Zt,we.alpha=.3+Zt*.2,Ne.alpha=Zt*.8,Rt<1?requestAnimationFrame(Te):setTimeout(()=>{const pt=Date.now(),oe=()=>{const Tr=Date.now()-pt,bs=Math.min(Tr/300,1),dr=Mr.easeInCubic(bs);if(ge.width=Ee*(1-dr),ge.height=ys*(1-dr),ce.alpha=1-dr,we.alpha=.5-dr*.5,Ne.alpha=.8-dr*.8,bs<1)requestAnimationFrame(oe);else{Y.stage.removeChild(ce),Y.stage.removeChild(we);const pn=Y.renderer.width/2,Jp=Y.renderer.height/2;rt.playCardTrailEffect(pn,Jp,w?4890367:16729156),k()}};oe()},400)};Te()};tt()}catch(E){console.warn("[CardUse] Failed to load card image:",E),k()}})}async function gl(y,w=!0){return new Promise(I=>{const k=new mt,v=Qa();if(!v){I();return}st.load(v).then(E=>{k.texture=E,k.width=120,k.height=165,k.anchor.set(.5);const M=w?Ue:Ge;k.x=M.x,k.y=M.y,k.rotation=0,k.alpha=1,Y.stage.addChild(k);const P=300,D=Date.now(),H=k.x,L=k.y,O=()=>{const X=Date.now()-D,ne=Math.min(X/P,1),F=Mr.easeOutQuad(ne);k.x=H+(y.x-H)*F,k.y=L+(y.y-L)*F,k.rotation=Math.PI*2*F,ne<1?requestAnimationFrame(O):(Y.stage.removeChild(k),rt.playDrawEffect(y.x,y.y),q.playSFX("card_draw",.5),I())};O()}).catch(E=>{console.warn("[DrawAnim] Failed to load card back:",E),I()})})}function an(){if(Ui){Gi=!0;return}Ui=!0;try{const y=N.getState();if(Cs.releaseAll(),ml=[],kt.removeChildren(),!y.hand||y.hand.length===0)return;const w=Er?Math.min(fn,y.hand.length):y.hand.length,I=window.innerWidth<=768,k=window.innerWidth<=480,v=k?75:I?90:120,E=k?112:I?135:180,M=k?5:I?6:10,P=(Y.renderer.width-(w*(v+M)-M))*.5;for(let D=0;D<w;D++){const H=y.hand[D],L=Cs.acquire(v,E),O=L.container;for(O.x=P+D*(v+M),O.y=0,O.visible=!0,O.scale.set(1),O.alpha=1,O.tint=16777215;O.children.length>4;)O.removeChildAt(4);const X=Fo(H);if(X){const le=mt.from(X);le.width=v,le.height=E,le.tint=16777215,Cs.replaceSprite(L,le)}else{const le=new Pe;le.rect(0,0,v,E),le.fill({color:y.energy<H.cost?4473924:5596791}),Cs.replaceSprite(L,le)}Cs.setupCostText(L,H.cost,v,y.energy>=H.cost);const ne=L.costText;ne instanceof ve&&(ne.x=v-15,ne.y=15);const F={Attack:{color:16729156,iconPath:"cardIcons/Type/type_attack.png"},Defense:{color:4474111,iconPath:"cardIcons/Type/type_defense.png"},Heal:{color:4521796,iconPath:"cardIcons/Type/type_heal.png"},Special:{color:16729343,iconPath:"cardIcons/Type/type_special.png"}}[H.type]||{color:16777215,iconPath:"cardIcons/Type/type_attack.png"};Cs.setupTypeIcon(L,F.color,F.iconPath);const fe=L.typeIcon;if(fe instanceof ve&&(fe.x=15,fe.y=15),y.energy<H.cost){const le=new Pe;le.rect(0,0,v,E),le.fill({color:0,alpha:.5}),O.addChild(le),O.alpha=.6}const ie=N.getState(),ce=ie.queuedHandIndices.includes(D),ge=ie.getRemainingEnergy(),we=!ce&&ie.gameOver==="none"&&H.cost<=ge,Ne=O.y,Oe=Ne-20,Pt=1.05;ce?(O.y=Oe,O.scale.set(Pt),O.alpha=1):O.alpha=we?1:.5,O.removeAllListeners(),O.eventMode="static",O.cursor=we||ce?"pointer":"not-allowed",O.on("pointerenter",le=>{N.getState().queuedHandIndices.includes(D)?(O.y=Oe-10,O.scale.set(Pt*1.05)):we&&(O.y=Ne-15,O.scale.set(1.1)),en(H,le.globalX,le.globalY)}),O.on("pointerleave",()=>{N.getState().queuedHandIndices.includes(D)?(O.y=Oe,O.scale.set(Pt)):(O.y=Ne,O.scale.set(1)),ar()});let et=null,tt=0,jt={x:0,y:0};O.on("pointerdown",le=>{N.getState().gameOver==="none"&&(tt=Date.now(),jt={x:le.globalX,y:le.globalY},et=window.setTimeout(()=>{ar(),Ze(H),et=null},500))}),O.on("pointerup",le=>{et!==null&&(clearTimeout(et),et=null);const U=N.getState();if(U.gameOver!=="none")return;const ye=Date.now()-tt,te=Math.hypot(le.globalX-jt.x,le.globalY-jt.y);if(ye<500&&te<10){if(ar(),N.getState().isTurnProcessing)return;U.queuedHandIndices.includes(D)?(q.playSFX("card_play",.4),N.getState().unDeclareCard(D)):(q.playSFX("card_play",.6),N.getState().declareCard(D))}}),O.on("pointerupoutside",()=>{et!==null&&(clearTimeout(et),et=null)}),kt.addChild(O),requestAnimationFrame(()=>{if(!O.parent)return;N.getState().queuedHandIndices.includes(D)||(O.y=Ne,O.scale.set(1))}),ml.push({sprite:L.sprite,container:O,index:D})}}finally{Ui=!1,Lp(),Gi&&(Gi=!1,an())}}window.addEventListener("resize",async()=>{kt.y=Y.renderer.height-200,await an()});let Ir=[],Qt=!1,Ve=null;function jp(y){const w=["ATT_ARIANA_NO_001","ATT_ARIANA_NO_001","ATT_ARIANA_NO_001","ATT_DARIUS_NO_017","ATT_ELDER_NO_033","ATT_ELENA_NO_049","ATT_GAREN_NO_065","ATT_IRIS_NO_081","DEF_ARIANA_NO_013","DEF_ARIANA_NO_013","DEF_ARIANA_NO_013","DEF_ELENA_NO_061","DEF_IRIS_NO_093","HEA_ARIANA_NO_005","HEA_ARIANA_NO_005","HEA_ARIANA_NO_005","HEA_DARIUS_NO_021","SPE_ARIANA_NO_009","SPE_ARIANA_NO_009","SPE_ELDER_NO_041"],I=new Map(y.map(v=>[v.id,v])),k=[];for(const v of w){const E=I.get(v);E&&k.push({...E,id:`${E.id}_${Date.now()}_${Math.random()}`})}return k}try{console.log("Loading cards from /data/cards.json..."),Rr.setProgress(10,"   ..."),Ir=await Uv(),console.log(`Loaded ${Ir.length} cards`),N.getState().setAllCardsPool(Ir);const y=N.getState(),w=ut.getState().session!==null;if(y.collection.length===0&&!w){const I=jp(Ir);y.setCollection(I)}Rr.setProgress(30,"   ..."),await Vv(Ir),Rr.setProgress(80," ..."),await new Promise(I=>setTimeout(I,500)),Rr.setProgress(100,"!"),await new Promise(I=>setTimeout(I,300)),Rr.hide(),bt.success(`${Ir.length}   !`,2e3)}catch(y){console.error("Failed to load sample cards",y),Rr.hide(),bt.error(`  : ${y instanceof Error?y.message:String(y)}`,5e3),t.innerHTML=`<span style="color: #f88;">  : ${y instanceof Error?y.message:String(y)}</span>`}function ha(){Sn.classList.add("active"),ei.classList.remove("active");const y=N.getState(),{playerDeck:w,collection:I}=y;console.log("[UI][DeckEditor] Rendering with state",{deckLength:w.length,collectionLength:I.length,deckSampleIds:w.slice(0,3).map(U=>U.id),deckSampleNames:w.slice(0,3).map(U=>U.name),collectionSampleIds:I.slice(0,3).map(U=>U.id),collectionSampleNames:I.slice(0,3).map(U=>U.name)});const k=y.getDeckValidity(),v=[0,0,0,0,0,0];w.forEach(U=>{const ye=Math.min(5,Math.max(0,U.cost));v[ye]++});const E=new Map;w.forEach(U=>{const ye=E.get(U.id)||0;E.set(U.id,ye+1)});const M=window.innerWidth<=768,P=window.innerWidth<=480,D=P?80:M?100:110,H=P?120:M?140:160,L=P?10:M?14:18,O=P?6:8,X=w.reduce((U,ye)=>U+((ye==null?void 0:ye.cost)??0),0),ne=w.length>0?(X/w.length).toFixed(1):"0.0",F=w.filter(U=>U.rarity==="Legendary").length,fe=new Set(w.map(U=>U.id.split("__snap__")[0]??U.id)),ie=k.errors.length>0?`
          <div style="background: rgba(244, 67, 54, 0.2); border: 1px solid #f44336; border-radius: 6px; padding: 8px; margin-bottom: 12px; font-size: 12px;">
            ${k.errors.map(U=>`<div> ${U}</div>`).join("")}
          </div>
        `:"",ce=k.valid?`
          <div style="background: rgba(102, 187, 106, 0.18); border: 1px solid rgba(102, 187, 106, 0.45); border-radius: 8px; padding: 10px; font-size: 12px; color: #c8e6c9;">
               .
          </div>
        `:`
          <div style="background: rgba(244, 67, 54, 0.18); border: 1px solid rgba(244, 67, 54, 0.45); border-radius: 8px; padding: 10px; font-size: 12px; color: #ffab91; line-height: 1.5;">
            ${k.errors.map(U=>` ${U}`).join("<br>")}
          </div>
        `,ge=`
      <div class="cost-chart">
        <h4 style="margin-top: 0;"> </h4>
        ${v.map((U,ye)=>`
          <div class="cost-bar">
            <div class="label"> ${ye}</div>
            <div class="bar">
              <div class="bar-fill" style="width: ${U/20*100}%"></div>
            </div>
            <div class="count">${U}</div>
          </div>
        `).join("")}
      </div>
    `,we=`
      <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
        <div style="background: rgba(33, 150, 243, 0.18); border: 1px solid rgba(33, 150, 243, 0.45); border-radius: 10px; padding: 10px;">
          <div style="font-size: 12px; color: #bbdefb;"> </div>
          <div style="font-size: 18px; font-weight: 700; margin-top: 4px;">${ne}</div>
        </div>
        <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.18); border-radius: 10px; padding: 10px; display: flex; justify-content: space-between; font-size: 12px;">
          <span> </span>
          <span style="font-weight: 700;">${F}</span>
        </div>
        <div style="background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.18); border-radius: 10px; padding: 10px; display: flex; justify-content: space-between; font-size: 12px;">
          <span>  </span>
          <span style="font-weight: 700;">${fe.size}</span>
        </div>
      </div>
    `,Ne=`
      <div class="header">
        <div>
          <h2>  </h2>
          <div style="font-size: 11px; color: #aaa; margin-top: 6px;">
             <strong>PC:</strong> Shift+      | <strong>:</strong>   
          </div>
          <div style="display: flex; gap: 8px; margin-top: 8px;">
            <button id="deck-menu-btn" style="background: #2a3f5f; color: #fff; border: 1px solid #3a4f75; padding: 4px 12px; border-radius: 6px; cursor: pointer;">  </button>
            <button id="deck-gallery-btn" style="background: #4a9eff; color: #fff; border: 1px solid #5aaeff; padding: 4px 12px; border-radius: 6px; cursor: pointer;"> </button>
          </div>
        </div>
        <div class="deck-info">
          <div class="info-item ${k.valid?"valid":"invalid"}">
            <strong> :</strong> ${w.length}/20
          </div>
          <div class="info-item ${k.valid?"valid":"invalid"}">
            <strong>:</strong> ${k.valid?" ":" "}
          </div>
        </div>
      </div>
    `;let Oe="";if(M){const U={collection:"",deck:" ",stats:" "};Cd.includes(fr)||(fr="collection"),Oe=`
        <div class="mobile-tab-nav" style="display: flex; gap: 10px; margin: 12px 0; padding: 0 2px;">
          ${Cd.map(te=>{const Ee=te===fr;return`
          <button
            type="button"
            data-deck-tab="${te}"
            style="
              flex: 1;
              padding: 10px 12px;
              border-radius: 999px;
              border: 1px solid ${Ee?"#4a9eff":"rgba(255,255,255,0.25)"};
              background: ${Ee?"linear-gradient(90deg, rgba(74,158,255,0.9), rgba(33,150,243,0.9))":"rgba(255,255,255,0.08)"};
              color: ${Ee?"#E3F2FD":"#cfd8dc"};
              font-size: 13px;
              font-weight: 600;
              transition: all 0.2s ease;
            "
          >
            ${U[te]}
          </button>
        `}).join("")}
        </div>
        <div class="mobile-page" data-page="collection" style="${fr==="collection"?"":"display:none;"}">
          <h3 style="margin: 8px 0;">  (${I.length})</h3>
          <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
               ,       .
          </div>
          <div class="card-grid" id="collection-grid"></div>
        </div>
        <div class="mobile-page" data-page="deck" style="${fr==="deck"?"":"display:none;"}">
          <h3 style="margin: 8px 0;">  (${w.length}/20)</h3>
          <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
                ,       .
          </div>
          ${ie}
          <div class="deck-card-list" id="deck-list"></div>
        </div>
        <div class="mobile-page" data-page="stats" style="${fr==="stats"?"":"display:none;"}">
          <h3 style="margin: 8px 0;"> </h3>
          ${ce}
          ${we}
          ${ge}
        </div>
      `}else fr="collection",Oe=`
        <div class="content">
          <div class="collection">
            <h3>  (${I.length})</h3>
            <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
              <strong>PC:</strong> :  | Shift+/: <br>
              <strong>:</strong>  :  |   (0.5): 
            </div>
            <div class="card-grid" id="collection-grid"></div>
          </div>
          <div class="current-deck">
            <h3>  (${w.length}/20)</h3>
            <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
              <strong>PC:</strong>   X   | Shift+: <br>
              <strong>:</strong>    X   |  : 
            </div>
            ${ie}
            <div class="deck-card-list" id="deck-list"></div>
            ${ge}
          </div>
        </div>
      `;Sn.innerHTML=`${Ne}${Oe}`;const Pt=document.getElementById("deck-menu-btn");Pt.onclick=()=>{N.getState().setGameScreen("menu")};const et=document.getElementById("deck-gallery-btn");et.onclick=()=>{Np()},M&&document.querySelectorAll("button[data-deck-tab]").forEach(ye=>{ye.onclick=()=>{const te=ye.dataset.deckTab;te&&te!==fr&&(fr=te,ha())}});const tt=document.getElementById("collection-grid"),jt=(U,ye)=>{if(Ds&&!window.confirm(`'${U.name}'   ?`))return;const te=N.getState().addCardToDeck(U);!te&&ye===0?bt.warning("   Legendary  .",2500):te?(bt.success(`${U.name} `,1500),q.playSFX("card_play",.6)):bt.warning(`${U.name}()  3.`,2e3)};if(M){const U=P?130:150;tt.style.cssText=`
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(${U}px, 1fr));
        gap: ${L}px;
        padding: 8px 4px 12px;
        max-height: 60vh;
        overflow-y: auto;
      `,tt.style.removeProperty("scrollbar-width"),tt.style.removeProperty("scrollbar-color")}else tt.style.cssText=`
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(${H}px, 1fr));
        gap: ${L}px;
        padding: 8px 12px 16px;
        max-height: none;
        overflow-y: auto;
      `,tt.style.removeProperty("scrollbar-width"),tt.style.removeProperty("scrollbar-color");I.forEach(U=>{const ye=E.get(U.id)||0,te=document.createElement("div");te.className=`deck-editor-card ${ye>=3?"maxed":""}`,te.style.cssText=`
        position: relative;
        cursor: pointer;
        transition: transform 0.2s;
      `;const Ee=document.createElement("img"),ys=Ma(U);if(Ee.src=ys,Ee.alt=U.name,Ee.style.cssText=`
        width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        object-fit: cover;
      `,Ee.onerror=()=>{Ee.style.display="none",te.innerHTML+=`
          <div style="background: linear-gradient(135deg, #2a3f5f, #1a2f4f); border: 2px solid #3a4f75; border-radius: 8px; padding: 10px; height: ${M?150:180}px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px; text-align: center;">${U.name}</div>
            <div style="font-size: 11px; color: #aaa; display: flex; gap: 8px;">
              <span> ${U.cost}</span>
              <span>${U.type}</span>
            </div>
          </div>
        `},ye>0){const oe=document.createElement("div");oe.className="card-count-badge",oe.textContent=`${ye}`,oe.style.cssText="position: absolute; top: 8px; right: 8px; background: #4a9eff; color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.4);",te.appendChild(oe)}te.appendChild(Ee),te.onmouseenter=()=>{te.style.transform="translateY(-4px)",Ee.style.boxShadow="0 8px 16px rgba(74, 158, 255, 0.4)"},te.onmouseleave=()=>{te.style.transform="translateY(0)",Ee.style.boxShadow="0 4px 8px rgba(0,0,0,0.3)"};let Te=null,ht=0,Rt=!1,Zt=0,_s=0,pt=!1;te.ontouchstart=oe=>{oe.touches&&oe.touches.length>0&&(Zt=oe.touches[0].clientX,_s=oe.touches[0].clientY),ht=Date.now(),Te=window.setTimeout(()=>{Ze(U),Te=null},500),pt=!1},te.ontouchmove=oe=>{if(!pt&&oe.touches&&oe.touches.length>0){const Tr=oe.touches[0].clientX,bs=oe.touches[0].clientY,dr=Math.abs(Tr-Zt),pn=Math.abs(bs-_s);(dr>8||pn>8)&&(pt=!0,Te!==null&&(clearTimeout(Te),Te=null))}},te.ontouchend=oe=>{if(Te!==null&&(clearTimeout(Te),Te=null),pt){pt=!1,Rt=!0,window.setTimeout(()=>{Rt=!1},150);return}Date.now()-ht<500&&jt(U,ye),Rt=!0,Rt=!0,window.setTimeout(()=>{Rt=!1},400)},te.ontouchcancel=()=>{Te!==null&&(clearTimeout(Te),Te=null),pt=!1},te.onclick=oe=>{if(!(Ds&&Rt)){if(oe.shiftKey){oe.preventDefault(),Ze(U);return}jt(U,ye)}},te.oncontextmenu=oe=>{oe.preventDefault(),Ze(U)},tt.appendChild(te)});const le=document.getElementById("deck-list");if(w.length===0)le.innerHTML='<div style="color: #777; text-align: center; padding: 20px;"> </div>';else{if(M){const U=P?130:150;le.style.cssText=`
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(${U}px, 1fr));
          gap: ${O}px;
          margin-top: 16px;
          max-height: 60vh;
          overflow-y: auto;
          padding: 0 4px 12px;
        `,le.style.removeProperty("scrollbar-width"),le.style.removeProperty("scrollbar-color")}else le.style.cssText=`
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(${D}px, 1fr));
          gap: ${O}px;
          margin-top: 16px;
          max-height: 600px;
          overflow-y: auto;
          padding: 0;
        `,le.style.removeProperty("scrollbar-width"),le.style.removeProperty("scrollbar-color");w.forEach((U,ye)=>{const te=document.createElement("div");te.style.cssText=`
          position: relative;
          cursor: pointer;
          transition: transform 0.2s;
        `;const Ee=document.createElement("img"),ys=Ma(U);Ee.src=ys,Ee.alt=U.name,Ee.style.cssText=`
          width: 100%;
          height: auto;
          border-radius: 6px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.3);
          object-fit: cover;
        `,Ee.onerror=()=>{Ee.style.display="none",te.innerHTML+=`
            <div style="background: rgba(0,0,0,0.3); border: 1px solid #3a4f75; border-radius: 6px; padding: 8px; height: ${M?130:140}px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11px;">
              <div style="font-weight: bold; margin-bottom: 4px; text-align: center;">${U.name}</div>
              <div style="color: #aaa;"> ${U.cost}</div>
            </div>
          `};const Te=document.createElement("button");Te.textContent="",Te.style.cssText="position: absolute; top: 4px; right: 4px; background: rgba(244, 67, 54, 0.9); color: #fff; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: all 0.2s; opacity: 0;",Te.onclick=oe=>{oe.stopPropagation(),N.getState().removeCardFromDeck(U.id),q.playSFX("card_play",.4),bt.info(`${U.name} `,1500)},te.onmouseenter=()=>{te.style.transform="translateY(-2px)",Ee.style.boxShadow="0 4px 10px rgba(244, 67, 54, 0.4)",Te.style.opacity="1"},te.onmouseleave=()=>{te.style.transform="translateY(0)",Ee.style.boxShadow="0 2px 6px rgba(0,0,0,0.3)",Te.style.opacity="0"};let ht=null,Rt=0,Zt=0,_s=0,pt=!1;te.ontouchstart=oe=>{Rt=Date.now(),oe.touches&&oe.touches.length>0&&(Zt=oe.touches[0].clientX,_s=oe.touches[0].clientY),ht=window.setTimeout(()=>{Ze(U),ht=null},500),pt=!1},te.ontouchmove=oe=>{if(!pt&&oe.touches&&oe.touches.length>0){const Tr=oe.touches[0].clientX,bs=oe.touches[0].clientY,dr=Math.abs(Tr-Zt),pn=Math.abs(bs-_s);(dr>8||pn>8)&&(pt=!0,ht!==null&&(clearTimeout(ht),ht=null))}},te.ontouchend=oe=>{if(ht!==null){clearTimeout(ht),ht=null;const Tr=Date.now()-Rt;!pt&&Tr<500&&(Te.style.opacity==="1"?Te.style.opacity="0":Te.style.opacity="1")}pt=!1},te.ontouchcancel=()=>{ht!==null&&(clearTimeout(ht),ht=null),pt=!1},te.onclick=oe=>{oe.shiftKey&&(oe.preventDefault(),Ze(U))},te.oncontextmenu=oe=>{oe.preventDefault(),Ze(U)},te.appendChild(Ee),te.appendChild(Te),le.appendChild(te)})}}function Np(){const w=N.getState().allCardsPool,I={Attack:w.filter(E=>E.type==="Attack"),Defense:w.filter(E=>E.type==="Defense"),Heal:w.filter(E=>E.type==="Heal"),Special:w.filter(E=>E.type==="Special")},k={Normal:"#9e9e9e",Rare:"#2196f3",Epic:"#9c27b0",Legendary:"#ff9800"};ei.innerHTML=`
      <div class="header">
        <div>
          <h2> </h2>
          <div style="font-size: 11px; color: #aaa; margin-top: 6px;">
             <strong>PC:</strong> Shift+      | <strong>:</strong>   
          </div>
          <button id="gallery-back-btn" style="background: #2a3f5f; color: #fff; border: 1px solid #3a4f75; padding: 4px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px;">  </button>
        </div>
        <div class="gallery-info">
          <div style="font-size: 14px;">
            <strong> :</strong> ${w.length}
          </div>
        </div>
      </div>
      <div class="content">
        ${Object.entries(I).map(([E,M])=>`
          <div style="margin-bottom: 40px;">
            <h3 style="font-size: 20px; margin-bottom: 16px; color: #4a9eff; border-bottom: 2px solid #4a9eff; padding-bottom: 8px;">
              ${E==="Attack"?" ":E==="Defense"?" ":E==="Heal"?" ":" "}  (${M.length})
            </h3>
            <div class="card-grid" id="gallery-grid-${E}"></div>
          </div>
        `).join("")}
      </div>
    `;const v=document.getElementById("gallery-back-btn");v.onclick=()=>{ei.classList.remove("active"),ha()},ei.classList.add("active"),Sn.classList.remove("active"),Object.entries(I).forEach(([E,M])=>{const P=document.getElementById(`gallery-grid-${E}`),D={Normal:0,Rare:1,Epic:2,Legendary:3};[...M].sort((L,O)=>{const X=D[L.rarity]??999,ne=D[O.rarity]??999;return X!==ne?X-ne:L.cost-O.cost}).forEach(L=>{const O=document.createElement("div");O.className="gallery-card",O.style.cssText="position: relative; cursor: pointer; transition: transform 0.2s;";const X=document.createElement("img"),ne=Ma(L);X.src=ne,X.alt=L.name,X.style.cssText="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);",X.onerror=()=>{X.style.display="none",O.innerHTML+=`
            <div style="background: linear-gradient(135deg, #2a3f5f, #1a2f4f); border: 2px solid ${k[L.rarity]||"#3a4f75"}; border-radius: 8px; padding: 12px; height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
              <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px; text-align: center; color: ${k[L.rarity]||"#fff"};">${L.name}</div>
              <div style="font-size: 11px; color: #aaa; display: flex; gap: 8px;">
                <span> ${L.cost}</span>
                <span>${L.type}</span>
              </div>
            </div>
          `};const F=document.createElement("div");F.textContent=L.rarity==="Normal"?"N":L.rarity==="Rare"?"R":L.rarity==="Epic"?"E":"L",F.style.cssText=`position: absolute; top: 8px; left: 8px; background: ${k[L.rarity]||"#9e9e9e"}; color: #fff; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; box-shadow: 0 2px 6px rgba(0,0,0,0.4);`,O.appendChild(F),O.appendChild(X),O.onmouseenter=()=>{O.style.transform="translateY(-4px)",X.style.boxShadow="0 8px 16px rgba(74, 158, 255, 0.4)"},O.onmouseleave=()=>{O.style.transform="translateY(0)",X.style.boxShadow="0 4px 8px rgba(0,0,0,0.3)"};let fe=null;O.ontouchstart=ie=>{fe=window.setTimeout(()=>{Ze(L),fe=null},500)},O.ontouchend=ie=>{fe!==null&&(clearTimeout(fe),fe=null)},O.ontouchcancel=()=>{fe!==null&&(clearTimeout(fe),fe=null)},O.onclick=ie=>{if(ie.shiftKey){ie.preventDefault(),Ze(L);return}Ze(L)},O.oncontextmenu=ie=>{ie.preventDefault(),Ze(L)},P.appendChild(O)})})}function yl(){N.getState().ensureDailyDungeon();const{dailyDungeon:w,gold:I,shards:k}=N.getState(),v=w.dateKey||new Date().toISOString().slice(0,10);let E=" 00:00 (KST)";try{const O=new Date(`${v}T00:00:00`);if(!Number.isNaN(O.getTime())){const X=new Date(O.getTime()+864e5),ne=String(X.getMonth()+1).padStart(2,"0"),F=String(X.getDate()).padStart(2,"0");E=`${X.getFullYear()}.${ne}.${F} 00:00 (KST)`}}catch{}const M=w.floors.length,P=w.floors.filter(O=>O.cleared).length,D=M>0&&P===M,H=w.floors.map((O,X)=>{const F=!(X===0?!0:w.floors[X-1].cleared),fe=O.cleared?"":F?"":" ",ie=O.cleared?"":F?"":"",ce=`
        <div class="stage-rewards">
          <span> +${O.reward.gold}</span>
          <span> +${O.reward.shards}</span>
        </div>
      `,ge=O.modifiers.map(we=>`
        <div class="modifier-item">
          <strong>${we.label}</strong>
          <div>${we.description}</div>
        </div>
      `).join("");return`
        <div class="stage-card ${O.cleared?"cleared":""} ${F?"locked":""}">
          <div class="stage-header">
            <div class="stage-number">Floor ${O.id}</div>
            <div class="badge">${fe}</div>
          </div>
          <div class="stage-name">${O.name}</div>
          <div class="stage-description">${O.description}</div>
          <div class="stage-power">  : ${O.recommendedPower}</div>
          <div class="modifier-list">${ge}</div>
          ${ce}
          <div class="stage-actions">
            <button id="daily-play-${O.id}" ${O.cleared||F?"disabled":""}>${ie}</button>
          </div>
        </div>
      `}).join("");Ho.innerHTML=`
      <div class="header">
        <div>
          <h2>  </h2>
          <div class="summary">
            <span> : ${v}</span>
            <span> : ${P} / ${M||0}</span>
            <span> ${E}</span>
            ${D?"<span>    !</span>":""}
          </div>
          <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
            <button id="daily-menu-btn" style="background: #2a3f5f; color: #fff; border: 1px solid #3a4f75; padding: 6px 14px; border-radius: 8px; cursor: pointer;">  </button>
          </div>
        </div>
        <div class="currency">
          <div class="currency-item"> : ${I}</div>
          <div class="currency-item"> : ${k}</div>
        </div>
      </div>
      <section class="chapter-section">
        <div class="chapter-header">
          <h3> </h3>
          <div class="chapter-description">        .</div>
          <div class="chapter-progress"> ${P} / ${M||0}</div>
        </div>
        <div class="stages-grid">
          ${H||'<div style="color: #ccc; font-size: 14px;">    ...</div>'}
        </div>
      </section>
    `;const L=document.getElementById("daily-menu-btn");L&&L.addEventListener("click",()=>{N.getState().setGameScreen("menu")}),w.floors.forEach((O,X)=>{const ne=X===0?!0:w.floors[X-1].cleared,F=document.getElementById(`daily-play-${O.id}`);if(F){if(O.cleared||!ne){F.disabled=!0;return}F.onclick=()=>{const fe=N.getState();if(fe.pendingReward){bt.error("  !",2e3);return}fe.enterDailyDungeonFloor(O.id)}}})}function _l(){const y=N.getState(),{campaignStages:w,gold:I,shards:k}=y;No.innerHTML=`
      <div class="header">
        <div>
          <h2> </h2>
          <button id="campaign-menu-btn" style="background: #2a3f5f; color: #fff; border: 1px solid #3a4f75; padding: 4px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px;">  </button>
        </div>
        <div class="currency">
          <div class="currency-item"> : ${I}</div>
          <div class="currency-item"> : ${k}</div>
        </div>
      </div>
      <div style="text-align: center; padding: 12px; background: rgba(103, 126, 234, 0.1); border-radius: 8px; margin: 0 16px 16px 16px; font-size: 13px; color: #aaa;">
         <strong>:</strong>   <strong>/</strong>   | <strong>  </strong>   
      </div>
      <div id="campaign-chapters"></div>
    `;const v=document.getElementById("campaign-menu-btn");v.onclick=()=>{N.getState().setGameScreen("menu")};const E=document.getElementById("campaign-chapters"),M=[{id:1,title:" Chapter 1:  ",description:"  ,   ",start:1,end:10},{id:2,title:" Chapter 2:  ",description:" ,   ,  ",start:11,end:20},{id:3,title:" Chapter 3:  ",description:"  ,    ",start:21,end:30},{id:4,title:" Chapter 4:  ",description:",  ,  ,  ",start:31,end:40},{id:5,title:" Chapter 5:  ",description:"  ,  ,  ",start:41,end:50}],P=new Map;w.forEach((D,H)=>{P.set(D.id,H)}),M.forEach(D=>{const H=w.filter(F=>F.id>=D.start&&F.id<=D.end);if(H.length===0)return;const L=H.filter(F=>F.cleared).length,O=document.createElement("section");O.className="chapter-section",O.innerHTML=`
        <div class="chapter-header">
          <h3>${D.title}</h3>
          <div class="chapter-description">${D.description}</div>
          <div class="chapter-progress"> ${L} / ${H.length}</div>
        </div>
        <div class="stages-grid" id="chapter-grid-${D.id}"></div>
      `,E.appendChild(O);const X=O.querySelector(`#chapter-grid-${D.id}`);[...H].sort((F,fe)=>F.id-fe.id).forEach(F=>{var Oe,Pt;const fe=P.get(F.id)??0,ie=fe>0&&!w[fe-1].cleared,ce=document.createElement("div");ce.className=`stage-card ${F.cleared?"cleared":""} ${ie?"locked":""}`;const ge=F.cleared?F.repeatReward:F.firstReward,we=Ip(ge,F.id,F.cleared),Ne=[];if(we.gold>0&&Ne.push(` ${we.gold}`),we.shards>0&&Ne.push(` ${we.shards}`),(Oe=F.story)!=null&&Oe.backgroundImage&&(ce.style.backgroundImage=`url('${F.story.backgroundImage}')`,ce.style.backgroundSize="cover",ce.style.backgroundPosition="center",ce.style.position="relative"),ce.innerHTML=`
          ${(Pt=F.story)!=null&&Pt.backgroundImage?'<div style="position: absolute; inset: 0; background: rgba(0, 0, 0, 0.6); border-radius: inherit;"></div>':""}
          <div style="position: relative; z-index: 1;">
            <div class="stage-header">
              <div class="stage-number">Stage ${F.id}</div>
              <div style="display: flex; gap: 8px; align-items: center;">
                ${F.cleared?'<div style="color: #4CAF50; font-size: 20px;"></div>':""}
                ${ie?'<div style="color: #f44336; font-size: 20px;"></div>':""}
                ${F.story&&!ie?`
                  <button class="story-btn" data-stage-id="${F.id}" style="
                    background: rgba(103, 126, 234, 0.8);
                    color: white;
                    border: none;
                    border-radius: 6px;
                    padding: 4px 8px;
                    font-size: 16px;
                    cursor: pointer;
                    transition: all 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                  " onmouseover="this.style.background='rgba(103, 126, 234, 1)'; this.style.transform='scale(1.05)'" onmouseout="this.style.background='rgba(103, 126, 234, 0.8)'; this.style.transform='scale(1)'">
                    <span style="font-size: 12px;"></span>
                  </button>
                `:""}
              </div>
            </div>
            <div class="stage-name">${F.name}</div>
            <div class="stage-theme">: ${F.theme}</div>
            <div class="stage-power">  : ${F.recommendedPower}</div>
            <div class="stage-rewards">: ${Ne.join(", ")}</div>
          </div>
        `,!ie){const et=ce.querySelector(".story-btn");et&&F.story&&et.addEventListener("click",tt=>{tt.stopPropagation(),Hp(F)}),ce.onclick=tt=>{var jt,le;tt.target.closest(".story-btn")||(Ve!==null&&(window.clearTimeout(Ve),Ve=null),N.getState().selectStage(F.id),Qt=!1,(jt=F.cutscene)!=null&&jt.preBattle?Vi(F.cutscene.preBattle,((le=F.story)==null?void 0:le.backgroundImage)||"",()=>{N.getState().setGameScreen("battle")}):N.getState().setGameScreen("battle"))}}X.appendChild(ce)})})}function Hp(y){if(!y.story)return;const w=document.getElementById("story-modal");w&&w.remove();const I=document.createElement("div");I.id="story-modal",I.style.cssText=`
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
      animation: fadeIn 0.3s;
    `;const k=document.createElement("div");k.style.cssText=`
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      position: relative;
      animation: slideUp 0.3s;
    `;const v=document.createElement("div");v.style.cssText=`
      height: 200px;
      background-image: url('${y.story.backgroundImage}');
      background-size: cover;
      background-position: center;
      border-radius: 12px 12px 0 0;
      position: relative;
    `;const E=document.createElement("div");E.style.cssText=`
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, transparent 0%, rgba(26, 26, 46, 0.9) 100%);
      border-radius: 12px 12px 0 0;
    `,v.appendChild(E);const M=document.createElement("div");M.style.cssText=`
      padding: 24px;
      color: white;
    `,M.innerHTML=`
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
        <div style="font-size: 14px; color: #888;">Stage ${y.id}</div>
        <div style="font-size: 24px; font-weight: bold; color: #fff;">${y.name}</div>
      </div>
      <div style="font-size: 14px; color: #aaa; margin-bottom: 8px;">
        : ${y.theme} |   : ${y.recommendedPower}
      </div>
      <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 16px 0;"></div>
      <div style="font-size: 16px; line-height: 1.8; color: #ddd; white-space: pre-wrap;">
        ${y.story.description}
      </div>
      <button id="story-modal-start" style="
        width: 100%;
        padding: 12px;
        margin-top: 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
      ">
         
      </button>
      <button id="story-modal-close" style="
        width: 100%;
        padding: 12px;
        margin-top: 8px;
        background: rgba(255,255,255,0.1);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.2s;
      ">
        
      </button>
    `,k.appendChild(v),k.appendChild(M),I.appendChild(k),document.body.appendChild(I);const P=document.getElementById("story-modal-start");P.onclick=()=>{var L,O;I.remove(),Ve!==null&&(window.clearTimeout(Ve),Ve=null),N.getState().selectStage(y.id),Qt=!1,(L=y.cutscene)!=null&&L.preBattle?Vi(y.cutscene.preBattle,((O=y.story)==null?void 0:O.backgroundImage)||"",()=>{N.getState().setGameScreen("battle")}):N.getState().setGameScreen("battle")};const D=document.getElementById("story-modal-close");D.onclick=()=>I.remove(),I.onclick=L=>{L.target===I&&I.remove()};const H=L=>{L.key==="Escape"&&(I.remove(),document.removeEventListener("keydown",H))};document.addEventListener("keydown",H)}function bl(){const w=N.getState().pendingReward;if(!w){ti.classList.remove("active");return}ti.classList.add("active"),ti.innerHTML=`
      <div class="reward-panel">
        <div class="reward-title">  !</div>
        <div class="reward-items">
          ${w.gold>0?`
            <div class="reward-item">
              <div class="reward-icon"></div>
              <div class="reward-amount">+${w.gold}</div>
              <div class="reward-label"></div>
            </div>
          `:""}
          ${w.shards>0?`
            <div class="reward-item">
              <div class="reward-icon"></div>
              <div class="reward-amount">+${w.shards}</div>
              <div class="reward-label"></div>
            </div>
          `:""}
        </div>
        <button id="claim-reward-btn" class="reward-btn"> </button>
      </div>
    `;const I=document.getElementById("claim-reward-btn");I.onclick=()=>{var E,M;const k=N.getState(),v=k.postBattleScreen;if(k.claimReward(),v==="campaign"){const P=k.currentStage;if(P){const D=k.campaignStages.find(H=>H.id===P);if((E=D==null?void 0:D.cutscene)!=null&&E.postVictory){Vi(D.cutscene.postVictory,((M=D.story)==null?void 0:M.backgroundImage)||"",()=>{N.getState().navigateAfterReward()});return}}}k.navigateAfterReward()}}let Ar=0,on=[];function Up(y,w){Ar=0,on=y,Es.classList.add("active"),zi(),Es.onComplete=w}function zi(){if(Ar>=on.length){Es.classList.remove("active");const D=Es.onComplete;D&&(D(),Es.onComplete=null);return}const y=on[Ar],w=on.length;Es.innerHTML=`
      <div class="tutorial-content">
        <div class="tutorial-icon">${y.icon}</div>
        <div class="tutorial-title">${y.title}</div>
        <div class="tutorial-text">${y.text}</div>
        ${y.highlight?`
          <div class="tutorial-highlight">${y.highlight}</div>
        `:""}
        <div class="tutorial-buttons">
          ${Ar<w-1?`
            <button class="tutorial-btn" id="tutorial-next"> </button>
          `:`
            <button class="tutorial-btn" id="tutorial-complete"> </button>
          `}
          ${Ar>0?`
            <button class="tutorial-btn secondary" id="tutorial-skip"></button>
          `:""}
        </div>
      </div>
    `;const I=document.getElementById("tutorial-next"),k=document.getElementById("tutorial-complete"),v=document.getElementById("tutorial-skip"),E=()=>{Ar++,zi()},M=()=>{Ar=on.length,zi()};I&&(I.onclick=E),k&&(k.onclick=M),v&&(v.onclick=M);const P=D=>{D.key===" "||D.key==="Enter"?(D.preventDefault(),Ar<w-1?E():M()):D.key==="Escape"&&(D.preventDefault(),M())};document.removeEventListener("keydown",P),document.addEventListener("keydown",P)}const da=document.getElementById("cutscene"),xl=document.getElementById("screen-transition-overlay");let cr=0,cn=[],ua=null;function Vi(y,w,I){cr=0,cn=y,ua=I,N.getState().setGameScreen("cutscene"),Wi(w)}function Wi(y){if(cr>=cn.length){da.classList.remove("active"),ua&&(ua(),ua=null);return}const w=cn[cr],I=cn.length;da.innerHTML=`
      <div class="cutscene-background" style="background-image: url('${y}');"></div>
      <div class="cutscene-content">
        <div class="cutscene-top">
          ${w.characterImage?`
            <img 
              class="character-portrait visible ${w.emotion?`emotion-${w.emotion}`:""}" 
              src="${w.characterImage}.png" 
              alt="${w.speaker}"
            >
          `:""}
        </div>
        <div class="dialogue-box">
          <div class="dialogue-speaker">${w.speaker}</div>
          <div class="dialogue-text">${w.text}</div>
          <div class="dialogue-controls">
            <div class="dialogue-progress">${cr+1} / ${I}</div>
            <div class="dialogue-buttons">
              ${cr<I-1?`
                <button class="dialogue-btn" id="dialogue-next"> </button>
              `:`
                <button class="dialogue-btn" id="dialogue-complete"> </button>
              `}
              ${cr>0?`
                <button class="dialogue-btn secondary" id="dialogue-skip"></button>
              `:""}
            </div>
          </div>
        </div>
        <div class="skip-hint">Space  Enter:  | ESC: </div>
      </div>
    `;const k=document.getElementById("dialogue-next"),v=document.getElementById("dialogue-complete"),E=document.getElementById("dialogue-skip"),M=()=>{cr++,Wi(y)},P=()=>{cr=cn.length,Wi(y)};k&&(k.onclick=M),v&&(v.onclick=P),E&&(E.onclick=P);const D=H=>{H.key===" "||H.key==="Enter"?(H.preventDefault(),cr<I-1?M():P()):H.key==="Escape"&&(H.preventDefault(),P())};document.removeEventListener("keydown",D),document.addEventListener("keydown",D)}function Gp(){const y=N.getState();console.log(`[ShowVictoryScreen]  Called - gameOver: ${y.gameOver}, playerHp: ${y.playerHp}, enemyHp: ${y.enemyHp}`);const w=Math.floor(Math.random()*3)+1,I=Ad("victory",w),k=y.pendingReward!==null;ri.innerHTML=`
      <div class="result-background" style="background-image: url('${I}');"></div>
      <div class="result-overlay">
        <div class="result-title"> !</div>
        <button class="result-btn" id="victory-continue-btn">${k?" ":" "}</button>
      </div>
    `,ri.classList.add("active");const v=document.getElementById("victory-continue-btn");v.onclick=()=>{ri.classList.remove("active"),Ve!==null&&(window.clearTimeout(Ve),Ve=null),k?N.getState().setGameScreen("reward"):N.getState().setGameScreen("menu")}}function zp(){const y=N.getState();console.log(`[ShowDefeatScreen]  Called - gameOver: ${y.gameOver}, playerHp: ${y.playerHp}, enemyHp: ${y.enemyHp}`);const w=Math.floor(Math.random()*3)+1,I=Ad("defeat",w);si.innerHTML=`
      <div class="result-background" style="background-image: url('${I}');"></div>
      <div class="result-overlay">
        <div class="result-title"> </div>
        <button class="result-btn" id="defeat-retry-btn"> </button>
      </div>
    `,si.classList.add("active");const k=document.getElementById("defeat-retry-btn");k.onclick=()=>{si.classList.remove("active"),Ve!==null&&(window.clearTimeout(Ve),Ve=null),Qt=!1,N.getState().handleBattleDefeatNavigation()}}let ln=null;function fa(){const y=N.getState(),{gold:w,shards:I}=y;console.log("[UI][Shop] Rendering with state",{gold:w,shards:I,collection:y.collection.length,deck:y.playerDeck.length});const k=y.getCardPacks();Uo.innerHTML=`
      <div class="header">
        <div>
          <h2> </h2>
          <button id="shop-menu-btn" style="background: #2a3f5f; color: #fff; border: 1px solid #3a4f75; padding: 4px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px;">  </button>
        </div>
        <div class="currency">
          <div class="currency-item"> : ${w}</div>
          <div class="currency-item"> : ${I}</div>
        </div>
      </div>
      <div class="shop-packs" id="shop-packs"></div>
      <!--    () -->
      <div id="gacha-result-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: #1a2332; border: 2px solid #4a9eff; border-radius: 12px; padding: 30px; max-width: 400px; text-align: center;">
          <h2 style="color: #fff; margin-bottom: 20px;"> !</h2>
          <div id="gacha-result-card" style="margin-bottom: 20px;"></div>
          <button id="gacha-result-close-old" style="background: #4a9eff; color: #fff; border: none; padding: 10px 30px; border-radius: 6px; cursor: pointer; font-size: 16px;"></button>
        </div>
      </div>
    `,ln=document.getElementById("gacha-result-modal");const v=document.getElementById("shop-menu-btn");v.onclick=()=>{N.getState().setGameScreen("menu")};const E=document.getElementById("gacha-result-close-old");E&&(E.onclick=()=>{ln&&(ln.style.display="none"),fa()});const M=document.getElementById("shop-packs");k.forEach(P=>{const D=document.createElement("div");D.className="shop-pack",D.style.cssText=`
        background: linear-gradient(135deg, #1a2332 0%, #2a3f5f 100%);
        border: 2px solid ${P.type==="legendary"?"#ff9800":P.type==="epic"?"#9c27b0":P.type==="rare"?"#2196f3":"#9e9e9e"};
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
      `;const H=P.priceType==="gold"?"":"",O=(P.priceType==="gold"?w:I)>=P.price;D.innerHTML=`
        <h3 style="color: #fff; margin: 0 0 10px 0; font-size: 20px;">${P.name}</h3>
        <p style="color: #aaa; margin: 0 0 15px 0; font-size: 14px;">${P.description}</p>
        <div style="margin: 15px 0; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 6px;">
          <div style="color: #fff; font-size: 12px; margin-bottom: 5px;"></div>
          <div style="color: #aaa; font-size: 11px; line-height: 1.6;">
             ${P.rates.Normal}% |  ${P.rates.Rare}%<br>
             ${P.rates.Epic}% |  ${P.rates.Legendary}%
          </div>
        </div>
        <div style="color: ${O?"#4a9eff":"#f44336"}; font-size: 18px; font-weight: bold; margin: 15px 0;">
          ${H} ${P.price}
        </div>
        <button class="buy-pack-btn" data-pack-type="${P.type}" style="
          background: ${O?"#4a9eff":"#666"};
          color: #fff;
          border: none;
          padding: 12px 30px;
          border-radius: 6px;
          cursor: ${O?"pointer":"not-allowed"};
          font-size: 16px;
          font-weight: bold;
          width: 100%;
          transition: background 0.2s;
        " ${O?"":"disabled"}></button>
      `;const X=D.querySelector(".buy-pack-btn");X.onmouseenter=()=>{O&&(X.style.background="#5aaeff")},X.onmouseleave=()=>{O&&(X.style.background="#4a9eff")},X.onclick=async()=>{if(!O){bt.error(`${P.priceType==="gold"?"":""} !`,2e3),q.playSFX("button_click",.3);return}q.playSFX("button_click",.7);const ne=y.buyCardPack(P.type);ne?(await Vp(ne),bt.success(`${P.name}() !`,2e3)):bt.error(" !",2e3)},M.appendChild(D)})}async function Vp(y){console.log("[Gacha] Starting animation for card:",y.name);const w=document.getElementById("gacha-animation-container"),I=document.getElementById("gacha-card-wrapper"),k=document.getElementById("gacha-card-back-img"),v=document.getElementById("gacha-card-front-img"),E=document.getElementById("gacha-result-info"),M=document.getElementById("gacha-result-name"),P=document.getElementById("gacha-result-rarity"),D=document.getElementById("gacha-result-close");if(!w||!I||!k||!v||!E||!M||!P||!D){console.error("[Gacha] Elements not found!"),Wp(y);return}const H={Normal:"#9e9e9e",Rare:"#2196f3",Epic:"#9c27b0",Legendary:"#ff9800"},L={Normal:"",Rare:"",Epic:"",Legendary:""};w.style.display="flex",k.style.display="block",v.style.display="none",E.style.display="none",I.style.transform="translate(0, 0) rotate(0deg)",I.style.transition="none";const O=Qa(),X=Fo(y);k.src=O||"cards/card_back.webp",v.src=X||"",await new Promise(ie=>{let ce=0;const ge=()=>{ce++,ce>=2&&ie()};k.complete?ge():k.onload=ge,v.complete?ge():v.onload=ge,setTimeout(()=>ie(),3e3)}),await new Promise(ie=>setTimeout(ie,300));const ne=2e3,F=30;for(let ie=0;ie<F;ie++){const ce=ie/F,ge=ce*ce*25,we=Math.random()*360,Ne=Math.cos(we*Math.PI/180)*ge,Oe=Math.sin(we*Math.PI/180)*ge,Pt=(Math.random()-.5)*ge*.6;I.style.transform=`translate(${Ne}px, ${Oe}px) rotate(${Pt}deg)`,await new Promise(et=>setTimeout(et,ne/F))}I.style.transition="transform 0.3s ease-out",I.style.transform="translate(0, 0) rotate(0deg)",await new Promise(ie=>setTimeout(ie,300)),k.style.display="none",v.style.display="block",q.playSFX("button_click",.8),await new Promise(ie=>setTimeout(ie,300)),M.textContent=y.name,M.style.color=H[y.rarity]||"#fff",P.textContent=L[y.rarity]||y.rarity,P.style.color=H[y.rarity]||"#fff",E.style.display="block",y.rarity==="Legendary"?q.playSFX("button_click",1):y.rarity==="Epic"&&q.playSFX("button_click",.9);const fe=()=>{w.style.display="none",setTimeout(()=>fa(),100)};D.onclick=ie=>{ie.stopPropagation(),fe()},w.onclick=ie=>{ie.target===w&&fe()},console.log("[Gacha] Animation completed")}function Wp(y){if(!ln)return;const w={Normal:"#9e9e9e",Rare:"#2196f3",Epic:"#9c27b0",Legendary:"#ff9800"},I=document.getElementById("gacha-result-card");I.innerHTML=`
      <div style="
        background: linear-gradient(135deg, #1a2332 0%, #2a3f5f 100%);
        border: 3px solid ${w[y.rarity]||"#9e9e9e"};
        border-radius: 12px;
        padding: 20px;
        margin: 0 auto;
        max-width: 300px;
      ">
        <div style="color: ${w[y.rarity]||"#9e9e9e"}; font-size: 14px; margin-bottom: 10px; font-weight: bold;">
          ${y.rarity}
        </div>
        <div style="color: #fff; font-size: 24px; font-weight: bold; margin-bottom: 10px;">
          ${y.name}
        </div>
        <div style="color: #aaa; font-size: 14px; margin-bottom: 10px;">
          ${y.type}
        </div>
        <div style="color: #fff; font-size: 12px; line-height: 1.6;">
          ${y.effectText||" "}
        </div>
      </div>
    `,ln.style.display="flex"}let hn=[],gs=0,dn=[];function pa(){dn.forEach(y=>clearTimeout(y)),dn=[]}function un(y,w){const I=window.setTimeout(()=>{dn=dn.filter(k=>k!==I),y()},w);return dn.push(I),I}function qp(){Mp(!1),pa(),hn=[`   , .<br>      , 
             .`,"...   .<br>   ,   ."," .<br>  ,      .","   ,<br>      ."],gs=0,xt.classList.add("active"),qi(),xt.onclick=()=>{gs<hn.length?qi():wl()}}function qi(){if(gs>=hn.length){wl();return}pa();const y=gs;gs++;const I=["intro_01.webp","intro_02.webp","intro_03.webp","intro_04.webp"][y]||"intro_01.webp";xt.style.backgroundImage=`url('backgrounds/${I}')`,xt.style.backgroundSize="cover",xt.style.backgroundPosition="center",xt.style.backgroundRepeat="no-repeat",xt.innerHTML=`
      <div id="intro-page" class="active">
        <p id="intro-text"></p>
      </div>
    `,Xp(hn[y],k=>{const v=document.getElementById("intro-text");v&&(v.innerHTML=k),un(()=>{gs<=hn.length&&qi()},1500)})}function Xp(y,w,I=30,k="intro-text"){const v=document.getElementById(k);if(!v)return;pa();const E=[],M=/(<br>)/g;let P=0,D;for(;(D=M.exec(y))!==null;)D.index>P&&E.push(y.substring(P,D.index)),E.push(D[0]),P=M.lastIndex;P<y.length&&E.push(y.substring(P)),E.length===0&&E.push(y);let H=0,L=0;function O(){if(!v)return;if(H>=E.length){w(y);return}const X=E[H];X==="<br>"?(v.innerHTML=v.innerHTML+"<br>",H++,L=0,un(O,50)):L<X.length?(v.innerHTML=v.innerHTML+X[L],L++,un(O,I)):(H++,L=0,un(O,0))}O()}function wl(){pa();const y="  <br>      ";xt.style.backgroundImage="url('backgrounds/intro_title.webp')",xt.style.backgroundSize="cover",xt.style.backgroundPosition="center",xt.style.backgroundRepeat="no-repeat",xt.innerHTML=`
      <div id="intro-title">${y}</div>
      <div id="intro-click-hint"> </div>
    `,un(()=>{xt.onclick=()=>{tS(()=>{N.getState().setGameScreen("menu")})}},1e3)}let ma=!0;function Yp(y,w,I=!1){if(I||ma){w(),ma=!1;return}xl.classList.add("active"),setTimeout(()=>{w(),setTimeout(()=>{xl.classList.remove("active")},50)},300)}function vl(y){if(xt.classList.remove("active"),Tc.classList.remove("active"),Sn.classList.remove("active"),No.classList.remove("active"),Ho.classList.remove("active"),Uo.classList.remove("active"),ti.classList.remove("active"),da.classList.remove("active"),Ed.classList.remove("active"),ui.style.display="none",r.style.display="none",e.style.display="none",s.style.display="none",t.style.display="none",n.style.display="none",St(),y==="menu"||y==="deck-editor"?q.playBGM("bgm_menu"):y==="battle"||y==="campaign"||y==="daily"||y==="pvp"?q.playBGM("bgm_battle"):y==="shop"&&q.playBGM("bgm_shop"),y!=="cutscene"&&y!=="intro"&&q.playSFX("menu_open",.4),y==="intro")qp(),Me.visible=!1,$e.visible=!1;else if(y==="menu")Tc.classList.add("active"),Me.visible=!1,$e.visible=!1,Qt=!1;else if(y==="cutscene")da.classList.add("active"),Me.visible=!1,$e.visible=!1;else if(y==="battle"){if(ui.style.display="block",r.style.display="block",e.style.display="flex",s.style.display="block",t.style.display="flex",(Ds||window.innerWidth<=768)&&(n.style.display="block"),Me.visible=!0,$e.visible=!0,Ni(),!Qt&&Ir.length>0){Ve!==null&&(window.clearTimeout(Ve),Ve=null);const w=N.getState();Qt=!0,w.initGame(Ir),requestAnimationFrame(()=>{fs(),Fi(),nn(),w.currentStage===1&&setTimeout(()=>{Up([{icon:"",title:"",text:" HP 0  !"},{icon:"",title:" ",text:"   .",highlight:'   ""'},{icon:"",title:" ",text:'  " "  .',highlight:"     "},{icon:"",title:"",text:"     .",highlight:" >  >  > "},{icon:"",title:"",text:"     !"}],()=>{})},800)})}}else y==="deck-editor"?(Sn.classList.add("active"),Me.visible=!1,$e.visible=!1,Qt=!1,ha()):y==="campaign"?(No.classList.add("active"),Me.visible=!0,$e.visible=!0,_l()):y==="daily"?(Ho.classList.add("active"),Me.visible=!1,$e.visible=!1,Qt=!1,yl()):y==="shop"?(Uo.classList.add("active"),Me.visible=!1,$e.visible=!1,Qt=!1,fa()):y==="reward"?(Me.visible=!1,$e.visible=!1,Qt=!1,bl()):y==="pvp"&&(Ed.classList.add("active"),Me.visible=!1,$e.visible=!1)}ma=!0,vl(N.getState().gameScreen),ma=!1;let ga=N.getState().gameScreen,Xi=!1,Cr=null;function Kp(y){Cr=y,!Xi&&(Xi=!0,requestAnimationFrame(()=>{Xi=!1,Cr&&(Cr==="battle"?(fs(),Fi(),nn(),kr(),an()):Cr==="deck-editor"?ha():Cr==="campaign"?_l():Cr==="daily"?yl():Cr==="shop"?fa():Cr==="reward"&&bl())}))}let Yi=N.getState().deck.length,_t=N.getState().hand.length,Xe=N.getState().enemyHand.length,Er=!1,lr=!1,fn=0,hr=0,Ki=[],Ji=[];Sv(()=>{console.log("[HandTracking]  RESET CALLED"),console.log(`[HandTracking]   Before - prevHand: ${_t}, prevEnemyHand: ${Xe}`),Ki.forEach(y=>window.clearTimeout(y)),Ki=[],Ji.forEach(y=>window.clearTimeout(y)),Ji=[],Yi=0,_t=0,Xe=0,Er=!1,lr=!1,fn=0,hr=0,console.log(`[HandTracking]   After - prevHand: ${_t}, prevEnemyHand: ${Xe}`)}),kv(()=>{hr=N.getState().enemyHand.length,kr()}),N.subscribe(y=>{if(y.gameScreen!==ga){console.log(`[Screen] Transition: ${ga} -> ${y.gameScreen}`);const w=y.gameScreen;Yp(w,()=>{ga=w,vl(w),Q()})}if(y.gameScreen==="battle"&&Q(),y.deck.length!==Yi&&(Ni(),Yi=y.deck.length),y.hand.length!==_t&&console.log(`[Hand]  CHANGE DETECTED - prev: ${_t}, current: ${y.hand.length}, screen: ${y.gameScreen}, isDrawing: ${Er}`),y.hand.length===0&&_t>0&&Er)console.log("[Hand]  IGNORED: hand reset to 0 during draw animation (Zustand async issue)");else if(y.hand.length>_t&&y.gameScreen==="battle"&&!Er){const w=y.hand.length-_t,I=y.hand.length;console.log(`[Draw]  ${w} card(s) drawn (${_t}  ${I})`),Er=!0,fn=_t,an(),_t=I,console.log(`[Hand]  Updated prevHandLength to ${I}`);for(let k=0;k<w;k++){const v=Y.renderer.width/2,E=Y.renderer.height-100,M=window.setTimeout(async()=>{await gl({x:v,y:E},!0),fn++,an(),fn>=I&&(Er=!1,console.log("[Hand]  Animation complete"))},k*300);Ki.push(M)}}else y.hand.length!==_t&&!Er&&(console.log(`[Hand]  Change detected (not a draw or screen !== 'battle') - prev: ${_t}, current: ${y.hand.length}, screen: ${y.gameScreen}`),_t=y.hand.length);if(y.enemyHand.length!==Xe&&console.log(`[EnemyHand]  CHANGE DETECTED - prev: ${Xe}, current: ${y.enemyHand.length}, screen: ${y.gameScreen}, isDrawing: ${lr}`),y.enemyHand.length===0&&Xe>0&&lr)console.log("[EnemyHand]  IGNORED: enemyHand reset to 0 during draw animation (Zustand async issue)");else if(y.enemyHand.length>Xe&&y.gameScreen==="battle"&&!lr)if(Xe===0&&y.battleContext.type==="pvp"&&y.round===1)hr=y.enemyHand.length,kr(),Xe=y.enemyHand.length,lr=!1,console.log("[EnemyHand]  Initial PvP hand synced without animation");else{const w=y.enemyHand.length-Xe,I=y.enemyHand.length;console.log(`[EnemyDraw]  ${w} card(s) drawn (${Xe}  ${I})`),lr=!0,hr=Xe,kr(),Xe=I,console.log(`[EnemyHand]  Updated prevEnemyHandLength to ${I}`);for(let k=0;k<w;k++){const v=Y.renderer.width/2,E=100,M=window.setTimeout(async()=>{await gl({x:v,y:E},!1),hr++,kr(),hr>=I&&(lr=!1,console.log("[EnemyHand]  Animation complete"))},k*300);Ji.push(M)}}else if(y.enemyHand.length!==Xe&&y.gameScreen==="battle"&&!lr){const w=y.enemyHand.length-Xe;console.log(`[EnemyHand]  UNEXPECTED CHANGE - newCards: ${w}, prev: ${Xe}, current: ${y.enemyHand.length}`),w<0&&console.log(`[EnemyHand] ${Math.abs(w)} card(s) removed`),hr=y.enemyHand.length,kr(),Xe=y.enemyHand.length}else y.enemyHand.length!==Xe&&(console.log(`[EnemyHand]  Change detected but screen !== 'battle' (screen: ${y.gameScreen})`),hr=y.enemyHand.length,kr(),Xe=y.enemyHand.length);vr!==y.energy&&jo(Qn,y.energy,300,w=>{Qn=w,fs(),ms(ir,oa,w,10,Tt)},{easing:Mr.easeOutQuad}),vr=y.energy,y.enemyEnergy!==void 0&&ms(or,ca,y.enemyEnergy,10,Ft),Sr!==y.playerHp&&(jo(us,y.playerHp,400,w=>{us=w,fs(),ps(Me,na,w,y.playerMaxHp,Tt,ul,!0)},{easing:Mr.easeOutCubic}),ul=y.playerHp),Sr=y.playerHp,Gr!==y.enemyHp&&(jo(sn,y.enemyHp,400,w=>{sn=w,fs(),ps($e,aa,w,y.enemyMaxHp,Ft,fl,!0)},{easing:Mr.easeOutCubic}),fl=y.enemyHp),Gr=y.enemyHp,tn=y.round,rn=y.roundSeed,Ur=y.playerMaxHp,Kt=y.enemyMaxHp,it!==y.gameOver&&(console.log(`[GameOver] State changed: ${it}  ${y.gameOver}`),Ve!==null&&(window.clearTimeout(Ve),Ve=null,console.log("[GameOver] Cancelled previous timer")),y.gameOver==="victory"?(console.log("[GameOver] Setting victory timer"),Ve=window.setTimeout(()=>{const w=N.getState();w.gameOver==="victory"?Gp():console.log(`[GameOver] Timer fired but gameOver changed to ${w.gameOver}, skipping`)},1e3)):y.gameOver==="defeat"?(console.log("[GameOver] Setting defeat timer"),Ve=window.setTimeout(()=>{const w=N.getState();w.gameOver==="defeat"?zp():console.log(`[GameOver] Timer fired but gameOver changed to ${w.gameOver}, skipping`)},1e3)):(console.log("[GameOver] Hiding victory/defeat screens"),ri.classList.remove("active"),si.classList.remove("active"))),it=y.gameOver,(Bt!==y.playerStatus||Dt!==y.enemyStatus)&&hl(),Bt=y.playerStatus,Dt=y.enemyStatus,y.gameScreen===ga&&Kp(y.gameScreen)})});export{Vm as $,Iu as A,wt as B,ve as C,ke as D,J as E,Kd as F,Pi as G,Ll as H,mt as I,pg as J,Sg as K,Kn as L,pe as M,je as N,Re as O,ft as P,Hg as Q,Qo as R,Dc as S,Sa as T,Xo as U,jl as V,io as W,Nl as X,qm as Y,Hs as Z,qe as _,fu as a,Wd as a0,Au as a1,he as a2,_e as a3,Wg as a4,by as a5,uy as a6,Fy as a7,Ny as a8,Vy as a9,qy as aa,Xy as ab,Hu as ac,eh as ad,Ql as ae,Ih as af,nr as ag,K0 as ah,Ie as ai,Pe as aj,pm as ak,zn as al,Bh as am,zu as an,qt as b,ly as c,Un as d,at as e,Zl as f,iy as g,ai as h,Bc as i,vu as j,su as k,Xt as l,yu as m,Vn as n,Ly as o,jy as p,Gy as q,Em as r,Wy as s,me as t,fm as u,Ky as v,Ae as w,Ot as x,Gd as y,Wt as z};
//# sourceMappingURL=index-DR_Pg4UW.js.map
